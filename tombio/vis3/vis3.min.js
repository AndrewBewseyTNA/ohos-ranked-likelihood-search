(function(n,t){"use strict";function h(){var t,f,l,e,s,u,h,c;for(console.log("Get the URL"),t=[],t.push("selectedTool="+o),f=[],l=n(".pq-grid-title-row").find(".pq-td-div"),e=1;e<l.length;e++)f.push(l[e].children[0].innerText);t.push("taxa="+f.join("^"));s=[];f.forEach(function(n){i.stateTaxa[n].imgDiv?s.push(i.stateTaxa[n].imgDiv.attr("indexSelected")):s.push("x")});t.push("imgs="+s.join("-"));t.push("colwidth="+i.vis3ColWidth);u=r.getFilter();u&&(u.startsWith("#")&&(u="-"+u.substr(1)),t.push("filter="+u));r.taxonSort&&(r.taxonSort=="radio-a"?h="a-z":r.taxonSort=="radio-z"&&(h="z-a"),h&&t.push("sort="+h));r.hiddenControlsShown&&t.push("hc=show");c=encodeURI(window.location.href.split("?")[0]+"?"+t.join("&"));i.copyTextToClipboard(c);console.log("URL length:",c.length);console.log(c)}function f(n,t,r,u){t.on("remove",function(){n.closest(".pq-td-div").css("padding","");n.closest("td").css("background-color","");r.fadeIn();i.stateTaxa[u.Taxon.kbValue].imgDiv=null;t.is(".userRemoved")?(i.stateTaxa[u.Taxon.kbValue].displayImages=!1,i.stateTaxa[u.Taxon.kbValue].indexSelected=0):i.stateTaxa[u.Taxon.kbValue].indexSelected=t.attr("indexSelected")})}function e(n){var r=n.attr("taxon"),o=t.oTaxa[r],u,e;return u=i.stateTaxa[r].indexSelected?i.getTaxonImagesDiv(r,null,i.stateTaxa[r].indexSelected):i.getTaxonImagesDiv(r),i.stateTaxa[r].imgDiv=u,n.closest(".pq-td-div").css("padding",0),n.closest("td").css("background-color","lightgrey"),n.append(u),e=n.find(".loadImgIcon"),e.fadeOut(0),f(n,u,e,o),i.stateTaxa[r].displayImages=!0,u}function s(n,t,i){var r=i.Character,f=null,o,e,u,l;if(i.Status=="key")if(t[r].kbValue=="n/a"||t[r].kbValue=="")n[r].kbValue=="n/a"||n[r].kbValue==""||(f=-1);else if(n[r].kbValue=="n/a"||n[r].kbValue=="")f=-1;else if(i.ValueType=="numeric"){var s=i.maxVal-i.minVal,h=tombioScore.numberVsRange(t[r].getRange().min,n[r].getRange(),s,i.Strictness),c=tombioScore.numberVsRange(t[r].getRange().max,n[r].getRange(),s,i.Strictness);f=(h[0]-h[1]+c[0]-c[1])/2}else i.ValueType=="ordinal"||i.ValueType=="ordinalCircular"?(e=0,u=0,["male","female",""].forEach(function(f){t[r].getOrdinalRanges(f).forEach(function(t){o=tombioScore.ordinal2(t,n[r].getOrdinalRanges(f),i.CharacterStateValues,i.Strictness,i.ValueType=="ordinalCircular");u+=o[0];u-=o[1];e++})}),f=u/e):(e=0,u=0,["male","female",""].forEach(function(i){u+=tombioScore.jaccard(t[r].getStates(i),n[r].getStates(i));e++}),l=u/e,f=l*2-1);return f}var o="vis3",u=t[o]=Object.create(t.visP),i,r;u.initialise=function(){function o(n){var u=[],f;t.taxa.forEach(function(n){u.push(n)});i.sortTaxa(u);f=u.length>n?u.slice(0,n):u;i.vis3Taxa=f.map(function(n){return n.Taxon.kbValue});r.deselectAllTaxa();i.vis3Taxa.forEach(function(n){r.taxonClick(n)})}function u(u){var f=[],e,o;(n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&f.push(t.oTaxa[n.dataIndx])}),f.length!=0)&&(e=f[0],u&&(f=t.taxa),f.forEach(function(n){n.Taxon==e.Taxon?n.vis3CompScore=999999:(n.vis3CompScore=0,t.characters.forEach(function(t){t.Status=="key"&&(n.vis3CompScore+=s(e,n,t))}))}),f.sort(function(n,t){return n.vis3CompScore>t.vis3CompScore?-1:1}),o=u?f.slice(0,u+1):f,i.vis3Taxa=o.map(function(n){return n.Taxon.kbValue}),r.deselectAllTaxa(),i.vis3Taxa.forEach(function(n){r.taxonClick(n)}))}function l(n){n.selected&&i.vis3Taxa.indexOf(n.selected)==-1&&(i.vis3Taxa.push(n.selected),i.refresh());n.deselected&&i.vis3Taxa.indexOf(n.deselected)!=-1&&(i.vis3Taxa.splice(i.vis3Taxa.indexOf(n.deselected),1),i.refresh());n.taxa.length==0&&(i.vis3Taxa=[],i.refresh())}var f,e,c;i=this;this.metadata.title="Side by side comparison";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.1.0";this.charStateInput=!1;this.helpFiles=[t.opts.tombiopath+"vis3/vis3Help.html",t.opts.tombiopath+"common/taxon-select-help.html"];this.contextMenu.addItem("Get URL for side by side comparison view",function(){h()},[this.visName]);this.contextMenu.addItem("Rank those shown against first",function(){u();i.refresh()},[this.visName]);this.contextMenu.addItem("Show closest two to first",function(){u(2);i.refresh()},[this.visName]);this.contextMenu.addItem("Show closest five to first",function(){u(5);i.refresh()},[this.visName]);this.contextMenu.addItem("Show closest ten to first",function(){u(10);i.refresh()},[this.visName]);this.contextMenu.addItem("Show top two from key",function(){o(2);i.refresh()},[this.visName]);this.contextMenu.addItem("Show top five from key",function(){o(5);i.refresh()},[this.visName]);this.contextMenu.addItem("Show top ten from key",function(){o(10);i.refresh()},[this.visName]);this.contextMenu.addItem("Remove all",function(){i.vis3Taxa=[];i.refresh();r.deselectAllTaxa()},[this.visName]);i.vis3Taxa=[];f=n("<div>").appendTo(n(this.cssSel));f.css("display","flex");this.controlsDiv=n("<div/>").css("width",210);f.append(this.controlsDiv);e=n("<div/>").css("position","relative").css("top",-13);f.append(e);r=Object.create(t.taxonSelect);r.control(this.controlsDiv,!0,l);e.append(n("<div>").css("display","inline-block").css("width",150).css("height",1));c=n("<div id='visType3Grid'><\/div>");e.append(c);this.stateTaxa={};t.taxa.forEach(function(n){i.stateTaxa[n.Taxon.kbValue]={}})};u.refresh=function(){function y(n){if(n.dataIndx=="character"){i.vis3CharColWidth=n.newWidth;return}i.vis3ColWidth=n.newWidth;v()}function v(){n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&(n.width=i.vis3ColWidth)});n("#visType3Grid").pqGrid("refresh")}function p(){var y,r,h,u,w,c,o,l,a,v,p;if(n(".vis3ImageDiv").each(function(){var r=n(this),u=n(this).attr("taxon"),s=t.oTaxa[u],o;i.getTaxonImages(u).length>0&&(o=n("<img>").attr("src",t.opts.tombiopath+"resources/camera.png").addClass("loadImgIcon").css("cursor","pointer").css("width",15).on("click",function(){var t=n(this),i=e(r);f(r,i,t,s)}),n(this).append(o),i.stateTaxa[u].displayImages&&e(r))}),y=d3.scaleLinear().domain([-1,0,1]).range(i.scoreColours),r=[],n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&r.push(n.dataIndx)}),!(r.length<2))for(r.forEach(function(t,i){n("td[pq-row-indx=0][pq-col-indx="+(i+2)+"]").css("background-color","rgb(100,100,100)").css("color","white")}),h=t.oTaxa[r[0]],u=1;u<r.length;u++){w=t.oTaxa[r[u]];for(c in t.oCharacters)o=t.oCharacters[c],l=n("."+o.Character).closest("tr").attr("pq-row-indx"),l!=undefined&&(u==1&&(a=n("#visType3Grid").pqGrid("getCell",{rowIndx:l,dataIndx:r[0]}),o.Status=="key"?h[c].kbValue=="n/a"||h[c].kbValue==""||h[c].kbValue=="?"?a.css("background-color","white"):a.css("background-color",y(1)):o.Status=="display"&&a.css("background-color","lightgrey")),v=n("#visType3Grid").pqGrid("getCell",{rowIndx:l,dataIndx:r[u]}),p=s(h,w,o),o.Status=="display"?v.css("background-color","lightgrey"):p==null?v.css("background-color","white"):v.css("background-color",y(p)))}}var r,o,h,l,a,c,u;n("#visType3Grid").is(":empty")||n("#visType3Grid").pqGrid("destroy");r=[];o={group:" Images",character:"Images"};this.vis3Taxa.forEach(function(i){var r=t.oTaxa[i],u=n("<div>").attr("taxon",i).css("position","relative").attr("class","vis3ImageDiv");o[r.Taxon]=u[0].outerHTML});r.push(o);t.characters.forEach(function(n){if(n.Status=="display"||n.Status=="key"&&n.Character!="Sex"){var u={group:n.Group,character:n.Label,pq_cellcls:{character:n.Character}};i.vis3Taxa.forEach(function(i){var r=t.oTaxa[i];u[r.Taxon]=r[n.Character].toHtml1()});r.push(u)}});h=[];l=["group"].concat(["character"].concat(this.vis3Taxa));l.forEach(function(n,t){var r,u,f,e;r=t==0?!0:!1;u=t==1?"Character":"<i>"+n+"<\/i>";i.vis3ColWidth||(i.vis3ColWidth=200);i.vis3CharColWidth||(i.vis3CharColWidth=200);f=t==1?i.vis3CharColWidth:i.vis3ColWidth;e={title:u,hidden:r,width:f,dataType:"string",dataIndx:n,sortable:!1};h.push(e)});a=n("input[name=groupvisibility]:checked").val();c=null;a=="visible"&&(c={dataIndx:["group"],collapsed:[!0],title:["<b style='font-weight:bold;'>{0}<\/b>","{0}"],dir:["up","down"]});u={flexHeight:!0,flexWidth:!0,showTop:!1,showBottom:!1,showTitle:!1,numberCell:{show:!1},stripeRows:!0,columnBorders:!0,showHeader:!0,editable:!1,resizable:!1,groupModel:c,selectionModel:{type:null,mode:null},columnResize:function(n,t){y(t)},refresh:function(){p()}};u.colModel=h;u.dataModel={data:r,location:"local"};n("#visType3Grid").pqGrid(u);v()};u.urlParams=function(t){t.hc&&r.toggleHiddenControls();i.vis3ColWidth=t.colwidth;t.taxa&&t.taxa.split("^").forEach(function(n){r.taxonClick(n.replace(/%20/g," "))});t.imgs&&t.imgs.split("-").forEach(function(t,r){var u=i.vis3Taxa[r];if(t!="x"){i.stateTaxa[u].indexSelected=t;var o=n('.vis3ImageDiv[taxon="'+u+'"]'),s=o.find(".loadImgIcon"),h=e(o);f(o,h,s,u)}});setTimeout(function(){var n;t.filter&&(n=t.filter.startsWith("-")?"#"+t.filter.substr(1):t.filter,r.setFilter(n));t.sort&&r.setSort(t.sort)},100)}})(jQuery,this.tombiovis);