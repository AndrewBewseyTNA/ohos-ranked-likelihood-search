(function(n,t){"use strict";function h(){var f=[],e,h,o,s;for(f.push("selectedTool="+r),e=[],h=n(".pq-grid-title-row").find(".pq-td-div"),o=1;o<h.length;o++)e.push(h[o].children[0].innerText);f.push("taxa="+e.join("^"));s=[];e.forEach(function(n){typeof t.d.oTaxa[n].visState[r].indexSelected!="undefined"?s.push(t.d.oTaxa[n].visState[r].indexSelected):s.push("x")});f.push("imgs="+s.join("-"));f.push("colwidth="+i.vis3ColWidth);f=u.setParamsFromState(f);i.createViewURL(f)}function e(n,i,u,f){i.on("remove",function(){n.closest(".pq-td-div").css("padding","");n.closest("td").css("background-color","");u.fadeIn();t.d.oTaxa[f.Taxon.kbValue].visState[r].imgDiv=null;i.is(".userRemoved")&&(t.d.oTaxa[f.Taxon.kbValue].visState[r].displayImages=!1)})}function o(u){var f=u.attr("taxon"),h=t.d.oTaxa[f],o=n("<div>"),s;return i.addTaxonImagesToContainer({taxon:f,container:o,indexSelected:t.d.oTaxa[f].visState[r].indexSelected,imageRemovalButton:!0,height:i.vis3ColWidth,fImageSelect:function(n){t.d.oTaxa[f].visState[r].indexSelected=n}}),t.d.oTaxa[f].visState[r].imgDiv=o,u.closest(".pq-td-div").css("padding",0),u.closest("td").css("background-color","lightgrey"),u.append(o),s=u.find(".loadImgIcon"),s.fadeOut(0),e(u,o,s,h),t.d.oTaxa[f].visState[r].displayImages=!0,o}function s(n,i,r){var u=r.Character,e=null,s,o,f,l;if(r.Status=="key")if(i[u].kbValue=="n/a"||i[u].kbValue=="novalue"||i[u].kbValue=="")n[u].kbValue=="n/a"||n[u].kbValue=="novalue"||n[u].kbValue==""||(e=-1);else if(n[u].kbValue=="n/a"||n[u].kbValue=="novalue"||n[u].kbValue=="")e=-1;else if(r.ValueType=="numeric"){var a=r.maxVal-r.minVal,h=t.f.score.numberVsRange(i[u].getRange().min,n[u].getRange(),r.Latitude),c=t.f.score.numberVsRange(i[u].getRange().max,n[u].getRange(),r.Latitude);e=(h[0]-h[1]+c[0]-c[1])/2}else r.ValueType=="ordinal"||r.ValueType=="ordinalCircular"?(o=0,f=0,["male","female",""].forEach(function(e){i[u].getOrdinalRanges(e).forEach(function(i){s=t.f.score.ordinal(i,n[u].getOrdinalRanges(e),r.CharacterStateValues,r.Latitude,r.ValueType=="ordinalCircular");f+=s[0];f-=s[1];o++})}),e=f/o):(o=0,f=0,["male","female",""].forEach(function(r){f+=t.f.score.jaccard(i[u].getStates(r),n[u].getStates(r));o++}),l=f/o,e=l*2-1);return e}var r="vis3",f=t.v.visualisations[r]=Object.create(t.v.visPjQueryUILargeFormat),i,u;f.initialise=function(){function o(n){var r=[],f;t.d.taxa.forEach(function(n){r.push(n)});i.sortTaxa(r);f=r.length>n?r.slice(0,n):r;i.vis3Taxa=f.map(function(n){return n.Taxon.kbValue});u.deselectAllTaxa();i.vis3Taxa.forEach(function(n){u.taxonClick(n)})}function r(r){var f=[],e,o;(n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&f.push(t.d.oTaxa[n.dataIndx])}),f.length!=0)&&(e=f[0],r&&(f=t.d.taxa),f.forEach(function(n){n.Taxon==e.Taxon?n.vis3CompScore=999999:(n.vis3CompScore=0,t.d.characters.forEach(function(t){t.Status=="key"&&(n.vis3CompScore+=s(e,n,t))}))}),f.sort(function(n,t){return n.vis3CompScore>t.vis3CompScore?-1:1}),o=r?f.slice(0,r+1):f,i.vis3Taxa=o.map(function(n){return n.Taxon.kbValue}),u.deselectAllTaxa(),i.vis3Taxa.forEach(function(n){u.taxonClick(n)}))}function l(n){n.selected&&i.vis3Taxa.indexOf(n.selected)==-1&&(i.vis3Taxa.push(n.selected),i.refresh());n.deselected&&i.vis3Taxa.indexOf(n.deselected)!=-1&&(i.vis3Taxa.splice(i.vis3Taxa.indexOf(n.deselected),1),i.refresh());n.taxa.length==0&&(i.vis3Taxa=[],i.refresh())}var f,e,c;i=this;this.metadata.title="Side by side comparison";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.2";this.charStateInput=null;this.imageIndex=0;this.helpFiles=[t.opts.tombiopath+"vis3/vis3Help.html",t.opts.tombiopath+"common/taxon-select-help.html"];this.contextMenu.addItem("Get URL for side by side comparison view",function(){h()},[this.visName]);this.contextMenu.addItem("Rank those shown against first",function(){r();i.refresh()},[this.visName]);this.contextMenu.addItem("Show closest two to first",function(){r(2);i.refresh()},[this.visName]);this.contextMenu.addItem("Show closest five to first",function(){r(5);i.refresh()},[this.visName]);this.contextMenu.addItem("Show closest ten to first",function(){r(10);i.refresh()},[this.visName]);this.contextMenu.addItem("Show top two from key",function(){o(2);i.refresh()},[this.visName]);this.contextMenu.addItem("Show top five from key",function(){o(5);i.refresh()},[this.visName]);this.contextMenu.addItem("Show top ten from key",function(){o(10);i.refresh()},[this.visName]);this.contextMenu.addItem("Remove all",function(){i.vis3Taxa=[];i.refresh();u.deselectAllTaxa()},[this.visName]);i.vis3Taxa=[];f=n("<div>").appendTo(n(this.cssSel));f.css("display","flex");this.controlsDiv=n("<div/>").css("width",210);f.append(this.controlsDiv);e=n("<div/>").css("position","relative").css("top",-13);f.append(e);u=Object.create(t.gui.taxonSelect);u.init(this.controlsDiv,!0,l);e.append(n("<div>").css("display","inline-block").css("width",150).css("height",1));c=n("<div id='visType3Grid'><\/div>");e.append(c)};f.refresh=function(){function p(n){if(n.dataIndx=="character"){i.vis3CharColWidth=n.newWidth;return}console.log(n.newWidth);i.vis3ColWidth=n.newWidth;y()}function y(){n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&(n.width=i.vis3ColWidth)});n("#visType3Grid").pqGrid("refresh")}function w(){var p,u,f,h,b,c,l,a,v,y,w;if(n(".vis3ImageDiv").each(function(){var u=n(this),f=n(this).attr("taxon"),h=t.d.oTaxa[f],s;i.getTaxonImages(f).length>0&&(s=n("<img>").attr("src",t.opts.tombiopath+"resources/camera.png").addClass("loadImgIcon").css("cursor","pointer").css("width",15).on("click",function(){var t=n(this),i=o(u);e(u,i,t,h)}),n(this).append(s),t.d.oTaxa[f].visState[r].displayImages&&o(u))}),p=d3.scaleLinear().domain([-1,0,1]).range(i.scoreColours),u=[],n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&u.push(n.dataIndx)}),!(u.length<2))for(u.forEach(function(t,i){n("td[pq-row-indx=0][pq-col-indx="+(i+2)+"]").css("background-color","rgb(100,100,100)").css("color","white")}),f=t.d.oTaxa[u[0]],h=1;h<u.length;h++){b=t.d.oTaxa[u[h]];for(c in t.d.oCharacters)l=t.d.oCharacters[c],a=n("."+l.Character).closest("tr").attr("pq-row-indx"),a!=undefined&&(h==1&&(v=n("#visType3Grid").pqGrid("getCell",{rowIndx:a,dataIndx:u[0]}),l.Status=="key"?f[c].kbValue=="n/a"||f[c].kbValue=="novalue"||f[c].kbValue==""||f[c].kbValue=="?"?v.css("background-color","white"):v.css("background-color",p(1)):l.Status=="display"&&v.css("background-color","lightgrey")),y=n("#visType3Grid").pqGrid("getCell",{rowIndx:a,dataIndx:u[h]}),w=s(f,b,l),l.Status=="display"?y.css("background-color","lightgrey"):w==null?y.css("background-color","white"):y.css("background-color",p(w)))}}var u,h,c,a,v,l,f;n("#visType3Grid").is(":empty")||n("#visType3Grid").pqGrid("destroy");u=[];h={group:" Images",character:"Images"};this.vis3Taxa.forEach(function(i){var r=t.d.oTaxa[i],u=n("<div>").attr("taxon",i).css("position","relative").attr("class","vis3ImageDiv");h[r.Taxon]=u[0].outerHTML});u.push(h);t.d.characters.forEach(function(n){if(n.Status=="display"||n.Status=="key"&&n.Character!="Sex"){var r={group:n.Group,character:n.Label,pq_cellcls:{character:n.Character}};i.vis3Taxa.forEach(function(i){var u=t.d.oTaxa[i];r[u.Taxon]=u[n.Character].toHtml1()});u.push(r)}});c=[];a=["group"].concat(["character"].concat(this.vis3Taxa));a.forEach(function(n,t){var r,u,f,e;r=t==0?!0:!1;u=t==1?"Character":"<i>"+n+"<\/i>";i.vis3ColWidth||(i.vis3ColWidth=200);i.vis3CharColWidth||(i.vis3CharColWidth=200);f=t==1?i.vis3CharColWidth:i.vis3ColWidth;e={title:u,hidden:r,width:f,dataType:"string",dataIndx:n,sortable:!1};c.push(e)});v=n("input[name=groupvisibility]:checked").val();l=null;v=="visible"&&(l={dataIndx:["group"],collapsed:[!0],title:["<b style='font-weight:bold;'>{0}<\/b>","{0}"],dir:["up","down"]});f={flexHeight:!0,flexWidth:!0,showTop:!1,showBottom:!1,showTitle:!1,numberCell:{show:!1},stripeRows:!0,columnBorders:!0,showHeader:!0,editable:!1,resizable:!1,groupModel:l,selectionModel:{type:null,mode:null},columnResize:function(n,t){p(t)},refresh:function(){w()}};f.colModel=c;f.dataModel={data:u,location:"local"};n("#visType3Grid").pqGrid(f);y()};f.urlParams=function(f){i.vis3ColWidth=f.colwidth;f.taxa&&f.taxa.split("^").forEach(function(n){u.taxonClick(n.replace(/%20/g," "))});f.imgs&&f.imgs.split("-").forEach(function(u,f){var s=i.vis3Taxa[f];if(u!="x"){t.d.oTaxa[s].visState[r].indexSelected=u;var h=n('.vis3ImageDiv[taxon="'+s+'"]'),c=h.find(".loadImgIcon"),l=o(h);e(h,l,c,s)}});setTimeout(function(){u.initStateFromParams(f)},100)}})(jQuery,this.tombiovis);