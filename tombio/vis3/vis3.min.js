(function(n,t){"use strict";function u(n,t,i){var r=i.Character,f=null,o,e,u,l;if(i.Status=="key")if(t[r].value=="n/a"||t[r].value=="")n[r].value=="n/a"||n[r].value==""||(f=-1);else if(n[r].value=="n/a"||n[r].value=="")f=-1;else if(i.ValueType=="numeric"){var s=i.maxVal-i.minVal,h=tombioScore.numberVsRange(t[r].getRange().min,n[r].getRange(),s,i.Strictness),c=tombioScore.numberVsRange(t[r].getRange().max,n[r].getRange(),s,i.Strictness);f=(h[0]-h[1]+c[0]-c[1])/2}else i.ValueType=="ordinal"||i.ValueType=="ordinalCircular"?(e=0,u=0,["male","female",""].forEach(function(f){t[r].getOrdinalRanges(f).forEach(function(t){o=tombioScore.ordinal2(t,n[r].getOrdinalRanges(f),i.CharacterStateValues,i.Strictness,i.ValueType=="ordinalCircular");u+=o[0];u-=o[1];e++})}),f=u/e):(e=0,u=0,["male","female",""].forEach(function(i){u+=tombioScore.jaccard(t[r].getStates(i),n[r].getStates(i));e++}),l=u/e,f=l*2-1);return f}var r="vis3",i=t[r]={};i.Obj=function(n,t,i){i.visP.Obj.call(this,r,n,t,i);this.metadata.title="Side by side comparison";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.1.0"};i.Obj.prototype=Object.create(t.visP.Obj.prototype);i.Obj.prototype.initialise=function(){function e(n){var t=[],r;i.taxa.forEach(function(n){t.push(n)});i.sortTaxa(t);r=t.length>n?t.slice(0,n):t;i.vis3Taxa=r.map(function(n){return n.Taxon.value})}function o(t){var r=[],f,e;(n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&r.push(i.oTaxa[n.dataIndx])}),r.length!=0)&&(f=r[0],t&&(r=i.taxa),r.forEach(function(n){n.Taxon==f.Taxon?n.vis3CompScore=999999:(n.vis3CompScore=0,i.characters.forEach(function(t){t.Status=="key"&&(n.vis3CompScore+=u(f,n,t))}))}),r.sort(function(n,t){return n.vis3CompScore>t.vis3CompScore?-1:1}),e=t?r.slice(0,t+1):r,i.vis3Taxa=e.map(function(n){return n.Taxon.value}))}function c(n){n.selected&&i.vis3Taxa.indexOf(n.selected)==-1&&(i.vis3Taxa.push(n.selected),i.refresh());n.deselected&&i.vis3Taxa.indexOf(n.deselected)!=-1&&(i.vis3Taxa.splice(i.vis3Taxa.indexOf(n.deselected),1),i.refresh());n.taxa.length==0&&(i.vis3Taxa=[],i.refresh())}var i=this,f,s,r,h;if(this.charStateInput=!1,this.helpFiles=[t.tombiopath+"vis3/vis3Help.html"],this.contextMenu.addItem("Rank those shown against first",function(){o();i.refresh()},[this.visName]),this.contextMenu.addItem("Show closest two to first",function(){o(2);i.refresh()},[this.visName]),this.contextMenu.addItem("Show closest five to first",function(){o(5);i.refresh()},[this.visName]),this.contextMenu.addItem("Show closest ten to first",function(){o(10);i.refresh()},[this.visName]),this.contextMenu.addItem("Show top two from key",function(){e(2);i.refresh()},[this.visName]),this.contextMenu.addItem("Show top five from key",function(){e(5);i.refresh()},[this.visName]),this.contextMenu.addItem("Show top ten from key",function(){e(10);i.refresh()},[this.visName]),this.contextMenu.addItem("Show all",function(){e(1e4);i.refresh()},[this.visName]),this.contextMenu.addItem("Remove all",function(){i.vis3Taxa=[];i.refresh();i.taxSel.deselectAllTaxa()},[this.visName]),i.vis3Taxa=[],f=n("<div>").appendTo(n(this.cssSel)),f.css("display","flex"),n(this.cssSel).append(f),this.controlsDiv=n("<div/>").css("width",210),f.append(this.controlsDiv),s=n("<div/>").css("flex-grow",1),f.append(s),this.taxSel=Object.create(t.taxonSelect),this.taxSel.control(this.controlsDiv,!0,c),i.charactersGrouped){r=n("<fieldset>").css("display","inline-block").css("padding","0px").css("border","none").css("vertical-align","top");r.append(n("<label>").attr("for","groupvisible").text("group"));r.append(n("<input>").attr("type","radio").attr("name","groupvisibility").attr("id","groupvisible").attr("value","visible"));r.append(n("<label>").attr("for","groupinvisible").text("ungroup"));r.append(n("<input>").attr("type","radio").attr("name","groupvisibility").attr("id","groupinvisible").attr("value","invisible").attr("checked","checked"));s.append(r);n("[name='groupvisibility']").checkboxradio({icon:!1});r.on("change",function(){i.refresh()})}h=n("<div id='visType3Grid'><\/div>").css("margin-top",10);s.append(h);this.stateTaxa={};this.taxa.forEach(function(n){i.stateTaxa[n.Taxon.value]={}})};i.Obj.prototype.refresh=function(){function l(t){if(t.dataIndx=="character"){i.vis3CharColWidth=t.newWidth;return}i.vis3ColWidth=t.newWidth;n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&(n.width=t.newWidth)});n("#visType3Grid").pqGrid("refresh")}function a(){var y=function(n,t,r,u){t.on("remove",function(){n.closest(".pq-td-div").css("padding","");n.closest("td").css("background-color","");r.fadeIn();i.stateTaxa[u.Taxon.value].indexSelected=t.attr("indexSelected");t.is(".userRemoved")&&(i.stateTaxa[u.Taxon.value].displayImages=!1)})},p=function(n){var t=n.attr("taxon"),f=i.oTaxa[t],r,u;return r=i.stateTaxa[t].indexSelected?i.getTaxonImagesDiv(t,null,i.stateTaxa[t].indexSelected):i.getTaxonImagesDiv(t),n.closest(".pq-td-div").css("padding",0),n.closest("td").css("background-color","grey"),n.append(r),u=n.find(".loadImgIcon"),u.fadeOut(0),y(n,r,u,f),i.stateTaxa[t].displayImages=!0,r},a,r,o,f,w,s,e,h,c,l,v;if(n(".vis3ImageDiv").each(function(){var r=n(this),u=n(this).attr("taxon"),e=i.oTaxa[u],f;i.getTaxonImages(u).length>0&&(f=n("<img>").attr("src",t.tombiopath+"resources/camera.png").addClass("loadImgIcon").css("cursor","pointer").css("width",15).on("click",function(){var t=n(this),i=p(r);y(r,i,t,e)}),n(this).append(f),i.stateTaxa[u].displayImages&&p(r))}),a=d3.scaleLinear().domain([-1,0,1]).range(i.scoreColours),r=[],n("#visType3Grid").pqGrid("getColModel").forEach(function(n){n.dataIndx!="group"&&n.dataIndx!="character"&&r.push(n.dataIndx)}),!(r.length<2))for(o=i.oTaxa[r[0]],f=1;f<r.length;f++){w=i.oTaxa[r[f]];for(s in i.oCharacters)e=i.oCharacters[s],h=n("."+e.Character).closest("tr").attr("pq-row-indx"),h!=undefined&&(f==1&&(c=n("#visType3Grid").pqGrid("getCell",{rowIndx:h,dataIndx:r[0]}),e.Status=="key"?o[s].value=="n/a"||o[s].value==""||o[s].value=="?"?c.css("background-color","white"):c.css("background-color",a(1)):e.Status=="display"&&c.css("background-color","silver")),l=n("#visType3Grid").pqGrid("getCell",{rowIndx:h,dataIndx:r[f]}),v=u(o,w,e),e.Status=="display"?l.css("background-color","silver"):v==null?l.css("background-color","white"):l.css("background-color",a(v)))}}var i=this,r,e,o,h,c,s,f;n("#visType3Grid").is(":empty")||n("#visType3Grid").pqGrid("destroy");r=[];e={group:" Images",character:"Images"};this.vis3Taxa.forEach(function(t){var r=i.oTaxa[t],u=n("<div>").attr("taxon",t).css("position","relative").attr("class","vis3ImageDiv");e[r.Taxon]=u[0].outerHTML});r.push(e);this.characters.forEach(function(n){if(n.Status=="display"||n.Status=="key"&&n.Character!="Sex"){var t={group:n.Group,character:n.Label,pq_cellcls:{character:n.Character}};i.vis3Taxa.forEach(function(r){var u=i.oTaxa[r];t[u.Taxon]=u[n.Character].toHtml1()});r.push(t)}});o=[];h=["group"].concat(["character"].concat(this.vis3Taxa));h.forEach(function(n,t){var r,u,f,e;r=t==0?!0:!1;u=t==1?"Character":"<i>"+n+"<\/i>";i.vis3ColWidth||(i.vis3ColWidth=200);i.vis3CharColWidth||(i.vis3CharColWidth=200);f=t==1?i.vis3CharColWidth:i.vis3ColWidth;e={title:u,hidden:r,width:f,dataType:"string",dataIndx:n,sortable:!1};o.push(e)});c=n("input[name=groupvisibility]:checked").val();s=null;c=="visible"&&(s={dataIndx:["group"],collapsed:[!0],title:["<b style='font-weight:bold;'>{0}<\/b>","{0}"],dir:["up","down"]});f={flexHeight:!0,flexWidth:!0,showTop:!1,showBottom:!1,showTitle:!1,numberCell:{show:!1},stripeRows:!0,columnBorders:!0,showHeader:!0,editable:!1,resizable:!1,groupModel:s,selectionModel:{type:null,mode:null},columnResize:function(n,t){l(t)},refresh:function(){a()}};f.colModel=o;f.dataModel={data:r,location:"local"};n("#visType3Grid").pqGrid(f)}})(jQuery,this.tombiovis);