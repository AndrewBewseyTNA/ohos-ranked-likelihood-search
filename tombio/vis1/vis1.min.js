(function(n,t){"use strict";function e(){var e=[],n,r,f;e.push("selectedTool="+u);Array.prototype.push.apply(e,t.f.setParamsFromControls());e.push("imgtips="+i.displayToolTips);n=null;f=[];t.d.taxa.forEach(function(t,u){t.visState.vis1.height>i.taxheight&&(n===null?(n=u,r=u):u===r+1?r=u:(r===n?f.push(n):f.push(n+"-"+r),n=u,r=u))});n!=null&&(r===n?f.push(n):f.push(n+"-"+r));e.push("expand="+f.join(","));t.f.createViewURL(e)}function f(n,r){var f=t.f.getTaxonImages(n.Taxon),u;f.length>0&&(u=new Image,u.onload=function(){d3.select("#vis1Svg").select("#taxon-"+r).select(".taxonimage").attr("xlink:href",this.src).style("z-index",1e3).attr("height",(i.taxwidth-2*i.margin)*u.height/u.width);n.visState.vis1.height=(i.taxwidth-2*i.margin)*u.height/u.width+i.indVoffset+i.margin;i.refresh()},u.src=f[0].URI)}var i,u="vis1",r=t.v.visualisations[u]=Object.create(t.v.visP);r.visName=u;r.initialise=function(){i=this;console.log("vis1 initialising");this.metadata.title="Two-column key";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.1";this.displayToolTips=!0;this.taxheight=35;this.indVoffset=18;this.helpFiles=[t.opts.tombiopath+"vis1/vis1Help.html",t.opts.tombiopath+"common/taxonDetailsHelp.html",t.opts.tombiopath+"common/full-details.html",t.opts.tombiopath+"common/stateInputHelp.html"];this.taxwidth=220;this.margin=4;n("#"+this.visName).append(n("<div>").attr("id","headerTaxa").append(n("<span>").attr("id","candidateTaxa").css("position","absolute").css("width",this.taxwidth).css("left",this.margin).css("font-size","small").text("Evidence balance positive")).append(n("<span>").attr("id","excludedTaxa").css("position","absolute").css("width",this.taxwidth).css("left",this.taxwidth+2*this.margin).css("font-size","small").text("Evidence balance negative")));d3.select("#"+this.visName).append("svg").attr("id","vis1Svg");var f=t.opts.toolconfig[this.visName].keyinput;t.gui.sharedKeyInput[f]||(t.gui.sharedKeyInput[f]=Object.create(t.gui[f]),t.gui.sharedKeyInput[f].init(n(t.gui.main.divInput)));r.inputControl=t.gui.sharedKeyInput[f];this.initialised=!0;t.f.checkInterface(u,t.templates.visTemplate,t.v.visualisations[u])};r.refresh=function(){var v,p,r;console.log("refresh");var u=this.margin,b=30,w=this.indVoffset,g=10,nt=2,tt=13,l=5,c=this.taxwidth,o=this.taxheight,a=250;n("#vis1Svg").css("width",l*3+c*2);n("#candidateTaxa").css("left",l*1);n("#excludedTaxa").css("left",l*2+c);v=d3.select("#vis1Svg").selectAll(".taxon").data(t.d.taxa,function(n){return n.Taxon}).enter().append("g").attr("class","taxon").attr("id",function(n,t){return"taxon-"+t}).style("cursor","pointer").on("click",function(n,t){n.visState.vis1.height==o?f(n,t):(n.visState.vis1.height=o,i.refresh())});v.append("rect").attr("x",0).attr("y",0).attr("class","taxarect").attr("height",o).attr("width",c);v.append("text").attr("x",0).attr("y",0).attr("class","scientificnames").style("opacity",0).style("cursor","pointer").text(function(n){return n.Taxon}).on("click",function(n){d3.event.stopPropagation();t.gui.main.showFullDetails(n.Taxon,0)});for(t.gui.main.createTaxonToolTips(".scientificnames",this.displayToolTips),v.append("svg:image").attr("class","taxonimage").attr("opacity",0).attr("width",c-2*u),r=1;r<=1;r++)v.append("rect").attr("class","indicator").attr("x",0).attr("y",0).attr("width",0).attr("height",0);for(r=1;r<=1;r++)v.append("text").attr("class","indtext").attr("x",0).attr("y",0);t.d.taxa.forEach(function(n){n.visState.vis1.height==undefined&&(n.visState.vis1.height=o)});var y=d3.select("#vis1Svg").selectAll(".taxon"),s=[],h=[];for(t.d.taxa.forEach(function(n){n.visState.score.for>n.visState.score.against?s.push(n):h.push(n)}),t.f.sortTaxa(s,"vis1"),t.f.sortTaxa(h,"vis1"),p=0,r=0;r<s.length;r++)s[r].visState.vis1.x=l,s[r].visState.vis1.y=p+l,p=s[r].visState.vis1.y+s[r].visState.vis1.height;for(p=0,r=0;r<h.length;r++)h[r].visState.vis1.x=c+2*l,h[r].visState.vis1.y=p+l,p=h[r].visState.vis1.y+h[r].visState.vis1.height;y.select(".taxarect").transition().duration(1e3).delay(a).attr("x",function(n){return n.visState.vis1.x}).attr("y",function(n){return n.visState.vis1.y}).attr("height",function(n){return n.visState.vis1.height});y.select(".scientificnames").transition().duration(1e3).delay(a).style("opacity",1).attr("x",function(n){return n.visState.vis1.x+l}).attr("y",function(n){return n.visState.vis1.y+tt});var it=d3.max(t.d.taxa,function(n){return n.visState.score.for}),rt=d3.max(t.d.taxa,function(n){return n.visState.score.against}),ut=d3.max(t.d.taxa,function(n){return n.visState.score.overall}),ft=d3.min(t.d.taxa,function(n){return n.visState.score.overall}),et=d3.scaleLinear().domain([ft,0,ut]).range(t.d.scoreColours),ot=d3.scaleLinear().domain([0,it]).range(t.d.scoreColours.slice(1)),st=d3.scaleLinear().domain([0,rt]).range(t.d.scoreColours.slice(0,1).reverse()),ct=d3.scaleLinear().domain([0,10]).range(t.d.scoreColours.slice(1)),k=[{scale:et,attr:"overall"},{scale:ot,attr:"for"},{scale:st,attr:"against"},],d=["overall","for","against"],ht=["overall score","score for","score against"];y.selectAll(".indicator").transition().duration(1e3).delay(a).attr("fill",function(n,t){return k[t].scale(n.visState.score[k[t].attr])}).attr("x",function(n,t){var i=n.visState.vis1.x+u+t*(u+b);return n.visState.vis1.height==o?i:i+u}).attr("y",function(n){var t=n.visState.vis1.y+w;return n.visState.vis1.height==o?t:t+u}).attr("width",b).attr("height",12).attr("title",function(n,t){return Math.round(n.visState.score[d[t]]*100)/100+" ("+ht[t]+")"});y.selectAll(".indtext").transition().duration(1e3).delay(a).text(function(n,t){return Math.round(n.visState.score[d[t]]*100)/100}).attr("x",function(n,t){var i=n.visState.vis1.x+u+nt+t*(u+b);return n.visState.vis1.height==o?i:i+u}).attr("y",function(n){var t=n.visState.vis1.y+w+g;return n.visState.vis1.height==o?t:t+u});y.selectAll(".taxonImageLink").transition().duration(1e3).delay(a).attr("x",function(n){return n.visState.vis1.x+c-2*u-16}).attr("y",function(n){return n.visState.vis1.y+w+u}).style("opacity",function(n){if(n.visState.vis1.height!=o){var i=t.d.media.filter(function(t){if(t.Taxon==n.Taxon)return!0});return i.length>0?1:0}return 0}).on("end",function(){d3.select(this).style("opacity")==0?d3.select(this).attr("display","none"):d3.select(this).attr("display","")});y.select(".taxonimage").transition().duration(1e3).delay(a).attr("opacity",function(n){return n.visState.vis1.height==o?0:1}).attr("x",function(n){return n.visState.vis1.x+u}).attr("y",function(n){return n.visState.vis1.y+w}).attr("width",c-2*u).on("end",function(n){n.visState.vis1.height==o&&d3.select(this).attr("height",0)});d3.select("#vis1Svg").transition().duration(1e3).delay(a).attr("height",function(){var n,t;return n=h.length==0?0:h[h.length-1].visState.vis1.y+h[h.length-1].visState.vis1.height,t=s.length==0?0:s[s.length-1].visState.vis1.y+s[s.length-1].visState.vis1.height,Math.max(t,n)});t.gui.main.contextMenu.addItem("Get URL for two-column key",function(){e()},!1,[this.visName]);this.displayToolTips?(t.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){n(".ui-tootip").remove();i.displayToolTips=!1;t.gui.main.contextMenu.removeItem("Remove taxon image tooltips");i.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),t.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(t.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0;t.gui.main.contextMenu.removeItem("Display taxon image tooltips");i.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),t.gui.main.contextMenu.removeItem("Remove taxon image tooltips"));t.d.taxa.some(function(n){return n.visState.vis1.height!=o})?t.gui.main.contextMenu.addItem("Contract all taxon items",function(){t.d.taxa.forEach(function(n){n.visState.vis1.height=o});t.gui.main.contextMenu.removeItem("Contract all taxon items");i.refresh()},!1,[this.visName]):t.gui.main.contextMenu.removeItem("Contract all taxon items");t.d.taxa.some(function(n){return n.visState.vis1.height==o&&t.f.getTaxonImages(n.Taxon).length>0})?t.gui.main.contextMenu.addItem("Expand all taxon items",function(){t.d.taxa.forEach(function(n,r){var e=t.f.getTaxonImages(n.Taxon),f;n.visState.vis1.height==o&&e.length>0&&(f=new Image,f.onload=function(){d3.select("#vis1Svg").select("#taxon-"+r).select(".taxonimage").attr("xlink:href",this.src).attr("height",(c-2*u)*f.height/f.width);n.visState.vis1.height=(c-2*u)*f.height/f.width+w+u;i.refresh()},f.src=e[0].URI)});t.gui.main.contextMenu.removeItem("Expand all taxon items")},!1,[this.visName]):t.gui.main.contextMenu.removeItem("Expand all taxon items")};r.urlParams=function(n){n.imgtips&&(i.displayToolTips=n.imgtips==="true");n.expand&&n.expand.split(",").forEach(function(n){var r=n.split("-")[0],u=n.split("-")[1],i;if(u)for(i=Number(r);i<=Number(u);i++)f(t.d.taxa[i],i);else f(t.d.taxa[r],r)});t.f.initControlsFromParams(n)};r.show=function(){n("#vis1").show();n(r.inputControl.divSel).show();r.inputControl.initFromCharacterState()};r.hide=function(){n("#vis1").hide();n(r.inputControl.divSel).hide()}})(jQuery,this.tombiovis.templates.loading?this.tombiovis.templates:this.tombiovis);