(function(n,t){"use strict";function f(){var n,r;console.log("Get the URL");n=[];n.push("selectedTool="+u);t.characters.forEach(function(t){t.userInput&&(t.ControlType==="spin"?n.push(t.Character+"="+t.userInput):n.push(t.Character+"="+t.userInput.join(",")))});r=encodeURI(window.location.href.split("?")[0]+"?"+n.join("&"));i.copyTextToClipboard(r);console.log(r)}var u="vis1",r=t[u]={},i;r.Obj=function(n,t,i){i.visP.Obj.call(this,u,n,t,i);this.metadata.title="Two-column key";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.0"};r.Obj.prototype=Object.create(t.visP.Obj.prototype);r.Obj.prototype.initialise=function(){i=this;this.displayToolTips=!0;this.charStateInput=!0;this.helpFiles=[t.opts.tombiopath+"vis1/vis1Help.html",t.opts.tombiopath+"common/taxonDetailsHelp.html",t.opts.tombiopath+"common/stateInputHelp.html"];this.taxwidth=220;this.margin=4;n("#"+this.visName).append(n("<div>").attr("id","headerTaxa").append(n("<span>").attr("id","candidateTaxa").css("position","absolute").css("left",this.margin).css("font-size","small").text("Evidence balance positive")).append(n("<span>").attr("id","excludedTaxa").css("position","absolute").css("left",this.taxwidth+2*this.margin).css("font-size","small").text("Evidence balance negative")));d3.select("#"+this.visName).append("svg").attr("id","vis1Svg")};r.Obj.prototype.refresh=function(){var r=this.margin,p=30,l=18,k=10,d=2,g=13,h=5,s=this.taxwidth,u=35,c=250,a,y,t;n("#vis1Svg").css("width",h*3+s*2);n("#candidateTaxa").css("left",h*1);n("#excludedTaxa").css("left",h*2+s);a=d3.select("#vis1Svg").selectAll(".taxon").data(this.taxa,function(n){return n.Taxon}).enter().append("g").attr("class","taxon").attr("id",function(n,t){return"taxon-"+t}).style("cursor","pointer").on("click",function(n,t){var e,f;n.height==u?(e=i.getTaxonImages(n.Taxon),e.length>0&&(f=new Image,f.onload=function(){d3.select("#vis1Svg").select("#taxon-"+t).select(".taxonimage").attr("xlink:href",this.src).style("z-index",1e3).attr("height",(s-2*r)*f.height/f.width);n.height=(s-2*r)*f.height/f.width+l+r;i.refresh()},f.src=e[0].URI)):(n.height=u,i.refresh())});a.append("rect").attr("x",0).attr("y",0).attr("class","taxarect").attr("height",u).attr("width",s);a.append("text").attr("x",0).attr("y",0).attr("class","scientificnames").style("opacity",0).style("cursor","pointer").text(function(n){return n.Taxon}).on("click",function(n){d3.event.stopPropagation();i.fullDetails(n.Taxon,0)});for(n(".scientificnames").tooltip({track:!0,items:"text",content:function(){if(i.displayToolTips)return i.getTaxonTipImage(this.textContent)}}),a.append("svg:image").attr("class","taxonimage").attr("opacity",0).attr("width",s-2*r),t=1;t<=1;t++)a.append("rect").attr("class","indicator").attr("x",0).attr("y",0).attr("width",0).attr("height",0);for(t=1;t<=1;t++)a.append("text").attr("class","indtext").attr("x",0).attr("y",0);this.taxa.forEach(function(n){n.height==undefined&&(n.height=u)});var v=d3.select("#vis1Svg").selectAll(".taxon"),e=[],o=[];for(this.taxa.forEach(function(n){n.scorefor>n.scoreagainst?e.push(n):o.push(n)}),this.sortTaxa(e,"lastPosInTaxain"),this.sortTaxa(o,"lastPosInTaxaout"),t=0;t<e.length;t++)e[t].lastPosInTaxain=t,e[t].lastPosInTaxaout=t-100;for(t=0;t<o.length;t++)o[t].lastPosInTaxaout=t,o[t].lastPosInTaxain=100-t;for(y=0,t=0;t<e.length;t++)e[t].x=h,e[t].y=y+h,y=e[t].y+e[t].height;for(y=0,t=0;t<o.length;t++)o[t].x=s+2*h,o[t].y=y+h,y=o[t].y+o[t].height;v.select(".taxarect").transition().duration(1e3).delay(c).attr("x",function(n){return n.x}).attr("y",function(n){return n.y}).attr("height",function(n){return n.height});v.select(".scientificnames").transition().duration(1e3).delay(c).style("opacity",1).attr("x",function(n){return n.x+h}).attr("y",function(n){return n.y+g});var nt=d3.max(this.taxa,function(n){return n.scorefor}),tt=d3.max(this.taxa,function(n){return n.scoreagainst}),it=d3.max(this.taxa,function(n){return n.scoreoverall}),rt=d3.min(this.taxa,function(n){return n.scoreoverall}),ut=d3.scaleLinear().domain([rt,0,it]).range(i.scoreColours),ft=d3.scaleLinear().domain([0,nt]).range(i.scoreColours.slice(1)),et=d3.scaleLinear().domain([0,tt]).range(i.scoreColours.slice(0,1).reverse()),st=d3.scaleLinear().domain([0,10]).range(i.scoreColours.slice(1)),w=[{scale:ut,attr:"scoreoverall"},{scale:ft,attr:"scorefor"},{scale:et,attr:"scoreagainst"},],b=["scoreoverall","scorefor","scoreagainst"],ot=["overall score","score for","score against"];v.selectAll(".indicator").transition().duration(1e3).delay(c).attr("fill",function(n,t){return w[t].scale(n[w[t].attr])}).attr("x",function(n,t){var i=n.x+r+t*(r+p);return n.height==u?i:i+r}).attr("y",function(n){var t=n.y+l;return n.height==u?t:t+r}).attr("width",p).attr("height",12).attr("title",function(n,t){return Math.round(n[b[t]]*100)/100+" ("+ot[t]+")"});v.selectAll(".indtext").transition().duration(1e3).delay(c).text(function(n,t){return Math.round(n[b[t]]*100)/100}).attr("x",function(n,t){var i=n.x+r+d+t*(r+p);return n.height==u?i:i+r}).attr("y",function(n){var t=n.y+l+k;return n.height==u?t:t+r});v.selectAll(".taxonImageLink").transition().duration(1e3).delay(c).attr("x",function(n){return n.x+s-2*r-16}).attr("y",function(n){return n.y+l+r}).style("opacity",function(n){if(n.height!=u){var t=i.media.filter(function(t){if(t.Taxon==n.Taxon)return!0});return t.length>0?1:0}return 0}).on("end",function(){d3.select(this).style("opacity")==0?d3.select(this).attr("display","none"):d3.select(this).attr("display","")});v.select(".taxonimage").transition().duration(1e3).delay(c).attr("opacity",function(n){return n.height==u?0:1}).attr("x",function(n){return n.x+r}).attr("y",function(n){return n.y+l}).attr("width",s-2*r).on("end",function(n){n.height==u&&d3.select(this).attr("height",0)});d3.select("#vis1Svg").transition().duration(1e3).delay(c).attr("height",function(){var n,t;return n=o.length==0?0:o[o.length-1].y+o[o.length-1].height,t=e.length==0?0:e[e.length-1].y+e[e.length-1].height,Math.max(t,n)});this.contextMenu.addItem("Get URL for two-column key",function(){f()},[this.visName]);this.displayToolTips?(this.contextMenu.addItem("Remove taxon image tooltips",function(){n(".ui-tootip").remove();i.displayToolTips=!1;i.contextMenu.removeItem("Remove taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Display taxon image tooltips")):(this.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0;i.contextMenu.removeItem("Display taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Remove taxon image tooltips"));this.taxa.some(function(n){return n.height!=u})?this.contextMenu.addItem("Contract all taxon items",function(){i.taxa.forEach(function(n){n.height=u});i.contextMenu.removeItem("Contract all taxon items");i.refresh()},[this.visName]):this.contextMenu.removeItem("Contract all taxon items");this.taxa.some(function(n){return n.height==u&&i.getTaxonImages(n.Taxon).length>0})?this.contextMenu.addItem("Expand all taxon items",function(){i.taxa.forEach(function(n,t){var e=i.getTaxonImages(n.Taxon),f;n.height==u&&e.length>0&&(f=new Image,f.onload=function(){d3.select("#vis1Svg").select("#taxon-"+t).select(".taxonimage").attr("xlink:href",this.src).attr("height",(s-2*r)*f.height/f.width);n.height=(s-2*r)*f.height/f.width+l+r;i.refresh()},f.src=e[0].URI)});i.contextMenu.removeItem("Expand all taxon items")},[this.visName]):this.contextMenu.removeItem("Expand all taxon items")}})(jQuery,this.tombiovis);