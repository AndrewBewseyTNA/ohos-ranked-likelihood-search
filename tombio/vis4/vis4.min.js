(function(n,t){"use strict";function h(){var n,o,f,s,h;console.log("Get the URL");n=[];n.push("selectedTool="+i);n.push("taxon="+u);var c=document.getElementById("tbVis4Images").checked,l=document.getElementById("tbVis4Kb").checked,a=document.getElementById("tbVis4Text").checked;c&&l&&a||(o=[],c&&o.push("image"),a&&o.push("text"),l&&o.push("kb"),n.push("opts="+o.join("-")));f=r.getFilter();f&&(f.startsWith("#")&&(f="-"+f.substr(1)),n.push("filter="+f));r.taxonSort&&(r.taxonSort=="radio-a"?s="a-z":r.taxonSort=="radio-z"&&(s="z-a"),s&&n.push("sort="+s));r.hiddenControlsShown&&n.push("hc=show");console.log("taxon",">>"+u+"<<");console.log("tbv.oTaxa[selectedTaxon].visState[visName].indexselectedImg",t.oTaxa[u].visState[i].indexselectedImg);t.oTaxa[u].visState[i].indexselectedImg&&(console.log("imgi",t.oTaxa[u].visState[i].indexselectedImg),n.push("imgi="+t.oTaxa[u].visState[i].indexselectedImg));t.oTaxa[u].visState[i].indexselectedText&&n.push("txti="+t.oTaxa[u].visState[i].indexselectedText);h=encodeURI(window.location.href.split("?")[0]+"?"+n.join("&"));e.copyTextToClipboard(h);console.log(h)}function c(n){u=n.selected;s(u)}function s(r){var a,s,b,o,k,c,d,l,p,w;if(f.html(null),r){t.opts.toolconfig&&t.opts.toolconfig.vis4&&t.opts.toolconfig.vis4.subTitleChar&&(b=t.opts.toolconfig.vis4.subTitleChar,a=t.oTaxa[r][b].kbValue);s=a?r+" ("+a+")":r+" ";s=s+"<span id='vis4TaxonHeaderPadding'>x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x<\/span>";n("<div id='vis4TaxonHeader'>").html(s).appendTo(f);var v=document.getElementById("tbVis4Images").checked,y=document.getElementById("tbVis4NbnMap")&&document.getElementById("tbVis4NbnMap").checked,g=document.getElementById("tbVis4Kb").checked,u=document.getElementById("tbVis4Text").checked,h=e.getTaxonHtmlFiles(r);u=u&&h.length>0;v=v&&e.getTaxonImages(r).length>0;y=y&&t.oTaxa[r].TVK;v&&(o=n('<div style="position: relative">').appendTo(f),u?o.attr("class","vis4ImageWithText"):o.attr("class","vis4ImageNoText"),k=t.oTaxa[r].visState[i].indexselectedImg?t.oTaxa[r].visState[i].indexselectedImg:0,e.getTaxonImagesDiv({taxon:r,container:o,indexSelected:k,height:u?400:600,fImageSelect:function(n){t.oTaxa[r].visState[i].indexselectedImg=n}}));y&&(c=n('<div style="position: relative">').appendTo(f),u?c.attr("class","vis4ImageWithText"):c.attr("class","vis4ImageNoText"),e.addNBNMap(t.oTaxa[r].TVK,c));u&&(h.length>1&&(d=n('<div style="margin-bottom: 20px; display: inline">').appendTo(f),l=n("<select id='vis4html'><\/select>").appendTo(d),h.forEach(function(t,i){var r=n("<option/>").text(t.Caption).attr("value",i);l.append(r)}),l.selectmenu({change:function(n,u){e.showTaxonHtmlInfo(r,p,u.item.value);t.oTaxa[r].visState[i].indexselectedText=u.item.value}}).selectmenu("menuWidget")),p=n('<div class="htmlFile">').appendTo(f),w=t.oTaxa[r].visState[i].indexselectedText?t.oTaxa[r].visState[i].indexselectedText:0,e.showTaxonHtmlInfo(r,p,w),h.length>1&&l.val(w).selectmenu("refresh"));g&&(f.append(n("<h2>").css("clear","both").text("Knowledge-base values")),f.append(e.showTaxonCharacterValues(t.oTaxa[r],!0)));o&&n(window).resize(function(){var n=o.find(".baseimage");n.trigger("change")})}}var i="vis4",o=t[i]=Object.create(t.visP),e,r,f,u;o.initialise=function(){function l(i,r,f){if(i!="tbVis4NbnMap"||t.oCharacters.TVK){var e=n('<div style="display: inline-block; vertical-align:top; margin-left: 20px">').appendTo(f);e.append(n("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='"+i+"' id='"+i+"'>"));e.append(n("<span>").text(r));e.change(function(){s(u,!0)})}}var o,i;e=this;this.metadata.title="Full taxon details";this.metadata.authors="Burkmar, R.";this.metadata.year="2016";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.0";this.charStateInput=!1;this.helpFiles=[t.opts.tombiopath+"vis4/vis4Help.html",t.opts.tombiopath+"common/full-details.html",t.opts.tombiopath+"common/taxon-select-help.html"];this.contextMenu.addItem("Get URL for full details view",function(){h()},[this.visName]);o=n("<div>").appendTo(n(this.cssSel));n(this.cssSel).append(o);this.controlsDiv=n("<div/>").css("width",210).css("float","left");o.append(this.controlsDiv);i=n("<div/>").css("display","block").css("overflow","hidden");o.append(i);r=Object.create(t.taxonSelect);r.init(this.controlsDiv,!1,c);l("tbVis4Images","Images",i);l("tbVis4NbnMap","NBN Map",i);l("tbVis4Kb","Knowledge-base",i);l("tbVis4Text","Show text",i);f=n("<div>").css("margin","10px");i.append(f)};o.refresh=function(){n("#vis4taxon").selectmenu("menuWidget").css("height",200)};o.urlParams=function(u){var e,f,o;u.opts&&(e=u.opts.split("-"),n("#tbVis4Text").prop("checked",e.indexOf("text")>-1),n("#tbVis4Images").prop("checked",e.indexOf("image")>-1),n("#tbVis4Kb").prop("checked",e.indexOf("kb")>-1));f=u.taxon?u.taxon.replace(/%20/g," "):"";u.hc&&r.toggleHiddenControls();u.sort&&r.setSort(u.sort);u.imgi&&(t.oTaxa[f].visState[i].indexselectedImg=u.imgi);u.txti&&(t.oTaxa[f].visState[i].indexselectedText=u.txti);f&&r.taxonClick(f);u.filter&&(o=u.filter.startsWith("-")?"#"+u.filter.substr(1):u.filter,console.log("setting filter",o),r.setFilter(o))}})(jQuery,this.tombiovis);