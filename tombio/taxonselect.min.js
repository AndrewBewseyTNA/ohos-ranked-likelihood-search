(function(n,t){"use strict";t.taxonSelect={filterMessage:"Filter names (use # for 'starts with')",gap:4,textHeightOffset:4,taxonHeight:25,taxonWidth:200};t.taxonSelect.init=function(){this.filterText="";this.selectedTaxa=[];this.taxa=[];t.taxa.forEach(function(n,t){this.taxa.push({name:n.Taxon.kbValue,abbrv:"",order:t})},this)};t.taxonSelect.control=function(i,r,u){var o=this,h,c,e,l;this.init();this.isMultiSelect=r;this.hostCallback=u;var s=n('<div class="taxonSelect" />').appendTo(i),a=d3.select(s[0]),f=n('<input type="text"/>').addClass("ui-widget ui-widget-content ui-corner-all");f.css("color","silver").css("padding-left",5).css("width",this.taxonWidth-5).css("height",this.taxonHeight);f.val(this.filterMessage);s.append(f);n("<br>").appendTo(s);f.on("keyup",function(){o.filterText=this.value;o.updateTaxa()});f.on("focus",function(){this.value==o.filterMessage&&(f.val(""),f.css("color","black"))});f.on("blur",function(){this.value==""&&(f.val(o.filterMessage),f.css("color","silver"))});h=n("<div>").css("margin-top",5).css("display","none").appendTo(s);c=n("<img>").attr("src",t.tombiopath+"resources/chevron-down.png").attr("class","taxonSelectHiddenControlsArrow").appendTo(s);c.on("click",function(){h.css("display")=="none"?(h.slideDown(400),c.attr("src",t.tombiopath+"resources/chevron-up.png")):(h.slideUp(400),c.attr("src",t.tombiopath+"resources/chevron-down.png"))});e=n("<div>").appendTo(h);n("<label>").attr("for","radio-x").text("none").appendTo(e);n("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-x").attr("checked","true").appendTo(e);n("<label>").attr("for","radio-a").text("a-z").appendTo(e);n("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-a").appendTo(e);n("<label>").attr("for","radio-z").text("z-a").appendTo(e);n("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-z").appendTo(e);e.find("input").checkboxradio();n("[name=radioSort]").on("change",function(){o.taxonSort=n("[name='radioSort']").filter(":checked").attr("id");o.sortTaxa();o.updateTaxa()});return this.D3svg=a.append("svg"),this.D3svg.attr("width",this.taxonWidth),l=d3.select("body").append("svg"),this.taxa.forEach(function(n){var i=0,t=n.name,u,r;do i>0&&(t=n.name.substr(0,n.name.length-i)+"..."),u=l.append("text").attr("class","taxonSelectScientificnames").style("opacity",0).text(t),r=u.node().getBBox().width,i++;while(r>this.taxonWidth-10);t!=n.name&&(n.abbrv=t)},this),l.remove(),this.updateTaxa(),s};t.taxonSelect.taxonClick=function(n){var i,r=this.D3svg.select('rect[taxonName="'+n+'"]'),s=this.D3svg.select('text[taxonName="'+n+'"]'),t,f,e,u,o;if(r.size()==0){console.log("Couldn't find the taxon:",n);return}t=r.classed("taxonSelectTaxarectSelected");r.classed("taxonSelectTaxarectDeselected",t).classed("taxonSelectTaxarectSelected",!t);s.classed("taxonSelectScientificnamesDeselected",t).classed("taxonSelectScientificnamesSelected",!t);!this.isMultiSelect&&this.selectedTaxon&&this.selectedTaxon!=n&&(f=this.D3svg.select('rect[taxonName="'+this.selectedTaxon+'"]'),e=this.D3svg.select('text[taxonName="'+this.selectedTaxon+'"]'),f.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1),e.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1),i=this.selectedTaxon);t?(this.selectedTaxon=null,i=n):this.selectedTaxon=n;i&&(u=this.selectedTaxa.indexOf(i),u!=-1&&this.selectedTaxa.splice(u,1));this.selectedTaxon&&this.selectedTaxa.push(this.selectedTaxon);o={selected:this.selectedTaxon,deselected:i,taxa:this.selectedTaxa};this.hostCallback&&this.hostCallback(o)};t.taxonSelect.taxonDeselectedExternally=function(n){var i=this.D3svg.select('rect[taxonName="'+n+'"]'),r=this.D3svg.select('text[taxonName="'+n+'"]'),t;i.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1);r.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1);(this.selectedTaxon=n)&&(this.selectedTaxon=null);t=this.selectedTaxa.indexOf(n);t!=-1&&this.selectedTaxa.splice(t,1)};t.taxonSelect.sortTaxa=function(){var n=this;this.taxa.sort(function(t,i){var r,u;return n.taxonSort=="radio-a"?(r=t.name.toUpperCase(),u=i.name.toUpperCase(),r<u)?-1:r>u?1:0:n.taxonSort=="radio-z"?(r=t.name.toUpperCase(),u=i.name.toUpperCase(),r<u)?1:r>u?-1:0:t.order-i.order})};t.taxonSelect.updateTaxa=function(){var t=this,i=300,u=this.D3svg.selectAll("g").data(this.taxa.filter(function(n){if(this.filterText==""||this.filterText.toLowerCase()==this.filterMessage.toLowerCase()||this.filterText=="#"||this.filterText.startsWith("#")&&n.name.toLowerCase().startsWith(this.filterText.toLowerCase().substr(1))||n.name.toLowerCase().indexOf(this.filterText.toLowerCase())!==-1)return!0;for(var t=0;t<this.selectedTaxa.length;t++)if(this.selectedTaxa[t]==n.name)return!0;return!1},this),function(n){return n.name}),s=u.enter(),f=s.append("g"),e=f.merge(u),r=u.exit(),o;f.append("rect").style("opacity",0).attr("x",0).attr("width",this.taxonWidth).attr("height",this.taxonHeight).classed("taxonSelectTaxarect",!0).classed("taxonSelectTaxarectDeselected",!0).attr("taxonName",function(n){return n.name}).on("click",function(n){t.taxonClick(n.name)});f.append("text").style("opacity",0).attr("x",5).classed("taxonSelectScientificnames",!0).classed("taxonSelectScientificnamesDeselected",!0).classed("abbrvName",function(n){return n.abbrv?!0:!1}).attr("taxonName",function(n){return n.name}).text(function(n){return n.abbrv?n.abbrv:n.name}).attr("title",function(n){return n.abbrv?n.name:""}).on("click",function(n){t.taxonClick(n.name)});e.select(".taxonSelectTaxarect").transition().duration(i).delay(function(){return r.empty()?0:i}).attr("y",function(n,i){return i*(t.taxonHeight+t.gap)+t.gap}).transition().style("opacity",1);e.select(".taxonSelectScientificnames").transition().duration(i).delay(function(){return r.empty()?0:i}).attr("y",function(n,i){return i*(t.taxonHeight+t.gap)+t.taxonHeight/2+t.textHeightOffset+t.gap}).transition().style("opacity",1);r.transition().duration(i).style("opacity",0).remove();n(".abbrvName").tooltip({classes:{"ui-tooltip":"ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(t,i){setTimeout(function(){n(i.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return n(this).attr("title")}});o=e._groups[0].length*(this.taxonHeight+this.gap);this.D3svg.transition().delay(function(){return r.empty()?0:i}).attr("height",o)}})(jQuery,this.tombiovis);