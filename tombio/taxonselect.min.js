(function(n,t){"use strict";t.gui.taxonSelect={hiddenControlsShown:!1,taxonSort:null,width:225,filterMessage:"Filter names (use # for 'starts with')",filterSelectedOnly:"Show only selected taxa",gap:6,textHeightOffset:4,taxonHeight:30,taxonWidth:200};t.gui.taxonSelect.init=function(i,r,u){var f=this,s,a,e,h,c,o,l;this.isMultiSelect=r;this.hostCallback=u;this.filterText="";this.selectedTaxa=[];this.taxa=[];t.d.taxa.forEach(function(n,t){this.taxa.push({name:n.Taxon.kbValue,abbrv:"",order:t})},this);s=n('<div class="taxonSelect" />').css("width",this.taxonWidth).appendTo(i);a=d3.select(s[0]);this.$div=s;e=n('<input type="text"/>').addClass("ui-widget ui-widget-content ui-corner-all");e.css("color","silver").css("padding-left",5).css("width",this.taxonWidth-5).css("height",this.taxonHeight);e.val(this.filterMessage);s.append(e);n("<br>").appendTo(s);e.on("keyup",function(){f.setFilter(this.value)});e.on("focus",function(){(this.value==f.filterMessage||this.value==f.filterSelectedOnly)&&(f.setFilter(""),f.checkFilterColour())});e.on("blur",function(){f.checkEmptyFilter();f.checkFilterColour()});h=n("<div>").css("margin-top",5).css("display","none").appendTo(s);c=n("<img>").attr("src",t.opts.tombiopath+"resources/chevron-down.png").attr("class","taxonSelectHiddenControlsArrow").appendTo(s);c.on("click",function(){f.toggleHiddenControls()});o=n("<div>").appendTo(h);n("<label>").attr("for","radio-x").text("none").appendTo(o);n("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-x").attr("checked","true").appendTo(o);n("<label>").attr("for","radio-a").text("a-z").appendTo(o);n("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-a").appendTo(o);n("<label>").attr("for","radio-z").text("z-a").appendTo(o);n("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-z").appendTo(o);o.find("input").checkboxradio();n("[name=radioSort]").on("change",function(){f.taxonSort=n("[name='radioSort']").filter(":checked").attr("id");f.sortTaxa();f.updateTaxa()});n("<button>").text("Clear filter").css("margin-top",5).css("width","100%").appendTo(h).button().on("click",function(){f.setFilter("");f.checkEmptyFilter();f.checkFilterColour()});n("<button>").text("Clear selection").css("margin-top",5).css("width","100%").appendTo(h).button().on("click",function(){var t=f.selectedTaxon,n;f.deselectAllTaxa();n={selected:f.selectedTaxon,deselected:t,taxa:f.selectedTaxa};f.hostCallback&&f.hostCallback(n)});n("<button>").text("Show only selected taxa").css("margin-top",5).css("width","100%").appendTo(h).button().on("click",function(){f.setFilter(f.filterSelectedOnly);f.checkFilterColour()});this.D3svg=a.append("svg");this.D3svg.attr("width",this.taxonWidth);l=d3.select("body").append("svg");this.taxa.forEach(function(n){var i=0,t=n.name,u,r;do i>0&&(t=n.name.substr(0,n.name.length-i)+"..."),u=l.append("text").attr("class","taxonSelectScientificnames").style("opacity",0).text(t),r=u.node().getBBox().width,i++;while(r>this.taxonWidth-10);t!=n.name&&(n.abbrv=t)},this);l.remove();this.updateTaxa();this.$textFilter=e;this.$hiddenControlsDiv=h;this.$controlsArrow=c};t.gui.taxonSelect.setFilter=function(n){this.filterText=n;this.$textFilter.val(n);this.checkFilterColour();this.updateTaxa()};t.gui.taxonSelect.getFilter=function(){return this.filterText!=this.filterMessage?this.filterText:null};t.gui.taxonSelect.setSort=function(t){t=="a-z"&&(t="radio-a",n("#radio-a").attr("checked","true"),n("[name=radioSort]").checkboxradio("refresh"));t=="z-a"&&(t="radio-z",n("#radio-z").attr("checked","true"),n("[name=radioSort]").checkboxradio("refresh"));t=="none"&&(t="radio-x",n("#radio-x").attr("checked","true"),n("[name=radioSort]").checkboxradio("refresh"));this.taxonSort=t;this.sortTaxa();this.updateTaxa()};t.gui.taxonSelect.toggleHiddenControls=function(){this.$hiddenControlsDiv.css("display")=="none"?(this.$hiddenControlsDiv.slideDown(400),this.$controlsArrow.attr("src",t.opts.tombiopath+"resources/chevron-up.png"),this.hiddenControlsShown=!0):(this.$hiddenControlsDiv.slideUp(400),this.$controlsArrow.attr("src",t.opts.tombiopath+"resources/chevron-down.png"),this.hiddenControlsShown=!1)};t.gui.taxonSelect.taxonClick=function(n){var i,r=this.D3svg.select('rect[taxonName="'+n+'"]'),s=this.D3svg.select('text[taxonName="'+n+'"]'),t,f,e,u,o;if(r.size()==0){console.log("Couldn't find the taxon:",n);return}t=r.classed("taxonSelectTaxarectSelected");r.classed("taxonSelectTaxarectDeselected",t).classed("taxonSelectTaxarectSelected",!t);s.classed("taxonSelectScientificnamesDeselected",t).classed("taxonSelectScientificnamesSelected",!t);!this.isMultiSelect&&this.selectedTaxon&&this.selectedTaxon!=n&&(f=this.D3svg.select('rect[taxonName="'+this.selectedTaxon+'"]'),e=this.D3svg.select('text[taxonName="'+this.selectedTaxon+'"]'),f.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1),e.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1),i=this.selectedTaxon);t?(this.selectedTaxon=null,i=n):this.selectedTaxon=n;i&&(u=this.selectedTaxa.indexOf(i),u!=-1&&this.selectedTaxa.splice(u,1));this.selectedTaxon&&this.selectedTaxa.push(this.selectedTaxon);o={selected:this.selectedTaxon,deselected:i,taxa:this.selectedTaxa};this.hostCallback&&this.hostCallback(o)};t.gui.taxonSelect.deselectAllTaxa=function(){var n=this.D3svg.selectAll("rect"),t=this.D3svg.selectAll("text");n.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1);t.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1);this.selectedTaxon=null;this.selectedTaxa=[];this.updateTaxa()};t.gui.taxonSelect.deselectTaxon=function(n){var i=this.D3svg.select('rect[taxonName="'+n+'"]'),r=this.D3svg.select('text[taxonName="'+n+'"]'),t;i.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1);r.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1);(this.selectedTaxon=n)&&(this.selectedTaxon=null);t=this.selectedTaxa.indexOf(n);t!=-1&&this.selectedTaxa.splice(t,1)};t.gui.taxonSelect.setParamsFromState=function(n){var t=this.getFilter(),i;return t&&(t.startsWith("#")&&(t="-"+t.substr(1)),n.push("filter="+t)),this.taxonSort&&(this.taxonSort=="radio-a"?i="a-z":this.taxonSort=="radio-z"&&(i="z-a"),i&&n.push("sort="+i)),this.hiddenControlsShown&&n.push("hc=show"),n};t.gui.taxonSelect.initStateFromParams=function(n){var t;n.hc&&this.toggleHiddenControls();n.sort&&this.setSort(n.sort);n.filter&&(t=n.filter.startsWith("-")?"#"+n.filter.substr(1):n.filter,this.setFilter(t))};t.gui.taxonSelect.sortTaxa=function(){var n=this;this.taxa.sort(function(t,i){var r,u;return n.taxonSort=="radio-a"?(r=t.name.toUpperCase(),u=i.name.toUpperCase(),r<u)?-1:r>u?1:0:n.taxonSort=="radio-z"?(r=t.name.toUpperCase(),u=i.name.toUpperCase(),r<u)?1:r>u?-1:0:t.order-i.order})};t.gui.taxonSelect.updateTaxa=function(){var i=this,r=300,f=this.D3svg.selectAll("g").data(this.taxa.filter(function(n){if(this.filterText==""||this.filterText.toLowerCase()==this.filterMessage.toLowerCase()||this.filterText=="#"||this.filterText.startsWith("#")&&n.name.toLowerCase().startsWith(this.filterText.toLowerCase().substr(1))||n.name.toLowerCase().indexOf(this.filterText.toLowerCase())!==-1)return!0;for(var t=0;t<this.selectedTaxa.length;t++)if(this.selectedTaxa[t]==n.name)return!0;return!1},this),function(n){return n.name}),h=f.enter(),e=h.append("g"),o=e.merge(f),u=f.exit(),s;e.append("rect").style("opacity",0).attr("x",0).attr("width",this.taxonWidth).attr("height",this.taxonHeight).classed("taxonSelectTaxarect",!0).classed("taxonSelectTaxarectDeselected",!0).attr("taxonName",function(n){return n.name}).on("click",function(n){i.taxonClick(n.name)});e.append("text").style("opacity",0).attr("x",5).classed("taxonSelectScientificnames",!0).classed("taxonSelectScientificnamesDeselected",!0).classed("abbrvName",function(n){return n.abbrv?!0:!1}).attr("taxonName",function(n){return n.name}).text(function(n){return n.abbrv?n.abbrv:n.name}).attr("title",function(n){return n.abbrv?n.name:""}).on("click",function(n){i.taxonClick(n.name)});o.select(".taxonSelectTaxarect").transition().duration(r).delay(function(){return u.empty()?0:r}).attr("y",function(n,t){return t*(i.taxonHeight+i.gap)+i.gap}).transition().style("opacity",1);o.select(".taxonSelectScientificnames").transition().duration(r).delay(function(){return u.empty()?0:r}).attr("y",function(n,t){return t*(i.taxonHeight+i.gap)+i.taxonHeight/2+i.textHeightOffset+i.gap}).transition().style("opacity",1);u.transition().duration(r).style("opacity",0).remove();n(".abbrvName").tooltip({classes:{"ui-tooltip":"ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(t,i){setTimeout(function(){n(i.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return n(this).attr("title")}});s=o._groups[0].length*(this.taxonHeight+this.gap);this.D3svg.transition().delay(function(){return u.empty()?0:r}).attr("height",s).on("end",function(){t.gui.main.resizeControlsAndTaxa()})};t.gui.taxonSelect.checkEmptyFilter=function(){this.filterText==""&&(this.filterText=this.filterMessage,this.$textFilter.val(this.filterMessage))};t.gui.taxonSelect.checkFilterColour=function(){this.filterText==this.filterMessage||this.filterText==this.filterSelectedOnly?this.$textFilter.css("color","silver"):this.$textFilter.css("color","black")}})(jQuery,this.tombiovis);