(function(n,t){"use strict";function u(){function p(){var h,s,f;n("#headerTaxaW").css("width",i.taxspace*3+i.taxwidth*2);n("#candidateTaxaW").css("left",i.taxspace*1);n("#excludedTaxaW").css("left",i.taxspace*2+i.taxwidth);n("#confidenceLevelButton").click(function(){n("#tombioConfidenceDialog").dialog("open")});n("#tombioConfidenceDialog").dialog({title:"Identification confidence",autoOpen:!1,modal:!0,width:410,height:450,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}});n("#tombioOptionsDialog").dialog({title:"Options",autoOpen:!1,modal:!0,width:410,height:200,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}});n("#tombioConfidenceDialogContent").focus();n("#tombioResetW").button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(){n("#headtype").val("").selectmenu("refresh");n("#setaespacing").val("").selectmenu("refresh");n("#colourby").val("").selectmenu("refresh");n("#malepore").spinner("value","");n("#clitstart").spinner("value","");n("#clitend").spinner("value","");n("#tpstart").spinner("value","");n("#tpend").spinner("value","");n("#bodylength").spinner("value","");n("#bodydiameter").spinner("value","");n("#clitwidth").spinner("value","");c(0);r()});n(".resetImage").attr("src",t.opts.tombiopath+"/visEarthworm/resources/reset2.png");n("#tombioOptions").button({icons:{primary:null,secondary:"ui-icon-options"},disabled:!1}).click(function(){n("#tombioOptionsDialog").dialog("open")});u("malepore",0,40,1);u("clitstart",0,40,1);u("clitend",0,40,1);u("tpstart",0,40,1);u("tpend",0,40,1);u("bodylength",0,350,1);u("bodydiameter",0,10,.1);u("clitwidth",0,13,1);l("headtype");l("setaespacing");h=n("#tolerance").spinner({min:0,max:5,step:1}).on("spinchange",r).on("spinstop",r);n("#colourby").selectmenu().on("selectmenuchange",function(){c(1e3)});n("#colourbyReset").click(function(){n("#colourby").val("").selectmenu("refresh");c(100)});n("#tombioPopup").dialog({autoOpen:!1,width:410,height:610,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}});n("#tombioPopup").parent().find(".ui-dialog-title").css("font-style","italic");n("#tombioPopupTabs").tabs();n("#tombioMapBack").selectmenu().on("selectmenuchange",o);n("#tombioMapData").selectmenu().on("selectmenuchange",o);for(n("#tombioHelpDialog").dialog({title:"Morphological features",width:600,height:470,autoOpen:!1,modal:!0,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}}),n("#tombioHelpTabs").tabs(),t.taxa.forEach(function(n){n.visEarthworm={}}),i.worms=d3.select("#multiaccess").selectAll(".worm").data(t.taxa).enter().append("g").attr("class","worm").on("click",function(n){n.visEarthworm.height=n.visEarthworm.height==i.taxheight?i.taxexpanded:i.taxheight;r()}),i.worms.append("rect").attr("x",0).attr("y",0).attr("rx",5).attr("ry",5).attr("height",i.taxheight).attr("width",i.taxwidth),i.worms.append("text").attr("x",0).attr("y",0).attr("class","scientificnames").style("opacity",0).text(function(n){return n.Taxon.kbValue}),f=0;f<e.length;f++)i.worms.append("text").attr("x",0).attr("y",0).attr("class","charactervalue").style("opacity",0).text(function(n){var t=String(n[e[f].kbname].kbValue);return e[f].label+": "+t.replace("[","").replace("]","").replace(" |",",").replace("|",",")});i.worms.append("image").attr("x",0).attr("y",0).attr("width",i.imagedim).attr("height",i.imagedim).style("opacity",0).attr("xlink:href",t.opts.tombiopath+"/visEarthworm/resources/info20.png").attr("class","infoimage").attr("id",function(n,t){return"infoimage-"+t}).on("click",function(t){n(this).css("opacity")>0&&(d3.event.stopPropagation(),n("#tombioPopup").dialog("open"),n("#tombioPopupTitleText").html(t.Taxon.kbValue),n("#tombioInfoSpName").html(t.Taxon.kbValue),n("#tombioInfoSpAccount").html(t.AccountPage.kbValue),n("#tombioInfoSpTable").html(t.TablePage.kbValue),n("#tombioPopup").dialog("option","title",t.Taxon.kbValue),i.tvk=t.TVK.kbValue,o())});for(f=1;f<=10;f++)s=i.worms.append("g").attr("class","indg"),s.append("circle").attr("class","indicator"+f).attr("cx",0).attr("cy",0).attr("r",function(){return f<3?i.indrad:f<9?i.indrad*.8:i.indrad*.6}),s.append("text").attr("class","indText");for(d3.select("#multiaccess").attr("width",i.taxwidth*2+i.taxspace*3),d3.select("#legend").attr("width",130),f=0;f<t.taxa.length;f++)t.taxa[f].visEarthworm.height=i.taxheight;n(".morphoLabel").hover(function(){n(this).animate({color:"#D55E00"},"fast")},function(){n(this).animate({color:"black"},"fast")}).click(function(){var t=n('#tombioHelpTabs a[href="#tombioHelpTab-'+n(this).attr("morphoKey")+'"]').parent().index();n("#tombioHelpTabs").tabs("option","active",t);n("#tombioHelpDialog").dialog("open")});n("#tolerance").spinner("value",2);r()}function l(t){n("#"+t).selectmenu().on("selectmenuchange",r);n("#"+t+"Reset").click(function(){n("#"+t).val("").selectmenu("refresh");r()})}function u(t,i,u,f){var e=n("#"+t).spinner({min:i,max:u,step:f});e.on("spinchange",r).on("spinstop",r);e.on("spin",function(n,t){if(t.value==e.spinner("option","min"))return e.spinner("value",""),!1});n("#"+t+"Reset").click(function(){n("#"+t).val("").spinner("value","");r()})}function o(){var r=n("#tombioMapBack").val(),t=n("#tombioMapData").val();t=="esb"&&(alert("Earthworm Society of Britain (ESB) verified data will be accessible via NBN soon! For now, all currently available datasets will be displayed instead."),n("#tombioMapData").val("all"),n("#tombioMapData").selectmenu("refresh"),t="");t=="all"&&(t="");n("#tombioMapDiv").html("<img id='tombioPopupMap' src='https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+i.tvk+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100' width='100%'/>");d3.select("#tombioMapDiv").style("width","400px")}function s(n,t,i){var r=i.replace("[","").replace("]","").replace(/,/g,"").replace(/ /g,""),u=d3.select("#multiaccess").append("linearGradient").attr("id",r);return u.append("stop").attr("offset","0%").attr("stop-color",n),u.append("stop").attr("offset","100%").attr("stop-color",t),r}function h(n){var i=[],u,f,r,e,t;if(n.indexOf("[")===0)for(u=n.substr(1,n.length-2),f=n.indexOf("-")>-1?"-":",",r=u.split(f),t=0;t<r.length;t++)i.push(r[t].trim());else n.indexOf("|")>0?(e=n.split("|"),i=e.map(function(n){return n.trim()})):i.push(n);for(t=0;t<i.length;t++)n.indexOf("-")>-1&&(i[t]=Number(i[t]));return i}function f(n,t){var i,r;if(n==""||String(t)=="")return null;if(String(t)=="n/a")return n;if(String(t).indexOf("[")===0)var f=t.substr(1,t.length-2),u=f.split("-"),i=Number(u[0]),r=Number(u[1]);else i=Number(t),r=Number(t);return n<i?i-n:n>r?n-r:0}function a(n,t){var i,r;if(n==""||String(t)=="")return null;if(String(t).indexOf("[")===0)var f=t.substr(1,t.length-2),u=f.split("-"),i=Number(u[0]),r=Number(u[1]);else i=Number(t),r=Number(t);return n<i?(i-n)/n<1?(i-n)/n:.48:n>r?(n-r)/n<1?(n-r)/n:.48:0}function v(n,t){return n.sort(function(n,i){var r=n.visEarthworm.matcharray.reduce(y,0),u=i.visEarthworm.matcharray.reduce(y,0);return u>r?-1:r>u?1:u==r?n.visEarthworm[t]>i.visEarthworm[t]?1:-1:void 0})}function w(n,t){return t>=1&&t<100&&t>n?t:n}function b(n,t){return t>=1&&t<100?n+t:n}function y(n,t){return n+t}function r(){var u,s,et,h,r,y;i.tolerance=n("#tolerance").spinner("value");var o=[],e=[],tt=n("#headtype").val(),it=n("#setaespacing").val(),rt=Number(n("#malepore").val()),c=Number(n("#clitstart").val()),l=Number(n("#clitend").val()),p=Number(n("#clitwidth").val()),g=Number(n("#tpstart").val()),nt=Number(n("#tpend").val()),ut=Number(n("#bodylength").val()),ft=Number(n("#bodydiameter").val());for(r=0;r<t.taxa.length;r++)u=t.taxa[r],u.visEarthworm.matcharray=[null,null,null,null,null,null,null,null,null,null],u.HeadShape.kbValue==tt?u.visEarthworm.matcharray[0]=0:tt!=""&&(u.visEarthworm.matcharray[0]=100),u.SetaeSpacing.kbValue==it?u.visEarthworm.matcharray[1]=0:it!=""&&(u.visEarthworm.matcharray[1]=100),u.visEarthworm.matcharray[2]=f(rt,u.MalePore.kbValue),u.visEarthworm.matcharray[3]=f(c,u.CliStart.kbValue),u.visEarthworm.matcharray[4]=f(l,u.CliEnd.kbValue),u.visEarthworm.matcharray[5]=f(p,u.CliWidth.kbValue),u.visEarthworm.matcharray[6]=f(g,u.TPStart.kbValue),u.visEarthworm.matcharray[7]=f(nt,u.TPEnd.kbValue),u.visEarthworm.matcharray[8]=a(ut,u.Length.kbValue),u.visEarthworm.matcharray[9]=a(ft,u.Diameter.kbValue),u.visEarthworm.matcharray[0]+u.visEarthworm.matcharray[1]>0?e.push(u):u.visEarthworm.matcharray.reduce(w,0)>i.tolerance?e.push(u):o.push(u);for(s=0,tt!=""&&s++,it!=""&&s++,rt>0&&s++,c>0&&s++,l>0&&s++,p>0&&s++,g>0&&s++,nt>0&&s++,ut>0&&s++,ft>0&&s++,et=d3.scaleLinear().domain([0,5,10]).range(["#D55E00","#F0E442","#0072B2"]),n(".confidenceLevel").css("background",et(s)),s==0?n(".confidenceLevel").css("display","none"):n(".confidenceLevel").css("display","inline-block"),n("#charCount").text(s),h=!1,p!=""&&c!=""&&l!=""&&p!=l-c+1&&(h=!0),h?n("#clitwidth").css("color","#D55E00"):n("#clitwidth").css("color","black"),h=!1,c!=""&&l!=""&&l<=c&&(h=!0),h?n("#clitend").css("color","#D55E00"):n("#clitend").css("color","black"),h=!1,g!=""&&nt!=""&&nt<=g&&(h=!0),h?n("#tpend").css("color","#D55E00"):n("#tpend").css("color","black"),v(o,"visEarthworm.lastPosInTaxain"),v(e,"visEarthworm.lastPosInTaxaout"),r=0;r<o.length;r++)o[r].visEarthworm.lastPosInTaxain=r,o[r].visEarthworm.lastPosInTaxaout=r-100;for(r=0;r<e.length;r++)e[r].visEarthworm.lastPosInTaxaout=r,e[r].visEarthworm.lastPosInTaxain=100+r;for(y=0,r=0;r<o.length;r++)o[r].visEarthworm.x=i.taxspace,o[r].visEarthworm.y=y+i.taxspace,y=o[r].visEarthworm.y+o[r].visEarthworm.height;for(y=0,r=0;r<e.length;r++)e[r].visEarthworm.x=i.taxwidth+2*i.taxspace,e[r].visEarthworm.y=y+i.taxspace,y=e[r].visEarthworm.y+e[r].visEarthworm.height;i.worms.select("rect").transition().duration(1e3).delay(i.delay).attr("x",function(n){return n.visEarthworm.x}).attr("y",function(n){return n.visEarthworm.y}).attr("height",function(n){return n.visEarthworm.height});i.worms.select(".scientificnames").transition().duration(1e3).delay(i.delay).style("opacity",1).attr("x",function(n){return n.visEarthworm.x+i.taxspace}).attr("y",function(n){return 1+n.visEarthworm.y+i.taxheight/2-2});i.worms.select("text").text(function(n){return n.Taxon.kbValue+" - "}).append("tspan").style("font-style","normal").style("font-weight","bold").style("font-size","0.9em").style("color","red").text(function(n){return n.visEarthworm.matcharray.reduce(b,0)});i.worms.selectAll(".charactervalue").transition().duration(1e3).delay(i.delay).style("opacity",function(n){return n.visEarthworm.height==i.taxheight?0:1}).attr("x",function(n){return n.visEarthworm.x+2*(i.taxspace+i.indrad)}).attr("y",function(n,t){return n.visEarthworm.y+i.taxheight+i.indrad-1+t*2*(i.indrad+i.taxspace)});i.worms.selectAll(".infoimage").transition().duration(1e3).delay(i.delay).style("opacity",function(n){return n.visEarthworm.height==i.taxheight?0:1}).attr("x",function(n){return n.visEarthworm.x+i.taxwidth-i.imagedim-3}).attr("y",function(n){return n.visEarthworm.y+i.imagedim/2-2});var st=d3.scaleLinear().domain([0,100]).range(["#0072B2","#D55E00"]),ot=d3.scaleLinear().domain([0,i.tolerance+1]).range(["#0072B2","#D55E00"]),ht=d3.scaleLinear().domain([0,.48]).range(["#0072B2","#D55E00"]);i.worms.selectAll("circle").on("mouseover",k).on("mouseout",d).transition().duration(1e3).delay(i.delay).attr("cx",function(n,t,r){if(n.visEarthworm.height==i.taxheight){if(t<2)var f=n.visEarthworm.x,r=t,u=1;else if(t<8)var f=n.visEarthworm.x+2*(2*i.indrad+i.taxspace),r=t-2,u=.8;else var f=n.visEarthworm.x+2*(2*i.indrad+i.taxspace)+6*(1.6*i.indrad+i.taxspace),r=t-8,u=.6;return f+i.taxspace+u*i.indrad+r*(2*u*i.indrad+i.taxspace)}return n.visEarthworm.x+i.taxspace+i.indrad}).attr("cy",function(n,t){return n.visEarthworm.height==i.taxheight?n.visEarthworm.y+i.taxheight-i.indrad-2:n.visEarthworm.y+i.taxheight+t*2*(i.indrad+i.taxspace)}).style("fill",function(n,t){return n.visEarthworm.matcharray[t]!=null?t<2?st(n.visEarthworm.matcharray[t]):t<8?n.visEarthworm.matcharray[t]>i.tolerance+1?ot(i.tolerance+1):ot(n.visEarthworm.matcharray[t]):n.visEarthworm.matcharray[t]>1?1:ht(n.visEarthworm.matcharray[t]):"white"});i.worms.selectAll(".indText").text(function(n,t){return n.visEarthworm.matcharray[t]!=null?t>1&&t<8?n.visEarthworm.matcharray[t]:"":""});d3.select("#multiaccess").transition().duration(1e3).delay(i.delay).attr("height",function(){var n,t;return n=e.length==0?0:e[e.length-1].visEarthworm.y+e[e.length-1].visEarthworm.height,t=o.length==0?0:o[o.length-1].visEarthworm.y+o[o.length-1].visEarthworm.height,Math.max(t,n)})}function k(n,t){var r=d3.select(this),u=d3.select(this.parentNode).select("text");u.style("opacity","1").attr("x",Number(r.attr("cx"))).attr("y",Number(r.attr("cy"))+4);r.attr("oR",r.attr("r"));r.attr("r",function(){return n.visEarthworm.matcharray[t]!=null?t>1&&t<8?Number(r.attr("r"))+i.taxspace:Number(Number(r.attr("r"))):Number(Number(r.attr("r")))}).attr("cursor",function(){return n.visEarthworm.matcharray[t]!=null?t>1&&t<8?"none":"auto":"auto"})}function d(){var n=d3.select(this),t=d3.select(this.parentNode).select("text");n.attr("r",Number(n.attr("oR")));t.style("opacity","0")}function g(n,t){return t.indexOf(n)>-1}function c(r){var u=n("#colourby").val(),ut=[],w=[],ft,b,a,d,nt,v,tt,it,c,l,y,e,p,f,o,k,rt;if(u!="")for(f=0;f<t.taxa.length;f++)for(ft=t.taxa[f][u].kbValue,b=h(ft),a=0;a<b.length;a++)g(b[a],w)||(w.push(b[a]),o={},o.colval=b[a],ut.push(o));if(d="",nt="",u=="Length"||u=="Diameter"){for(c=1e3,l=0,f=0;f<t.taxa.length;f++)v=h(t.taxa[f][u].kbValue),v!=""&&(tt=v[0],tt<c&&(c=tt),it=v.length>1?v[1]:v[0],it>l&&(l=it));e=u=="Length"?d3.scaleLinear().domain([Math.log(c),Math.log(l)]).range(["yellow","blue"]):d3.scaleLinear().domain([c,l]).range(["yellow","blue"]);d="url(#"+s("yellow","blue",c+"-"+l)+")";nt=c+"-"+l+" mm"}else u=="TPShape"?(y=["3 mounds","2 mounds","2 humps","3 discs","2 discs","Band","Raised band","Thick band","Thin band","Thin bands","Long, thin band","Ridge","Thin ridge","Raised area","Swelling","None",""],e=d3.scaleOrdinal().domain(y).range(["#006BB2","#2379AF","#4585AD","#FF7700","#FF9232","#009E00","#0F9B0F","#1E991E","#2D992D","#3D993D","#4C994C","#D30003","#D1292C","#6100BC","#6F25BA","yellow","lightgrey"])):u=="Colour"?(y=["Pale","Pink","Pinky grey","Red","Dull red","Green","Grey","Blue grey","Phosphorescent","Almost black",""],e=d3.scaleOrdinal().domain(y).range(["#FFF996","#FF56F9","#CC7EA0","#FF0000","#CC3B3B","#43A31A","#999999","#4C6B99","#4CFFA7","#000000","lightgrey"])):e=w.length<=10?d3.scaleOrdinal(d3.schemeCategory10).domain(w):d3.scaleOrdinal(d3.schemeCategory20).domain(w);if(i.worms.select("rect").transition().duration(r).attr("fill",function(n){if(u!=""){if(n[u]=="")return"lightgrey";var t=h(n[u].kbValue);return t.length==1?u=="Length)"?e(Math.log(t[0])):e(t[0]):u=="Length"?"url(#"+s(e(Math.log(t[0])),e(Math.log(t[1])),n[u].kbValue)+")":"url(#"+s(e(t[0]),e(t[1]),n[u].kbValue)+")"}return"lightgrey"}),d3.select("#legend").selectAll(".legenditem").remove(),u=="Length"||u=="Diameter")p=[],o={},o.colval=d,p.push(o),k=d3.select("#legend").selectAll(".legenditem").data(p);else if(u=="Colour"||u=="TPShape"){for(p=[],f=0;f<y.length;f++)o={},o.colval=y[f],p.push(o);k=d3.select("#legend").selectAll(".legenditem").data(p)}else k=d3.select("#legend").selectAll(".legenditem").data(ut);rt=k.enter().append("g").attr("class","legenditem");rt.append("rect").attr("x",0).attr("y",function(n,t){return i.taxspace+t*(i.taxheight+i.taxspace)}).attr("rx",5).attr("ry",5).attr("height",i.taxheight).attr("width",130).attr("fill",function(n){return n.colval==""?"lightgrey":n.colval.substr(0,5)=="url(#"?n.colval:e(n.colval)});rt.append("text").attr("class","legend").attr("x",i.taxspace).attr("y",function(n,t){return i.taxspace+t*(i.taxheight+i.taxspace)+i.taxheight*2/3}).text(function(n){return n.colval.substr(0,5)=="url(#"?nt:n.colval});d3.select("#legend").attr("height",i.taxspace+(d3.select("#legend").selectAll(".legenditem").size()+1)*(i.taxheight+i.taxspace))}var i={data:{},worms:{},infowidth:640,taxwidth:205,taxheight:32,taxexpanded:353,imagedim:12,taxspace:5,indrad:6,tvk:0,delay:450,tolerance:null},e=[{kbname:"HeadShape",label:"Head shape"},{kbname:"SetaeSpacing",label:"Setae spacing"},{kbname:"MalePore",label:"Male pore"},{kbname:"CliStart",label:"Clitellum start"},{kbname:"CliEnd",label:"Clitellum end"},{kbname:"CliWidth",label:"Clitellum length"},{kbname:"TPStart",label:"TP start"},{kbname:"TPEnd",label:"TP end"},{kbname:"Length",label:"Length"},{kbname:"Diameter",label:"Diameter"},{kbname:"Family",label:"Family"},{kbname:"Genus",label:"Genus"},{kbname:"EcoGroup",label:"Ecological group"},{kbname:"Colour",label:"Colour"},{kbname:"TPShape",label:"TP shape"}];n(document).ready(function(){n.get(t.opts.tombiopath+"/visEarthworm/earthworms-import.html?ver="+t.opts.tombiover,function(i){n("#tombiod3Earthworm").html(i.replace(/##tombiopath##/g,t.opts.tombiopath));p()})})}var i,r;console.log("tbv",t);i=t["visEarthworm"]=Object.create(t.visP);i.initialise=function(){r=this;this.metadata.title="Earthworm multi-access key";this.metadata.authors="Rich Burkmar";this.metadata.year="2016";this.metadata.publisher="Field Studies Council";this.metadata.location="Preston Montford";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="3.0";this.charStateInput=!1;this.helpFiles=[t.opts.tombiopath+"visEarthworm/visEarthwormHelp.html",];this.div.append("<div id='tombiod3Earthworm'>");u()};i.refresh=function(){};i.urlParams=function(){}})(jQuery,this.tombiovis);