(function(n,t){"use strict";t.checkKnowledgeBase=function(){function d(r,u){return t.kbmetadata[r]&&String(t.kbmetadata[r]).trim()!=""?!0:(s=!1,i.append(n('<li class="tombioValid3">').text(u)),!1)}var ft,f,et,ot,st,g,o,w,a;if(typeof t.opts.checkKB=="undefined"&&(t.opts.checkKB=t.kbconfig.checkValidity&&t.kbconfig.checkValidity=="yes"),!t.opts.checkKB)return!0;var c=!0,u=!0,v=!0,l=!0,b=!0,s=!0,i,ct,e,r,h,y,k=t.characters.map(function(n){return n.Character}),p=Object.keys(t.taxa[0]).filter(function(n){return n!=""}),tt=[];t.values.forEach(function(n){tt.indexOf(n.Character)==-1&&tt.push(n.Character)});var lt=t.characters.filter(function(n){return n.ValueType=="numeric"&&p.indexOf(n.Character)>-1}).map(function(n){return n.Character}),at=t.characters.filter(function(n){return(n.ValueType=="ordinal"||n.ValueType=="ordinalCircular")&&p.indexOf(n.Character)>-1}).map(function(n){return n.Character}),vt=t.characters.filter(function(n){return n.ValueType=="ordinalCircular"&&p.indexOf(n.Character)>-1}).map(function(n){return n.Character});n("#tombioReload").button({icons:{primary:"ui-icon-reset",secondary:null}}).click(function(){window.location.reload(!0)});n("#tombioContinue").button().css("margin-left","5px").click(function(){n("#downloadspin").show();n("#tombioKBReport").hide();setTimeout(function(){t.loadComplete("force")},100)});n("#tombioKBReport").append(n("<h3>").text("First fix these knowledge-base problems..."));n("#tombioKBReport").append(n("<p>").html("Some problems were found with the knowledge-base. They should be easy enough to fix. Read on for more details and guidance."));n("#tombioKBReport").append(n("<p>").html("When you've fixed one or more problems, use the <i>Save worksheets as CSV<\/i> button on the KB to regenerate the CSVs and then click the <i>Reload<\/i> button above."));n("#tombioKBReport").append(n("<p>").html("The problems are colour-coded according to the schema shown below:"));i=n("<ul>");i.append(n('<li class="tombioValid3">').html("These are serious problems that could cause the visualisation software to malfunction."));i.append(n('<li class="tombioValid2">').html("These problems are not likely to cause the visualisation software to malfunction, but you might not see what you expect."));i.append(n('<li class="tombioValid1">').html("These are for information only - it may be what you intended to do, but if not, you may as well sort them out. These will not cause the visualisation software to malfunction."));n("#tombioKBReport").append(i);i=n("<ul>");h=["Key","Type","Mandatory","Value","Date","Notes"];r=[];for(e in t.config[0])t.config[0].hasOwnProperty(e)&&r.push(e);h.forEach(function(t){n.inArray(t,r)==-1&&(i.append(n('<li class="tombioValid3">').html("The madatory column <b>'"+t+"'<\/b> is missing.")),s=!1)});d("title","You must specify a title for the KB (Key - title). This is used to generate a citation.")||(s=!1);d("year","You must specify a year for the KB (Key - year). This is used to generate a citation.")||(s=!1);d("authors","You must specify one or more authors for the KB (Key - authors). This is used to generate a citation. Authors will appear in the citation exactly as you specify them.")||(s=!1);d("version","You must specify a version for the KB (Key - version). This is used to generate a citation.")||(s=!1);s||(n("#tombioKBReport").append(n("<h4>").text("On the config worksheet...")),n("#tombioKBReport").append(i));i=n("<ul>");t.taxa[0].Taxon||(i.append(n('<li class="tombioValid3">').html("There must be a column called <i>Taxon<\/i> (case sensitive) which stores the names of the taxa you are working with.")),c=!1);ft=/^[a-zA-Z0-9\-_]+$/;Object.keys(t.taxa[0]).forEach(function(t,r){ft.test(t)||(i.append(n('<li class="tombioValid3">').html("<b>'"+t+"'<\/b> (column "+(r+1)+") is not a valid identifier for a character. Use only alphanumerics with no spaces.")),c=!1)});et=/^(\d+(\.\d*)?|\.\d+)$/;ot=/^\[(\d+(\.\d*)?|\.\d+)-(\d+(\.\d*)?|\.\d+)\]$/;lt.forEach(function(r){t.taxa.forEach(function(t){f=t[r];f||f==""||console.log(t.Taxon,r,f);f==""||f=="n/a"||f=="novalue"||f=="?"||f.substr(0,1)=="#"||et.test(f)||ot.test(f)||(i.append(n('<li class="tombioValid3">').html("The value <b>'"+f+"'<\/b> is not a valid for the numeric character <b>'"+r+"'<\/b> and taxon <b>'"+t.Taxon+"'<\/b>. Values must be a number or a range in the form '[x-y]'. (Other permitted values are '?', 'n/a', 'novalue' and no specified value.)")),c=!1)})});st=/^\[[^-]+-[^-]+\]$/;at.forEach(function(r){var e=t.values.filter(function(n){return n.Character==r}),u=[];t.values.forEach(function(n){n.Character==r&&n.StateGroup&&u.indexOf(n.StateGroup)==-1&&u.push(n.StateGroup)});t.taxa.forEach(function(t){var o,s;f=t[r];o=!1;f==""||f=="n/a"||f=="novalue"||f=="?"||f.substr(0,1)=="#"||(s=f.split("|").forEach(function(f){var h=!0,o,s;f=f.trim();f.length>3&&(f.substr(f.length-3,3)=="(m)"||f.substr(f.length-3,3)=="(f)")&&(f=f.substr(0,f.length-3).trim());o=st.test(f)?f.slice(1,-1).split("-").slice(0,2):[f];o.forEach(function(f){f=f.trim();var o=e.filter(function(n){return n.CharacterState==f});o.length==0&&u.indexOf(f)==-1&&(i.append(n('<li class="tombioValid2">').html("The value <b>'"+f+"'<\/b> for character <b>'"+r+"'<\/b> and taxon <b>'"+t.Taxon+"'<\/b> is not represented in the values worksheet either as a state value or a state group. All character state values for ordinal and ordinalCircular characters must be represented on the values worksheet.")),c=!1,h=!1)});h&&o.length==2&&vt.indexOf(r)==-1&&(s=e.map(function(n){return n.CharacterState}),s.indexOf(o[0])>s.indexOf(o[1])&&(i.append(n('<li class="tombioValid2">').html("The ordinal range <b>'"+f+"'<\/b> for character <b>'"+r+"'<\/b> and taxon <b>'"+t.Taxon+"'<\/b> is not valid since the start of the range appears after the end in the ordinal values expressed on the values worksheet for this character.")),c=!1))}))})});c||(n("#tombioKBReport").append(n("<h4>").text("On the taxa worksheet...")),n("#tombioKBReport").append(i));i=n("<ul>");r=[];for(e in t.characters[0])t.characters[0].hasOwnProperty(e)&&r.push(e);h=["Group","Character","Label","Help","Status","ValueType","ControlType","Params","Weight"];h.forEach(function(t){n.inArray(t,r)==-1&&(i.append(n('<li class="tombioValid3">').html("The madatory column <b>'"+t+"'<\/b> is missing.")),u=!1)});y=["HelpShort"];y.forEach(function(t){n.inArray(t,r)==-1&&(i.append(n('<li class="tombioValid1">').html("The optional column <b>'"+t+"'<\/b> is missing.")),u=!1)});n.inArray("Strictness",r)==-1&&n.inArray("Latitude",r)==-1?(i.append(n('<li class="tombioValid3">').html("The column <b>'Latitude'<\/b> is missing.")),u=!1):n.inArray("Strictness",r)>-1&&n.inArray("Latitude",r)>-1?(i.append(n('<li class="tombioValid1">').html("Columns <b>'Strictness'<\/b> and  <b>'Latitude'<\/b> are both specified. 'Strictness' has been deprecated and will be ignored in favour of 'Latitude'.")),u=!1):n.inArray("Strictness",r)>-1&&(i.append(n('<li class="tombioValid1">').html("You are using <b>'Strictness'<\/b> which has been deprecated (since version 1.7.0) in favour of <b>'Latitude'<\/b>. Strictness will still work, but you are advised to change to Latitude (see documentation).")),u=!1);g=t.characters.filter(function(n){return n.Character=="Taxon"});g.length>0&&g[0].Group!="Taxonomy"&&(i.append(n('<li class="tombioValid3">').html("The Taxon character must have a Group value of 'Taxonomy'. It is currently set to '"+g[0].Group+"'.")),u=!1);p.forEach(function(t,r){k.indexOf(t)==-1&&(i.append(n('<li class="tombioValid3">').html("There is no row on the <i>characters<\/i> worksheet for the character <b>'"+t+"'<\/b> represented by a column (column "+(r+1)+") on the <i>taxa<\/i> worksheet. All columns on the <i>taxa<\/i> tab must be represented by a row in the <i>characters<\/i> worksheet regardless of whether or not they are used. Names are case sensitive. Note that rows will not be seen unless the <b>Group<\/b> column has a value.")),u=!1)});k.forEach(function(t){p.indexOf(t)==-1&&(i.append(n('<li class="tombioValid2">').html("There is no column on the <i>taxa<\/i> worksheet for the character <b>'"+t+"'<\/b> which is represented in the <i>characters<\/i> worksheet.")),u=!1)});t.characters.filter(function(n){return n.Status=="key"}).forEach(function(t){var r=!0,f=!0,e,o,s,h;/^([1-9]|10)$/.test(t.Weight)||(i.append(n('<li class="tombioValid3">').html("You must specify a 'Weight' value for <b>'"+t.Character+"'<\/b> because it has a 'Status' value of 'key'.")),u=!1);typeof t.Strictness!="undefined"&&t.Strictness!=""&&(e=/^([0-9]|10)$/,t.ValueType!="numeric"&&t.ValueType!="ordinal"&&t.ValueType!="ordinalCircular"||e.test(t.Strictness)||(i.append(n('<li class="tombioValid2">').html("For numeric, ordinal and ordinalCircular characters, 'Strictness', if specified, must be between 0 and 10. There is an invalid 'Strictness' value for <b>'"+t.Character+"'<\/b>.")),u=!1));typeof t.Latitude!="undefined"&&t.Latitude!=""&&(o=/^[0-9]\d*(\.\d+)?$/,t.ValueType!="numeric"||o.test(t.Latitude)||(i.append(n('<li class="tombioValid2">').html("For numeric characters, 'Latitude', if specified, must be a valid number. There is an invalid 'Latitude' value for <b>'"+t.Character+"'<\/b>.")),u=!1),s=/^(?:[0-9]|0[1-9]|10)$/,t.ValueType!="ordinal"&&t.ValueType!="ordinalCircular"||s.test(t.Latitude)||(i.append(n('<li class="tombioValid2">').html("For ordinal and ordinalCircular characters, 'Latitude', if specified, must be a whole number. There is an invalid 'Latitude' value for <b>'"+t.Character+"'<\/b>.")),u=!1));["numeric","ordinal","ordinalCircular","text"].indexOf(t.ValueType)==-1&&(i.append(n('<li class="tombioValid3">').html("<b>'"+t.ValueType+"'<\/b>  is an invalid 'ValueType' value for <b>'"+t.Character+"'<\/b>. You must specify a valid 'ValueType' because it has a 'Status' value of 'key'.")),r=!1,u=!1);["single","multi","spin"].indexOf(t.ControlType)==-1&&(i.append(n('<li class="tombioValid3">').html("<b>'"+t.ControlType+"'<\/b> is an invalid 'ControlType' value for <b>'"+t.Character+"'<\/b>. You must specify a valid 'ControlType' because it has a 'Status' value of 'key'.")),f=!1,u=!1);r&&f&&{numeric:["spin"],text:["single","multi"],ordinal:["single","multi"],ordinalCircular:["single","multi"]}[t.ValueType].indexOf(t.ControlType)==-1&&(i.append(n('<li class="tombioValid3">').html("Invalid combination of 'ValueType' <b>('"+t.ValueType+"')<\/b> and 'ControlType' <b>('"+t.ControlType+"')<\/b> for <b>'"+t.Character+"'<\/b>. You must specify a valid combination because it has a 'Status' value of 'key'.")),u=!1);t.ControlType=="spin"&&(h=/^(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+)$/,h.test(t.Params)||(i.append(n('<li class="tombioValid3">').html("<b>'"+t.Params+"'<\/b> is an invalid spin control 'Param' value for <b>'"+t.Character+"'<\/b>. It must have the form 'n,n,n' (where n can be any valid numeric value, including decimal).")),u=!1));t.HelpShort&&!t.Help&&(i.append(n('<li class="tombioValid2">').html("A value for 'HelpShort' is set but there is no value for 'Help' for <b>'"+t.Character+"'<\/b>. You can set 'Help' without setting 'HelpShort', but not the other way around.")),u=!1)});u||(n("#tombioKBReport").append(n("<h4>").text("On the characters worksheet...")),n("#tombioKBReport").append(i));i=n("<ul>");ct=n("<ul>");r=[];for(e in t.values[0])t.values[0].hasOwnProperty(e)&&r.push(e);h=["Character","CharacterState","CharacterStateTranslation","StateHelp"];h.forEach(function(t){n.inArray(t,r)==-1&&(i.append(n('<li class="tombioValid3">').html("The madatory column <b>'"+t+"'<\/b> is missing.")),v=!1)});y=["StateHelpShort"];y.forEach(function(t){n.inArray(t,r)==-1&&(i.append(n('<li class="tombioValid1">').html("The optional column <b>'"+t+"'<\/b> is missing.")),v=!1)});tt.forEach(function(t){k.indexOf(t)==-1&&(i.append(n('<li class="tombioValid2">').html("There is no row on the <i>characters<\/i> worksheet for the character <b>'"+t+"'<\/b> represented in the <i>values<\/i> worksheet.")),v=!1)});t.values.forEach(function(t){t.StateHelpShort&&!t.StateHelp&&(i.append(n('<li class="tombioValid2">').html("A value for 'StateHelpShort' is set but there is no value for 'StateHelp' for <b>'"+t.Character+" - "+t.CharacterState+"'<\/b>. You can set 'StateHelp' without setting 'StateHelpShort', but not the other way around.")),v=!1)});v||(n("#tombioKBReport").append(n("<h4>").text("On the values worksheet...")),n("#tombioKBReport").append(i));i=n("<ul>");r=[];for(e in t.media[0])t.media[0].hasOwnProperty(e)&&r.push(e);if(h=["URI","ImageWidth","Type","Priority","Caption","Taxon","Character","State"],h.forEach(function(t){n.inArray(t,r)==-1&&(i.append(n('<li class="tombioValid3">').html("The madatory column <b>'"+t+"'<\/b> is missing.")),l=!1)}),y=["UseFor","TipStyle","SmallURI","LargeURI"],y.forEach(function(t){n.inArray(t,r)==-1&&(i.append(n('<li class="tombioValid1">').html("The optional column <b>'"+t+"'<\/b> is missing.")),l=!1)}),t.media.filter(function(n){return n.Type=="image-local"||n.Type=="image-web"}).forEach(function(r){if(r.Character!=""&&k.indexOf(r.Character)==-1?(i.append(n('<li class="tombioValid2">').html("An image is specified for the character <b>'"+r.Character+"'<\/b> on the media worksheet, but that character is not on the characters worksheet.")),l=!1):r.Character!="",r.State!=""&&r.Character==""&&(i.append(n('<li class="tombioValid2">').html("An image is specified for the state value <b>'"+r.State+"'<\/b> on the media worksheet, but no character is specified.")),l=!1),r.State!=""&&r.Character!=""){var u=t.values.filter(function(n){return r.Character==n.Character&&r.State==n.CharacterState});(u.length==0||u[0].StateHelp=="")&&(i.append(n('<li class="tombioValid2">').html("An image is specified for the character <b>'"+r.Character+"'<\/b> and state <b>'"+r.State+"'<\/b> on the media worksheet, but no corresponding pair is found with help text on the values worksheet, so it won't be displayed.")),l=!1)}}),l||(n("#tombioKBReport").append(n("<h4>").text("On the media worksheet...")),n("#tombioKBReport").append(i)),i=n("<ul>"),o=t.characters.filter(function(n){return n.Group=="Taxonomy"}),w=o.length>1?o[o.length-1].Character:null,w&&w!="Taxon"&&(i.append(n('<li class="tombioValid3">').html("The last Taxonomy row representing '"+w+"' on the characters worksheet appears below the row representing 'Taxon' - it must come above.")),b=!1),w=="Taxon"&&o.length>2)for(a=o.length-2;a>0;a--){var nt=o[a].Character,it=o[a].Label,ht=o[a-1].Character,rt=o[a-1].Label,ut=[];t.taxa.forEach(function(n){n[nt]!=""&&ut.indexOf(n[nt])==-1&&ut.push(n[nt])});ut.forEach(function(r){var u=[],f=t.taxa.filter(function(n){return n[nt]==r});f.forEach(function(n){u.indexOf(n[ht])==-1&&u.push(n[ht])});u.length>1&&(i.append(n('<li class="tombioValid3">').html("Taxa of "+it+" "+r+" are represented by more than one "+rt+", breaking the rules of a strict hierarchical taxonomy. Check that the taxonomy columns are specified in the correct order on the characters worksheet  (at the moment "+rt+" is specified at a higher level than "+it+"). If they are, then check the values for "+rt+" and "+it+" on the taxa worksheet.")),b=!1)})}return b||(n("#tombioKBReport").append(n("<h4>").text("Taxonomy problems...")),n("#tombioKBReport").append(i)),c&&u&&v&&l&&s&b?!0:(n("#tombioKBReport").show(),n("#downloadspin").hide(),!1)};t.mediaCheck=function(i,r,u){var f=[];return t.media.filter(function(n){return n[i]&&(n.Type=="image-local"||n.Type=="html-local"||n.Type=="image-web")}).forEach(function(t){var e=new Promise(function(r,u){if(t.Type=="image-web"){var f=new Image;f.onload=function(){r(t[i])};f.onerror=function(){u(t[i])};f.src=t[i]}else n.ajax({url:t[i],type:"HEAD",success:function(){r(t[i])},error:function(){u(t[i])}})}).then(function(n){r(n)},function(n){u(n)});f.push(e)}),Promise.all(f)};t.tvkCheck=function(i,r,u){var f=[];if(!t.oCharacters.TVK){u();return}t.taxa.forEach(function(t){if(t.TVK.kbValue){var u=new Promise(function(i,r){n.ajax({url:"https://species-ws.nbnatlas.org/species/"+t.TVK.kbValue,dataType:"json",success:function(){i(t)},error:function(){r(t)}})}).then(function(n){i(n)},function(n){r(n)});f.push(u)}});Promise.all(f).then(function(){u()})}})(jQuery,this.tombiovis);