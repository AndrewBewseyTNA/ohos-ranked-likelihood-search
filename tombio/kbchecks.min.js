(function(n,t){"use strict";t.checkKnowledgeBase=function(){function k(r,u){return t.kbmetadata[r]&&String(t.kbmetadata[r]).trim()!=""?!0:(s=!1,i.append(n('<li class="tombioValid3">').text(u)),!1)}var ut,r,ft,et,ot,d,o,p,l;if(typeof t.opts.checkKB=="undefined"&&(t.opts.checkKB=t.kbconfig.checkValidity&&t.kbconfig.checkValidity=="yes"),!t.opts.checkKB)return!0;var c=!0,u=!0,v=!0,a=!0,w=!0,s=!0,i,ht,e,f,h,b=t.characters.map(function(n){return n.Character}),y=Object.keys(t.taxa[0]).filter(function(n){return n!=""}),nt=[];t.values.forEach(function(n){nt.indexOf(n.Character)==-1&&nt.push(n.Character)});var ct=t.characters.filter(function(n){return n.ValueType=="numeric"&&y.indexOf(n.Character)>-1}).map(function(n){return n.Character}),lt=t.characters.filter(function(n){return(n.ValueType=="ordinal"||n.ValueType=="ordinalCircular")&&y.indexOf(n.Character)>-1}).map(function(n){return n.Character}),at=t.characters.filter(function(n){return n.ValueType=="ordinalCircular"&&y.indexOf(n.Character)>-1}).map(function(n){return n.Character});n("#tombioReload").button({icons:{primary:"ui-icon-reset",secondary:null}}).click(function(){window.location.reload(!0)});n("#tombioContinue").button().css("margin-left","5px").click(function(){n("#downloadspin").show();n("#tombioKBReport").hide();setTimeout(function(){t.loadComplete("force")},100)});n("#tombioKBReport").append(n("<h3>").text("First fix these knowledge-base problems..."));n("#tombioKBReport").append(n("<p>").html("Some problems were found with the knowledge-base. They should be easy enough to fix. Read on for more details and guidance."));n("#tombioKBReport").append(n("<p>").html("When you've fixed one or more problems, use the <i>Save worksheets as CSV<\/i> button on the KB to regenerate the CSVs and then click the <i>Reload<\/i> button above."));n("#tombioKBReport").append(n("<p>").html("The problems are colour-coded according to the schema shown below:"));i=n("<ul>");i.append(n('<li class="tombioValid3">').html("These are serious problems that could cause the visualisation software to malfunction."));i.append(n('<li class="tombioValid2">').html("These problems are not likely to cause the visualisation software to malfunction, but you might not see what you expect."));i.append(n('<li class="tombioValid1">').html("These are for information only - it may be what you intended to do, but if not, you may as well sort them out. These will not cause the visualisation software to malfunction."));n("#tombioKBReport").append(i);i=n("<ul>");h=["Key","Type","Mandatory","Value","Date","Notes"];f=[];for(e in t.config[0])t.config[0].hasOwnProperty(e)&&f.push(e);h.forEach(function(t){n.inArray(t,f)==-1&&(i.append(n('<li class="tombioValid3">').html("The madatory column <b>'"+t+"'<\/b> is missing.")),s=!1)});k("title","You must specify a title for the KB (Key - title). This is used to generate a citation.")||(s=!1);k("year","You must specify a year for the KB (Key - year). This is used to generate a citation.")||(s=!1);k("authors","You must specify one or more authors for the KB (Key - authors). This is used to generate a citation. Authors will appear in the citation exactly as you specify them.")||(s=!1);k("version","You must specify a version for the KB (Key - version). This is used to generate a citation.")||(s=!1);s||(n("#tombioKBReport").append(n("<h4>").text("On the config worksheet...")),n("#tombioKBReport").append(i));i=n("<ul>");t.taxa[0].Taxon||(i.append(n('<li class="tombioValid3">').html("There must be a column called <i>Taxon<\/i> (case sensitive) which stores the names of the taxa you are working with.")),c=!1);ut=/^[a-zA-Z0-9\-_]+$/;Object.keys(t.taxa[0]).forEach(function(t,r){ut.test(t)||(i.append(n('<li class="tombioValid3">').html("<b>'"+t+"'<\/b> (column "+(r+1)+") is not a valid identifier for a character. Use only alphanumerics with no spaces.")),c=!1)});ft=/^(\d+(\.\d*)?|\.\d+)$/;et=/^\[(\d+(\.\d*)?|\.\d+)-(\d+(\.\d*)?|\.\d+)\]$/;ct.forEach(function(u){t.taxa.forEach(function(t){r=t[u];r||r==""||console.log(t.Taxon,u,r);r==""||r=="n/a"||r=="novalue"||r=="?"||r.substr(0,1)=="#"||ft.test(r)||et.test(r)||(i.append(n('<li class="tombioValid3">').html("The value <b>'"+r+"'<\/b> is not a valid for the numeric character <b>'"+u+"'<\/b> and taxon <b>'"+t.Taxon+"'<\/b>. Values must be a number or a range in the form '[x-y]'. (Other permitted values are '?', 'n/a', 'novalue' and no specified value.)")),c=!1)})});ot=/^\[[^-]+-[^-]+\]$/;lt.forEach(function(u){var e=t.values.filter(function(n){return n.Character==u}),f=[];t.values.forEach(function(n){n.Character==u&&n.StateGroup&&f.indexOf(n.StateGroup)==-1&&f.push(n.StateGroup)});t.taxa.forEach(function(t){var o,s;r=t[u];o=!1;r==""||r=="n/a"||r=="novalue"||r=="?"||r.substr(0,1)=="#"||(s=r.split("|").forEach(function(r){var h=!0,o,s;r=r.trim();r.length>3&&(r.substr(r.length-3,3)=="(m)"||r.substr(r.length-3,3)=="(f)")&&(r=r.substr(0,r.length-3).trim());o=ot.test(r)?r.slice(1,-1).split("-").slice(0,2):[r];o.forEach(function(r){r=r.trim();var o=e.filter(function(n){return n.CharacterState==r});o.length==0&&f.indexOf(r)==-1&&(i.append(n('<li class="tombioValid2">').html("The value <b>'"+r+"'<\/b> for character <b>'"+u+"'<\/b> and taxon <b>'"+t.Taxon+"'<\/b> is not represented in the values worksheet either as a state value or a state group. All character state values for ordinal and ordinalCircular characters must be represented on the values worksheet.")),c=!1,h=!1)});h&&o.length==2&&at.indexOf(u)==-1&&(s=e.map(function(n){return n.CharacterState}),s.indexOf(o[0])>s.indexOf(o[1])&&(i.append(n('<li class="tombioValid2">').html("The ordinal range <b>'"+r+"'<\/b> for character <b>'"+u+"'<\/b> and taxon <b>'"+t.Taxon+"'<\/b> is not valid since the start of the range appears after the end in the ordinal values expressed on the values worksheet for this character.")),c=!1))}))})});c||(n("#tombioKBReport").append(n("<h4>").text("On the taxa worksheet...")),n("#tombioKBReport").append(i));i=n("<ul>");h=["Group","Character","Label","Help","HelpShort","Status","ValueType","ControlType","Params","Weight"];f=[];for(e in t.characters[0])t.characters[0].hasOwnProperty(e)&&f.push(e);h.forEach(function(t){n.inArray(t,f)==-1&&(i.append(n('<li class="tombioValid3">').html("The madatory column <b>'"+t+"'<\/b> is missing.")),u=!1)});n.inArray("Strictness",f)==-1&&n.inArray("Latitude",f)==-1?(i.append(n('<li class="tombioValid3">').html("The column <b>'Latitude'<\/b> is missing.")),u=!1):n.inArray("Strictness",f)>-1&&n.inArray("Latitude",f)>-1?(i.append(n('<li class="tombioValid1">').html("Columns <b>'Strictness'<\/b> and  <b>'Latitude'<\/b> are both specified. 'Strictness' has been deprecated and will be ignored in favour of 'Latitude'.")),u=!1):n.inArray("Strictness",f)>-1&&(i.append(n('<li class="tombioValid1">').html("You are using <b>'Strictness'<\/b> which has been deprecated (since version 1.7.0) in favour of <b>'Latitude'<\/b>. Strictness will still work, but you are advised to change to Latitude (see documentation).")),u=!1);d=t.characters.filter(function(n){return n.Character=="Taxon"});d.length>0&&d[0].Group!="Taxonomy"&&(i.append(n('<li class="tombioValid3">').html("The Taxon character must have a Group value of 'Taxonomy'. It is currently set to '"+d[0].Group+"'.")),u=!1);y.forEach(function(t,r){b.indexOf(t)==-1&&(i.append(n('<li class="tombioValid3">').html("There is no row on the <i>characters<\/i> worksheet for the character <b>'"+t+"'<\/b> represented by a column (column "+(r+1)+") on the <i>taxa<\/i> worksheet. All columns on the <i>taxa<\/i> tab must be represented by a row in the <i>characters<\/i> worksheet regardless of whether or not they are used. Names are case sensitive. Note that rows will not be seen unless the <b>Group<\/b> column has a value.")),u=!1)});b.forEach(function(t){y.indexOf(t)==-1&&(i.append(n('<li class="tombioValid2">').html("There is no column on the <i>taxa<\/i> worksheet for the character <b>'"+t+"'<\/b> which is represented in the <i>characters<\/i> worksheet.")),u=!1)});t.characters.filter(function(n){return n.Status=="key"}).forEach(function(t){var r=!0,f=!0,e,o,s,h;/^([1-9]|10)$/.test(t.Weight)||(i.append(n('<li class="tombioValid3">').html("You must specify a 'Weight' value for <b>'"+t.Character+"'<\/b> because it has a 'Status' value of 'key'.")),u=!1);typeof t.Strictness!="undefined"&&t.Strictness!=""&&(e=/^([0-9]|10)$/,t.ValueType!="numeric"&&t.ValueType!="ordinal"&&t.ValueType!="ordinalCircular"||e.test(t.Strictness)||(i.append(n('<li class="tombioValid2">').html("For numeric, ordinal and ordinalCircular characters, 'Strictness', if specified, must be between 0 and 10. There is an invalid 'Strictness' value for <b>'"+t.Character+"'<\/b>.")),u=!1));typeof t.Latitude!="undefined"&&t.Latitude!=""&&(o=/^[0-9]\d*(\.\d+)?$/,t.ValueType!="numeric"||o.test(t.Latitude)||(i.append(n('<li class="tombioValid2">').html("For numeric characters, 'Latitude', if specified, must be a valid number. There is an invalid 'Latitude' value for <b>'"+t.Character+"'<\/b>.")),u=!1),s=/^(?:[0-9]|0[1-9]|10)$/,t.ValueType!="ordinal"&&t.ValueType!="ordinalCircular"||s.test(t.Latitude)||(i.append(n('<li class="tombioValid2">').html("For ordinal and ordinalCircular characters, 'Latitude', if specified, must be a whole number. There is an invalid 'Latitude' value for <b>'"+t.Character+"'<\/b>.")),u=!1));["numeric","ordinal","ordinalCircular","text"].indexOf(t.ValueType)==-1&&(i.append(n('<li class="tombioValid3">').html("<b>'"+t.ValueType+"'<\/b>  is an invalid 'ValueType' value for <b>'"+t.Character+"'<\/b>. You must specify a valid 'ValueType' because it has a 'Status' value of 'key'.")),r=!1,u=!1);["single","multi","spin"].indexOf(t.ControlType)==-1&&(i.append(n('<li class="tombioValid3">').html("<b>'"+t.ControlType+"'<\/b> is an invalid 'ControlType' value for <b>'"+t.Character+"'<\/b>. You must specify a valid 'ControlType' because it has a 'Status' value of 'key'.")),f=!1,u=!1);r&&f&&{numeric:["spin"],text:["single","multi"],ordinal:["single","multi"],ordinalCircular:["single","multi"]}[t.ValueType].indexOf(t.ControlType)==-1&&(i.append(n('<li class="tombioValid3">').html("Invalid combination of 'ValueType' <b>('"+t.ValueType+"')<\/b> and 'ControlType' <b>('"+t.ControlType+"')<\/b> for <b>'"+t.Character+"'<\/b>. You must specify a valid combination because it has a 'Status' value of 'key'.")),u=!1);t.ControlType=="spin"&&(h=/^(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+)$/,h.test(t.Params)||(i.append(n('<li class="tombioValid3">').html("<b>'"+t.Params+"'<\/b> is an invalid spin control 'Param' value for <b>'"+t.Character+"'<\/b>. It must have the form 'n,n,n' (where n can be any valid numeric value, including decimal).")),u=!1));t.HelpShort&&!t.Help&&(i.append(n('<li class="tombioValid2">').html("A value for 'HelpShort' is set but there is no value for 'Help' for <b>'"+t.Character+"'<\/b>. You can set 'Help' without setting 'HelpShort', but not the other way around.")),u=!1)});u||(n("#tombioKBReport").append(n("<h4>").text("On the characters worksheet...")),n("#tombioKBReport").append(i));i=n("<ul>");ht=n("<ul>");h=["Character","CharacterState","CharacterStateTranslation","StateHelp","StateHelpShort"];f=[];for(e in t.values[0])t.values[0].hasOwnProperty(e)&&f.push(e);h.forEach(function(t){n.inArray(t,f)==-1&&(i.append(n('<li class="tombioValid3">').html("The madatory column <b>'"+t+"'<\/b> is missing.")),v=!1)});nt.forEach(function(t){b.indexOf(t)==-1&&(i.append(n('<li class="tombioValid2">').html("There is no row on the <i>characters<\/i> worksheet for the character <b>'"+t+"'<\/b> represented in the <i>values<\/i> worksheet.")),v=!1)});t.values.forEach(function(t){t.StateHelpShort&&!t.StateHelp&&(i.append(n('<li class="tombioValid2">').html("A value for 'StateHelpShort' is set but there is no value for 'StateHelp' for <b>'"+t.Character+" - "+t.CharacterState+"'<\/b>. You can set 'StateHelp' without setting 'StateHelpShort', but not the other way around.")),v=!1)});v||(n("#tombioKBReport").append(n("<h4>").text("On the values worksheet...")),n("#tombioKBReport").append(i));i=n("<ul>");h=["URI","ImageWidth","Type","Priority","Caption","Taxon","Character","State","UseFor","TipStyle"];f=[];for(e in t.media[0])t.media[0].hasOwnProperty(e)&&f.push(e);if(h.forEach(function(t){n.inArray(t,f)==-1&&(i.append(n('<li class="tombioValid3">').html("The madatory column <b>'"+t+"'<\/b> is missing.")),a=!1)}),t.media.filter(function(n){return n.Type=="image-local"||n.Type=="image-web"}).forEach(function(r){if(r.Character!=""&&b.indexOf(r.Character)==-1?(i.append(n('<li class="tombioValid2">').html("An image is specified for the character <b>'"+r.Character+"'<\/b> on the media worksheet, but that character is not on the characters worksheet.")),a=!1):r.Character!="",r.State!=""&&r.Character==""&&(i.append(n('<li class="tombioValid2">').html("An image is specified for the state value <b>'"+r.State+"'<\/b> on the media worksheet, but no character is specified.")),a=!1),r.State!=""&&r.Character!=""){var u=t.values.filter(function(n){return r.Character==n.Character&&r.State==n.CharacterState});(u.length==0||u[0].StateHelp=="")&&(i.append(n('<li class="tombioValid2">').html("An image is specified for the character <b>'"+r.Character+"'<\/b> and state <b>'"+r.State+"'<\/b> on the media worksheet, but no corresponding pair is found with help text on the values worksheet, so it won't be displayed.")),a=!1)}}),a||(n("#tombioKBReport").append(n("<h4>").text("On the media worksheet...")),n("#tombioKBReport").append(i)),i=n("<ul>"),o=t.characters.filter(function(n){return n.Group=="Taxonomy"}),p=o.length>1?o[o.length-1].Character:null,p&&p!="Taxon"&&(i.append(n('<li class="tombioValid3">').html("The last Taxonomy row representing '"+p+"' on the characters worksheet appears below the row representing 'Taxon' - it must come above.")),w=!1),p=="Taxon"&&o.length>2)for(l=o.length-2;l>0;l--){var g=o[l].Character,tt=o[l].Label,st=o[l-1].Character,it=o[l-1].Label,rt=[];t.taxa.forEach(function(n){n[g]!=""&&rt.indexOf(n[g])==-1&&rt.push(n[g])});rt.forEach(function(r){var u=[],f=t.taxa.filter(function(n){return n[g]==r});f.forEach(function(n){u.indexOf(n[st])==-1&&u.push(n[st])});u.length>1&&(i.append(n('<li class="tombioValid3">').html("Taxa of "+tt+" "+r+" are represented by more than one "+it+", breaking the rules of a strict hierarchical taxonomy. Check that the taxonomy columns are specified in the correct order on the characters worksheet  (at the moment "+it+" is specified at a higher level than "+tt+"). If they are, then check the values for "+it+" and "+tt+" on the taxa worksheet.")),w=!1)})}return w||(n("#tombioKBReport").append(n("<h4>").text("Taxonomy problems...")),n("#tombioKBReport").append(i)),c&&u&&v&&a&&s&w?!0:(n("#tombioKBReport").show(),n("#downloadspin").hide(),!1)};t.mediaCheck=function(i,r,u){var f=[];t.media.filter(function(n){return n.Type=="image-local"||n.Type=="html-local"||n.Type=="image-web"}).forEach(function(t){var u=new Promise(function(i,r){if(t.Type=="image-web"){var u=new Image;u.onload=function(){i(t.URI)};u.onerror=function(){r(t.URI)};u.src=t.URI}else n.ajax({url:t.URI,type:"HEAD",success:function(){i(t.URI)},error:function(){r(t.URI)}})}).then(function(n){i(n)},function(n){r(n)});f.push(u)});Promise.all(f).then(function(){u()})};t.tvkCheck=function(i,r,u){var f=[];if(!t.oCharacters.TVK){u();return}t.taxa.forEach(function(t){if(t.TVK.kbValue){var u=new Promise(function(i,r){n.ajax({url:"https://species-ws.nbnatlas.org/species/"+t.TVK.kbValue,dataType:"json",success:function(){i(t)},error:function(){r(t)}})}).then(function(n){i(n)},function(n){r(n)});f.push(u)}});Promise.all(f).then(function(){u()})}})(jQuery,this.tombiovis);