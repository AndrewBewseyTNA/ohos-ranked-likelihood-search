(function(n,t){"use strict";t.checkKnowledgeBase=function(){function p(r,u){return t.kbmetadata[r]&&String(t.kbmetadata[r]).trim()!=""?!0:(o=!1,i.append(n('<li class="tombioValid3">').text(u)),!1)}var tt,r,it,rt,ut,w,f,l,s;if(!(t.kbconfig.checkValidity&&t.kbconfig.checkValidity=="yes"))return!0;var e=!0,u=!0,a=!0,h=!0,v=!0,o=!0,i,et,y=t.characters.map(function(n){return n.Character}),c=Object.keys(t.taxa[0]).filter(function(n){return n!=""}),k=[];t.values.forEach(function(n){k.indexOf(n.Character)==-1&&k.push(n.Character)});var ot=t.characters.filter(function(n){return n.ValueType=="numeric"&&c.indexOf(n.Character)>-1}).map(function(n){return n.Character}),st=t.characters.filter(function(n){return(n.ValueType=="ordinal"||n.ValueType=="ordinalCircular")&&c.indexOf(n.Character)>-1}).map(function(n){return n.Character}),ht=t.characters.filter(function(n){return n.ValueType=="ordinalCircular"&&c.indexOf(n.Character)>-1}).map(function(n){return n.Character});if(n("#tombioReload").button({icons:{primary:"ui-icon-reset",secondary:null}}).click(function(){window.location.reload(!0)}),n("#tombioContinue").button().css("margin-left","5px").click(function(){n("#downloadspin").show();n("#tombioKBReport").hide();setTimeout(function(){t.loadComplete("force")},100)}),n("#tombioKBReport").append(n("<h3>").text("First fix these knowledge-base problems...")),n("#tombioKBReport").append(n("<p>").html("Some problems were found with the knowledge-base. They should be easy enough to fix. Read on for more details and guidance.")),n("#tombioKBReport").append(n("<p>").html("When you've fixed one or more problems, use the <i>Save worksheets as CSV<\/i> button on the KB to regenerate the CSVs and then click the <i>Reload<\/i> button above.")),n("#tombioKBReport").append(n("<p>").html("The problems are colour-coded according to the schema shown below:")),i=n("<ul>"),i.append(n('<li class="tombioValid3">').html("These are serious problems that could cause the visualisation software to malfunction.")),i.append(n('<li class="tombioValid2">').html("These problems are not likely to cause the visualisation software to malfunction, but you might not see what you expect.")),i.append(n('<li class="tombioValid1">').html("These are for information only - it may be what you intended to do, but if not, you may as well sort them out. These will not cause the visualisation software to malfunction.")),n("#tombioKBReport").append(i),i=n("<ul>"),p("title","You must specify a title for the KB (Key - title). This is used to generate a citation.")||(o=!1),p("year","You must specify a year for the KB (Key - year). This is used to generate a citation.")||(o=!1),p("authors","You must specify one or more authors for the KB (Key - authors). This is used to generate a citation. Authors will appear in the citation exactly as you specify them.")||(o=!1),p("version","You must specify a version for the KB (Key - version). This is used to generate a citation.")||(o=!1),o||(n("#tombioKBReport").append(n("<h4>").text("On the config worksheet...")),n("#tombioKBReport").append(i)),i=n("<ul>"),t.taxa[0].Taxon||(i.append(n('<li class="tombioValid3">').html("There must be a column called <i>Taxon<\/i> (case sensitive) which stores the names of the taxa you are working with.")),e=!1),tt=/^[a-zA-Z0-9\-_]+$/,Object.keys(t.taxa[0]).forEach(function(t,r){tt.test(t)||(i.append(n('<li class="tombioValid3">').html("<b>'"+t+"'<\/b> (column "+(r+1)+") is not a valid identifier for a character. Use only alphanumerics with no spaces.")),e=!1)}),it=/^(\d+(\.\d*)?|\.\d+)$/,rt=/^\[(\d+(\.\d*)?|\.\d+)-(\d+(\.\d*)?|\.\d+)\]$/,ot.forEach(function(u){t.taxa.forEach(function(t){r=t[u];r||r==""||console.log(t.Taxon,u,r);r==""||r=="n/a"||r=="?"||r.substr(0,1)=="#"||it.test(r)||rt.test(r)||(i.append(n('<li class="tombioValid3">').html("The value <b>'"+r+"'<\/b> is not a valid for the numeric character <b>'"+u+"'<\/b> and taxon <b>'"+t.Taxon+"'<\/b>. Values must be a number or a range in the form '[x-y]'. (Other permitted values are '?', 'n/a' and no value.)")),e=!1)})}),ut=/^\[[^-]+-[^-]+\]$/,st.forEach(function(u){t.taxa.forEach(function(f){var s,o,h;r=f[u];s=!1;r==""||r=="n/a"||r=="?"||r.substr(0,1)=="#"||(o=t.values.filter(function(n){return n.Character==u}),h=r.split("|").forEach(function(t){var h=!0,r,s;t=t.trim();t.length>3&&(t.substr(t.length-3,3)=="(m)"||t.substr(t.length-3,3)=="(f)")&&(t=t.substr(0,t.length-3).trim());r=ut.test(t)?t.slice(1,-1).split("-").slice(0,2):[t];r.forEach(function(t){t=t.trim();var r=o.filter(function(n){return n.CharacterState==t});r.length==0&&(i.append(n('<li class="tombioValid2">').html("The value <b>'"+t+"'<\/b> for character <b>'"+u+"'<\/b> and taxon <b>'"+f.Taxon+"'<\/b> is not represented in the values worksheet. All character state values for ordinal and ordinalCircular characters must be represented on the values worksheet.")),e=!1,h=!1)});h&&r.length==2&&ht.indexOf(u)==-1&&(s=o.map(function(n){return n.CharacterState}),s.indexOf(r[0])>s.indexOf(r[1])&&(i.append(n('<li class="tombioValid2">').html("The ordinal range <b>'"+t+"'<\/b> for character <b>'"+u+"'<\/b> and taxon <b>'"+f.Taxon+"'<\/b> is not valid since the start of the range appears after the end in the ordinal values expressed on the values worksheet for this character.")),e=!1))}))})}),e||(n("#tombioKBReport").append(n("<h4>").text("On the taxa worksheet...")),n("#tombioKBReport").append(i)),i=n("<ul>"),w=t.characters.filter(function(n){return n.Character=="Taxon"}),w.length>0&&w[0].Group!="Taxonomy"&&(i.append(n('<li class="tombioValid3">').html("The Taxon character must have a Group value of 'Taxonomy'. It is currently set to '"+w[0].Group+"'.")),u=!1),c.forEach(function(t,r){y.indexOf(t)==-1&&(i.append(n('<li class="tombioValid3">').html("There is no row on the <i>characters<\/i> worksheet for the character <b>'"+t+"'<\/b> represented by a column (column "+(r+1)+") on the <i>taxa<\/i> worksheet. All columns on the <i>taxa<\/i> tab must be represented by a row in the <i>characters<\/i> worksheet regardless of whether or not they are used. Names are case sensitive. Note that rows will not be seen unless the <b>Group<\/b> column has a value.")),u=!1)}),y.forEach(function(t){c.indexOf(t)==-1&&(i.append(n('<li class="tombioValid2">').html("There is no column on the <i>taxa<\/i> worksheet for the character <b>'"+t+"'<\/b> which is represented in the <i>characters<\/i> worksheet.")),u=!1)}),t.characters.filter(function(n){return n.Status=="key"}).forEach(function(t){var r=!0,f=!0,e,o;/^([1-9]|10)$/.test(t.Weight)||(i.append(n('<li class="tombioValid3">').html("You must specify a 'Weight' value for <b>'"+t.Character+"'<\/b> because it has a 'Status' value of 'key'.")),u=!1);e=/^([0-9]|10)$/;t.ValueType!="numeric"&&t.ValueType!="ordinal"&&t.ValueType!="ordinalCircular"||e.test(t.Strictness)||(i.append(n('<li class="tombioValid3">').html("For numeric, ordinal and ordinalCircular characters, you must specify a 'Strictness' value of between 0 and 10. There is an invalid 'Strictness' value for <b>'"+t.Character+"'<\/b>.")),u=!1);["numeric","ordinal","ordinalCircular","text"].indexOf(t.ValueType)==-1&&(i.append(n('<li class="tombioValid3">').html("<b>'"+t.ValueType+"'<\/b>  is an invalid 'ValueType' value for <b>'"+t.Character+"'<\/b>. You must specify a valid 'ValueType' because it has a 'Status' value of 'key'.")),r=!1,u=!1);["single","multi","spin"].indexOf(t.ControlType)==-1&&(i.append(n('<li class="tombioValid3">').html("<b>'"+t.ControlType+"'<\/b> is an invalid 'ControlType' value for <b>'"+t.Character+"'<\/b>. You must specify a valid 'ControlType' because it has a 'Status' value of 'key'.")),f=!1,u=!1);r&&f&&{numeric:["spin"],text:["single","multi"],ordinal:["single","multi"],ordinalCircular:["single","multi"]}[t.ValueType].indexOf(t.ControlType)==-1&&(i.append(n('<li class="tombioValid3">').html("Invalid combination of 'ValueType' <b>('"+t.ValueType+"')<\/b> and 'ControlType' <b>('"+t.ControlType+"')<\/b> for <b>'"+t.Character+"'<\/b>. You must specify a valid combination because it has a 'Status' value of 'key'.")),u=!1);t.ControlType=="spin"&&(o=/^(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+)$/,o.test(t.Params)||(i.append(n('<li class="tombioValid3">').html("<b>'"+t.Params+"'<\/b> is an invalid spin control 'Param' value for <b>'"+t.Character+"'<\/b>. It must have the form 'n,n,n' (where n can be any valid numeric value, including decimal).")),u=!1));t.HelpShort&&!t.Help&&(i.append(n('<li class="tombioValid2">').html("A value for 'HelpShort' is set but there is no value for 'Help' for <b>'"+t.Character+"'<\/b>. You can set 'Help' without setting 'HelpShort', but not the other way around.")),u=!1)}),u||(n("#tombioKBReport").append(n("<h4>").text("On the characters worksheet...")),n("#tombioKBReport").append(i)),i=n("<ul>"),et=n("<ul>"),k.forEach(function(t){y.indexOf(t)==-1&&(i.append(n('<li class="tombioValid2">').html("There is no row on the <i>characters<\/i> worksheet for the character <b>'"+t+"'<\/b> represented in the <i>values<\/i> worksheet.")),a=!1)}),t.values.forEach(function(t){t.StateHelpShort&&!t.StateHelp&&(i.append(n('<li class="tombioValid2">').html("A value for 'StateHelpShort' is set but there is no value for 'StateHelp' for <b>'"+t.Character+" - "+t.CharacterState+"'<\/b>. You can set 'StateHelp' without setting 'StateHelpShort', but not the other way around.")),a=!1)}),a||(n("#tombioKBReport").append(n("<h4>").text("On the values worksheet...")),n("#tombioKBReport").append(i)),i=n("<ul>"),t.media.filter(function(n){return n.Type=="image-local"}).forEach(function(r){if(r.Character!=""&&y.indexOf(r.Character)==-1?(i.append(n('<li class="tombioValid2">').html("An image is specified for the character <b>'"+r.Character+"'<\/b> on the media worksheet, but that character is not on the characters worksheet.")),h=!1):r.Character!="",r.State!=""&&r.Character==""&&(i.append(n('<li class="tombioValid2">').html("An image is specified for the state value <b>'"+r.State+"'<\/b> on the media worksheet, but no character is specified.")),h=!1),r.State!=""&&r.Character!=""){var u=t.values.filter(function(n){return r.Character==n.Character&&r.State==n.CharacterState});(u.length==0||u[0].StateHelp=="")&&(i.append(n('<li class="tombioValid2">').html("An image is specified for the character <b>'"+r.Character+"'<\/b> and state <b>'"+r.State+"'<\/b> on the media worksheet, but no corresponding pair is found with help text on the values worksheet, so it won't be displayed.")),h=!1)}}),h||(n("#tombioKBReport").append(n("<h4>").text("On the media worksheet...")),n("#tombioKBReport").append(i)),i=n("<ul>"),f=t.characters.filter(function(n){return n.Group=="Taxonomy"}),l=f.length>1?f[f.length-1].Character:null,l&&l!="Taxon"&&(i.append(n('<li class="tombioValid3">').html("The last Taxonomy row representing '"+l+"' on the characters worksheet appears below the row representing 'Taxon' - it must come above.")),v=!1),l=="Taxon"&&f.length>2)for(s=f.length-2;s>0;s--){var b=f[s].Character,d=f[s].Label,ft=f[s-1].Character,g=f[s-1].Label,nt=[];t.taxa.forEach(function(n){n[b]!=""&&nt.indexOf(n[b])==-1&&nt.push(n[b])});nt.forEach(function(r){var u=[],f=t.taxa.filter(function(n){return n[b]==r});f.forEach(function(n){u.indexOf(n[ft])==-1&&u.push(n[ft])});u.length>1&&(i.append(n('<li class="tombioValid3">').html("Taxa of "+d+" "+r+" are represented by more than one "+g+", breaking the rules of a strict hierarchical taxonomy. Check that the taxonomy columns are specified in the correct order on the characters worksheet  (at the moment "+g+" is specified at a higher level than "+d+"). If they are, then check the values for "+g+" and "+d+" on the taxa worksheet.")),v=!1)})}return v||(n("#tombioKBReport").append(n("<h4>").text("Taxonomy problems...")),n("#tombioKBReport").append(i)),e&&u&&a&&h&&o&v?!0:(n("#tombioKBReport").show(),n("#downloadspin").hide(),!1)}})(jQuery,this.tombiovis);