(function(n,t){"use strict";var r="vis2",i=t[r]={};i.Obj=function(n,t,i){i.visP.Obj.call(this,r,n,t,i);this.metadata.title="Single-column key";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.0"};i.Obj.prototype=Object.create(t.visP.Obj.prototype);i.Obj.prototype.initialise=function(){var n=this;this.charStateInput=!0;this.helpFiles=[t.tombiopath+"vis2/vis2Help.html",t.tombiopath+"common/taxonDetailsHelp.html",t.tombiopath+"common/stateInputHelp.html"];this.showWeightedScores=!0;this.displayToolTips=!0;d3.select("#"+this.visName).append("svg").attr("id","vis2Svg")};i.Obj.prototype.refresh=function(){var i=this,r=34,u=2,l=16,nt=r-2*u,h=r/2-2*u,p=d3.scaleLinear().domain([-1,0,1]).range(i.scoreColours),w=d3.max(this.taxa,function(n){return n.scoreoverall}),b=d3.min(this.taxa,function(n){return n.scoreoverall}),k=d3.scaleLinear().domain([b,0,w]).range(i.scoreColours),s=[],c,e,f,o,a;for(this.taxa.forEach(function(n){s.push(n)}),this.sortTaxa(s,"lastPosition"),c=0;c<s.length;c++)s[c].lastPosition=c;e=0;s.forEach(function(n){d3.select("#vis2Svg").append("text").attr("class","scientificnames tmpTaxonText").style("opacity",0).text(n.Taxon)});d3.selectAll(".tmpTaxonText").each(function(){var n=this.getBBox();n.width>e&&(e=n.width)});e+=u*7+2*h+l;d3.selectAll(".tmpTaxonText").remove();f=0;o=[];this.characters.forEach(function(n){n.stateSet&&o.push(n)});o.forEach(function(n){d3.select("#vis2Svg").append("text").attr("class","type2VisCharacter tmpCharacterText").style("opacity",0).text(n.Label)});d3.selectAll(".tmpCharacterText").each(function(){var n=this.getBBox();n.width>f&&(f=n.width)});d3.selectAll(".tmpCharacterText").remove();var v=d3.select("#vis2Svg").selectAll(".type2VisTaxon").data(s,function(n){return n.Taxon}),d=v.enter(),g=v.exit(),y=d.append("g").attr("class","type2VisTaxon").style("opacity",0).each(function(r){d3.select(this).append("rect").attr("class","taxarect");d3.select(this).append("text").attr("class","scientificnames").text(function(){return r.Taxon}).style("cursor","pointer").on("click",function(){i.fullDetails(r.Taxon,0)});n(".scientificnames").tooltip({track:!0,items:"text",content:function(){if(i.displayToolTips)return i.getTaxonTipImage(this.textContent)}});d3.select(this).append("rect").attr("class","type2VisOverallInd").attr("width",(h+u)*2).attr("height",h*2).attr("x",u).attr("title","Overall weighted score");d3.select(this).append("text").attr("class","type2VisOverallIndText").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",u+h).attr("opacity",0).attr("text",0).attr("cursor","default").attr("title","Overall weighted score");d3.select(this).append("svg:image").attr("xlink:href",t.tombiopath+"resources/camera.png").attr("class","taxonImageLink").attr("width",l).attr("height",l).attr("x",function(){return u*5+h*2}).style("display",function(){var n=i.media.filter(function(n){if(n.Taxon==r.Taxon.value)return!0});return n.length>0?null:"none"}).on("click",function(){var t=n("#tombioMain").offset(),u=d3.event.clientX-t.left+document.body.scrollLeft,f=d3.event.clientY-t.top+document.body.scrollTop;i.fullDetails(r.Taxon,1,u,f)})}).merge(v);y.transition().duration(1e3).style("opacity",1).each(function(n,t){d3.select(this).select(".taxarect").transition().duration(1e3).attr("x",function(){return 0}).attr("y",function(){return f+t*r+u}).attr("width",function(){return e+u+o.length*r}).attr("height",function(){return r-2*u});d3.select(this).select(".scientificnames").transition().duration(1e3).attr("x",function(){var n=this.getBBox();return e-n.width}).attr("y",function(){var n=this.getBBox();return f+t*r+n.height+(r-n.height)/3});d3.select(this).select(".type2VisOverallInd").transition().duration(1e3).attr("y",function(){return f+2*u+t*r}).attr("fill",function(){return k(n.scoreoverall)});d3.select(this).select(".type2VisOverallIndText").transition().duration(1e3).attr("y",function(){return f+(t+.5)*r}).attr("text",function(){var t=n.scoreoverall*100;t=Math.round(t)/100;d3.select(this).text(t)}).attr("opacity",1);d3.select(this).select(".taxonImageLink").transition().duration(1e3).attr("y",function(){var n=(r-2*u-l)/2;return f+t*r+u+n})});g.transition().duration(1e3).style("opacity",0).remove();n(".type2VisOverallInd").tooltip();n(".type2VisOverallIndText").tooltip();y.each(function(n,t){var l=t,s=n,h=n.Taxon.value.replace(/[\/|&;$%@"<>()+:.,' ]/g,""),c=d3.select(this).selectAll(".type2VisIndicators-"+h).data(o,function(n){return n.Character+"-"+h});c.enter().append("g").attr("class","type2VisIndicators-"+h).style("cursor","pointer").on("click",function(n){i.showCharacterScoreDetails(s,n)}).each(function(){d3.select(this).append("circle").attr("r",r/2-2*u).attr("class","type2VisInd").attr("fill","white").style("opacity",0);d3.select(this).append("text").style("opacity",0).attr("class","type2VisIndtext").attr("text-anchor","middle").attr("alignment-baseline","central")}).merge(c).each(function(n,t){d3.select(this).select(".type2VisInd").transition().duration(1e3).attr("cx",function(){return e+u+(t+.5)*r}).attr("cy",function(){return f+(l+.5)*r}).attr("fill",function(){return p(s.matchscore[n.Character].scoreoverall)}).style("opacity",1);d3.select(this).select(".type2VisIndtext").transition().duration(1e3).attr("text",function(){var r,t;r=i.showWeightedScores?Number(i.oCharacters[n.Character].Weight)/10:1;t=s.matchscore[n.Character].scoreoverall*r*10;t=Math.floor(t)/10;d3.select(this).text(t)}).attr("x",function(){return e+u+(t+.5)*r}).attr("y",function(){return f+(l+.5)*r}).style("opacity",1)});c.exit().transition().duration(1e3).style("opacity",0).remove()});a=d3.select("#vis2Svg").selectAll(".type2VisCharacter").data(o,function(n){return n.Character});a.enter().append("text").attr("class","type2VisCharacter").style("opacity",0).text(function(n){return n.Label}).merge(a).transition().duration(1e3).style("opacity",1).attr("x",function(n,t){return e+u+(t+.5)*r}).attr("y",function(){var n=this.getBBox();return f-n.width}).attr("transform",function(n,t){var i=this.getBBox(),o=e+u+(t+.5)*r,s=f-i.width;return"rotate(90 "+o+","+s+")"});a.exit().transition().duration(1e3).attr("x",0).attr("y",0).style("opacity",0).remove();d3.select("#vis2Svg").transition().duration(1e3).attr("width",function(){return e+u+o.length*r}).attr("height",function(){return f+i.taxa.length*r});this.showWeightedScores?(this.contextMenu.removeItem("Show weighted scores"),this.contextMenu.addItem("Show unweighted scores",function(){i.showWeightedScores=!1;i.refresh()},[this.visName])):(this.contextMenu.removeItem("Show unweighted scores"),this.contextMenu.addItem("Show weighted scores",function(){i.showWeightedScores=!0;i.refresh()},[this.visName]));this.displayToolTips?(this.contextMenu.addItem("Remove taxon image tooltips",function(){i.displayToolTips=!1;i.contextMenu.removeItem("Remove taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Display taxon image tooltips")):(this.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0;i.contextMenu.removeItem("Display taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Remove taxon image tooltips"))}})(jQuery,this.tombiovis);