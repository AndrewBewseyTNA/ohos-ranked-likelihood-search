(function(n,t){"use strict";function f(){var n=[];n.push("selectedTool="+u);Array.prototype.push.apply(n,t.f.setParamsFromControls());n.push("weighted="+i.showWeightedScores);n.push("imgtips="+i.displayToolTips);i.createViewURL(n)}var u="vis2",r=t.v.visualisations[u]=Object.create(t.v.visPjQueryUILargeFormat),i;r.initialise=function(){i=this;this.metadata.title="Single-column key";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.1";this.charStateInput=!0;this.helpFiles=[t.opts.tombiopath+"vis2/vis2Help.html",t.opts.tombiopath+"common/taxonDetailsHelp.html",t.opts.tombiopath+"common/full-details.html",t.opts.tombiopath+"common/stateInputHelp.html"];this.showWeightedScores=!0;this.displayToolTips=!0;d3.select("#"+this.visName).append("svg").attr("id","vis2Svg");t.gui.sharedKeyInput||(t.gui.sharedKeyInput=Object.create(t.gui.keyInput),t.gui.sharedKeyInput.init(n("#tombioGuiMain1Controls")));r.inputControl=t.gui.sharedKeyInput};r.refresh=function(){var o,e,s,a;i=this;var r=34,u=2,c=16,nt=r-2*u,h=r/2-2*u,p=d3.scaleLinear().domain([-1,0,1]).range(i.scoreColours),w=d3.max(t.d.taxa,function(n){return n.visState.score.overall}),b=d3.min(t.d.taxa,function(n){return n.visState.score.overall}),k=d3.scaleLinear().domain([b,0,w]).range(i.scoreColours),l=[];t.d.taxa.forEach(function(n){l.push(n)});this.sortTaxa(l);o=0;l.forEach(function(n){d3.select("#vis2Svg").append("text").attr("class","scientificnames tmpTaxonText").style("opacity",0).text(n.Taxon)});d3.selectAll(".tmpTaxonText").each(function(){var n=this.getBBox();n.width>o&&(o=n.width)});o+=u*7+2*h+c;d3.selectAll(".tmpTaxonText").remove();e=0;s=[];t.d.characters.forEach(function(n){n.stateSet&&s.push(n)});s.forEach(function(n){d3.select("#vis2Svg").append("text").attr("class","type2VisCharacter tmpCharacterText").style("opacity",0).text(n.Label)});d3.selectAll(".tmpCharacterText").each(function(){var n=this.getBBox();n.width>e&&(e=n.width)});d3.selectAll(".tmpCharacterText").remove();var v=d3.select("#vis2Svg").selectAll(".type2VisTaxon").data(l,function(n){return n.Taxon}),d=v.enter(),g=v.exit(),y=d.append("g").attr("class","type2VisTaxon").style("opacity",0).each(function(r){d3.select(this).append("rect").attr("class","taxarect");d3.select(this).append("text").attr("class","scientificnames").text(function(){return r.Taxon}).style("cursor","pointer").on("click",function(){i.createFullDetailsDialog(r.Taxon,0)});n(".scientificnames").tooltip({track:!0,items:"text",content:function(){if(i.displayToolTips)return i.getTaxonTipImage(this.textContent)}});d3.select(this).append("rect").attr("class","type2VisOverallInd").attr("width",(h+u)*2).attr("height",h*2).attr("x",u).attr("title","Overall weighted score");d3.select(this).append("text").attr("class","type2VisOverallIndText").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",u+h).attr("opacity",0).attr("text",0).attr("cursor","default").attr("title","Overall weighted score");d3.select(this).append("svg:image").attr("xlink:href",t.opts.tombiopath+"resources/camera.png").attr("class","taxonImageLink").attr("width",c).attr("height",c).attr("x",function(){return u*5+h*2}).style("display",function(){var n=t.d.media.filter(function(n){if(n.Taxon==r.Taxon.kbValue)return!0});return n.length>0?null:"none"}).on("click",function(){var t=n("#tombioGuiMain1").offset(),u=d3.event.clientX-t.left+document.body.scrollLeft,f=d3.event.clientY-t.top+document.body.scrollTop;i.createFullDetailsDialog(r.Taxon,1,u,f)})}).merge(v);y.transition().duration(1e3).style("opacity",1).each(function(n,t){d3.select(this).select(".taxarect").transition().duration(1e3).attr("x",function(){return 0}).attr("y",function(){return e+t*r+u}).attr("width",function(){return o+u+s.length*r}).attr("height",function(){return r-2*u});d3.select(this).select(".scientificnames").transition().duration(1e3).attr("x",function(){var n=this.getBBox();return o-n.width}).attr("y",function(){var n=this.getBBox();return e+t*r+n.height+(r-n.height)/3});d3.select(this).select(".type2VisOverallInd").transition().duration(1e3).attr("y",function(){return e+2*u+t*r}).attr("fill",function(){return k(n.visState.score.overall)});d3.select(this).select(".type2VisOverallIndText").transition().duration(1e3).attr("y",function(){return e+(t+.5)*r}).attr("text",function(){var t=n.visState.score.overall*100;t=Math.round(t)/100;d3.select(this).text(t)}).attr("opacity",1);d3.select(this).select(".taxonImageLink").transition().duration(1e3).attr("y",function(){var n=(r-2*u-c)/2;return e+t*r+u+n})});g.transition().duration(1e3).style("opacity",0).remove();n(".type2VisOverallInd").tooltip();n(".type2VisOverallIndText").tooltip();y.each(function(n,f){var a=f,h=n,c=n.Taxon.kbValue.replace(/[\/|&;$%@"<>()+:.,' ]/g,""),l=d3.select(this).selectAll(".type2VisIndicators-"+c).data(s,function(n){return n.Character+"-"+c});l.enter().append("g").attr("class","type2VisIndicators-"+c).style("cursor","pointer").on("click",function(n){i.createCharacterScoreDialog(h,n)}).each(function(){d3.select(this).append("circle").attr("r",r/2-2*u).attr("class","type2VisInd").attr("fill","white").style("opacity",0);d3.select(this).append("text").style("opacity",0).attr("class","type2VisIndtext").attr("text-anchor","middle").attr("alignment-baseline","central")}).merge(l).each(function(n,f){d3.select(this).select(".type2VisInd").transition().duration(1e3).attr("cx",function(){return o+u+(f+.5)*r}).attr("cy",function(){return e+(a+.5)*r}).attr("fill",function(){return p(h[n.Character].score.overall)}).style("opacity",1);d3.select(this).select(".type2VisIndtext").transition().duration(1e3).attr("text",function(){var u,r;u=i.showWeightedScores?Number(t.d.oCharacters[n.Character].Weight)/10:1;r=h[n.Character].score.overall*u*10;r=Math.floor(r)/10;d3.select(this).text(r)}).attr("x",function(){return o+u+(f+.5)*r}).attr("y",function(){return e+(a+.5)*r}).style("opacity",1)});l.exit().transition().duration(1e3).style("opacity",0).remove()});a=d3.select("#vis2Svg").selectAll(".type2VisCharacter").data(s,function(n){return n.Character});a.enter().append("text").attr("class","type2VisCharacter").style("opacity",0).text(function(n){return n.Label}).merge(a).transition().duration(1e3).style("opacity",1).attr("x",function(n,t){return o+u+(t+.5)*r}).attr("y",function(){var n=this.getBBox();return e-n.width}).attr("transform",function(n,t){var i=this.getBBox(),f=o+u+(t+.5)*r,s=e-i.width;return"rotate(90 "+f+","+s+")"});a.exit().transition().duration(1e3).attr("x",0).attr("y",0).style("opacity",0).remove();d3.select("#vis2Svg").transition().duration(1e3).attr("width",function(){return o+u+s.length*r}).attr("height",function(){return e+t.d.taxa.length*r});this.contextMenu.addItem("Get URL for single-column key",function(){f()},[this.visName]);this.showWeightedScores?(this.contextMenu.removeItem("Show weighted scores"),this.contextMenu.addItem("Show unweighted scores",function(){i.showWeightedScores=!1;i.refresh()},[this.visName])):(this.contextMenu.removeItem("Show unweighted scores"),this.contextMenu.addItem("Show weighted scores",function(){i.showWeightedScores=!0;i.refresh()},[this.visName]));this.displayToolTips?(this.contextMenu.addItem("Remove taxon image tooltips",function(){i.displayToolTips=!1;i.contextMenu.removeItem("Remove taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Display taxon image tooltips")):(this.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0;i.contextMenu.removeItem("Display taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Remove taxon image tooltips"))};r.urlParams=function(r){r.weighted&&(i.showWeightedScores=r.weighted==="true");r.imgtips&&(i.displayToolTips=r.imgtips==="true");t.f.initControlsFromParams(r);setTimeout(function(){var t=n("#tombioGuiMain1Controls").width();n("#tombioGuiMain1ControlsAndTaxa").css("min-width",t+n("#vis2Svg").width()+50)},700)}})(jQuery,this.tombiovis);