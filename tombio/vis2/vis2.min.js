(function(n,t){"use strict";function f(){var n=[];n.push("selectedTool="+u);Array.prototype.push.apply(n,t.f.setParamsFromControls());n.push("weighted="+i.showWeightedScores);n.push("imgtips="+i.displayToolTips);i.createViewURL(n)}var u="vis2",r=t.v.visualisations[u]=Object.create(t.v[t.opts.toolconfig[u].prototype]),i;r.initialise=function(){i=this;this.metadata.title="Single-column key";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.1";this.helpFiles=[t.opts.tombiopath+"vis2/vis2Help.html",t.opts.tombiopath+"common/taxonDetailsHelp.html",t.opts.tombiopath+"common/full-details.html",t.opts.tombiopath+"common/stateInputHelp.html"];this.showWeightedScores=!0;this.displayToolTips=!0;d3.select("#"+this.visName).append("svg").attr("id","vis2Svg");var u=t.opts.toolconfig[this.visName].keyinput;t.gui.sharedKeyInput[u]||(t.gui.sharedKeyInput[u]=Object.create(t.gui[u]),t.gui.sharedKeyInput[u].init(n(t.gui.main.divInput)));r.inputControl=t.gui.sharedKeyInput[u]};r.refresh=function(){var s,o,h,v;i=this;var r=34,e=2,l=16,tt=r-2*e,c=r/2-2*e,w=d3.scaleLinear().domain([-1,0,1]).range(t.d.scoreColours),b=d3.max(t.d.taxa,function(n){return n.visState.score.overall}),k=d3.min(t.d.taxa,function(n){return n.visState.score.overall}),d=d3.scaleLinear().domain([k,0,b]).range(t.d.scoreColours),a=[];t.d.taxa.forEach(function(n){a.push(n)});t.f.sortTaxa(a);s=0;a.forEach(function(n){d3.select("#vis2Svg").append("text").attr("class","scientificnames tmpTaxonText").style("opacity",0).text(n.Taxon)});d3.selectAll(".tmpTaxonText").each(function(){var n=this.getBBox();n.width>s&&(s=n.width)});s+=e*7+2*c+l;d3.selectAll(".tmpTaxonText").remove();o=0;h=[];t.d.characters.forEach(function(n){n.stateSet&&h.push(n)});h.forEach(function(n){d3.select("#vis2Svg").append("text").attr("class","type2VisCharacter tmpCharacterText").style("opacity",0).text(n.Label)});d3.selectAll(".tmpCharacterText").each(function(){var n=this.getBBox();n.width>o&&(o=n.width)});d3.selectAll(".tmpCharacterText").remove();var y=d3.select("#vis2Svg").selectAll(".type2VisTaxon").data(a,function(n){return n.Taxon}),g=y.enter(),nt=y.exit(),p=g.append("g").attr("class","type2VisTaxon").style("opacity",0).each(function(r){d3.select(this).append("rect").attr("class","taxarect");d3.select(this).append("text").attr("class","scientificnames").text(function(){return r.Taxon}).style("cursor","pointer").on("click",function(){i.showFullDetails(r.Taxon,0)});t.opts.toolconfig[u].prototype=="visPjQueryUILargeFormat"&&n(".scientificnames").tooltip({track:!0,items:"text",content:function(){if(i.displayToolTips)return t.f.getTaxonTipImage(this.textContent,this)},open:function(t,i){var r=n(t.target);i.tooltip.click(function(){r.tooltip("close")})}});d3.select(this).append("rect").attr("class","type2VisOverallInd").attr("width",(c+e)*2).attr("height",c*2).attr("x",e).attr("title","Overall weighted score");d3.select(this).append("text").attr("class","type2VisOverallIndText").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",e+c).attr("opacity",0).attr("text",0).attr("cursor","default").attr("title","Overall weighted score");d3.select(this).append("svg:image").attr("xlink:href",t.opts.tombiopath+"resources/camera.png").attr("class","taxonImageLink").attr("width",l).attr("height",l).attr("x",function(){return e*5+c*2}).style("display",function(){var n=t.d.media.filter(function(n){if(n.Taxon==r.Taxon.kbValue)return!0});return n.length>0?null:"none"}).on("click",function(){i.showFullDetails(r.Taxon,1)})}).merge(y);p.transition().duration(1e3).style("opacity",1).each(function(n,t){d3.select(this).select(".taxarect").transition().duration(1e3).attr("x",function(){return 0}).attr("y",function(){return o+t*r+e}).attr("width",function(){return s+e+h.length*r}).attr("height",function(){return r-2*e});d3.select(this).select(".scientificnames").transition().duration(1e3).attr("x",function(){var n=this.getBBox();return s-n.width}).attr("y",function(){var n=this.getBBox();return o+t*r+n.height+(r-n.height)/3});d3.select(this).select(".type2VisOverallInd").transition().duration(1e3).attr("y",function(){return o+2*e+t*r}).attr("fill",function(){return d(n.visState.score.overall)});d3.select(this).select(".type2VisOverallIndText").transition().duration(1e3).attr("y",function(){return o+(t+.5)*r}).attr("text",function(){var t=n.visState.score.overall*100;t=Math.round(t)/100;d3.select(this).text(t)}).attr("opacity",1);d3.select(this).select(".taxonImageLink").transition().duration(1e3).attr("y",function(){var n=(r-2*e-l)/2;return o+t*r+e+n})});nt.transition().duration(1e3).style("opacity",0).remove();this.tooltip(".type2VisOverallInd");this.tooltip(".type2VisOverallIndText");p.each(function(n,u){var a=u,f=n,c=t.f.taxonTag(n.Taxon.kbValue),l=d3.select(this).selectAll(".type2VisIndicators-"+c).data(h,function(n){return n.Character+"-"+c});l.enter().append("g").attr("class","type2VisIndicators-"+c).style("cursor","pointer").on("click",function(n){i.showCharacterScore(f,n)}).each(function(){d3.select(this).append("circle").attr("r",r/2-2*e).attr("class","type2VisInd").attr("fill","white").style("opacity",0);d3.select(this).append("text").style("opacity",0).attr("class","type2VisIndtext").attr("text-anchor","middle").attr("alignment-baseline","central")}).merge(l).each(function(n,u){d3.select(this).select(".type2VisInd").transition().duration(1e3).attr("cx",function(){return s+e+(u+.5)*r}).attr("cy",function(){return o+(a+.5)*r}).attr("fill",function(){return w(f[n.Character].score.overall)}).style("opacity",1);d3.select(this).select(".type2VisIndtext").transition().duration(1e3).attr("text",function(){var u,r;u=i.showWeightedScores?Number(t.d.oCharacters[n.Character].Weight)/10:1;r=f[n.Character].score.overall*u*10;r=Math.floor(r)/10;d3.select(this).text(r)}).attr("x",function(){return s+e+(u+.5)*r}).attr("y",function(){return o+(a+.5)*r}).style("opacity",1)});l.exit().transition().duration(1e3).style("opacity",0).remove()});v=d3.select("#vis2Svg").selectAll(".type2VisCharacter").data(h,function(n){return n.Character});v.enter().append("text").attr("class","type2VisCharacter").style("opacity",0).text(function(n){return n.Label}).merge(v).transition().duration(1e3).style("opacity",1).attr("x",function(n,t){return s+e+(t+.5)*r}).attr("y",function(){var n=this.getBBox();return o-n.width}).attr("transform",function(n,t){var i=this.getBBox(),u=s+e+(t+.5)*r,f=o-i.width;return"rotate(90 "+u+","+f+")"});v.exit().transition().duration(1e3).attr("x",0).attr("y",0).style("opacity",0).remove();d3.select("#vis2Svg").transition().duration(1e3).attr("width",function(){return s+e+h.length*r}).attr("height",function(){return o+t.d.taxa.length*r});this.contextMenu.addItem("Get URL for single-column key",function(){f()},[this.visName]);this.showWeightedScores?(this.contextMenu.removeItem("Show weighted scores"),this.contextMenu.addItem("Show unweighted scores",function(){i.showWeightedScores=!1;i.refresh()},[this.visName])):(this.contextMenu.removeItem("Show unweighted scores"),this.contextMenu.addItem("Show weighted scores",function(){i.showWeightedScores=!0;i.refresh()},[this.visName]));this.displayToolTips?(this.contextMenu.addItem("Remove taxon image tooltips",function(){i.displayToolTips=!1;i.contextMenu.removeItem("Remove taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Display taxon image tooltips")):(this.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0;i.contextMenu.removeItem("Display taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Remove taxon image tooltips"))};r.urlParams=function(n){n.weighted&&(i.showWeightedScores=n.weighted==="true");n.imgtips&&(i.displayToolTips=n.imgtips==="true");t.f.initControlsFromParams(n)};r.show=function(){n("#vis2").show();r.inputControl.$div.show();r.inputControl.initFromCharacterState()};r.hide=function(){n("#vis2").hide();r.inputControl.$div.hide()}})(jQuery,this.tombiovis);