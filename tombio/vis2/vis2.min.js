(function(n,t){"use strict";function f(){var n=[];n.push("selectedTool="+u);Array.prototype.push.apply(n,t.f.setParamsFromControls());n.push("weighted="+i.showWeightedScores);n.push("imgtips="+i.displayToolTips);t.f.createViewURL(n)}var u="vis2",r=t.v.visualisations[u]=Object.create(t.v.visP),i;r.visName=u;r.initialise=function(){i=this;this.metadata.title="Single-column key";this.metadata.year="2016";this.metadata.authors="Burkmar, R";this.metadata.publisher="Field Studies Council";this.metadata.location="Shrewsbury, England";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.1";this.helpFiles=[t.opts.tombiopath+"vis2/vis2Help.html",t.opts.tombiopath+"common/taxonDetailsHelp.html",t.opts.tombiopath+"common/full-details.html",t.opts.tombiopath+"common/stateInputHelp.html"];this.showWeightedScores=!0;this.displayToolTips=!0;d3.select("#"+this.visName).append("svg").attr("id","vis2Svg");var f=t.opts.toolconfig[this.visName].keyinput;t.gui.sharedKeyInput[f]||(t.gui.sharedKeyInput[f]=Object.create(t.gui[f]),t.gui.sharedKeyInput[f].init(n(t.gui.main.divInput)));r.inputControl=t.gui.sharedKeyInput[f];this.initialised=!0;t.f.checkInterface(u,t.templates.visTemplate,t.v.visualisations[u])};r.refresh=function(){var e,u,o,l;i=this;var n=34,r=2,h=16,g=n-2*r,s=n/2-2*r,y=d3.scaleLinear().domain([-1,0,1]).range(t.d.scoreColours),p=d3.max(t.d.taxa,function(n){return n.visState.score.overall}),w=d3.min(t.d.taxa,function(n){return n.visState.score.overall}),b=d3.scaleLinear().domain([w,0,p]).range(t.d.scoreColours),c=[];t.d.taxa.forEach(function(n){c.push(n)});t.f.sortTaxa(c);e=0;c.forEach(function(n){d3.select("#vis2Svg").append("text").attr("class","scientificnames tmpTaxonText").style("opacity",0).text(n.Taxon)});d3.selectAll(".tmpTaxonText").each(function(){var n=this.getBBox();n.width>e&&(e=n.width)});e+=r*7+2*s+h;d3.selectAll(".tmpTaxonText").remove();u=0;o=[];t.d.characters.forEach(function(n){n.stateSet&&o.push(n)});o.forEach(function(n){d3.select("#vis2Svg").append("text").attr("class","type2VisCharacter tmpCharacterText").style("opacity",0).text(n.Label)});d3.selectAll(".tmpCharacterText").each(function(){var n=this.getBBox();n.width>u&&(u=n.width)});d3.selectAll(".tmpCharacterText").remove();var a=d3.select("#vis2Svg").selectAll(".type2VisTaxon").data(c,function(n){return n.Taxon}),k=a.enter(),d=a.exit(),v=k.append("g").attr("class","type2VisTaxon").style("opacity",0).each(function(n){d3.select(this).append("rect").attr("class","taxarect");d3.select(this).append("text").attr("class","scientificnames").text(function(){return n.Taxon}).style("cursor","pointer").on("click",function(){t.gui.main.showFullDetails(n.Taxon,0)});d3.select(this).append("rect").attr("class","type2VisOverallInd").attr("width",(s+r)*2).attr("height",s*2).attr("x",r).attr("title","Overall weighted score");d3.select(this).append("text").attr("class","type2VisOverallIndText").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",r+s).attr("opacity",0).attr("text",0).attr("cursor","default").attr("title","Overall weighted score");d3.select(this).append("svg:image").attr("xlink:href",t.opts.tombiopath+"resources/camera.png").attr("class","taxonImageLink").attr("width",h).attr("height",h).attr("x",function(){return r*5+s*2}).style("display",function(){var i=t.d.media.filter(function(t){if(t.Taxon==n.Taxon.kbValue)return!0});return i.length>0?null:"none"}).on("click",function(){t.gui.main.showFullDetails(n.Taxon,1)})}).merge(a);v.transition().duration(1e3).style("opacity",1).each(function(t,i){d3.select(this).select(".taxarect").transition().duration(1e3).attr("x",function(){return 0}).attr("y",function(){return u+i*n+r}).attr("width",function(){return e+r+o.length*n}).attr("height",function(){return n-2*r});d3.select(this).select(".scientificnames").transition().duration(1e3).attr("x",function(){var n=this.getBBox();return e-n.width}).attr("y",function(){var t=this.getBBox();return u+i*n+t.height+(n-t.height)/3});d3.select(this).select(".type2VisOverallInd").transition().duration(1e3).attr("y",function(){return u+2*r+i*n}).attr("fill",function(){return b(t.visState.score.overall)});d3.select(this).select(".type2VisOverallIndText").transition().duration(1e3).attr("y",function(){return u+(i+.5)*n}).attr("text",function(){var n=t.visState.score.overall*100;n=Math.round(n)/100;d3.select(this).text(n)}).attr("opacity",1);d3.select(this).select(".taxonImageLink").transition().duration(1e3).attr("y",function(){var t=(n-2*r-h)/2;return u+i*n+r+t})});d.transition().duration(1e3).style("opacity",0).remove();t.gui.main.createTaxonToolTips(".scientificnames",this.displayToolTips);t.gui.main.tooltip(".type2VisOverallInd");t.gui.main.tooltip(".type2VisOverallIndText");v.each(function(f,s){var a=s,h=f,c=t.f.taxonTag(f.Taxon.kbValue),l=d3.select(this).selectAll(".type2VisIndicators-"+c).data(o,function(n){return n.Character+"-"+c});l.enter().append("g").attr("class","type2VisIndicators-"+c).style("cursor","pointer").on("click",function(n){t.gui.main.dialog("Character score details",t.f.getCharacterScoreDetails(h,n))}).each(function(){d3.select(this).append("circle").attr("r",n/2-2*r).attr("class","type2VisInd").attr("fill","white").style("opacity",0);d3.select(this).append("text").style("opacity",0).attr("class","type2VisIndtext").attr("text-anchor","middle").attr("alignment-baseline","central")}).merge(l).each(function(f,o){d3.select(this).select(".type2VisInd").transition().duration(1e3).attr("cx",function(){return e+r+(o+.5)*n}).attr("cy",function(){return u+(a+.5)*n}).attr("fill",function(){return y(h[f.Character].score.overall)}).style("opacity",1);d3.select(this).select(".type2VisIndtext").transition().duration(1e3).attr("text",function(){var r,n;r=i.showWeightedScores?Number(t.d.oCharacters[f.Character].Weight)/10:1;n=h[f.Character].score.overall*r*10;n=Math.floor(n)/10;d3.select(this).text(n)}).attr("x",function(){return e+r+(o+.5)*n}).attr("y",function(){return u+(a+.5)*n}).style("opacity",1)});l.exit().transition().duration(1e3).style("opacity",0).remove()});l=d3.select("#vis2Svg").selectAll(".type2VisCharacter").data(o,function(n){return n.Character});l.enter().append("text").attr("class","type2VisCharacter").style("opacity",0).text(function(n){return n.Label}).merge(l).transition().duration(1e3).style("opacity",1).attr("x",function(t,i){return e+r+(i+.5)*n}).attr("y",function(){var n=this.getBBox();return u-n.width}).attr("transform",function(t,i){var f=this.getBBox(),o=e+r+(i+.5)*n,s=u-f.width;return"rotate(90 "+o+","+s+")"});l.exit().transition().duration(1e3).attr("x",0).attr("y",0).style("opacity",0).remove();d3.select("#vis2Svg").transition().duration(1e3).attr("width",function(){return e+r+o.length*n}).attr("height",function(){return u+t.d.taxa.length*n});t.gui.main.contextMenu.addItem("Get URL for single-column key",function(){f()},!1,[this.visName]);this.showWeightedScores?(t.gui.main.contextMenu.removeItem("Show weighted scores"),t.gui.main.contextMenu.addItem("Show unweighted scores",function(){i.showWeightedScores=!1;i.refresh()},!1,[this.visName])):(t.gui.main.contextMenu.removeItem("Show unweighted scores"),t.gui.main.contextMenu.addItem("Show weighted scores",function(){i.showWeightedScores=!0;i.refresh()},!1,[this.visName]));this.displayToolTips?(t.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){i.displayToolTips=!1;t.gui.main.contextMenu.removeItem("Remove taxon image tooltips");i.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),t.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(t.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0;t.gui.main.contextMenu.removeItem("Display taxon image tooltips");i.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),t.gui.main.contextMenu.removeItem("Remove taxon image tooltips"))};r.urlParams=function(n){n.weighted&&(i.showWeightedScores=n.weighted==="true");n.imgtips&&(i.displayToolTips=n.imgtips==="true");t.f.initControlsFromParams(n)};r.show=function(){n("#vis2").show();n(r.inputControl.divSel).show();r.inputControl.initFromCharacterState()};r.hide=function(){n("#vis2").hide();n(r.inputControl.divSel).hide()}})(jQuery,this.tombiovis);