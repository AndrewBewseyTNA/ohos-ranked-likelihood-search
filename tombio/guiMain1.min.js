(function(n,t){"use strict";function r(){var i=n("<div>"),r,u;return i.append(n("<h3>").text("Citation for FSC Identikit (core software)")),r="This is the reference you can use for the FSC Identikit - in other words the core software.",r+=" The core version number is updated whenever there is a new major release of the core software.",i.append(n("<p>").html(r)),i.append(n("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationCore' id='tbCitationCore'>")),i.append(n("<span>").text("Copy citation")),i.append(n("<b>").html(t.f.getCitation(t.d.softwareMetadata,"Software"))),i.append(n("<h3>").text("Citation for last selected visualisation tool")),r="This is the reference you can use for the last selected visualisation tool.",r+=" The tool version number is updated whenever there is a new release of the tool.",r+=" If you cite a tool, there's no need to cite the core software separately since it is implicit.",i.append(n("<p>").html(r)),i.append(n("<input style='position: relative; top: 0.2em' type='checkbox' name='tbCitationVis' id='tbCitationVis'>")),i.append(n("<span>").text("Copy citation")),i.append(n("<b>").html(t.f.getCitation(t.v.visualisations[t.v.lastVis].metadata,"Software",t.d.softwareMetadata.title))),i.append(n("<h3>").text("Citation for knowledge-base")),r="This is the reference you can use for the knowledge-base currently driving the software.",r+=" The knowledge-base version number is updated whenever there is a new release of the knowledge-base.",i.append(n("<p>").html(r)),i.append(n("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationKb' id='tbCitationKb'>")),i.append(n("<span>").text("Copy citation")),i.append(n("<b>").html(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title))),u=n("<button>Copy citations<\/button>"),u.button(),u.click(function(){n("#tbSelectedCitations").html("");document.getElementById("tbCitationCore").checked&&n("#tbSelectedCitations").append(t.f.getCitation(t.d.softwareMetadata,"Software"));document.getElementById("tbCitationVis").checked&&n("#tbSelectedCitations").append(t.f.getCitation(t.v.visualisations[t.v.lastVis].metadata,"Software",t.d.softwareMetadata.title));document.getElementById("tbCitationKb").checked&&n("#tbSelectedCitations").append(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title));t.f.selectElementText(document.getElementById("tbSelectedCitations"));n("#tbCitationInstructions").show()}),i.append(n("<p>").append(u).append("&nbsp;The selected citations will appear together below - just copy and paste")),i.append(n("<div id='tbSelectedCitations'>")),i.append(n("<p id='tbCitationInstructions' style='display: none'>").text("You can now copy and paste the selected citation text.")),i}function i(i){var r;r=i!=undefined?i:!n("#tombioGuiMain1Controls").is(":visible");r?n("#tombioGuiMain1Controls").show(0,t.f.resizeControlsAndTaxa):n("#tombioGuiMain1Controls").hide(0,t.f.resizeControlsAndTaxa)}function u(){t.gui.main1.contextMenu={};t.gui.main1.contextMenu.items={};t.gui.main1.contextMenu.contexts={};t.gui.main1.contextMenu.menu=n("<ul>").css("white-space","nowrap").appendTo("#tombioGuiMain1").addClass("contextMenu").css("position","absolute").css("display","none").css("z-index",999999);t.gui.main1.contextMenu.menu.menu();n("#tombioGuiMain1").on("contextmenu",function(i){t.gui.main1.contextMenu.menu.position({});var r=n(this).parent().offset(),u=i.pageX-r.left,f=i.pageY-r.top;return t.gui.main1.contextMenu.menu.css({left:u,top:f}),t.gui.main1.contextMenu.menu.show(),!1});n("#tombioGuiMain1").on("click",function(){t.gui.main1.contextMenu.menu.hide()});t.gui.main1.contextMenu.addItem=function(i,r,u,f){if(f&&i in t.gui.main1.contextMenu.items&&(t.gui.main1.contextMenu.items[i].remove(),delete t.gui.main1.contextMenu.items[i],delete t.gui.main1.contextMenu.contexts[i]),!(i in t.gui.main1.contextMenu.items)){var e=n("<li>").append(n("<div>").text(i).click(r));t.gui.main1.contextMenu.menu.append(e);t.gui.main1.contextMenu.menu.menu("refresh");t.gui.main1.contextMenu.items[i]=e;t.gui.main1.contextMenu.contexts[i]=u}};t.gui.main1.contextMenu.removeItem=function(n){n in t.gui.main1.contextMenu.items&&(t.gui.main1.contextMenu.items[n].remove(),delete t.gui.main1.contextMenu.items[n],delete t.gui.main1.contextMenu.contexts[n])};t.gui.main1.contextMenu.contextChanged=function(n){for(var i in t.gui.main1.contextMenu.items)t.gui.main1.contextMenu.contexts[i].indexOf(n)>-1?t.gui.main1.contextMenu.items[i].show():t.gui.main1.contextMenu.items[i].hide()}}t.gui.main1={};t.gui.main1.toolSet=function(t){n("#tombioGuiMain1Visualisation").val()!=t&&n("#tombioGuiMain1Visualisation").val(t)};t.gui.main1.resizeControlsAndTaxa=function(){if(n("#tombioGuiMain1Controls").is(":visible")){var t=n("#tombioGuiMain1Controls").width();n("#tombioGuiMain1ControlsAndTaxa").css("min-width",t+n("#tombioGuiMain1Taxa").width()+50)}else n("#tombioGuiMain1ControlsAndTaxa").css("min-width","0px")};t.gui.main1.addTopPageElements=function(){n("#tombiod3vis").html("");n("#tombiod3vis").css("position","relative");n("<div>").attr("id","tombioGuiMain1").addClass("needsclick").css("display","none").appendTo("#tombiod3vis");n("<div>").attr("id","tombioGuiMain1DeviceWarning").appendTo("#tombioGuiMain1");n("<div>").attr("id","tombioGuiMain1DeviceWarningInnerDiv").css("margin","2em").appendTo(n("#tombioGuiMain1DeviceWarning"));n("<p>").text("This Identikit tool is designed for large format devices. If you are working with a small screen or with a touch device, it might not appear or work as intended. We are working to produce a range of 'mobile-first' tools in the latter part of 2018.").appendTo(n("#tombioGuiMain1DeviceWarningInnerDiv"));n("<img>").attr("id","tombioGuiMain1DeviceWarningButton").attr("src",t.opts.tombiopath+"/resources/remove.png").css("position","absolute").css("right","10px").css("top","10px").appendTo(n("#tombioGuiMain1DeviceWarningInnerDiv"));n("#tombioGuiMain1DeviceWarningButton").on("click",function(){n("#tombioGuiMain1DeviceWarning").hide()});n("<div>").attr("id","tombioGuiMain1DebugText").css("display","none").appendTo("#tombioGuiMain1");n("<select>").attr("id","tombioGuiMain1Visualisation").appendTo("#tombioGuiMain1");n("<div>").addClass("tombioNoSelect").attr("id","tombioGuiMain1ControlsAndTaxa").appendTo("#tombioGuiMain1");n("<div>").attr("id","tombioGuiMain1Controls").css("display","none").appendTo("#tombioGuiMain1ControlsAndTaxa");n("<span>").attr("id","tombioGuiMain1Taxa").appendTo("#tombioGuiMain1ControlsAndTaxa");t.gui.main1.visParent="#tombioGuiMain1Taxa";n("<div>").attr("id","currentVisInfo").css("display","none").appendTo("#tombioGuiMain1");n("<div>").attr("id","kbInfo").css("display","none").appendTo("#tombioGuiMain1");n("<div>").attr("id","visInfo").css("display","none").appendTo("#tombioGuiMain1");n("<div>").attr("id","tombioCitation").css("display","none").appendTo("#tombioGuiMain1");n("<div>").attr("id","mediaFilesCheck").css("display","none").appendTo("#tombioGuiMain1");n("<div>").attr("id","tvkCheck").css("display","none").appendTo("#tombioGuiMain1")};t.gui.main1.createUIControls=function(){var i,r;n("#tombioGuiMain1").css("display","");u();i=[];i.push(n('<option value="reload" class="html" data-class="reload">Reload<\/option>'));t.v.includedVisualisations.forEach(function(r){var u=n('<option class="needsclick">').attr("value",r).attr("data-class","vis").addClass("visualisation").text(t.js.jsFiles[r].toolName);i.push(u)});i.push(n('<option id="optCurrentVisInfo" value="currentVisInfo" class="html" data-class="info"><\/option>'));i.push(n('<option value="kbInfo" class="html" data-class="info">About the Knowledge-base<\/option>'));i.push(n('<option value="visInfo" class="html" data-class="info">About FSC Identikit<\/option>'));i.push(n('<option value="tombioCitation" class="html" data-class="info">Get citation text<\/option>'));t.opts.checkKB&&(i.push(n('<option value="mediaFilesCheck" class="html" data-class="wrench">Check media files<\/option>')),t.d.oCharacters.TVK&&i.push(n('<option value="tvkCheck" class="html" data-class="wrench">Check TVKs<\/option>')));r=t.f.getURLParameter("selectedTool");t.v.selectedTool=r?r:t.opts.selectedTool?t.opts.selectedTool:t.d.kbconfig.selectedTool?t.d.kbconfig.selectedTool:t.v.includedVisualisations[0];i.forEach(function(n){n.attr("value")==t.v.selectedTool&&n.attr("selected","selected")});n("#tombioGuiMain1Visualisation").append(i);n.widget("custom.iconselectmenu",n.ui.selectmenu,{_renderItem:function(t,i){var r=n("<li>"),u=n("<div>",{text:i.label});return i.disabled&&r.addClass("ui-state-disabled"),n("<span>",{style:i.element.attr("data-style"),"class":"ui-icon "+i.element.attr("data-class")}).appendTo(u),r.append(u).appendTo(t)}});n("#tombioGuiMain1Visualisation").iconselectmenu({change:function(){t.v.selectedTool=n("#tombioGuiMain1Visualisation").val();t.f.visChanged(t.v.selectedTool)}}).iconselectmenu("menuWidget").addClass("ui-menu-icons customicons");t.opts.hideVisDropdown==!0&&n("#tombioGuiMain1Visualisation-button").hide()};t.gui.main1.visShow=function(u){var s=t.v.visualisations[u],h,c,a,e,v,f,o,l;if(u=="tombioCitation"&&n("#tombioCitation").html(r()),u=="mediaFilesCheck"&&n("#mediaFilesCheck").html(t.f.createMediaCheckPage()),u=="tvkCheck"&&n("#tvkCheck").html(t.f.createTvkCheckPage()),u=="kbInfo"&&n("#kbInfo").html().length==0&&n.get(t.opts.tombiokbpath+"info.html",function(i){n("#kbInfo").append(i.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath))}).always(function(){var e=n("<h3>").attr("id","tombioKbCitation").text("Citation"),u,f,r,i;n("#kbInfo").append(e);n("#kbInfo").append(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title));u=n("<h3>").attr("id","tombioKbRevisionHistory").text("Knowledge-base revision history");n("#kbInfo").append(u);f=n("<p>").html("<b>Current version: "+t.d.kbmetadata.version+"<\/b>");n("#kbInfo").append(f);r=n("<table>");i=n("<tr>").css("background-color","black").css("color","white");i.append(n("<td>").text("Date").css("padding","3px"));i.append(n("<td>").text("Version").css("padding","3px"));i.append(n("<td>").text("Notes").css("padding","3px"));r.append(i);t.d.kbreleaseHistory.forEach(function(t,u){i=n("<tr>");u%2==0?i.css("background-color","rgb(200,200,200)"):i.css("background-color","rgb(230,230,230)");var f=new Date(t.Date);i.append(n("<td>").css("padding","3px").text(f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()));i.append(n("<td>").css("padding","3px").text(t.Value));i.append(n("<td>").css("padding","3px").text(t.Notes));r.append(i)});n("#kbInfo").append(r)}),u=="visInfo"&&n("#visInfo").html().length==0&&n.get(t.opts.tombiopath+"visInfo.html",function(i){n("#visInfo").html(i.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath))}),u=="currentVisInfo"&&(h=new Array(t.v.visualisations[t.v.lastVis].helpFiles.length),c=[],t.v.visualisations[t.v.lastVis].helpFiles.forEach(function(t,i){c.push(new Promise(function(r){n.get(t,function(n){h[i]=n;r()})}))}),Promise.all(c).then(function(){var i="";h.forEach(function(n){i+=n});i=i.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath);n("#currentVisInfo").html(i)})),u!=t.v.currentTool&&(t.v.currentTool&&(a=n("#"+t.v.currentTool),a.hide(),e=t.v.visualisations[t.v.currentTool],e&&e.inputControl&&e.inputControl.$div.hide()),v=n("#"+u),v.show(),f=t.v.visualisations[u],f&&f.inputControl&&(f.inputControl.$div.show(),f.inputControl.initFromCharacterState())),s&&s.charStateInput?i(!0):i(!1),s?n("#tombioGuiMain1ControlsAndTaxa").show():n("#tombioGuiMain1ControlsAndTaxa").hide(),t.f.refreshVisualisation(),t.v.currentTool=u,Object.keys(t.v.visualisations).indexOf(u)>-1&&(t.v.lastVis=u,n("#optCurrentVisInfo").text("Using the "+t.v.visualisations[t.v.lastVis].metadata.title),n("#tombioGuiMain1Visualisation").iconselectmenu("refresh")),t.gui.main1.contextMenu.contextChanged(u),!t.v.initialised&&t.v.visualisations[u]){var y={},w=decodeURI(window.location.search.substring(1)).replace(/\+/g," "),p=w.split("&");for(o=0;o<p.length;o++)l=p[o].split("="),y[l[0]]=l[1];t.v.visualisations[u].urlParams(y);t.v.initialised=!0}}})(jQuery,this.tombiovis);