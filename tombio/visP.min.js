(function(n,t){"use strict";var i=t.v.visP={};i.scoreColours=["#fc8d59","#ffffbf","#91bfdb"];i.initP=function(i,r){var u=r.visParent,f=r.contextMenu,e;this.visName=i;this.contextMenu=f;this.div=n("<div/>").attr("id",i).css("display","none").appendTo(u);this.cssSel=u+" > #"+i;e=this;this.metadata={};this.nbnMapCache={};t.d.taxa.forEach(function(n){n.visState[i]={}});this.initialise()};i.sortTaxa=function(n){return n.sort(function(n,t){return n.visState.score.overall>t.visState.score.overall?-1:t.visState.score.overall>n.visState.score.overall?1:t.visState.score.overall==n.visState.score.overall?n.visState.score.for>t.visState.score.for?1:t.visState.score.for>n.visState.score.for?-1:n.kbPosition>t.kbPosition?1:-1:void 0})};i.addNBNMapToContainer=function(i,r){var s,u;i=i+="";var f=n("<div>").appendTo(r).css("border","1px solid black").css("padding","5px").css("border-radius","10px"),e=n("<img>").addClass("tombioNbnLogo").attr("src",t.opts.tombiopath+"/resources/nbn-logo-centred.png").addClass(function(){if(i)return"tombioSpiningNbn"}()).appendTo(f),o=n("<div>").addClass("tombioNbnLoading").css("font-size","0.8em").text(function(){return i?"Loading distribution map from NBN...":"No TVK specified for this taxon"}()).appendTo(f);i&&(this.nbnMapCache[i]?(u=this.nbnMapCache[i],e.attr("src",t.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),o.hide()):(s="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+i+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100",u=n("<img>").css("width","100%").on("load",function(){e.attr("src",t.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn");o.hide()}).on("error",function(){e.removeClass("tombioSpiningNbn");o.text("An error was encountered attemping to retrieve an NBN distribution map for the TVK "+i);u.hide()}).attr("src",s),this.nbnMapCache[i]=u));n("<div>").append(u).appendTo(f)};i.addTaxonImagesToContainer=function(i){var h=i.taxon,u=i.container,c=i.indexSelected?i.indexSelected:0,l=i.imageRemovalButton?i.imageRemovalButton:!1,e=i.fImageSelect?i.fImageSelect:null,a=i.height?i.height:400,v=this,o=this.getTaxonImages(h),s,r,f;if(o.length==0){s=n("<div>").css("margin","10px");s.text("No images are specified in the knowledge-base for this taxon.").appendTo(u);return}r=n("<div>").addClass("tombio-galleria-pane").css("position","relative").css("max-width","2000px").css("height",a).appendTo(u);f=[];o.forEach(function(n){var t={image:n.URI,thumb:n.SmallURI?n.SmallURI:null,big:n.LargeURI?n.LargeURI:null,alt:n.Caption,title:n.Caption};f.push(t)});Galleria.run(r,{transition:"fade",wait:!0,dataSource:f,theme:"classic",show:c});r.data("galleria").bind("loadfinish",function(n){e&&e(n.index)});n("<img>").attr("src",t.opts.tombiopath+"resources/enlarge.png").appendTo(r).addClass("tombio-galleria-lightbox-button").on("click",function(){r.data("galleria").openLightbox()});if(l)n("<img>").attr("src",t.opts.tombiopath+"resources/remove.png").appendTo(r).addClass("tombio-galleria-remove-button").on("click",function(){r.data("galleria").destroy();u.addClass("userRemoved");u.remove()})};i.addTaxonHtmlToContainer=function(i,r,u){var f=this.getTaxonHtmlFiles(i);u<=f.length-1?n.get(f[u].URI+"?ver="+t.opts.tombiover,function(t){var i=t.indexOf("<body"),u=t.indexOf("<\/body"),f=t.slice(i,u),e=n("<div>").html(f);r.html(e.html())}):r.html(null)};i.getTaxonImages=function(n){return t.d.media.filter(function(t){if(t.Taxon==n&&(t.Type=="image-local"||t.Type=="image-web"))return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)})};i.getTaxonTipImage=function(i){var f=t.d.media.filter(function(n){if(n.Taxon==i&&(n.Type=="image-local"||n.Type=="image-web")){if(n.UseFor){var t=!1;return n.UseFor.split(",").forEach(function(n){n.toLowerCase().trim()=="tip"&&(t=!0)}),t}return!0}}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});if(f.length>0){var u=n("<div/>"),r=f[0],e=n("<img/>",{src:r.URI}).appendTo(u).css("margin-top",2),o=n("<figcaption/>",{html:r.Caption}).appendTo(u);return r.ImageWidth&&e.css("width",r.ImageWidth),u}return null};i.getTaxonHtmlFiles=function(n){return t.d.media.filter(function(t){if(t.Taxon==n&&t.Type=="html-local")return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)})};i.getCharacterScoreDetails=function(t,i){var r,u;return r="<p>Specified state(s) for character <b>"+i.Label+"<\/b>: <\/p>",u=n("#"+i.Character),r+="<ul>",i.ControlType=="spin"||i.ControlType=="single"?(r+="<li><b>",r+=u.val(),r+="<\/b><\/li>"):i.ControlType=="multi"&&u.val().forEach(function(n){r+="<li><b>";r+=n;r+="<\/b><\/li>"}),r+="<\/ul>",r+="<p>Valid state(s) for <b>"+i.Label+"<\/b> recorded against ",r+="<b><i>"+t.Taxon+"<\/i><\/b> in the knowledge base: ",r+="<ul>",r+=t[i.Character].toHtml2(),r+="<\/ul>",r+="<hr/>",r+="<p>Knowledge-base <b>weighting<\/b> for this character: <b>"+i.Weight+"<\/b><\/p>",r+="<p>Knowledge-base <b>latitude<\/b> for this character: <b>"+i.Latitude+"<\/b><\/p>",r+="<hr/>",r+="<p>Unweighted character score: <b>"+Math.round(t[i.Character].score.overall*100)/100+"<\/b>; ",r+="(for, "+Math.round(t[i.Character].score.for*100)/100,r+="; against, "+Math.round((t[i.Character].score.against+t[i.Character].score.na)*100)/100+")<\/p>",r+="<p>Weighted character score: <b>"+Math.round(t[i.Character].score.overall*i.Weight*10)/100+"<\/b><\/p>"};i.getTaxonCharacterValues=function(i){var r=n("<table>"),u,f;return r.css("width","100%"),r.css("margin","0px"),u=0,f="",t.d.characters.forEach(function(e){var s,o,h,c;(e.Status=="key"||e.Status=="display")&&(t.d.oCharacters.grouped&&e.Group!=f&&(o=n("<tr>"),o.css("background-color","rgb(100,100,100)"),o.css("color","rgb(255,255,255)"),s=n("<td colspan='3'>"),o.append(s.append(e.Group)),r.append(o),f=e.Group),u++,o=n("<tr>"),u%2!=0?o.css("background-color","rgb(200,200,200)"):o.css("background-color","rgb(230,230,230)"),h=n("<td>").append(e.Label),c=n("<td>").append(i[e.Character].toHtml1()),o.append(h),o.append(c),r.append(o))}),r.find("td").css("padding","2"),r};i.shortName=function(n){var i=n.split(" "),t="";return i.forEach(function(n,i){i==0?t+=n.substring(0,1):(t+=" ",t+=n.substring(0,3))}),t};i.taxonTag=function(n){return n.replace(/[|&;$%@"<>()+:.,'\/ ]/g,"")};i.copyTextToClipboard=function(n){var t=document.createElement("textarea"),i,r;t.value=n;document.body.appendChild(t);t.select();try{i=document.execCommand("copy");r=i?"successful":"unsuccessful";console.log("Copying text "+r)}catch(u){console.log("Oops, unable to copy text")}document.body.removeChild(t)};i.createViewURL=function(n){var t=window.location.href.split("tbv=")[0],i=t.indexOf("?")==-1?"?":"&",r=encodeURI(t+i+"tbv=&"+n.join("&"));this.copyTextToClipboard(r)}})(jQuery,this.tombiovis);