(function(n,t){"use strict";var i=t.visP={};i.initP=function(t,i,r,u){this.visName=t;this.contextMenu=r;this.div=n("<div/>").attr("id",t).css("display","none").appendTo(i);this.cssSel=i+" > #"+t;this.mobile=/Mobi/.test(navigator.userAgent);var f=this;this.metadata={};this.nbnMapCache={};u.taxa.forEach(function(n){n.visState[t]={}});this.initialise()};i.fullDetails=function(i,r,u,f){function w(){var n=o.find(".tombio-galleria-pane").first();n.data("galleria")&&(n.data("galleria").setOptions("height",o.height()-a),n.data("galleria").resize())}var b=this,a,e,s,h,c,v,l,o,y,k,p;u=typeof u!="undefined"?u:0;f=typeof f!="undefined"?f:0;r=typeof r!="undefined"?r:1;e=n("<div>").addClass("tombioFullDetailsTabs");e.css("border","none");s=n("<ul>").appendTo(e);s.append("<li><a href='#tabs-1'>Knowledge-base<\/a><\/li>");s.append("<li><a href='#tabs-2'>Images<\/a><\/li>");t.oCharacters.TVK&&s.append("<li><a href='#tabs-4'>NBN map<\/a><\/li>");s.append("<li><a href='#tabs-3'>Details<\/a><\/li>");h=n("<div>").attr("id","tabs-1").appendTo(e);c=n("<div>").attr("id","tabs-2").appendTo(e);t.oCharacters.TVK&&(v=n("<div>").attr("id","tabs-4").appendTo(e));l=n("<div>").attr("id","tabs-3").appendTo(e);o=n("<div>").append(e);o.attr("title",i);o.dialog({closeText:"",height:550,width:600,modal:!0,resizeStop:function(){e.tabs("refresh");w()}});e.tabs({heightStyle:"fill",active:r,create:function(){a=o.height()-h.height()},activate:function(n,t){e.tabs("refresh");t.newTab.index()==1&&w()}});l.css("overflow","hidden");y=this.showTaxonCharacterValues(t.oTaxa[i],!0);h.append(y);k=this.getTaxonImagesDiv({taxon:i,container:c,height:c.height()});t.oCharacters.TVK&&t.oTaxa[i].TVK&&(p=n("<div>").css("position","relative").appendTo(v),b.addNBNMap(t.oTaxa[i].TVK,p));this.getHTMLFileSelectionDiv(i,l)};i.sortTaxa=function(n){return n.sort(function(n,t){return n.visState.score.overall>t.visState.score.overall?-1:t.visState.score.overall>n.visState.score.overall?1:t.visState.score.overall==n.visState.score.overall?n.visState.score.for>t.visState.score.for?1:t.visState.score.for>n.visState.score.for?-1:n.kbPosition>t.kbPosition?1:-1:void 0})};i.addNBNMap=function(i,r){var s,u;i=i+="";var f=n("<div>").appendTo(r).css("border","1px solid black").css("padding","5px").css("border-radius","10px"),e=n("<img>").addClass("tombioNbnLogo").attr("src",t.opts.tombiopath+"/resources/nbn-logo-centred.png").addClass(function(){if(i)return"tombioSpiningNbn"}()).appendTo(f),o=n("<div>").addClass("tombioNbnLoading").css("font-size","0.8em").text(function(){return i?"Loading distribution map from NBN...":"No TVK specified for this taxon"}()).appendTo(f);i&&(this.nbnMapCache[i]?(u=this.nbnMapCache[i],e.attr("src",t.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),o.hide()):(s="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+i+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100",u=n("<img>").css("width","100%").on("load",function(){e.attr("src",t.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn");o.hide()}).on("error",function(){e.removeClass("tombioSpiningNbn");o.text("An error was encountered attemping to retrieve an NBN distribution map for the TVK "+i);u.hide()}).attr("src",s),this.nbnMapCache[i]=u));n("<div>").append(u).appendTo(f)};i.getTaxonImagesDiv=function(i){var h=i.taxon,u=i.container,c=i.indexSelected?i.indexSelected:0,l=i.imageRemovalButton?i.imageRemovalButton:!1,e=i.fImageSelect?i.fImageSelect:null,a=i.height?i.height:400,v=this,o=this.getTaxonImages(h),s,r,f;if(o.length==0){s=n("<div>").css("margin","10px");s.text("No images are specified in the knowledge-base for this taxon.").appendTo(u);return}r=n("<div>").addClass("tombio-galleria-pane").css("position","relative").css("max-width","2000px").css("height",a).appendTo(u);f=[];o.forEach(function(n){var t={image:n.URI,thumb:n.smallURI?n.smallURI:null,big:n.largeURI?n.largeURI:null,alt:n.Caption,title:n.Caption};f.push(t)});Galleria.run(r,{transition:"fade",wait:!0,dataSource:f,theme:"classic",show:c});r.data("galleria").bind("loadfinish",function(n){e&&e(n.index)});n("<img>").attr("src",t.opts.tombiopath+"resources/enlarge.png").appendTo(r).addClass("tombio-galleria-lightbox-button").on("click",function(){r.data("galleria").openLightbox()});if(l)n("<img>").attr("src",t.opts.tombiopath+"resources/remove.png").appendTo(r).addClass("tombio-galleria-remove-button").on("click",function(){r.data("galleria").destroy();u.addClass("userRemoved");u.remove()})};i.getTaxonImages=function(n){return t.media.filter(function(t){if(t.Taxon==n&&(t.Type=="image-local"||t.Type=="image-web"))return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)})};i.getTaxonTipImage=function(i){var f=t.media.filter(function(n){if(n.Taxon==i&&(n.Type=="image-local"||n.Type=="image-web")){if(n.UseFor){var t=!1;return n.UseFor.split(",").forEach(function(n){n.toLowerCase().trim()=="tip"&&(t=!0)}),t}return!0}}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});if(f.length>0){var u=n("<div/>"),r=f[0],e=n("<img/>",{src:r.URI}).appendTo(u).css("margin-top",2),o=n("<figcaption/>",{html:r.Caption}).appendTo(u);return r.ImageWidth&&e.css("width",r.ImageWidth),u}return null};i.getTaxonHtmlFiles=function(n){return t.media.filter(function(t){if(t.Taxon==n&&t.Type=="html-local")return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)})};i.showFloatingImages=function(t,i,r){var f=this,u=n("<div/>").appendTo("#tombioMain");u.attr("class","tombioFloatingImage").css("position","absolute").css("top",r).css("left",i).css("width",350).css("background-color","grey").css("border-radius",10).css("cursor","move").css("z-index",function(){var t=5e3;return n(".tombioFloatingImage").each(function(){var i=Number(n(this).css("z-index"));i>t&&(t=i)}),t+1}).draggable().resizable({resize:function(){var n=u.find(".baseimage");n.trigger("change")}}).click(function(){var t=5e3;n(".tombioFloatingImage").each(function(){var i=Number(n(this).css("z-index"));i>t&&(t=i)});n(this).css("z-index",t+1)});u.append(this.getTaxonImagesDiv({taxon:t,container:u}));this.contextMenu.addItem("Close all images",function(){n(".tombioFloatingImage").remove();f.contextMenu.removeItem("Close all images")},[this.visName])};i.showCharacterScoreDetails=function(t,i){var r,f,u;r="<p>Specified state(s) for character <b>"+i.Label+"<\/b>: <\/p>";f=n("#"+i.Character);r+="<ul>";i.ControlType=="spin"||i.ControlType=="single"?(r+="<li><b>",r+=f.val(),r+="<\/b><\/li>"):i.ControlType=="multi"&&f.val().forEach(function(n){r+="<li><b>";r+=n;r+="<\/b><\/li>"});r+="<\/ul>";r+="<p>Valid state(s) for <b>"+i.Label+"<\/b> recorded against ";r+="<b><i>"+t.Taxon+"<\/i><\/b> in the knowledge base: ";r+="<ul>";r+=t[i.Character].toHtml2();r+="<\/ul>";r+="<hr/>";r+="<p>Knowledge-base <b>weighting<\/b> for this character: <b>"+i.Weight+"<\/b><\/p>";r+="<p>Knowledge-base <b>latitude<\/b> for this character: <b>"+i.Latitude+"<\/b><\/p>";r+="<hr/>";r+="<p>Unweighted character score: <b>"+Math.round(t[i.Character].score.overall*100)/100+"<\/b>; ";r+="(for, "+Math.round(t[i.Character].score.for*100)/100;r+="; against, "+Math.round((t[i.Character].score.against+t[i.Character].score.na)*100)/100+")<\/p>";r+="<p>Weighted character score: <b>"+Math.round(t[i.Character].score.overall*i.Weight*10)/100+"<\/b><\/p>";u=n("<div>");u.dialog({height:300,width:600,modal:!0,title:"Character score details"});u.html(r);u.dialog("open")};i.showTaxonCharacterValues=function(i,r){var u=n("<table>"),f,e;if(u.css("width","100%"),u.css("margin","0px"),f=0,e="",t.characters.forEach(function(r){var s,o,h,c;(r.Status=="key"||r.Status=="display")&&(t.oCharacters.grouped&&r.Group!=e&&(o=n("<tr>"),o.css("background-color","rgb(100,100,100)"),o.css("color","rgb(255,255,255)"),s=n("<td colspan='3'>"),o.append(s.append(r.Group)),u.append(o),e=r.Group),f++,o=n("<tr>"),f%2!=0?o.css("background-color","rgb(200,200,200)"):o.css("background-color","rgb(230,230,230)"),h=n("<td>").append(r.Label),c=n("<td>").append(i[r.Character].toHtml1()),o.append(h),o.append(c),u.append(o))}),u.find("td").css("padding","2"),r)return u;n("#tombioHelpAndInfoDialog").dialog("option","title",i.Taxon);n("#tombioHelpAndInfoDialog").html(u);n("#tombioHelpAndInfoDialog").dialog("open")};i.getHTMLFileSelectionDiv=function(t,i){var u=n("<div>").appendTo(i),o=this,f=this.getTaxonHtmlFiles(t),s,r,h,e;f.length==0?(s=n("<div>").css("margin","10px").appendTo(u),s.text("No text information files (HTML) are specified in the knowledge-base for this taxon.")):(r=n("<div>"),f.length>1&&(h=n('<div style="margin-bottom: 20px">').appendTo(u),e=n("<select id='tombioFileSelect'><\/select>").appendTo(h),f.forEach(function(t,i){var r=n("<option/>").text(t.Caption).attr("value",i);e.append(r)}),e.selectmenu({change:function(n,i){o.showTaxonHtmlInfo(t,r,i.item.value)}})),r.appendTo(u),o.showTaxonHtmlInfo(t,r,0))};i.resizeIframe=function(n){n.height(10);n.height(n.contents().height()+100)};i.showTaxonHtmlIframe=function(n,i,r){var u=this.getTaxonHtmlFiles(n);r<=u.length-1?i.attr("src",u[r].URI+"?ver="+t.opts.tombiover):i.attr("src",null)};i.showTaxonHtmlInfo=function(i,r,u){var f=this.getTaxonHtmlFiles(i);u<=f.length-1?n.get(f[u].URI+"?ver="+t.opts.tombiover,function(t){var i=t.indexOf("<body"),u=t.indexOf("<\/body"),f=t.slice(i,u),e=n("<div>").html(f);r.html(e.html())}):r.html(null)};i.shortName=function(n){var i=n.split(" "),t="";return i.forEach(function(n,i){i==0?t+=n.substring(0,1):(t+=" ",t+=n.substring(0,3))}),t};i.taxonTag=function(n){return n.replace(/[|&;$%@"<>()+:.,'\/ ]/g,"")};i.copyTextToClipboard=function(n){var t=document.createElement("textarea"),i,r;t.value=n;document.body.appendChild(t);t.select();try{i=document.execCommand("copy");r=i?"successful":"unsuccessful";console.log("Copying text "+r)}catch(u){console.log("Oops, unable to copy text")}document.body.removeChild(t)};i.scoreColours=["#fc8d59","#ffffbf","#91bfdb"]})(jQuery,this.tombiovis);