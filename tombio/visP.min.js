(function(n,t){"use strict";var i=t.visP={};i.initP=function(t,i,r,u){this.visName=t;this.contextMenu=r;this.div=n("<div/>").attr("id",t).css("display","none").appendTo(i);this.cssSel=i+" > #"+t;this.mobile=/Mobi/.test(navigator.userAgent);var f=this;this.metadata={};this.initialise();u.taxa.forEach(function(n){n.visState[t]={}})};i.fullDetails=function(i,r,u,f){var v=this,e,o,l,a;u=typeof u!="undefined"?u:0;f=typeof f!="undefined"?f:0;r=typeof r!="undefined"?r:1;e=n("<div>").addClass("tombioFullDetailsTabs");e.css("border","none");o=n("<ul>").appendTo(e);o.append("<li><a href='#tabs-1'>Knowledge-base<\/a><\/li>");o.append("<li><a href='#tabs-2'>Images<\/a><\/li>");o.append("<li><a href='#tabs-3'>Details<\/a><\/li>");var y=n("<div>").attr("id","tabs-1").appendTo(e),s=n("<div>").attr("id","tabs-2").appendTo(e),h=n("<div>").attr("id","tabs-3").appendTo(e),c=n("<div>").append(e);c.addClass("tombioFullDetailsDlg");c.attr("title",i);c.dialog({height:550,width:600,modal:!0,resizeStop:function(){var n=s.find(".baseimage");n.trigger("change")}});e.tabs({active:r,activate:function(){var t=s.find(".baseimage"),n;t.trigger("change");n=h.find("#tombioFullDetailsHTMLDiv");v.resizeIframe(n)}});h.css("overflow","hidden");l=this.showTaxonCharacterValues(t.oTaxa[i],!0);y.append(l);a=this.getTaxonImagesDiv(i,s,0,!0,!0);s.append(a);this.getHTMLFileSelectionDiv(i,h)};i.fullDetailsTest=function(){var r=n("<div>").dialog(),i;r.dialog({height:400,width:300});var u=n("<div>"),t=n("<select><\/select>").appendTo(u),i=n("<option/>").text("one");t.append(i);i=n("<option/>").text("two");t.append(i);r.append(u);t.selectmenu()};i.sortTaxa=function(n,t,i){return n.sort(function(n,r){return n.visState.score.overall>r.visState.score.overall?-1:r.visState.score.overall>n.visState.score.overall?1:r.visState.score.overall==n.visState.score.overall?n.visState.score.for>r.visState.score.for?1:r.visState.score.for>n.visState.score.for?-1:i==undefined||t==undefined?1:n.visState[t][i]>r.visState[t][i]?1:-1:void 0})};i.getTaxonImagesDiv=function(i,r,u,f,e){function d(n,i){var u,e;s.attr("indexSelected",n);u=y[n];nt.find("img").attr("src",t.opts.tombiopath+"resources/camera.png");s.css("width")!="0px"&&(console.log("resizing pane"),s.css("width",s.css("width")),s.css("height",s.css("height")));c.attr("src",null);w.html("");e=new Image;e.onerror=function(){w.html("Couldn't load image'"+u.URI+"'.")};e.onload=function(){w.html(u.Caption);c.attr("src",this.src);w.html(u.Caption);r?(f||(r.css("width",c.width()+p),r.css("height",c.height()+p+30)),s.css("height","100%"),s.css("width","100%")):(s.css("width",c.width()+p),s.css("height",c.height()+p+30));c.css("opacity",.2);s.find("#imgLink"+n).attr("src",t.opts.tombiopath+"resources/cameragreen.png");var e=this;setTimeout(function(){o.attr("src",e.src).css("width",c.width()).css("height",c.height()).css("left",0).css("top",0).attr("viewWidth",c.width()).attr("viewHeight",c.height()).attr("xProp",.5).attr("yProp",.5)},50);i&&i()};e.src=u.URI}function g(n,t,i,r,u,f,e){var k=Number(n.attr("viewWidth")),c=Number(n.attr("viewHeight")),a=Number(n.css("width").replace("px","")),p=Number(n.css("height").replace("px","")),w=Number(n.attr("xProp")),b=Number(n.attr("yProp")),s,h,v,y,o,l;t?(o=t,l=i,t>a&&(r=t,u=i),f=w*a,e=b*p):(o=k,l=c);r?(r<o?(s=o,h=l):(s=r,h=u),f=w*s,e=b*h):(s=a,h=p);f?(v=f-o/2>=0&&f+o/2<=s?f:f-o/2<0?o/2:s-o/2,y=e-c/2>=0&&e+c/2<=h?e:e-c/2<0?c/2:c==0?h/2:h-c/2):(v=w*a,y=b*p);n.css("height",h).css("max-width",s).css("width",s).css("left",0-(v-o/2)).css("top",0-(y-l/2)).attr("viewWidth",o).attr("viewHeight",l).attr("xProp",v/s).attr("yProp",y/h);Math.round(s)>Math.round(o)?(n.draggable("enable"),n.css("cursor","-webkit-grab")):(n.draggable("disable"),n.css("cursor","inherit"))}var ft,et,ot,st,lt,y=this.getTaxonImages(i),h=this,tt,a,ht,l,ct,w,k,v,it,nt,rt,ut;if(u>=y.length&&(u=0),y.length==0)return tt=n("<div>").css("margin","10px"),tt.text("No images are specified in the knowledge-base for this taxon."),tt;u==undefined&&(u=0);var p=10,s=n("<div/>").attr("class","tombioImage").css("border","").css("position","relative").css("border-radius",p).css("background-color","grey").css("overflow","hidden"),b=n("<div/>").css("line-height",0).css("margin",p/2).css("border-radius",p*.7).css("position","relative").css("overflow","hidden").css("background-color","grey").css("background-image","url('"+t.opts.tombiopath+"resources/loading.gif')").css("background-repeat","no-repeat").css("background-position","center"),c=n("<img/>").css("width","100%").attr("class","baseimage").change(function(){var n=c.siblings(".zoomimage");g(n,c.width(),c.height(),null,null,null,null)}),o=n("<img/>").attr("class","zoomimage").css("position","absolute").css("left",0).css("top",0).draggable({start:function(){ft=Number(o.css("left").replace("px",""));et=Number(o.css("top").replace("px",""));ot=Number(o.css("width").replace("px",""))*o.attr("xProp");st=Number(o.css("height").replace("px",""))*o.attr("yProp")},drag:function(n,t){t.position.left>0&&(t.position.left=0);t.position.top>0&&(t.position.top=0);Number(o.css("width").replace("px",""))+t.position.left<Number(o.attr("viewWidth"))&&(t.position.left=Number(o.attr("viewWidth"))-Number(o.css("width").replace("px","")));Number(o.css("height").replace("px",""))+t.position.top<Number(o.attr("viewHeight"))&&(t.position.top=Number(o.attr("viewHeight"))-Number(o.css("height").replace("px","")));var i=ft-t.position.left,r=et-t.position.top,u=Number(o.css("width").replace("px",""))*o.attr("xProp");g(o,null,null,null,null,ot+i,st+r)}});if(o.draggable("disable"),a=n("<div>").css("position","absolute").css("left",0).css("top",0).css("height","100%").css("width","30px").css("background","rgba(0,0,0,0.3)").css("cursor","pointer").css("opacity",0).hover(function(){h.mobile||(l.stop().fadeTo(400,1),a.stop().fadeTo(400,1))},function(){h.mobile||(l.stop().fadeTo(400,0),a.stop().fadeTo(400,0))}).click(function(){if(n(this).css("opacity")!=0){var t=Number(s.attr("indexSelected"));d((y.length+t-1)%y.length,function(){h.mobile||(l.stop().fadeTo(400,1),a.stop().fadeTo(400,1),v.stop().fadeIn(10).fadeOut(800))})}}),ht=n('<img src="'+t.opts.tombiopath+'resources/moveleft.png">').css("position","absolute").css("top","50%").css("left",0).css("transform","translate(0, -50%)").css("opacity",1),a.append(ht),l=n("<div>"),l.css("position","absolute").css("right",0).css("top",0).css("height","100%").css("width","30px").css("background","rgba(0,0,0,0.3)").css("cursor","pointer").css("opacity",0).hover(function(){h.mobile||(l.stop().fadeTo(400,1),a.stop().fadeTo(400,1))},function(){h.mobile||(l.stop().fadeTo(400,0),a.stop().fadeTo(400,0))}).click(function(){if(n(this).css("opacity")!=0){var t=Number(s.attr("indexSelected"));d((y.length+t+1)%y.length,function(){h.mobile||(l.stop().fadeTo(400,1),a.stop().fadeTo(400,1),v.stop().fadeIn(10).fadeOut(800))})}}),ct=n('<img src="'+t.opts.tombiopath+'resources/moveright.png">').css("position","absolute").css("top","50%").css("right",0).css("transform","translate(0, -50%)").css("opacity",1),l.append(ct),w=n("<div/>").css("margin",p/2).attr("class","taxonImageCaption"),b.append(c),b.append(o),b.append(a),b.append(l),s.append(b),s.append(w),s.attr("indexSelected",u),o.mousewheel(function(n){var t,i,r,u;return n.stopPropagation(),t=Number(o.css("width").replace("px","")),i=Number(o.css("height").replace("px","")),n.deltaY>0?(r=t*1.1,u=i*1.1):(r=t/1.1,u=i/1.1),g(o,null,null,r,u,null,null),!1}),h.mobile){console.log("this is mobile!");k=new Hammer(o.get(0));k.get("pinch").set({enable:!0});k.on("pinchstart",function(){h.initPinchWidth=Number(o.css("width").replace("px",""));h.initPinchHeight=Number(o.css("height").replace("px",""))});k.on("pinch",function(n){var t=h.initPinchWidth*n.scale,i=h.initPinchHeight*n.scale;g(o,null,null,t,i,null,null)})}if(v=n("<div/>").css("margin-right",30).css("margin-top",6).css("margin-left",6).css("display","none"),it=n("<div/>").css("position","absolute").css("top",0).css("left",0).css("width","100%").css("height",30).hover(function(){h.mobile||v.stop().fadeIn(400)},function(){h.mobile||v.stop().fadeOut(400)}),h.mobile)k.on("press",function(){h.imageControlsDisplayed?(v.stop().fadeOut(400),l.stop().fadeTo(400,0),a.stop().fadeTo(400,0)):(v.stop().fadeIn(400),l.stop().fadeTo(400,1),a.stop().fadeTo(400,1));h.imageControlsDisplayed=!h.imageControlsDisplayed});return nt=n("<div/>"),v.append(nt),y.forEach(function(i,r){var f=n("<img/>");u==r?(rt=t.opts.tombiopath+"resources/cameragreen.png",lt=f):rt=t.opts.tombiopath+"resources/camera.png";f.attr("src",rt).css("cursor","pointer").css("width",20).css("margin",2).attr("id","imgLink"+r).click("click",function(){d(r)});f.tooltip({items:"img",content:function(){return i.Caption}});nt.append(f)}),e||(ut=n("<img/>"),ut.attr("src",t.opts.tombiopath+"resources/remove.png").css("cursor","pointer").css("position","absolute").css("top",8).css("right",8).css("width",20).click("click",function(){s.addClass("userRemoved");r?r.remove():s.remove()}),v.append(ut)),it.append(v),s.append(it),d(u),s.selectByIndex=function(n){console.log("Select image",n)},s};i.getTaxonImages=function(n){return t.media.filter(function(t){if(t.Taxon==n&&t.Type=="image-local")return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)})};i.getTaxonTipImage=function(i){var f=t.media.filter(function(n){if(n.Taxon==i&&n.Type=="image-local"){if(n.UseFor){var t=!1;return n.UseFor.split(",").forEach(function(n){n.toLowerCase().trim()=="tip"&&(t=!0)}),t}return!0}}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});if(f.length>0){var u=n("<div/>"),r=f[0],e=n("<img/>",{src:r.URI}).appendTo(u).css("margin-top",2),o=n("<figcaption/>",{html:r.Caption}).appendTo(u);return r.ImageWidth&&e.css("width",r.ImageWidth),u}return null};i.getTaxonHtmlFiles=function(n){return t.media.filter(function(t){if(t.Taxon==n&&t.Type=="html-local")return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)})};i.showFloatingImages=function(t,i,r){var f=this,u=n("<div/>").appendTo("#tombioMain");u.attr("class","tombioFloatingImage").css("position","absolute").css("top",r).css("left",i).css("width",350).css("background-color","grey").css("border-radius",10).css("cursor","move").css("z-index",function(){var t=5e3;return n(".tombioFloatingImage").each(function(){var i=Number(n(this).css("z-index"));i>t&&(t=i)}),t+1}).draggable().resizable({resize:function(){var n=u.find(".baseimage");n.trigger("change")}}).click(function(){var t=5e3;n(".tombioFloatingImage").each(function(){var i=Number(n(this).css("z-index"));i>t&&(t=i)});n(this).css("z-index",t+1)});u.append(this.getTaxonImagesDiv(t,u));this.contextMenu.addItem("Close all images",function(){n(".tombioFloatingImage").remove();f.contextMenu.removeItem("Close all images")},[this.visName])};i.showCharacterScoreDetails=function(t,i){var r,u;r="<p>Specified state(s) for character <b>"+i.Label+"<\/b>: <\/p>";u=n("#"+i.Character);r+="<ul>";i.ControlType=="spin"||i.ControlType=="single"?(r+="<li><b>",r+=u.val(),r+="<\/b><\/li>"):i.ControlType=="multi"&&u.val().forEach(function(n){r+="<li><b>";r+=n;r+="<\/b><\/li>"});r+="<\/ul>";r+="<p>Valid state(s) for <b>"+i.Label+"<\/b> recorded against ";r+="<b><i>"+t.Taxon+"<\/i><\/b> in the knowledge base: ";r+="<ul>";r+=t[i.Character].toHtml2();r+="<\/ul>";r+="<hr/>";r+="<p>Knowledge-base <b>weighting<\/b> for this character: <b>"+i.Weight+"<\/b><\/p>";r+="<p>Knowledge-base <b>strictness<\/b> for this character: <b>"+i.Strictness+"<\/b><\/p>";r+="<hr/>";r+="<p>Unweighted character score: <b>"+Math.round(t[i.Character].matchscore.scoreoverall*100)/100+"<\/b>; ";r+="(for, "+Math.round(t[i.Character].matchscore.scorefor*100)/100;r+="; against, "+Math.round((t[i.Character].matchscore.scoreagainst+t.matchscore[i.Character].scorena)*100)/100+")<\/p>";r+="<p>Weighted character score: <b>"+Math.round(t[i.Character].matchscore.scoreoverall*i.Weight*10)/100+"<\/b><\/p>";n("#tombioHelpAndInfoDialog").dialog("option","title","Character score details");n("#tombioHelpAndInfoDialog").html(r);n("#tombioHelpAndInfoDialog").dialog("open")};i.showTaxonCharacterValues=function(i,r){var u=n("<table>"),f,e;if(u.css("width","100%"),u.css("margin","0px"),f=0,e="",t.characters.forEach(function(r){var s,o,h,c;(r.Status=="key"||r.Status=="display")&&(t.charactersGrouped&&r.Group!=e&&(o=n("<tr>"),o.css("background-color","rgb(100,100,100)"),o.css("color","rgb(255,255,255)"),s=n("<td colspan='3'>"),o.append(s.append(r.Group)),u.append(o),e=r.Group),f++,o=n("<tr>"),f%2!=0?o.css("background-color","rgb(200,200,200)"):o.css("background-color","rgb(230,230,230)"),h=n("<td>").append(r.Label),c=n("<td>").append(i[r.Character].toHtml1()),o.append(h),o.append(c),u.append(o))}),u.find("td").css("padding","2"),r)return u;n("#tombioHelpAndInfoDialog").dialog("option","title",i.Taxon);n("#tombioHelpAndInfoDialog").html(u);n("#tombioHelpAndInfoDialog").dialog("open")};i.getHTMLFileSelectionDiv=function(t,i){var u=n("<div>").appendTo(i),o=this,f=this.getTaxonHtmlFiles(t),s,r,h,e;if(f.length==0)s=n("<div>").css("margin","10px").appendTo(u),s.text("No text information files (HTML) are specified in the knowledge-base for this taxon.");else{r=n('<iframe id="tombioFullDetailsHTMLDiv" scrolling="no" width="100%" frameborder="0">');f.length>1&&(h=n('<div style="margin-bottom: 20px">').appendTo(u),e=n("<select id='tombioFileSelect'><\/select>").appendTo(h),f.forEach(function(t,i){var r=n("<option/>").text(t.Caption).attr("value",i);e.append(r)}),e.selectmenu({change:function(n,i){o.showTaxonHtmlIframe(t,r,i.item.value)}}));r.on("load",function(){o.resizeIframe(n(this))});r.appendTo(u);this.showTaxonHtmlIframe(t,r,0)}};i.resizeIframe=function(n){n.height(10);n.height(n.contents().height()+100)};i.showTaxonHtmlIframe=function(n,i,r){var u=this.getTaxonHtmlFiles(n);r<=u.length-1?i.attr("src",u[r].URI+"?ver="+t.opts.tombiover):i.attr("src",null)};i.showTaxonHtmlInfo=function(i,r,u){var f=this.getTaxonHtmlFiles(i);u<=f.length-1?n.get(f[u].URI+"?ver="+t.opts.tombiover,function(t){var i=t.indexOf("<body"),u=t.indexOf("<\/body"),f=t.slice(i,u),e=n("<div>").html(f);r.html(e.html())}):r.html(null)};i.shortName=function(n){var i=n.split(" "),t="";return i.forEach(function(n,i){i==0?t+=n.substring(0,1):(t+=" ",t+=n.substring(0,3))}),t};i.taxonTag=function(n){return n.replace(/[|&;$%@"<>()+:.,'\/ ]/g,"")};i.copyTextToClipboard=function(n){var t=document.createElement("textarea"),i,r;t.value=n;document.body.appendChild(t);t.select();try{i=document.execCommand("copy");r=i?"successful":"unsuccessful";console.log("Copying text "+r)}catch(u){console.log("Oops, unable to copy text")}document.body.removeChild(t)};i.scoreColours=["#fc8d59","#ffffbf","#91bfdb"]})(jQuery,this.tombiovis);