!function(E,A){"use strict";A.f.checkKnowledgeBase=function(){if(void 0===A.opts.checkKB&&(A.opts.checkKB=A.d.kbconfig.checkValidity&&"yes"==A.d.kbconfig.checkValidity),!A.opts.checkKB)return!0;E("<div>").attr("id","tombioKBReport").css("display","none").appendTo("#tombiod3vis"),E("<button>").attr("id","tombioReload").text("Reload").appendTo("#tombioKBReport"),E("<button>").attr("id","tombioContinue").text("Continue").appendTo("#tombioKBReport");var l,e,t,a,c=!0,o=!0,i=!0,r=!0,n=!0,s=!0,h=A.d.characters.map(function(e){return e.Character}),u=Object.keys(A.d.taxa[0]).filter(function(e){return""!=e}),d=[];A.d.values.forEach(function(e){-1==d.indexOf(e.Character)&&d.push(e.Character)});var p=A.d.characters.filter(function(e){return"numeric"==e.ValueType&&-1<u.indexOf(e.Character)}).map(function(e){return e.Character}),m=A.d.characters.filter(function(e){return("ordinal"==e.ValueType||"ordinalCircular"==e.ValueType)&&-1<u.indexOf(e.Character)}).map(function(e){return e.Character}),f=A.d.characters.filter(function(e){return"ordinalCircular"==e.ValueType&&-1<u.indexOf(e.Character)}).map(function(e){return e.Character});function b(e,t){return!(!A.d.kbmetadata[e]||""==String(A.d.kbmetadata[e]).trim())||(s=!1,l.append(E('<li class="tombioValid3">').text(t)),!1)}for(e in E("#tombioReload").click(function(e){window.location.reload(!0)}),E("#tombioContinue").css("margin-left","5px").click(function(e){E("#downloadspin").show(),E("#tombioKBReport").hide(),setTimeout(function(){A.f.loadcomplete("force")},100)}),E("#tombioKBReport").append(E("<h3>").text("First fix these knowledge-base problems...")),E("#tombioKBReport").append(E("<p>").html("Some problems were found with the knowledge-base. They should be easy enough to fix. Read on for more details and guidance.")),E("#tombioKBReport").append(E("<p>").html("When you've fixed one or more problems, use the <i>Save worksheets as CSV</i> button on the KB to regenerate the CSVs and then click the <i>Reload</i> button above.")),E("#tombioKBReport").append(E("<p>").html("The problems are colour-coded according to the schema shown below:")),(l=E("<ul>")).append(E('<li class="tombioValid3">').html("These are serious problems that could cause the visualisation software to malfunction.")),l.append(E('<li class="tombioValid2">').html("These problems are not likely to cause the visualisation software to malfunction, but you might not see what you expect.")),l.append(E('<li class="tombioValid1">').html("These are for information only - it may be what you intended to do, but if not, you may as well sort them out. These will not cause the visualisation software to malfunction.")),E("#tombioKBReport").append(l),l=E("<ul>"),a=["Key","Type","Mandatory","Value","Date","Notes"],t=[],A.d.config[0])A.d.config[0].hasOwnProperty(e)&&t.push(e);a.forEach(function(e){-1==E.inArray(e,t)&&(l.append(E('<li class="tombioValid3">').html("The madatory column <b>'"+e+"'</b> is missing.")),s=!1)}),b("title","You must specify a title for the KB (Key - title). This is used to generate a citation.")||(s=!1),b("year","You must specify a year for the KB (Key - year). This is used to generate a citation.")||(s=!1),b("authors","You must specify one or more authors for the KB (Key - authors). This is used to generate a citation. Authors will appear in the citation exactly as you specify them.")||(s=!1),b("version","You must specify a version for the KB (Key - version). This is used to generate a citation.")||(s=!1),s||(E("#tombioKBReport").append(E("<h4>").text("On the config worksheet...")),E("#tombioKBReport").append(l)),l=E("<ul>"),A.d.taxa[0].Taxon||(l.append(E('<li class="tombioValid3">').html("There must be a column called <i>Taxon</i> (case sensitive) which stores the names of the taxa you are working with.")),c=!1);var y,v=/^[a-zA-Z0-9\-_]+$/;Object.keys(A.d.taxa[0]).forEach(function(e,t){v.test(e)||(l.append(E('<li class="tombioValid3">').html("<b>'"+e+"'</b> (column "+(t+1)+") is not a valid identifier for a character. Use only alphanumerics with no spaces.")),c=!1)});var T=/^(\d+(\.\d*)?|\.\d+)$/,w=/^\[(\d+(\.\d*)?|\.\d+)-(\d+(\.\d*)?|\.\d+)\]$/;p.forEach(function(t){A.d.taxa.forEach(function(e){(y=e[t])||""==y||console.log(e.Taxon,t,y),""==y||"n/a"==y||"novalue"==y||"?"==y||"#"==y.substr(0,1)||T.test(y)||w.test(y)||(l.append(E('<li class="tombioValid3">').html("The value <b>'"+y+"'</b> is not a valid for the numeric character <b>'"+t+"'</b> and taxon <b>'"+e.Taxon+"'</b>. Values must be a number or a range in the form '[x-y]'. (Other permitted values are '?', 'n/a', 'novalue' and no specified value.)")),c=!1)})});var x=/^\[[^-]+-[^-]+\]$/;for(e in m.forEach(function(r){var n=A.d.values.filter(function(e){return e.Character==r}),s=[];A.d.values.forEach(function(e){e.Character==r&&e.StateGroup&&-1==s.indexOf(e.StateGroup)&&s.push(e.StateGroup)}),A.d.taxa.forEach(function(i){if(""!=(y=i[r])&&"n/a"!=y&&"novalue"!=y&&"?"!=y&&"#"!=y.substr(0,1))y.split("|").forEach(function(e){var a=!0;if(3<(e=e.trim()).length&&("(m)"==e.substr(e.length-3,3)||"(f)"==e.substr(e.length-3,3))&&(e=e.substr(0,e.length-3).trim()),x.test(e))var t=e.slice(1,-1).split("-").slice(0,2);else t=[e];if(t.forEach(function(t){t=t.trim(),0==n.filter(function(e){return e.CharacterState==t}).length&&-1==s.indexOf(t)&&(l.append(E('<li class="tombioValid2">').html("The value <b>'"+t+"'</b> for character <b>'"+r+"'</b> and taxon <b>'"+i.Taxon+"'</b> is not represented in the values worksheet either as a state value or a state group. All character state values for ordinal and ordinalCircular characters must be represented on the values worksheet.")),a=c=!1)}),a&&2==t.length&&-1==f.indexOf(r)){var o=n.map(function(e){return e.CharacterState});o.indexOf(t[0])>o.indexOf(t[1])&&(l.append(E('<li class="tombioValid2">').html("The ordinal range <b>'"+e+"'</b> for character <b>'"+r+"'</b> and taxon <b>'"+i.Taxon+"'</b> is not valid since the start of the range appears after the end in the ordinal values expressed on the values worksheet for this character.")),c=!1)}})})}),c||(E("#tombioKBReport").append(E("<h4>").text("On the taxa worksheet...")),E("#tombioKBReport").append(l)),l=E("<ul>"),t=[],A.d.characters[0])A.d.characters[0].hasOwnProperty(e)&&t.push(e);(a=["Group","Character","Label","Help","Status","ValueType","ControlType","Params","Weight"]).forEach(function(e){-1==E.inArray(e,t)&&(l.append(E('<li class="tombioValid3">').html("The madatory column <b>'"+e+"'</b> is missing.")),o=!1)}),["HelpShort"].forEach(function(e){-1==E.inArray(e,t)&&(l.append(E('<li class="tombioValid1">').html("The optional column <b>'"+e+"'</b> is missing.")),o=!1)}),-1==E.inArray("Strictness",t)&&-1==E.inArray("Latitude",t)?(l.append(E('<li class="tombioValid3">').html("The column <b>'Latitude'</b> is missing.")),o=!1):-1<E.inArray("Strictness",t)&&-1<E.inArray("Latitude",t)?(l.append(E('<li class="tombioValid1">').html("Columns <b>'Strictness'</b> and  <b>'Latitude'</b> are both specified. 'Strictness' has been deprecated and will be ignored in favour of 'Latitude'.")),o=!1):-1<E.inArray("Strictness",t)&&(l.append(E('<li class="tombioValid1">').html("You are using <b>'Strictness'</b> which has been deprecated (since version 1.7.0) in favour of <b>'Latitude'</b>. Strictness will still work, but you are advised to change to Latitude (see documentation).")),o=!1);var g=A.d.characters.filter(function(e){return"Taxon"==e.Character});for(e in 0<g.length&&"Taxonomy"!=g[0].Group&&(l.append(E('<li class="tombioValid3">').html("The Taxon character must have a Group value of 'Taxonomy'. It is currently set to '"+g[0].Group+"'.")),o=!1),u.forEach(function(e,t){-1==h.indexOf(e)&&(l.append(E('<li class="tombioValid3">').html("There is no row on the <i>characters</i> worksheet for the character <b>'"+e+"'</b> represented by a column (column "+(t+1)+") on the <i>taxa</i> worksheet. All columns on the <i>taxa</i> tab must be represented by a row in the <i>characters</i> worksheet regardless of whether or not they are used. Names are case sensitive. Note that rows will not be seen unless the <b>Status</b> column has a value.")),o=!1)}),h.forEach(function(e){-1==u.indexOf(e)&&(l.append(E('<li class="tombioValid2">').html("There is no column on the <i>taxa</i> worksheet for the character <b>'"+e+"'</b> which is represented in the <i>characters</i> worksheet.")),o=!1)}),A.d.characters.filter(function(e){return"key"==e.Status}).forEach(function(e){var t=!0,a=!0;if(/^([1-9]|10)$/.test(e.Weight)||(l.append(E('<li class="tombioValid3">').html("You must specify a 'Weight' value for <b>'"+e.Character+"'</b> because it has a 'Status' value of 'key'.")),o=!1),void 0!==e.Strictness&&""!=e.Strictness){"numeric"!=e.ValueType&&"ordinal"!=e.ValueType&&"ordinalCircular"!=e.ValueType||/^([0-9]|10)$/.test(e.Strictness)||(l.append(E('<li class="tombioValid2">').html("For numeric, ordinal and ordinalCircular characters, 'Strictness', if specified, must be between 0 and 10. There is an invalid 'Strictness' value for <b>'"+e.Character+"'</b>.")),o=!1)}if(void 0!==e.Latitude&&""!=e.Latitude){"numeric"!=e.ValueType||/^[0-9]\d*(\.\d+)?$/.test(e.Latitude)||(l.append(E('<li class="tombioValid2">').html("For numeric characters, 'Latitude', if specified, must be a valid number. There is an invalid 'Latitude' value for <b>'"+e.Character+"'</b>.")),o=!1);"ordinal"!=e.ValueType&&"ordinalCircular"!=e.ValueType||/^(?:[0-9]|0[1-9]|10)$/.test(e.Latitude)||(l.append(E('<li class="tombioValid2">').html("For ordinal and ordinalCircular characters, 'Latitude', if specified, must be a whole number. There is an invalid 'Latitude' value for <b>'"+e.Character+"'</b>.")),o=!1)}if(-1==["numeric","ordinal","ordinalCircular","text"].indexOf(e.ValueType)&&(l.append(E('<li class="tombioValid3">').html("<b>'"+e.ValueType+"'</b>  is an invalid 'ValueType' value for <b>'"+e.Character+"'</b>. You must specify a valid 'ValueType' because it has a 'Status' value of 'key'.")),o=t=!1),-1==["single","multi","spin"].indexOf(e.ControlType)&&(l.append(E('<li class="tombioValid3">').html("<b>'"+e.ControlType+"'</b> is an invalid 'ControlType' value for <b>'"+e.Character+"'</b>. You must specify a valid 'ControlType' because it has a 'Status' value of 'key'.")),o=a=!1),t&&a&&-1=={numeric:["spin"],text:["single","multi"],ordinal:["single","multi"],ordinalCircular:["single","multi"]}[e.ValueType].indexOf(e.ControlType)&&(l.append(E('<li class="tombioValid3">').html("Invalid combination of 'ValueType' <b>('"+e.ValueType+"')</b> and 'ControlType' <b>('"+e.ControlType+"')</b> for <b>'"+e.Character+"'</b>. You must specify a valid combination because it has a 'Status' value of 'key'.")),o=!1),"spin"==e.ControlType){/^(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+)$/.test(e.Params)||(l.append(E('<li class="tombioValid3">').html("<b>'"+e.Params+"'</b> is an invalid spin control 'Param' value for <b>'"+e.Character+"'</b>. It must have the form 'n,n,n' (where n can be any valid numeric value, including decimal).")),o=!1)}e.HelpShort&&!e.Help&&(l.append(E('<li class="tombioValid2">').html("A value for 'HelpShort' is set but there is no value for 'Help' for <b>'"+e.Character+"'</b>. You can set 'Help' without setting 'HelpShort', but not the other way around.")),o=!1)}),o||(E("#tombioKBReport").append(E("<h4>").text("On the characters worksheet...")),E("#tombioKBReport").append(l)),l=E("<ul>"),E("<ul>"),t=[],A.d.values[0])A.d.values[0].hasOwnProperty(e)&&t.push(e);for(e in(a=["Character","CharacterState","CharacterStateTranslation","StateHelp"]).forEach(function(e){-1==E.inArray(e,t)&&(l.append(E('<li class="tombioValid3">').html("The madatory column <b>'"+e+"'</b> is missing.")),i=!1)}),["StateHelpShort"].forEach(function(e){-1==E.inArray(e,t)&&(l.append(E('<li class="tombioValid1">').html("The optional column <b>'"+e+"'</b> is missing.")),i=!1)}),d.forEach(function(e){-1==h.indexOf(e)&&(l.append(E('<li class="tombioValid2">').html("There is no row on the <i>characters</i> worksheet for the character <b>'"+e+"'</b> represented in the <i>values</i> worksheet.")),i=!1)}),A.d.values.forEach(function(e){e.StateHelpShort&&!e.StateHelp&&(l.append(E('<li class="tombioValid2">').html("A value for 'StateHelpShort' is set but there is no value for 'StateHelp' for <b>'"+e.Character+" - "+e.CharacterState+"'</b>. You can set 'StateHelp' without setting 'StateHelpShort', but not the other way around.")),i=!1)}),i||(E("#tombioKBReport").append(E("<h4>").text("On the values worksheet...")),E("#tombioKBReport").append(l)),l=E("<ul>"),t=[],A.d.media[0])A.d.media[0].hasOwnProperty(e)&&t.push(e);(a=["URI","ImageWidth","Type","Priority","Caption","Taxon","Character","State"]).forEach(function(e){-1==E.inArray(e,t)&&(l.append(E('<li class="tombioValid3">').html("The madatory column <b>'"+e+"'</b> is missing.")),r=!1)}),["UseFor","TipStyle","SmallURI","LargeURI"].forEach(function(e){-1==E.inArray(e,t)&&(l.append(E('<li class="tombioValid1">').html("The optional column <b>'"+e+"'</b> is missing.")),r=!1)}),A.d.media.filter(function(e){return"image-local"==e.Type||"image-web"==e.Type}).forEach(function(t){if(""!=t.Character&&-1==h.indexOf(t.Character)?(l.append(E('<li class="tombioValid2">').html("An image is specified for the character <b>'"+t.Character+"'</b> on the media worksheet, but that character is not on the characters worksheet.")),r=!1):t.Character,""!=t.State&&""==t.Character&&(l.append(E('<li class="tombioValid2">').html("An image is specified for the state value <b>'"+t.State+"'</b> on the media worksheet, but no character is specified.")),r=!1),""!=t.State&&""!=t.Character){var e=A.d.values.filter(function(e){return t.Character==e.Character&&t.State==e.CharacterState});0!=e.length&&""!=e[0].StateHelp||(l.append(E('<li class="tombioValid2">').html("An image is specified for the character <b>'"+t.Character+"'</b> and state <b>'"+t.State+"'</b> on the media worksheet, but no corresponding pair is found with help text on the values worksheet, so it won't be displayed.")),r=!1)}}),r||(E("#tombioKBReport").append(E("<h4>").text("On the media worksheet...")),E("#tombioKBReport").append(l)),l=E("<ul>");var C=A.d.characters.filter(function(e){return"Taxonomy"==e.Group}),V=1<C.length?C[C.length-1].Character:null;if(V&&"Taxon"!=V&&(l.append(E('<li class="tombioValid3">').html("The last Taxonomy row representing '"+V+"' on the characters worksheet appears below the row representing 'Taxon' - it must come above.")),n=!1),"Taxon"==V&&2<C.length)for(var S=C.length-2;0<S;S--){var k=C[S].Character,K=C[S].Label,B=C[S-1].Character,O=C[S-1].Label,R=[];A.d.taxa.forEach(function(e){""!=e[k]&&-1==R.indexOf(e[k])&&R.push(e[k])}),R.forEach(function(t){var a=[];A.d.taxa.filter(function(e){return e[k]==t}).forEach(function(e){-1==a.indexOf(e[B])&&a.push(e[B])}),1<a.length&&(l.append(E('<li class="tombioValid3">').html("Taxa of "+K+" "+t+" are represented by more than one "+O+", breaking the rules of a strict hierarchical taxonomy. Check that the taxonomy columns are specified in the correct order on the characters worksheet  (at the moment "+O+" is specified at a higher level than "+K+"). If they are, then check the values for "+O+" and "+K+" on the taxa worksheet.")),n=!1)})}return n||(E("#tombioKBReport").append(E("<h4>").text("Taxonomy problems...")),E("#tombioKBReport").append(l)),!!(c&&o&&i&&r&&s&n)||(E("#tombioKBReport").show(),E("#downloadspin").hide(),!1)},A.f.mediaCheck=function(i,t,a){var r=[];return A.d.media.filter(function(e){return e[i]&&("image-local"==e.Type||"html-local"==e.Type||"image-web"==e.Type)}).forEach(function(o){var e=new Promise(function(e,t){if("image-web"==o.Type){var a=new Image;a.onload=function(){e(o[i])},a.onerror=function(){t(o[i])},a.src=o[i]}else E.ajax({url:o[i],type:"HEAD",success:function(){e(o[i])},error:function(){t(o[i])}})}).then(function(e){t(e)},function(e){a(e)});r.push(e)}),Promise.all(r)},A.f.tvkCheck=function(t,o,e){var i=[];A.d.oCharacters.TVK?(A.d.taxa.forEach(function(a){if(a.TVK.kbValue){var e=new Promise(function(e,t){E.ajax({url:"https://species-ws.nbnatlas.org/species/"+a.TVK.kbValue,dataType:"json",success:function(){e(a)},error:function(){t(a)}})}).then(function(e){t(e)},function(e){o(e)});i.push(e)}}),Promise.all(i).then(function(){e()})):e()}}(jQuery,this.tombiovis);