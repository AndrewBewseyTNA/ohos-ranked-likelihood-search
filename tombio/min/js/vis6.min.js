!function(e,v){"use strict";var i="vis6",h=v.v.visualisations[i]=Object.create(v.v.visP);h.visName=i,h.fn={};var p="all",f=!0;function m(t,e){var i=Math.pow(10,e||0);return Math.round(t*i)/i}function o(t,e,i){var a=t[e.Character].score.overall;return i&&(a=a*e.Weight/10),m(a,1)}function b(t){if((t=(Math.round(10*t)/10).toFixed(1))<0)var e="";else if(0<t)e="+";else e=" ";return e+t}h.initialise=function(){this.metadata.title="Mobile key",this.metadata.authors="Rich Burkmar",this.metadata.year="2018",this.metadata.publisher="Field Studies Council",this.metadata.location="Preston Montford, Shropshire",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.0",this.helpFiles=[];var t=v.opts.toolconfig[this.visName].keyinput;v.gui.sharedKeyInput[t]||(v.gui.sharedKeyInput[t]=Object.create(v.gui[t]),v.gui.sharedKeyInput[t].init(e(v.gui.main.divInput))),h.inputControl=v.gui.sharedKeyInput[t];e("#"+this.visName).html('<ons-page id="tombioVis6page"><ons-toolbar modifier="noshadow"><div class="center"><ons-segment id="tombioVis6segment" style="width: calc(100% - 10px); margin: 0 5px 0 5px"><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'all\')"><div class="vis6ellipsis">All</div></button><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'matched\')"><div class="vis6ellipsis">Matched</div></button><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'discounted\')"><div class="vis6ellipsis">Discounted</div></button></ons-segment></div></ons-toolbar><div id="tombioVis6Main" style="position:relative"></ons-page><div>'),document.addEventListener("show",function(t){"tombioVis6page"==t.target.id&&h.refresh()}),this.initialised=!0,v.f.checkInterface(i,v.templates.visTemplate,v.v.visualisations[i])},h.refresh=function(){var e=[];v.d.taxa.forEach(function(t){("all"==p||"matched"==p&&t.visState.score.charFor==t.visState.score.charUsed||"discounted"==p&&t.visState.score.charFor!=t.visState.score.charUsed)&&e.push(t)}),"all"==p?v.f.sortTaxa(e,"all"):v.f.sortTaxa(e,"matched");for(var t=d3.select("#tombioVis6Main").selectAll(".taxon").data(e,function(t){return t.Taxon}),i=t.enter(),a=t.exit(),s=i.append("div").attr("class","taxon").style("overflow","hidden").attr("id",function(t){return"vis6 "+t.Taxon}).style("padding","5px").style("left","5px").style("opacity","0").style("width","calc(100% - 20px)").html(function(t){var e="";return e+='<table class="vis6TaxonInfo">',e+="<tr>",e+='<td class="vis6TaxonLeft">',e+="<div class='vis6ellipsis' onclick='tombiovis.gui.main.showFullDetails(\""+t.Taxon+"\", 1)'>"+t.Taxon+"</div>",e+="</td>",e+='<td class="vis6TaxonRight">',e+='<span class="vis6CharInd" data-taxon="'+t.Taxon+'">0</span>&nbsp;<span class="vis6ScoreInd" data-taxon="'+t.Taxon+'"></span>',e+='<ons-icon style="margin-left: 5px" icon="md-help" onclick="tombiovis.v.visualisations.vis6.fn.showScoreDetails(\''+t.Taxon+"')\"></ons-icon>",e+="</td>",e+="</tr>",e+="</table>"}).merge(t),n=0,o=0;o<e.length;o++)e[o].visState.vis6.y=n+10,e[o].visState.vis6.height=document.getElementById("vis6 "+e[o].Taxon.kbValue).offsetHeight,n=e[o].visState.vis6.y+e[o].visState.vis6.height;s.transition().duration(1e3).style("opacity","1").style("top",function(t,e){return t.visState.vis6.y+"px"}),a.transition().duration(1e3).style("opacity",function(){return 0}).transition().remove();var r=d3.max(v.d.taxa,function(t){return t.visState.score.overall}),l=d3.min(v.d.taxa,function(t){return t.visState.score.overall}),c=d3.scaleLinear().domain([l,0,r]).range(v.d.scoreColours),d=v.d.characters.map(function(t){return t.stateSet?1:0}).reduce(function(t,e){return t+e}),u=d3.scaleLinear().domain([0,d/2,d]).range(v.d.scoreColours);s.selectAll(".vis6ScoreInd").text(function(){return b(m(v.d.oTaxa[this.getAttribute("data-taxon")].visState.score.overall,1))}).transition().duration(1e3).style("background-color",function(){return c(v.d.oTaxa[this.getAttribute("data-taxon")].visState.score.overall,1)}),s.selectAll(".vis6CharInd").text(function(){return m(v.d.oTaxa[this.getAttribute("data-taxon")].visState.score.charFor,1)}).transition().duration(1e3).style("background-color",function(){return u(v.d.oTaxa[this.getAttribute("data-taxon")].visState.score.charFor)}),f&&(f=!1,setTimeout(h.refresh,1e3))},h.urlParams=function(t){console.log("URL parameters:",t)},h.show=function(){e("#vis6").show(),e(h.inputControl.divSel).show(),h.inputControl.initFromCharacterState()},h.hide=function(){e("#vis6").hide(),e(h.inputControl.divSel).hide()},h.fn.setVisType=function(t){p=t,h.refresh()},h.fn.showScoreDetails=function(t){var s=v.d.oTaxa[t],n="";n+='<div style="font-style: italic; font-size: 1.2em">'+t+"</div>",n+='<div style="margin: 1em 0">',n+="Matching characters: <b>"+s.visState.score.charFor+" from "+s.visState.score.charUsed+"</b><br/>",n+="Overall matching score: <b>"+m(s.visState.score.overall,1)+"</b><br/>",n+="</div>",n+="<ons-list>",v.d.characters.forEach(function(e){if(e.userInput){var t=d3.max(v.d.taxa,function(t){return t[e.Character].score.overall}),i=d3.min(v.d.taxa,function(t){return t[e.Character].score.overall}),a=d3.scaleLinear().domain([i,0,t]).range(v.d.scoreColours);n+="<ons-list-item expandable tappable>",n+='<div class="middle">'+e.Label+"</div>",n+='<div class="left" ><span class="vis6CharWeightedScore" style="background-color: '+a(o(s,e,!0))+'">'+b(o(s,e,!0))+"</span></div>",n+='<div class="expandable-content">',n+="<table>",n+="<tr>",n+='<td style="white-space: nowrap">Input states:</td>',n+="<td>"+function(e){if("text"==e.ValueType||"ordinal"==e.ValueType||"ordinalCircular"==e.ValueType){var i="";e.userInput.forEach(function(t){i&&(i+=" <i>or</i> "),i+='<span style="font-weight: bold">'+e.CharacterStateValues[t]+"</span>"})}else if("numeric"==e.ValueType)var i='<span style="font-weight: bold">'+e.userInput+"</span>";return i}(e)+"</td>",n+="</tr>",n+="<tr>",n+='<td style="white-space: nowrap">Taxon states:</td>',n+="<td>"+s[e.Character].toHtml2(!0)+"</td>",n+="</tr>",n+="<tr>",n+="<td>Match:</td>",n+="<td><b>"+(0<o(s,e,!0)?"yes":"no")+"</b></td>",n+="</tr>",n+="<tr>",n+="<td>Weighted:</td>",n+="<td><b>"+b(o(s,e,!0))+"</b></td>",n+="</tr>",n+="<td>Unweighted:</td>",n+="<td><b>"+b(o(s,e,!1))+"</b></td>",n+="</tr>",n+="</table>",n+="</div>",n+="</ons-list-item>"}}),n+="</ons-list>",v.gui.main.dialog("Taxon score breakdown",n)}}(jQuery,this.tombiovis);