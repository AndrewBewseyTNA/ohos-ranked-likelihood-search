!function(p,f){"use strict";var i="vis6",m=f.v.visualisations[i]=Object.create(f.v.visP);m.visName=i,m.fn={};var b="all",g=!0;function x(t,i){var e=Math.pow(10,i||0);return Math.round(t*e)/e}function o(t,i,e){var a=t[i.Character].score.overall;return e&&(a=a*i.Weight/10),x(a,1)}function y(t){if((t=(Math.round(10*t)/10).toFixed(1))<0)var i="";else if(0<t)i="+";else i=" ";return i+t}m.initialise=function(){this.metadata.title="Mobile key",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.helpFiles=[f.opts.tombiopath+"vis6/vis6Help.html"];var t=f.opts.toolconfig[this.visName].keyinput;f.gui.sharedKeyInput[t]||(f.gui.sharedKeyInput[t]=Object.create(f.gui[t]),f.gui.sharedKeyInput[t].init(p(f.gui.main.divInput))),m.inputControl=f.gui.sharedKeyInput[t];p("#"+this.visName).html('<ons-page id="tombioVis6page"><ons-toolbar modifier="noshadow"><div class="center"><ons-segment id="tombioVis6segment" style="width: calc(100% - 10px); margin: 0 5px 0 5px"><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'all\')"><div class="vis6ellipsis">All</div></button><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'matched\')"><div class="vis6ellipsis">Matched</div></button><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'discounted\')"><div class="vis6ellipsis">Discounted</div></button></ons-segment></div></ons-toolbar><div id="tombioVis6Main" style="position:relative"></ons-page><div>'),document.addEventListener("show",function(t){"tombioVis6page"==t.target.id&&m.refresh()}),this.initialised=!0,f.f.checkInterface(i,f.templates.visTemplate,f.v.visualisations[i])},m.refresh=function(){var i=[];f.d.taxa.forEach(function(t){("all"==b||"matched"==b&&t.visState.score.charFor==t.visState.score.charUsed||"discounted"==b&&t.visState.score.charFor!=t.visState.score.charUsed)&&i.push(t)}),"all"==b?f.f.sortTaxa(i,"all"):f.f.sortTaxa(i,"matched");for(var t=d3.select("#tombioVis6Main").selectAll(".taxon").data(i,function(t){return t.Taxon}),e=t.enter(),a=t.exit(),s=e.append("div").attr("class","taxon").style("overflow","hidden").attr("id",function(t){return"vis6 "+t.Taxon}).style("padding","5px").style("left","5px").style("opacity","0").style("width","calc(100% - 20px)").html(function(t){var i="";return i+='<table class="vis6TaxonInfo">',i+="<tr>",i+='<td class="vis6TaxonLeft">',i+="<div class='vis6ellipsis' onclick='tombiovis.gui.main.showFullDetails(\""+t.Taxon+"\", 1)'>"+t.Taxon+"</div>",i+="</td>",i+='<td class="vis6TaxonRight">',i+='<span class="vis6CharInd" data-taxon="'+t.Taxon+'">0</span>&nbsp;<span class="vis6ScoreInd" data-taxon="'+t.Taxon+'"></span>',i+='<ons-icon style="margin-left: 5px" icon="md-help" onclick="tombiovis.v.visualisations.vis6.fn.showScoreDetails(\''+t.Taxon+"')\"></ons-icon>",i+="</td>",i+="</tr>",i+="</table>"}).merge(t),n=0,o=0;o<i.length;o++){var r=document.getElementById("vis6 "+i[o].Taxon.kbValue),l=p(r).find(".vis6TaxonRight");l.show(),r.scrollWidth>p(r).innerWidth()&&l.hide(),i[o].visState.vis6.y=n+10,i[o].visState.vis6.height=r.offsetHeight,n=i[o].visState.vis6.y+i[o].visState.vis6.height}s.transition().duration(1e3).style("opacity","1").style("top",function(t,i){return t.visState.vis6.y+"px"}),a.transition().duration(1e3).style("opacity",function(){return 0}).transition().remove();var d=d3.max(f.d.taxa,function(t){return t.visState.score.overall}),c=d3.min(f.d.taxa,function(t){return t.visState.score.overall}),u=d3.scaleLinear().domain([c,0,d]).range(f.d.scoreColours),v=f.d.characters.map(function(t){return t.stateSet?1:0}).reduce(function(t,i){return t+i}),h=d3.scaleLinear().domain([0,v/2,v]).range(f.d.scoreColours);s.selectAll(".vis6ScoreInd").text(function(){return y(x(f.d.oTaxa[this.getAttribute("data-taxon")].visState.score.overall,1))}).transition().duration(1e3).style("background-color",function(){return u(f.d.oTaxa[this.getAttribute("data-taxon")].visState.score.overall,1)}),s.selectAll(".vis6CharInd").text(function(){return x(f.d.oTaxa[this.getAttribute("data-taxon")].visState.score.charFor,1)}).transition().duration(1e3).style("background-color",function(){return h(f.d.oTaxa[this.getAttribute("data-taxon")].visState.score.charFor)}),"guiOnsenUi"!=f.opts.gui&&d3.select("#vis6").transition().duration(1e3).style("height",n+20+"px"),g&&(g=!1,setTimeout(m.refresh,1e3))},m.urlParams=function(t){},m.show=function(){p("#vis6").show(),p(m.inputControl.divSel).show(),m.inputControl.initFromCharacterState()},m.hide=function(){p("#vis6").hide(),p(m.inputControl.divSel).hide()},m.fn.setVisType=function(t){b=t,m.refresh()},m.fn.showScoreDetails=function(t){var s=f.d.oTaxa[t],n="";n+='<div style="font-style: italic; font-size: 1.2em">'+t+"</div>",n+='<div style="margin: 1em 0">',n+="Matching characters: <b>"+s.visState.score.charFor+" from "+s.visState.score.charUsed+"</b><br/>",n+="Overall matching score: <b>"+x(s.visState.score.overall,1)+"</b><br/>",n+="</div>",n+="<ons-list>",f.d.characters.forEach(function(i){if(i.userInput){var t=d3.max(f.d.taxa,function(t){return t[i.Character].score.overall}),e=d3.min(f.d.taxa,function(t){return t[i.Character].score.overall}),a=d3.scaleLinear().domain([e,0,t]).range(f.d.scoreColours);n+="<ons-list-item expandable tappable>",n+='<div class="middle">'+i.Label+"</div>",n+='<div class="left" ><span class="vis6CharWeightedScore" style="background-color: '+a(o(s,i,!0))+'">'+y(o(s,i,!0))+"</span></div>",n+='<div class="expandable-content">',n+="<table>",n+="<tr>",n+='<td style="white-space: nowrap">Input states:</td>',n+="<td>"+function(i){if("text"==i.ValueType||"ordinal"==i.ValueType||"ordinalCircular"==i.ValueType){var e="";i.userInput.forEach(function(t){e&&(e+=" <i>or</i> "),e+='<span style="font-weight: bold">'+i.CharacterStateValues[t]+"</span>"})}else if("numeric"==i.ValueType)var e='<span style="font-weight: bold">'+i.userInput+"</span>";return e}(i)+"</td>",n+="</tr>",n+="<tr>",n+='<td style="white-space: nowrap">Taxon states:</td>',n+="<td>"+s[i.Character].toHtml2(!0)+"</td>",n+="</tr>",n+="<tr>",n+="<td>Match:</td>",n+="<td><b>"+(0<o(s,i,!0)?"yes":"no")+"</b></td>",n+="</tr>",n+="<tr>",n+="<td>Weighted:</td>",n+="<td><b>"+y(o(s,i,!0))+"</b></td>",n+="</tr>",n+="<td>Unweighted:</td>",n+="<td><b>"+y(o(s,i,!1))+"</b></td>",n+="</tr>",n+="</table>",n+="</div>",n+="</ons-list-item>"}}),n+="</ons-list>",f.gui.main.dialog("Taxon score breakdown",n)}}(jQuery,this.tombiovis);