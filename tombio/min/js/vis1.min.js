!function(T,w){"use strict";var I,b="vis1",i=w.v.visualisations[b]=Object.create(w.v.visP);function M(t,i){var e=w.f.getTaxonImages(t.Taxon);if(0<e.length){var a=new Image;a.onload=function(){d3.select("#vis1Svg").select("#taxon-"+i).select(".taxonimage").attr("xlink:href",this.src).style("z-index",1e3).attr("height",(I.taxwidth-2*I.margin)*a.height/a.width),t.visState.vis1.height=(I.taxwidth-2*I.margin)*a.height/a.width+I.indVoffset+I.margin,I.refresh()},a.src=e[0].URI}}i.visName=b,i.initialise=function(){(I=this).metadata.title="Two-column key",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.displayToolTips=!0,this.taxheight=35,this.indVoffset=18,this.helpFiles=[w.opts.tombiopath+"vis1/vis1Help.html",w.opts.tombiopath+"common/taxonDetailsHelp.html",w.opts.tombiopath+"common/full-details.html",w.opts.tombiopath+"common/stateInputHelp.html"],this.taxwidth=220,this.margin=4,T("#"+this.visName).append(T("<div>").attr("id","headerTaxa").append(T("<span>").attr("id","candidateTaxa").css("position","absolute").css("width",this.taxwidth).css("left",this.margin).css("font-size","small").text("Evidence balance positive")).append(T("<span>").attr("id","excludedTaxa").css("position","absolute").css("width",this.taxwidth).css("left",this.taxwidth+2*this.margin).css("font-size","small").text("Evidence balance negative"))),d3.select("#"+this.visName).append("svg").attr("id","vis1Svg");var t=w.opts.toolconfig[this.visName].keyinput;w.gui.sharedKeyInput[t]||(w.gui.sharedKeyInput[t]=Object.create(w.gui[t]),w.gui.sharedKeyInput[t].init(T(w.gui.main.divInput))),i.inputControl=w.gui.sharedKeyInput[t],this.initialised=!0,w.f.checkInterface(b,w.templates.visTemplate,w.v.visualisations[b])},i.refresh=function(){var s=this.margin,n=this.indVoffset,o=this.taxwidth,r=this.taxheight,t=250;T("#vis1Svg").css("width",15+2*o),T("#candidateTaxa").css("left",5),T("#excludedTaxa").css("left",10+o);var i=d3.select("#vis1Svg").selectAll(".taxon").data(w.d.taxa,function(t,i){return t.Taxon}).enter().append("g").attr("class","taxon").attr("id",function(t,i){return"taxon-"+i}).style("cursor","pointer").on("click",function(t,i){t.visState.vis1.height==r?M(t,i):(t.visState.vis1.height=r,I.refresh())});i.append("rect").attr("x",0).attr("y",0).attr("class","taxarect").attr("height",r).attr("width",o),i.append("text").attr("x",0).attr("y",0).attr("class","scientificnames").style("opacity",0).style("cursor","pointer").text(function(t){return t.Taxon}).on("click",function(t){d3.event.stopPropagation(),w.gui.main.showFullDetails(t.Taxon,0)}),w.gui.main.createTaxonToolTips(".scientificnames",this.displayToolTips),i.append("svg:image").attr("class","taxonimage").attr("opacity",0).attr("width",o-2*s);for(var e=1;e<=1;e++)i.append("rect").attr("class","indicator").attr("x",0).attr("y",0).attr("width",0).attr("height",0);for(e=1;e<=1;e++)i.append("text").attr("class","indtext").attr("x",0).attr("y",0);w.d.taxa.forEach(function(t){null==t.visState.vis1.height&&(t.visState.vis1.height=r)});var a=d3.select("#vis1Svg").selectAll(".taxon"),l=[],c=[];w.d.taxa.forEach(function(t){t.visState.score.for>t.visState.score.against?l.push(t):c.push(t)}),w.f.sortTaxa(l,"vis1"),w.f.sortTaxa(c,"vis1");var h=0;for(e=0;e<l.length;e++)l[e].visState.vis1.x=5,l[e].visState.vis1.y=h+5,h=l[e].visState.vis1.y+l[e].visState.vis1.height;for(e=h=0;e<c.length;e++)c[e].visState.vis1.x=o+10,c[e].visState.vis1.y=h+5,h=c[e].visState.vis1.y+c[e].visState.vis1.height;a.select(".taxarect").transition().duration(1e3).delay(t).attr("x",function(t){return t.visState.vis1.x}).attr("y",function(t){return t.visState.vis1.y}).attr("height",function(t){return t.visState.vis1.height}),a.select(".scientificnames").transition().duration(1e3).delay(t).style("opacity",1).attr("x",function(t){return t.visState.vis1.x+5}).attr("y",function(t,i){return t.visState.vis1.y+13});var u=d3.max(w.d.taxa,function(t){return t.visState.score.for}),v=d3.max(w.d.taxa,function(t){return t.visState.score.against}),d=d3.max(w.d.taxa,function(t){return t.visState.score.overall}),m=d3.min(w.d.taxa,function(t){return t.visState.score.overall}),g=d3.scaleLinear().domain([m,0,d]).range(w.d.scoreColours),x=d3.scaleLinear().domain([0,u]).range(w.d.scoreColours.slice(1)),f=d3.scaleLinear().domain([0,v]).range(w.d.scoreColours.slice(0,1).reverse()),p=(d3.scaleLinear().domain([0,10]).range(w.d.scoreColours.slice(1)),[{scale:g,attr:"overall"},{scale:x,attr:"for"},{scale:f,attr:"against"}]),y=["overall","for","against"],S=["overall score","score for","score against"];a.selectAll(".indicator").transition().duration(1e3).delay(t).attr("fill",function(t,i,e){return p[i].scale(t.visState.score[p[i].attr])}).attr("x",function(t,i,e){var a=t.visState.vis1.x+s+i*(s+30);return t.visState.vis1.height==r?a:a+s}).attr("y",function(t,i,e){var a=t.visState.vis1.y+n;return t.visState.vis1.height==r?a:a+s}).attr("width",30).attr("height",12).attr("title",function(t,i,e){return Math.round(100*t.visState.score[y[i]])/100+" ("+S[i]+")"}),a.selectAll(".indtext").transition().duration(1e3).delay(t).text(function(t,i,e){return Math.round(100*t.visState.score[y[i]])/100}).attr("x",function(t,i,e){var a=t.visState.vis1.x+s+2+i*(s+30);return t.visState.vis1.height==r?a:a+s}).attr("y",function(t,i,e){var a=t.visState.vis1.y+n+10;return t.visState.vis1.height==r?a:a+s}),a.selectAll(".taxonImageLink").transition().duration(1e3).delay(t).attr("x",function(t){return t.visState.vis1.x+o-2*s-16}).attr("y",function(t,i,e){return t.visState.vis1.y+n+s}).style("opacity",function(i,t){return i.visState.vis1.height!=r&&0<w.d.media.filter(function(t){if(t.Taxon==i.Taxon)return!0}).length?1:0}).on("end",function(t,i){0==d3.select(this).style("opacity")?d3.select(this).attr("display","none"):d3.select(this).attr("display","")}),a.select(".taxonimage").transition().duration(1e3).delay(t).attr("opacity",function(t,i){return t.visState.vis1.height==r?0:1}).attr("x",function(t){return t.visState.vis1.x+s}).attr("y",function(t){return t.visState.vis1.y+n}).attr("width",o-2*s).on("end",function(t,i){t.visState.vis1.height==r&&d3.select(this).attr("height",0)}),d3.select("#vis1Svg").transition().duration(1e3).delay(t).attr("height",function(){if(0==c.length)var t=0;else t=c[c.length-1].visState.vis1.y+c[c.length-1].visState.vis1.height;if(0==l.length)var i=0;else i=l[l.length-1].visState.vis1.y+l[l.length-1].visState.vis1.height;return Math.max(i,t)}),w.gui.main.contextMenu.addItem("Get URL for two-column key",function(){!function(){var t=[];t.push("selectedTool="+b),Array.prototype.push.apply(t,w.f.setParamsFromControls()),t.push("imgtips="+I.displayToolTips);var e,a=null,s=[];w.d.taxa.forEach(function(t,i){t.visState.vis1.height>I.taxheight&&(null===a?e=a=i:i===e+1?e=i:(e===a?s.push(a):s.push(a+"-"+e),e=a=i))}),null!=a&&(e===a?s.push(a):s.push(a+"-"+e));t.push("expand="+s.join(",")),w.f.createViewURL(t)}()},!1,[this.visName]),this.displayToolTips?(w.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){T(".ui-tootip").remove(),I.displayToolTips=!1,w.gui.main.contextMenu.removeItem("Remove taxon image tooltips"),I.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),w.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(w.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){I.displayToolTips=!0,w.gui.main.contextMenu.removeItem("Display taxon image tooltips"),I.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),w.gui.main.contextMenu.removeItem("Remove taxon image tooltips")),w.d.taxa.some(function(t){return t.visState.vis1.height!=r})?w.gui.main.contextMenu.addItem("Contract all taxon items",function(){w.d.taxa.forEach(function(t){t.visState.vis1.height=r}),w.gui.main.contextMenu.removeItem("Contract all taxon items"),I.refresh()},!1,[this.visName]):w.gui.main.contextMenu.removeItem("Contract all taxon items"),w.d.taxa.some(function(t){return t.visState.vis1.height==r&&0<w.f.getTaxonImages(t.Taxon).length})?w.gui.main.contextMenu.addItem("Expand all taxon items",function(){w.d.taxa.forEach(function(t,i){var e=w.f.getTaxonImages(t.Taxon);if(t.visState.vis1.height==r&&0<e.length){var a=new Image;a.onload=function(){d3.select("#vis1Svg").select("#taxon-"+i).select(".taxonimage").attr("xlink:href",this.src).attr("height",(o-2*s)*a.height/a.width),t.visState.vis1.height=(o-2*s)*a.height/a.width+n+s,I.refresh()},a.src=e[0].URI}}),w.gui.main.contextMenu.removeItem("Expand all taxon items")},!1,[this.visName]):w.gui.main.contextMenu.removeItem("Expand all taxon items")},i.urlParams=function(t){t.imgtips&&(I.displayToolTips="true"===t.imgtips),t.expand&&t.expand.split(",").forEach(function(t){var i=t.split("-")[0],e=t.split("-")[1];if(e)for(var a=Number(i);a<=Number(e);a++)M(w.d.taxa[a],a);else M(w.d.taxa[i],i)}),w.f.initControlsFromParams(t)},i.show=function(){T("#vis1").show(),T(i.inputControl.divSel).show(),i.inputControl.initFromCharacterState()},i.hide=function(){T("#vis1").hide(),T(i.inputControl.divSel).hide()}}(jQuery,this.tombiovis);