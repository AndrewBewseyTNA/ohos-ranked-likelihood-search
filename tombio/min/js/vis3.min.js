!function(u,h){"use strict";var r,s,v="vis3",a=h.v.visualisations[v]=Object.create(h.v.visP);function f(a,e,t,i){e.on("remove",function(){a.closest(".pq-td-div").css("padding",""),a.closest("td").css("background-color",""),t.fadeIn(),h.d.oTaxa[i.taxon.kbValue].visState[v].imgDiv=null,e.is(".userRemoved")&&(h.d.oTaxa[i.taxon.kbValue].visState[v].displayImages=!1)})}function p(a){var e=a.attr("taxon"),t=h.d.oTaxa[e],i=u("<div>");h.f.addTaxonImagesToContainer({taxon:e,container:i,indexSelected:h.d.oTaxa[e].visState[v].indexSelected,imageRemovalButton:!0,height:r.vis3ColWidth,fImageSelect:function(a){h.d.oTaxa[e].visState[v].indexSelected=a}}),h.d.oTaxa[e].visState[v].imgDiv=i,a.closest(".pq-td-div").css("padding",0),a.closest("td").css("background-color","lightgrey"),a.append(i);var o=a.find(".loadImgIcon");return o.fadeOut(0),f(a,i,o,t),h.d.oTaxa[e].visState[v].displayImages=!0,i}function m(t,i,o){var s=o.Character,a=null;if("key"==o.Status)if("n/a"==i[s].kbValue||"novalue"==i[s].kbValue||""==i[s].kbValue)"n/a"==t[s].kbValue||"novalue"==t[s].kbValue||""==t[s].kbValue||(a=-1);else if("n/a"==t[s].kbValue||"novalue"==t[s].kbValue||""==t[s].kbValue)a=-1;else if("numeric"==o.ValueType){o.maxVal,o.minVal;var e=h.f.score.numberVsRange(i[s].getRange().min,t[s].getRange(),o.Latitude),n=h.f.score.numberVsRange(i[s].getRange().max,t[s].getRange(),o.Latitude);a=(e[0]-e[1]+n[0]-n[1])/2}else if("ordinal"==o.ValueType||"ordinalCircular"==o.ValueType){var r,d=0,c=0;["male","female",""].forEach(function(e){i[s].getOrdinalRanges(e).forEach(function(a){r=h.f.score.ordinal(a,t[s].getOrdinalRanges(e),o.CharacterStateValues,o.Latitude,"ordinalCircular"==o.ValueType),c+=r[0],c-=r[1],d++})}),a=c/d}else{d=0,c=0;["male","female",""].forEach(function(a){c+=h.f.score.jaccard(i[s].getStates(a),t[s].getStates(a)),d++}),a=2*(c/d)-1}return a}a.visName=v,a.initialise=function(){function a(a){var e=[];if(h.d.taxa.forEach(function(a){e.push(a)}),h.f.sortTaxa(e),e.length>a)var t=e.slice(0,a);else t=e;r.vis3Taxa=t.map(function(a){return a.taxon.kbValue}),s.deselectAllTaxa(),r.vis3Taxa.forEach(function(a){s.taxonClick(a)})}function e(a){var e=[];if(u("#visType3Grid").pqGrid("getColModel").forEach(function(a){"group"!=a.dataIndx&&"character"!=a.dataIndx&&e.push(h.d.oTaxa[a.dataIndx])}),0!=e.length){var t=e[0];if(a&&(e=h.d.taxa),e.forEach(function(e){e.taxon==t.taxon?e.vis3CompScore=999999:(e.vis3CompScore=0,h.d.characters.forEach(function(a){"key"==a.Status&&(e.vis3CompScore+=m(t,e,a))}))}),e.sort(function(a,e){return a.vis3CompScore>e.vis3CompScore?-1:1}),a)var i=e.slice(0,a+1);else i=e;r.vis3Taxa=i.map(function(a){return a.taxon.kbValue}),s.deselectAllTaxa(),r.vis3Taxa.forEach(function(a){s.taxonClick(a)})}}(r=this).metadata.title="Side by side comparison",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.imageIndex=0,this.helpFiles=[h.opts.tombiopath+"vis3/vis3Help.html",h.opts.tombiopath+"common/taxon-select-help.html"],h.gui.main.contextMenu.addItem("Get URL for side by side comparison view",function(){!function(){var a=[];a.push("selectedTool="+v);for(var e=[],t=u(".pq-grid-title-row").find(".pq-td-div"),i=1;i<t.length;i++)e.push(t[i].children[0].innerText);a.push("taxa="+e.join("^"));var o=[];e.forEach(function(a){void 0!==h.d.oTaxa[a].visState[v].indexSelected?o.push(h.d.oTaxa[a].visState[v].indexSelected):o.push("x")}),a.push("imgs="+o.join("-")),a.push("colwidth="+r.vis3ColWidth),a=s.setParamsFromState(a),h.f.createViewURL(a)}()},!1,[this.visName]),h.gui.main.contextMenu.addItem("Rank those shown against first",function(){e(),r.refresh()},!1,[this.visName]),h.gui.main.contextMenu.addItem("Show closest two to first",function(){e(2),r.refresh()},!1,[this.visName]),h.gui.main.contextMenu.addItem("Show closest five to first",function(){e(5),r.refresh()},!1,[this.visName]),h.gui.main.contextMenu.addItem("Show closest ten to first",function(){e(10),r.refresh()},!1,[this.visName]),h.gui.main.contextMenu.addItem("Show top two from key",function(){a(2),r.refresh()},!1,[this.visName]),h.gui.main.contextMenu.addItem("Show top five from key",function(){a(5),r.refresh()},!1,[this.visName]),h.gui.main.contextMenu.addItem("Show top ten from key",function(){a(10),r.refresh()},!1,[this.visName]),h.gui.main.contextMenu.addItem("Remove all",function(){r.vis3Taxa=[],r.refresh(),s.deselectAllTaxa()},!1,[this.visName]),r.vis3Taxa=[];var t=u("<div/>").css("position","relative").css("top",-13);u(this.cssSel).append(t),(s=Object.create(h.gui.taxonSelect)).init(h.gui.main.divInput,!0,function(a){a.selected&&-1==r.vis3Taxa.indexOf(a.selected)&&(r.vis3Taxa.push(a.selected),r.refresh()),a.deselected&&-1!=r.vis3Taxa.indexOf(a.deselected)&&(r.vis3Taxa.splice(r.vis3Taxa.indexOf(a.deselected),1),r.refresh()),0==a.taxa.length&&(r.vis3Taxa=[],r.refresh())}),t.append(u("<div>").css("display","inline-block").css("width",150).css("height",1));var i=u("<div id='visType3Grid'></div>");t.append(i),this.taxonSelect=s,this.initialised=!0,h.f.checkInterface(v,h.templates.visTemplate,h.v.visualisations[v])},a.refresh=function(){u("#visType3Grid").is(":empty")||u("#visType3Grid").pqGrid("destroy");var a=[],i={group:" Images",character:"Images"};this.vis3Taxa.forEach(function(a){var e=h.d.oTaxa[a],t=u("<div>").attr("taxon",a).css("position","relative").attr("class","vis3ImageDiv");i[e.taxon]=t[0].outerHTML}),a.push(i),h.d.characters.forEach(function(t){if("display"==t.Status||"key"==t.Status&&"Sex"!=t.Character){var i={group:t.Group,character:t.Label,pq_cellcls:{character:t.Character}};r.vis3Taxa.forEach(function(a){var e=h.d.oTaxa[a];i[e.taxon]=e[t.Character].toHtml1()}),a.push(i)}});var n=[];["group"].concat(["character"].concat(this.vis3Taxa)).forEach(function(a,e){if(0==e)var t=!0;else t=!1;if(1==e)var i="Character";else i="<i>"+a+"</i>";if(r.vis3ColWidth||(r.vis3ColWidth=200),r.vis3CharColWidth||(r.vis3CharColWidth=200),1==e)var o=r.vis3CharColWidth;else o=r.vis3ColWidth;var s={title:i,hidden:t,width:o,dataType:"string",dataIndx:a,sortable:!1};n.push(s)});var e=null;"visible"==u("input[name=groupvisibility]:checked").val()&&(e={dataIndx:["group"],collapsed:[!0],title:["<b style='font-weight:bold;'>{0}</b>","{0}"],dir:["up","down"]});var t={flexHeight:!0,flexWidth:!0,showTop:!1,showBottom:!1,showTitle:!1,numberCell:{show:!1},stripeRows:!0,columnBorders:!0,showHeader:!0,editable:!1,resizable:!1,groupModel:e,selectionModel:{type:null,mode:null},columnResize:function(a,e){!function(a){if("character"==a.dataIndx)return r.vis3CharColWidth=a.newWidth;console.log(a.newWidth),r.vis3ColWidth=a.newWidth,o()}(e)},refresh:function(){!function(){u(".vis3ImageDiv").each(function(){var t=u(this),a=u(this).attr("taxon"),i=h.d.oTaxa[a];if(0<h.f.getTaxonImages(a).length){var e=u("<img>").attr("src",h.opts.tombiopath+"resources/camera.png").addClass("loadImgIcon").css("cursor","pointer").css("width",15).on("click",function(){var a=u(this),e=p(t);f(t,e,a,i)});u(this).append(e),h.d.oTaxa[a].visState[v].displayImages&&p(t)}});var a=d3.scaleLinear().domain([-1,0,1]).range(h.d.scoreColours),e=[];if(u("#visType3Grid").pqGrid("getColModel").forEach(function(a){"group"!=a.dataIndx&&"character"!=a.dataIndx&&e.push(a.dataIndx)}),e.length<2)return;e.forEach(function(a,e){u("td[pq-row-indx=0][pq-col-indx="+(e+2)+"]").css("background-color","rgb(100,100,100)").css("color","white")});for(var t=h.d.oTaxa[e[0]],i=1;i<e.length;i++){var o=h.d.oTaxa[e[i]];for(var s in h.d.oCharacters){var n=h.d.oCharacters[s],r=u("."+n.Character).closest("tr").attr("pq-row-indx");if(null!=r){if(1==i){var d=u("#visType3Grid").pqGrid("getCell",{rowIndx:r,dataIndx:e[0]});"key"==n.Status?"n/a"==t[s].kbValue||"novalue"==t[s].kbValue||""==t[s].kbValue||"?"==t[s].kbValue?d.css("background-color","white"):d.css("background-color",a(1)):"display"==n.Status&&d.css("background-color","lightgrey")}var c=u("#visType3Grid").pqGrid("getCell",{rowIndx:r,dataIndx:e[i]}),l=m(t,o,n);"display"==n.Status?c.css("background-color","lightgrey"):null==l?c.css("background-color","white"):c.css("background-color",a(l))}}}}()}};function o(){u("#visType3Grid").pqGrid("getColModel").forEach(function(a){"group"!=a.dataIndx&&"character"!=a.dataIndx&&(a.width=r.vis3ColWidth)}),u("#visType3Grid").pqGrid("refresh")}t.colModel=n,t.dataModel={data:a,location:"local"},u("#visType3Grid").pqGrid(t),o()},a.urlParams=function(a){r.vis3ColWidth=a.colwidth,a.taxa&&a.taxa.split("^").forEach(function(a){s.taxonClick(a.replace(/%20/g," "))}),a.imgs&&a.imgs.split("-").forEach(function(a,e){var t=r.vis3Taxa[e];if("x"!=a){h.d.oTaxa[t].visState[v].indexSelected=a;var i=u('.vis3ImageDiv[taxon="'+t+'"]'),o=i.find(".loadImgIcon");f(i,p(i),o,t)}}),setTimeout(function(){s.initStateFromParams(a)},100)},a.show=function(){u("#vis3").show(),s.$div.show()},a.hide=function(){u("#vis3").hide(),s.$div.hide()}}(jQuery,this.tombiovis);