!function(h,x){"use strict";x.gui.taxonSelect={hiddenControlsShown:!1,taxonSort:null,width:225,filterMessage:"Filter names (use # for 'starts with')",filterSelectedOnly:"Show only selected taxa",gap:6,textHeightOffset:4,taxonHeight:30,taxonWidth:200},x.gui.taxonSelect.init=function(t,e,a){var i=this;this.isMultiSelect=e,this.hostCallback=a,this.filterText="",this.selectedTaxa=[],this.taxa=[],x.d.taxa.forEach(function(t,e){this.taxa.push({name:t.Taxon.kbValue,abbrv:"",order:e})},this);var s=h('<div class="taxonSelect" />').css("width",this.taxonWidth).appendTo(t),n=d3.select(s[0]);this.$div=s;var o=h('<input type="text"/>').addClass("ui-widget ui-widget-content ui-corner-all");o.css("color","silver").css("padding-left",5).css("width",this.taxonWidth-5).css("height",this.taxonHeight),o.val(this.filterMessage),s.append(o),h("<br>").appendTo(s),o.on("keyup",function(){i.setFilter(this.value)}),o.on("focus",function(){this.value!=i.filterMessage&&this.value!=i.filterSelectedOnly||(i.setFilter(""),i.checkFilterColour())}),o.on("blur",function(){i.checkEmptyFilter(),i.checkFilterColour()});var r=h("<div>").css("margin-top",5).css("display","none").appendTo(s),c=h("<img>").attr("src",x.opts.tombiopath+"resources/chevron-down.png").attr("class","taxonSelectHiddenControlsArrow").appendTo(s);c.on("click",function(){i.toggleHiddenControls()});var l=h("<div>").appendTo(r);h("<label>").attr("for","radio-x").text("none").appendTo(l),h("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-x").attr("checked","true").appendTo(l),h("<label>").attr("for","radio-a").text("a-z").appendTo(l),h("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-a").appendTo(l),h("<label>").attr("for","radio-z").text("z-a").appendTo(l),h("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-z").appendTo(l),l.find("input").checkboxradio(),h("[name=radioSort]").on("change",function(t){i.taxonSort=h("[name='radioSort']").filter(":checked").attr("id"),i.sortTaxa(),i.updateTaxa()}),h("<button>").text("Clear filter").css("margin-top",5).css("width","100%").appendTo(r).button().on("click",function(){i.setFilter(""),i.checkEmptyFilter(),i.checkFilterColour()}),h("<button>").text("Clear selection").css("margin-top",5).css("width","100%").appendTo(r).button().on("click",function(){var t=i.selectedTaxon;i.deselectAllTaxa();var e={selected:i.selectedTaxon,deselected:t,taxa:i.selectedTaxa};i.hostCallback&&i.hostCallback(e)}),h("<button>").text("Show only selected taxa").css("margin-top",5).css("width","100%").appendTo(r).button().on("click",function(){i.setFilter(i.filterSelectedOnly),i.checkFilterColour()}),this.D3svg=n.append("svg"),this.D3svg.attr("width",this.taxonWidth);var d=d3.select("body").append("svg");this.taxa.forEach(function(t){var e=0,a=t.name;do{0<e&&(a=t.name.substr(0,t.name.length-e)+"...");var i=d.append("text").attr("class","taxonSelectScientificnames").style("opacity",0).text(a).node().getBBox().width;e++}while(i>this.taxonWidth-10);a!=t.name&&(t.abbrv=a)},this),d.remove(),this.updateTaxa(),this.$textFilter=o,this.$hiddenControlsDiv=r,this.$controlsArrow=c},x.gui.taxonSelect.setFilter=function(t){this.filterText=t,this.$textFilter.val(t),this.checkFilterColour(),this.updateTaxa()},x.gui.taxonSelect.getFilter=function(){return this.filterText!=this.filterMessage?this.filterText:null},x.gui.taxonSelect.setSort=function(t){"a-z"==t&&(t="radio-a",h("#radio-a").attr("checked","true"),h("[name=radioSort]").checkboxradio("refresh")),"z-a"==t&&(t="radio-z",h("#radio-z").attr("checked","true"),h("[name=radioSort]").checkboxradio("refresh")),"none"==t&&(t="radio-x",h("#radio-x").attr("checked","true"),h("[name=radioSort]").checkboxradio("refresh")),this.taxonSort=t,this.sortTaxa(),this.updateTaxa()},x.gui.taxonSelect.toggleHiddenControls=function(){"none"==this.$hiddenControlsDiv.css("display")?(this.$hiddenControlsDiv.slideDown(400),this.$controlsArrow.attr("src",x.opts.tombiopath+"resources/chevron-up.png"),this.hiddenControlsShown=!0):(this.$hiddenControlsDiv.slideUp(400),this.$controlsArrow.attr("src",x.opts.tombiopath+"resources/chevron-down.png"),this.hiddenControlsShown=!1)},x.gui.taxonSelect.taxonClick=function(t){var e,a=this.D3svg.select('rect[taxonName="'+t+'"]'),i=this.D3svg.select('text[taxonName="'+t+'"]');if(0!=a.size()){var s=a.classed("taxonSelectTaxarectSelected");if(a.classed("taxonSelectTaxarectDeselected",s).classed("taxonSelectTaxarectSelected",!s),i.classed("taxonSelectScientificnamesDeselected",s).classed("taxonSelectScientificnamesSelected",!s),!this.isMultiSelect&&this.selectedTaxon&&this.selectedTaxon!=t){var n=this.D3svg.select('rect[taxonName="'+this.selectedTaxon+'"]'),o=this.D3svg.select('text[taxonName="'+this.selectedTaxon+'"]');n.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1),o.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1),e=this.selectedTaxon}if(s?(this.selectedTaxon=null,e=t):this.selectedTaxon=t,e){var r=this.selectedTaxa.indexOf(e);-1!=r&&this.selectedTaxa.splice(r,1)}this.selectedTaxon&&this.selectedTaxa.push(this.selectedTaxon);var c={selected:this.selectedTaxon,deselected:e,taxa:this.selectedTaxa};this.hostCallback&&this.hostCallback(c)}else console.log("Couldn't find the taxon:",t)},x.gui.taxonSelect.deselectAllTaxa=function(){var t=this.D3svg.selectAll("rect"),e=this.D3svg.selectAll("text");t.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1),e.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1),this.selectedTaxon=null,this.selectedTaxa=[],this.updateTaxa()},x.gui.taxonSelect.deselectTaxon=function(t){var e=this.D3svg.select('rect[taxonName="'+t+'"]'),a=this.D3svg.select('text[taxonName="'+t+'"]');e.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1),a.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1),(this.selectedTaxon=t)&&(this.selectedTaxon=null);var i=this.selectedTaxa.indexOf(t);-1!=i&&this.selectedTaxa.splice(i,1)},x.gui.taxonSelect.setParamsFromState=function(t){if(e=this.getFilter()){if(e.startsWith("#"))var e="-"+e.substr(1);t.push("filter="+e)}if(this.taxonSort){if("radio-a"==this.taxonSort)var a="a-z";else if("radio-z"==this.taxonSort)a="z-a";a&&t.push("sort="+a)}return this.hiddenControlsShown&&t.push("hc=show"),t},x.gui.taxonSelect.initStateFromParams=function(t){if(t.hc&&this.toggleHiddenControls(),t.sort&&this.setSort(t.sort),t.filter){if(t.filter.startsWith("-"))var e="#"+t.filter.substr(1);else e=t.filter;this.setFilter(e)}},x.gui.taxonSelect.sortTaxa=function(){var s=this;this.taxa.sort(function(t,e){return"radio-a"!=s.taxonSort?"radio-z"!=s.taxonSort?t.order-e.order:(a=t.name.toUpperCase())<(i=e.name.toUpperCase())?1:i<a?-1:0:(a=t.name.toUpperCase())<(i=e.name.toUpperCase())?-1:i<a?1:0;var a,i})},x.gui.taxonSelect.updateTaxa=function(){var a=this,t=300,e=this.D3svg.selectAll("g").data(this.taxa.filter(function(t){if(""==this.filterText||this.filterText.toLowerCase()==this.filterMessage.toLowerCase()||"#"==this.filterText)return!0;if(this.filterText.startsWith("#")&&t.name.toLowerCase().startsWith(this.filterText.toLowerCase().substr(1)))return!0;if(-1!==t.name.toLowerCase().indexOf(this.filterText.toLowerCase()))return!0;for(var e=0;e<this.selectedTaxa.length;e++)if(this.selectedTaxa[e]==t.name)return!0;return!1},this),function(t){return t.name}),i=e.enter().append("g"),s=i.merge(e),n=e.exit();i.append("rect").style("opacity",0).attr("x",0).attr("width",this.taxonWidth).attr("height",this.taxonHeight).classed("taxonSelectTaxarect",!0).classed("taxonSelectTaxarectDeselected",!0).attr("taxonName",function(t){return t.name}).on("click",function(t){a.taxonClick(t.name)}),i.append("text").style("opacity",0).attr("x",5).classed("taxonSelectScientificnames",!0).classed("taxonSelectScientificnamesDeselected",!0).classed("abbrvName",function(t){return!!t.abbrv}).attr("taxonName",function(t){return t.name}).text(function(t){return t.abbrv?t.abbrv:t.name}).attr("title",function(t){return t.abbrv?t.name:""}).on("click",function(t){a.taxonClick(t.name)}),s.select(".taxonSelectTaxarect").transition().duration(t).delay(function(){return n.empty()?0:t}).attr("y",function(t,e){return e*(a.taxonHeight+a.gap)+a.gap}).transition().style("opacity",1),s.select(".taxonSelectScientificnames").transition().duration(t).delay(function(){return n.empty()?0:t}).attr("y",function(t,e){return e*(a.taxonHeight+a.gap)+a.taxonHeight/2+a.textHeightOffset+a.gap}).transition().style("opacity",1),n.transition().duration(t).style("opacity",0).remove(),h(".abbrvName").tooltip({classes:{"ui-tooltip":"ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(t,e){setTimeout(function(){h(e.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return h(this).attr("title")}});var o=s._groups[0].length*(this.taxonHeight+this.gap);this.D3svg.transition().delay(function(){return n.empty()?0:t}).attr("height",o).on("end",function(){x.gui.main.resizeControlsAndTaxa()})},x.gui.taxonSelect.checkEmptyFilter=function(){""==this.filterText&&(this.filterText=this.filterMessage,this.$textFilter.val(this.filterMessage))},x.gui.taxonSelect.checkFilterColour=function(){this.filterText==this.filterMessage||this.filterText==this.filterSelectedOnly?this.$textFilter.css("color","silver"):this.$textFilter.css("color","black")}}(jQuery,this.tombiovis);