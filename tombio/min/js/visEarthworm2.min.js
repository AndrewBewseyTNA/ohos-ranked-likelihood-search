!function(y,w){"use strict";var x,S="visEarthworm2",t=w.v.visualisations[S]=Object.create(w.v.visP);function C(t,r){return t.sort(function(t,e){var a=t.visState.visEarthworm2.segdiffTotal,o=e.visState.visEarthworm2.segdiffTotal;return a<o?-1:o<a?1:o==a?t.visState.visEarthworm2[r]>e.visState.visEarthworm2[r]?1:-1:void 0})}function T(e,a){var o=d3.select(this);d3.select(this.parentNode).select("text").style("opacity","1").attr("x",Number(o.attr("cx"))).attr("y",Number(o.attr("cy"))+4),o.attr("oR",o.attr("r")),o.attr("r",function(){var t=x.scoreChars[a];return null!=e.visState.visEarthworm2.scores[t.Character]&&"segnum"==t.EsbScoreType?Number(o.attr("r"))+x.taxspace:Number(Number(o.attr("r")))}).attr("cursor",function(){var t=x.scoreChars[a];return null!=e.visState.visEarthworm2.scores[t.Character]&&"segnum"==t.EsbScoreType?"none":"auto"})}function I(t,e){var a=d3.select(this),o=d3.select(this.parentNode).select("text");a.attr("r",Number(a.attr("oR"))),o.style("opacity","0")}t.visName=S,t.initialise=function(){(x=this).metadata.title="Bespoke earthworm key",this.metadata.authors="Rich Burkmar",this.metadata.year="2018",this.metadata.publisher="Field Studies Council",this.metadata.location="Preston Montford",this.metadata.contact="richardb@field-studies-council.org",this.metadata.version="4.0",this.taxwidth=205,this.taxheight=32,this.taxspace=5,this.taxexpanded=null,this.delay=200,this.indrad=6,this.imagedim=12,this.inputControl=Object.create(w.gui.keyInputEarthworm),this.inputControl.init(y(w.gui.main.divInput)),this.helpFiles=[w.opts.tombiopath+"visEarthworm2/visEarthwormHelp2.html"];var t,e=y("<div>").appendTo(y("#"+this.visName));y("<div>").attr("id","tombioEsbHeaderTaxa").appendTo(e).html('<span id="tombioEsbCandidateTaxa">Possible species  <span class="tombioEsbConfidenceLevel" id="tombioEsbConfidenceLevelButton">!</span></span><span id="tombioEsbExcludedTaxa">Unlikely species</span>'),d3.select("#"+this.visName).append("svg").attr("id","tombioEsbMultiaccess"),y("#tombioEsbHeaderTaxa").css("width",3*this.taxspace+2*this.taxwidth),y("#tombioEsbCandidateTaxa").css("left",1*this.taxspace),y("#tombioEsbExcludedTaxa").css("left",2*this.taxspace+this.taxwidth),y.get(w.opts.tombiopath+"/visEarthworm2/confidence.html?ver="+w.opts.tombiover,function(t){y("<div>").appendTo(y("#"+x.visName)).html(t.replace(/##tombiopath##/g,w.opts.tombiopath)),y("#tombioEsbConfidenceLevelButton").click(function(t){var e=x.scoreChars.filter(function(t){return t.stateSet}).length;y("#tombioEsbCharCount").html(x.scoreChars.length),y("#tombioEsbCharUsed").html(e),y("#tombioEsbConfidenceDialog").dialog("open")}),y("#tombioEsbConfidenceDialog").dialog({title:"Identification confidence",autoOpen:!1,modal:!0,width:410,height:450,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}})}),y("<div>").attr("id","tombioEsbPopup").appendTo(y("#"+x.visName)),y("<div>").attr("id","tombioEsbPopupTabs").appendTo(y("#tombioEsbPopup"));var a=y("<ul>").appendTo(y("#tombioEsbPopupTabs")),o=y("<li>").appendTo(a);y("<a>").attr("href","#tombioEsbPopupTabs1").text("Map").appendTo(o);var r=y("<li>").appendTo(a);y("<a>").attr("href","#tombioEsbPopupTabs2").text("Information").appendTo(r),y("<div>").attr("id","tombioEsbPopupTabs1").appendTo(y("#tombioEsbPopupTabs")),y("<div>").attr("id","tombioEsbMapDiv").appendTo(y("#tombioEsbPopupTabs1")),y("<img>").attr("id","tombioEsbNbnLogo").appendTo(y("#tombioEsbPopupTabs1")),y("<div>").attr("id","tombioEsbNbnLoading").text("Loading distribution map from NBN...").appendTo(y("#tombioEsbPopupTabs1")),y("<div>").attr("id","tombioEsbPopupTabs2").appendTo(y("#tombioEsbPopupTabs")),y("<div>").attr("id","tombioEsbSpInfo").appendTo(y("#tombioEsbPopupTabs2")),t=y("<a>").attr("target","_blank").attr("href","http://www.field-studies-council.org/publications/pubs/earthworms.aspx").appendTo(y("#tombioEsbPopupTabs2")),y("<img>").attr("src",w.opts.tombiopath+"/visEarthworm2/resources/sherlock.png").css("float","left").css("width","120px").css("padding","0 10px 10px 0").appendTo(t),y("<p>").html('More information on the morphology and ecology of <i><span id="tombioEsbInfoSpName"></span></i>can be found in Emma Sherlock\'s FSC AIDGAP publication,<a href="http://www.field-studies-council.org/publications/pubs/earthworms.aspx" target="_blank"> <span class="tombioEsbBooklink">Key to the earthworms of UK and Ireland</span></a>, on <b>pages <span id="tombioEsbInfoSpAccount"></span> (species account) and <span id="tombioEsbInfoSpTable"></span> (species comparison chart)</b>.(The knowledge base behind this visualisation is drawn from Emma Sherlock\'s key.)').appendTo(y("#tombioEsbPopupTabs2")),y("<p>").html('Additional information can be found in the Linnean Society synopsis,<a href="http://www.field-studies-council.org/publications/pubs/earthworms-synopsis.aspx" target="_blank"> <span class="tombioEsbBooklink">Earthworms</span></a>, by Sims and Gerard, also published by FSC.').appendTo(y("#tombioEsbPopupTabs2")),y("#tombioEsbPopup").dialog({autoOpen:!1,width:410,height:610,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}}),y("#tombioEsbPopup").parent().find(".ui-dialog-title").css("font-style","italic"),y("#tombioEsbPopupTabs").tabs(),this.scoreChars=[],w.d.characters.filter(function(t){return t.EsbKeyOrder}).sort(function(t,e){return t.EsbKeyOrder-e.EsbKeyOrder}).forEach(function(t){x.scoreChars.push(t)}),this.displayChars=[],w.d.characters.filter(function(t){return t.EsbKeyOrder||t.EsbColourParams}).sort(function(t,e){return t.EsbKeyOrder&&e.EsbKeyOrder?t.EsbKeyOrder-e.EsbKeyOrder:t.EsbKeyOrder&&!e.EsbKeyOrder?-1:!t.EsbKeyOrder&&e.EsbKeyOrder?1:t.EsbColourParams.split(" ")[0]-e.EsbColourParams.split(" ")[0]}).forEach(function(t){x.displayChars.push(t)}),this.taxexpanded=2*(this.displayChars.length+1)*(this.indrad+this.taxspace),w.d.taxa.forEach(function(e){e.visState.visEarthworm2.scores={},x.scoreChars.forEach(function(t){e.visState.visEarthworm2.scores[t.Character]=null}),e.visState.visEarthworm2.x=0,e.visState.visEarthworm2.y=0,e.visState.visEarthworm2.height=x.taxheight});d3.select("#tombioEsbMultiaccess");this.worms=d3.select("#tombioEsbMultiaccess").selectAll(".tombioEsbWorm").data(w.d.taxa).enter().append("g").attr("x",0).attr("class","tombioEsbWorm").on("click",function(t){t.visState.visEarthworm2.height==x.taxheight?t.visState.visEarthworm2.height=x.taxexpanded:t.visState.visEarthworm2.height=x.taxheight,x.refresh()}),this.worms.append("rect").attr("x",0).attr("y",0).attr("rx",5).attr("ry",5).attr("height",this.taxheight).attr("width",this.taxwidth),this.worms.append("text").attr("x",0).attr("y",0).attr("class","tombioEsbScientificnames").style("opacity",0).text(function(t){return t.Taxon.kbValue});for(var i=0;i<this.displayChars.length;i++)this.worms.append("text").attr("x",0).attr("y",0).attr("class","tombioEsbCharactervalue").style("opacity",0).attr("pointer-events","none").text(function(t){return x.displayChars[i].Label+": "+t[x.displayChars[i].Character].toString()});this.worms.append("image").attr("x",0).attr("y",0).attr("width",this.imagedim).attr("height",this.imagedim).style("opacity",0).attr("xlink:href",w.opts.tombiopath+"/visEarthworm2/resources/info20.png").attr("class","tombioEsbInfoimage").attr("id",function(t,e){return"tombioEsbInfoimage-"+e}).on("click",function(t,e){0<y(this).css("opacity")&&(d3.event.stopPropagation(),y("#tombioEsbPopup").dialog("open"),y("#tombioEsbPopupTitleText").html(t.Taxon.kbValue),y("#tombioEsbInfoSpName").html(t.Taxon.kbValue),y("#tombioEsbInfoSpAccount").html(t.AccountPage.kbValue),y("#tombioEsbInfoSpTable").html(t.TablePage.kbValue),y("#tombioEsbPopup").dialog("option","title",t.Taxon.kbValue),function(t){y("#tombioEsbNbnLogo").attr("src",w.opts.tombiopath+"/visEarthworm2/resources/nbn-logo-centred.png").addClass("tombioEsbSpiningNbn"),y("#tombioEsbNbnLoading").show();var e="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+t+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100";y("#tombioEsbMapDiv").html("<img id='tombioEsbPopupMap' width='100%' />"),y("#tombioEsbPopupMap").on("load",function(){y("#tombioEsbNbnLogo").attr("src",w.opts.tombiopath+"/visEarthworm2/resources/nbn-logo-colour-centred.png").removeClass("tombioEsbSpiningNbn"),y("#tombioEsbNbnLoading").hide()}).attr("src",e)}(t.TVK.kbValue))});for(i=1;i<=this.scoreChars.length;i++){var s=this.scoreChars[i-1],n=this.worms.append("g").attr("class","tombioEsbIndg");n.append("circle").attr("class","tombioEsbIndicator"+i).attr("cx",0).attr("cy",0).attr("r",function(){return"redline"==s.EsbScoreType?x.indrad:"segnum"==s.EsbScoreType?.8*x.indrad:.6*x.indrad}),n.append("text").attr("pointer-events","none").attr("class","tombioEsbIndText")}d3.select("#tombioEsbMultiaccess").style("width",2*this.taxwidth+3*this.taxspace),this.initialised=!0,w.f.checkInterface(S,w.templates.visTemplate,w.v.visualisations[S])},t.refresh=function(){function s(t,e){var a=String(Math.round(t,2)),o=String(Math.round(e,2)),r=n+"-"+a+"-"+o;if(r=r.replace(/ /g,""),!document.getElementById(r)){var i=d3.select("#tombioEsbMultiaccess").append("linearGradient").attr("id",r);i.append("stop").attr("offset","0%").attr("stop-color",l(t)),i.append("stop").attr("offset","100%").attr("stop-color",l(e))}return r}w.gui.main.contextMenu.addItem("Get URL for earthworm key",function(){var t;(t=[]).push("selectedTool="+S),Array.prototype.push.apply(t,w.f.setParamsFromControls()),w.f.createViewURL(t)},!1,[this.visName]);var t=this.scoreChars.filter(function(t){return t.stateSet}).length;0<t?y("#tombioEsbConfidenceLevelButton").show():y("#tombioEsbConfidenceLevelButton").hide();var e=d3.scaleLinear().domain([0,this.scoreChars.length/2,this.scoreChars.length]).range(w.d.scoreColours);y(".tombioEsbConfidenceLevel").css("background",e(t));var a=[],o=[];w.d.taxa.forEach(function(e){e.visState.visEarthworm2.redlineTotal=0,e.visState.visEarthworm2.segdiffTotal=0,x.scoreChars.forEach(function(t){"redline"==t.EsbScoreType&&(t.userInput&&e[t.Character].kbValue==t.CharacterStateValues[t.userInput]?e.visState.visEarthworm2.scores[t.Character]=0:t.userInput?(e.visState.visEarthworm2.scores[t.Character]=100,e.visState.visEarthworm2.redlineTotal+=100):e.visState.visEarthworm2.scores[t.Character]=null),"segnum"==t.EsbScoreType&&(e.visState.visEarthworm2.scores[t.Character]=function(t,e){if(""==t||null==t)return null;if(""==String(e))return null;if("n/a"==String(e))return t;if(0===String(e).indexOf("["))var a=e.substr(1,e.length-2),o=a.split("-"),r=Number(o[0]),i=Number(o[1]);else var r=Number(e),i=Number(e);return t<r?r-t:i<t?t-i:0}(t.userInput,e[t.Character].kbValue),e.visState.visEarthworm2.segdiffTotal+=e.visState.visEarthworm2.scores[t.Character]),"size"==t.EsbScoreType&&(e.visState.visEarthworm2.scores[t.Character]=function(t,e){if(""==t||null==t)return null;if(""==String(e))return null;if(0===String(e).indexOf("["))var a=e.substr(1,e.length-2),o=a.split("-"),r=Number(o[0]),i=Number(o[1]);else var r=Number(e),i=Number(e);return t<r?(r-t)/t<1?(r-t)/t:.48:i<t?(t-i)/t<1?(t-i)/t:.48:0}(t.userInput,e[t.Character].kbValue))}),0<e.visState.visEarthworm2.redlineTotal?o.push(e):e.visState.visEarthworm2.segdiffTotal>x.inputControl.otherState.tolerance?o.push(e):a.push(e)}),C(a,"lastPosInTaxain"),C(o,"lastPosInTaxaout");for(var r=0;r<a.length;r++)a[r].visState.visEarthworm2.lastPosInTaxain=r,a[r].visState.visEarthworm2.lastPosInTaxaout=r-100;for(r=0;r<o.length;r++)o[r].visState.visEarthworm2.lastPosInTaxaout=r,o[r].visState.visEarthworm2.lastPosInTaxain=100+r;var i=0;for(r=0;r<a.length;r++)a[r].visState.visEarthworm2.x=this.taxspace,a[r].visState.visEarthworm2.y=i+this.taxspace,i=a[r].visState.visEarthworm2.y+a[r].visState.visEarthworm2.height;for(r=i=0;r<o.length;r++)o[r].visState.visEarthworm2.x=this.taxwidth+2*this.taxspace,o[r].visState.visEarthworm2.y=i+this.taxspace,i=o[r].visState.visEarthworm2.y+o[r].visState.visEarthworm2.height;var n=w.v.visualisations.visEarthworm2.inputControl.otherState.colourby;if(n){var l,c,h,p=w.d.oCharacters[n].EsbColourParams.split(" ")[1];if("number"==p||"log"==p)c=w.d.oCharacters[n].minVal,h=w.d.oCharacters[n].maxVal,"log"==p&&(c=Math.log(c),h=Math.log(h)),l=d3.scaleLinear().domain([c,h]).range(["yellow","blue"]);else if("default"==p||"specified"==p){var u,d;"default"==p?(u=w.d.oCharacters[n].CharacterStateValues,d=w.d.oCharacters[n].CharacterStateValues.length<=10?d3.schemeCategory10:d3.schemeCategory20):(u=[],d=[],w.d.values.filter(function(t){return t.Character==n}).forEach(function(t){u.push(t.CharacterState),d.push(t.EsbColour.replace("*","#"))})),l=d3.scaleOrdinal().domain(u).range(d)}}w.d.taxa.forEach(function(t){if(n){if(""==t[n].kbValue)t.visState.visEarthworm2.fill="lightgrey";else if("number"==p||"log"==p){if((i=t[n].kbValue.trim()).startsWith("[")){var e=(i=i.substr(1,i.length-2)).split("-"),a=Number(e[0].trim()),o=Number(e[1].trim());"log"==p&&(a=Math.log(a),o=Math.log(o));var r="url(#"+s(a,o)+")";console.log("Gradient name: ",r),t.visState.visEarthworm2.fill=r}else t.visState.visEarthworm2.fill=l(t[n].kbValue)}else if("default"==p||"specified"==p){var i;if(1<(e=(i=t[n].kbValue).split("|")).length){a=e[0].trim(),o=e[e.length-1].trim();t.visState.visEarthworm2.fill="url(#"+s(a,o)+")"}else t.visState.visEarthworm2.fill=l(t[n].kbValue)}}else t.visState.visEarthworm2.fill="lightgrey"}),this.worms.select("rect").style("opacity",.5).style("fill",function(t){return t.visState.visEarthworm2.fill}).transition().duration(1e3).delay(x.delay).attr("x",function(t){return t.visState.visEarthworm2.x}).attr("y",function(t){return t.visState.visEarthworm2.y}).attr("height",function(t){return t.visState.visEarthworm2.height}),this.worms.select(".tombioEsbScientificnames").transition().duration(1e3).delay(x.delay).style("opacity",1).attr("x",function(t){return t.visState.visEarthworm2.x+x.taxspace}).attr("y",function(t,e){return 1+t.visState.visEarthworm2.y+x.taxheight/2-2}),this.worms.select("text").text(function(t){return t.Taxon.kbValue+" - "}).append("tspan").style("font-style","normal").style("font-weight","bold").style("font-size","0.9em").style("color","red").text(function(t){return t.visState.visEarthworm2.segdiffTotal}),this.worms.selectAll(".tombioEsbCharactervalue").transition().duration(1e3).delay(this.delay).style("opacity",function(t,e,a){return t.visState.visEarthworm2.height==x.taxheight?0:1}).attr("x",function(t){return t.visState.visEarthworm2.x+2*(x.taxspace+x.indrad)}).attr("y",function(t,e){return t.visState.visEarthworm2.y+x.taxheight+x.indrad-1+e*(2*(x.indrad+x.taxspace))}),this.worms.selectAll(".tombioEsbInfoimage").transition().duration(1e3).delay(this.delay).style("opacity",function(t,e,a){return t.visState.visEarthworm2.height==x.taxheight?0:1}).attr("x",function(t){return t.visState.visEarthworm2.x+x.taxwidth-x.imagedim-3}).attr("y",function(t,e){return t.visState.visEarthworm2.y+x.imagedim/2-2});var m=this.inputControl.otherState.tolerance,b=this.scoreChars.filter(function(t){return"redline"==t.EsbScoreType}).length,v=this.scoreChars.filter(function(t){return"segnum"==t.EsbScoreType}).length,E=d3.scaleLinear().domain([0,100]).range(["#0072B2","#D55E00"]),f=d3.scaleLinear().domain([0,m+1]).range(["#0072B2","#D55E00"]),g=d3.scaleLinear().domain([0,.48]).range(["#0072B2","#D55E00"]);this.worms.selectAll("circle").on("mouseover",T).on("mouseout",I).transition().duration(1e3).delay(x.delay).attr("cx",function(t,e,a){if(t.visState.visEarthworm2.height==x.taxheight){var o=x.scoreChars[e];if("redline"==o.EsbScoreType)var r=t.visState.visEarthworm2.x,i=(a=e,1);else if("segnum"==o.EsbScoreType)r=t.visState.visEarthworm2.x+b*(2*x.indrad+x.taxspace),a=e-b,i=.8;else r=t.visState.visEarthworm2.x+b*(2*x.indrad+x.taxspace)+v*(1.6*x.indrad+x.taxspace),a=e-b-v,i=.6;return r+x.taxspace+i*x.indrad+a*(2*i*x.indrad+x.taxspace)}return t.visState.visEarthworm2.x+x.taxspace+x.indrad}).attr("cy",function(t,e,a){return t.visState.visEarthworm2.height==x.taxheight?t.visState.visEarthworm2.y+x.taxheight-x.indrad-2:t.visState.visEarthworm2.y+x.taxheight+e*(2*(x.indrad+x.taxspace))}).style("fill",function(t,e){var a=x.scoreChars[e];return null!=t.visState.visEarthworm2.scores[a.Character]?e<2?E(t.visState.visEarthworm2.scores[a.Character]):e<8?t.visState.visEarthworm2.scores[a.Character]>m+1?f(m+1):f(t.visState.visEarthworm2.scores[a.Character]):1<t.visState.visEarthworm2.scores[a.Character]?1:g(t.visState.visEarthworm2.scores[a.Character]):"white"}),this.worms.selectAll(".tombioEsbIndText").text(function(t,e){var a=x.scoreChars[e];return null!=t.visState.visEarthworm2.scores[a.Character]&&"segnum"==a.EsbScoreType?t.visState.visEarthworm2.scores[a.Character]:""}),d3.select("#tombioEsbMultiaccess").transition().duration(1e3).delay(x.delay).attr("height",function(){var t,e;return t=0==o.length?0:o[o.length-1].visState.visEarthworm2.y+o[o.length-1].visState.visEarthworm2.height,e=0==a.length?0:a[a.length-1].visState.visEarthworm2.y+a[a.length-1].visState.visEarthworm2.height,Math.max(e,t)})},t.urlParams=function(t){},t.show=function(){y("#visEarthworm2").show(),y(t.inputControl.divSel).show(),t.inputControl.initFromCharacterState()},t.hide=function(){y("#visEarthworm2").hide(),y(t.inputControl.divSel).hide()}}(jQuery,this.tombiovis),function(f,g){"use strict";function y(t,e){g.f.refreshVisualisation()}function a(t){var e=g.gui.keyInputEarthworm.keyItemWidth,a=g.gui.keyInputEarthworm.keyItemHeight,o=g.gui.keyInputEarthworm.keyItemSpace,r=[];d3.select("#tombioEsbLegend").selectAll(".tombioesb-legenditem").remove();var i,s,n,l,c,h=f("#tombioEsbColourBy").val();if(""!=h){var p,u,d,m=g.d.oCharacters[h].EsbColourParams.split(" ")[1];if("number"==m||"log"==m)u=g.d.oCharacters[h].minVal,d=g.d.oCharacters[h].maxVal,"log"==m&&(u=Math.log(u),d=Math.log(d)),p=d3.scaleLinear().domain([u,d]).range(["yellow","blue"]),r=[{colval:"url(#"+(i="yellow",s="blue",n=u+"-"+d,l=n.replace("[","").replace("]","").replace(/,/g,"").replace(/ /g,""),c=d3.select("#tombioEsbLegend").append("linearGradient").attr("id",l),c.append("stop").attr("offset","0%").attr("stop-color",i),c.append("stop").attr("offset","100%").attr("stop-color",s),l)+")",coltext:g.d.oCharacters[h].Label,coltitle:"Range is "+g.d.oCharacters[h].minVal+"-"+g.d.oCharacters[h].maxVal}];else if("default"==m||"specified"==m){var b,v;"default"==m?(b=g.d.oCharacters[h].CharacterStateValues,v=g.d.oCharacters[h].CharacterStateValues.length<=10?d3.schemeCategory10:d3.schemeCategory20):(b=[],v=[],g.d.values.filter(function(t){return t.Character==h}).forEach(function(t){b.push(t.CharacterState),v.push(t.EsbColour.replace("*","#"))})),p=d3.scaleOrdinal().domain(b).range(v),r=b.map(function(t){return{colval:p(t),coltext:t}})}var E=d3.select("#tombioEsbLegend").selectAll(".tombioesb-legenditem").data(r).enter().append("g").attr("class","tombioesb-legenditem");E.append("rect").attr("class","tombioEsbLegendRect").attr("x",0).attr("y",function(t,e){return o+e*(a+o)}).attr("rx",5).attr("ry",5).attr("height",a).attr("width",e).style("opacity",.5).attr("fill",function(t){return t.colval}).attr("title",function(t){return t.coltitle?t.coltitle:""}),E.append("text").attr("class","tombioEsbLegendText").attr("x",o).attr("y",function(t,e){return o+e*(a+o)+2*a/3}).text(function(t){return t.coltext}).attr("title",function(t){return t.coltitle?t.coltitle:""}),f(".tombioEsbLegendRect[title!='']").tooltip({track:!0}),f(".tombioEsbLegendText[title!='']").tooltip({track:!0})}d3.select("#tombioEsbLegend").style("height",o+r.length*(a+o)),y()}g.gui.keyInputEarthworm={width:280,otherState:{keys:["colourby","tolerance"],colourby:null,tolerance:null},keyItemWidth:130,keyItemHeight:30,keyItemSpace:5},g.gui.keyInputEarthworm.init=function(t){var i,s,n,l,c,h,e=this;f("<div>").attr("id","tombioEsbKeyInput").appendTo(t);this.divSel="#tombioEsbKeyInput",(i=f("<table>").attr("id","tombioEsbControlsTable")).appendTo(f("#tombioEsbKeyInput")),s=f("<tr>").appendTo(i),f("<td>").appendTo(s),n=f("<td>").attr("colspan","2").appendTo(s),(l=f("<button>").attr("id","tombioEsbOptions").text("Options").appendTo(n)).button({icons:{primary:null,secondary:"ui-icon-options"},disabled:!1}).click(function(t){f("#tombioEsbOptionsDialog").dialog("open")}),s=f("<tr>").appendTo(i),f("<td>").appendTo(s),n=f("<td>").attr("colspan","2").appendTo(s),(l=f("<button>").attr("id","tombioEsbReset").text("Reset all").appendTo(n)).button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(t){f(".tombioEsbInputSpin").val("").spinner("value",""),f(".tombioEsbInputMenu").val("").selectmenu("refresh"),g.d.characters.forEach(function(t){t.stateSet=!1,t.userInput=null}),y(),f("#tombioEsbColourBy").val("").selectmenu("refresh"),e.otherState.colourby="",a()}),g.d.characters.filter(function(t){return""!=t.EsbKeyOrder}).sort(function(t,e){return t.EsbKeyOrder-e.EsbKeyOrder}).forEach(function(o){if(s=f("<tr>").appendTo(i),(n=f("<td>").attr("morphokey",o.EsbMorphoKey).appendTo(s)).addClass("tombioEsbMorphoLabel").text(o.Label).appendTo(n),n=f("<td>").appendTo(s),"spin"==o.ControlType?(c=f("<input>")).addClass("tombioEsbInputSpin"):(c=f("<select>"),"multi"==o.ControlType&&c.attr("multiple","multiple"),c.addClass("tombioEsbInputMenu")),c.addClass("tombioEsbInput").attr("id","tombioEsbInput-"+o.Character).appendTo(n),n=f("<td>").appendTo(s),h=f("<img>").attr("src",g.opts.tombiopath+"/visEarthworm2/resources/reset2.png").addClass("tombioEsbResetImage").attr("id","tombioEsbReset-"+o.Character).appendTo(n),"spin"==o.ControlType){var t=o.Params.split(","),e=Number(t[0]),a=Number(t[1]),r=Number(t[2]);c.spinner({min:e,max:a,step:r}).on("spinstop",function(t,e){var a=f("#tombioEsbInput-"+o.Character).spinner("value");o.stateSet=null!=a&&""!=a,o.userInput=a,y()}),h.click(function(){f("#tombioEsbInput-"+o.Character).val("").spinner("value",""),o.stateSet=!1,o.userInput=null,y()})}else c.attr("name","tombioEsbInput-"+o.Character),l=f("<option>").attr("value","").attr("selected","selected").text(""),c.append(l),o.CharacterStateValues.forEach(function(t){l=f("<option>").text(t),c.append(l)}),c.selectmenu().on("selectmenuchange",function(){var t=o.CharacterStateValues.indexOf(f("#tombioEsbInput-"+o.Character).val());-1==t?(o.stateSet=!1,o.userInput=null):(o.stateSet=!0,o.userInput=[t]),y()}),h.click(function(){f("#tombioEsbInput-"+o.Character).val("").selectmenu("refresh"),o.stateSet=!1,o.userInput=null,y()})}),s=f("<tr>").appendTo(i),n=f("<td>").addClass("tombioEsbMorphoLabelNoLink").text("Colour by").appendTo(s),n=f("<td>").appendTo(s),c=f("<select>").attr("id","tombioEsbColourBy").addClass("tombioEsbInputMenu").appendTo(n),l=f("<option>").attr("value","").attr("selected","selected").text("").appendTo(c),g.d.characters.filter(function(t){return""!=t.EsbColourParams}).sort(function(t,e){return t.EsbColourParams.split(" ")[0]-e.EsbColourParams.split(" ")[0]}).forEach(function(t){l=f("<option>").attr("value",t.Character).text(t.Label).appendTo(c)}),c.selectmenu().on("selectmenuchange",function(){e.otherState.colourby=f("#tombioEsbColourBy").val(),a()}),n=f("<td>").appendTo(s),(h=f("<img>").attr("src",g.opts.tombiopath+"/visEarthworm2/resources/reset2.png").addClass("tombioEsbResetImage").attr("id","tombioEsbReset-colour").appendTo(n)).click(function(){f("#tombioEsbColourBy").val("").selectmenu("refresh"),e.otherState.colourby="",a()}),s=f("<tr>").appendTo(i),f("<td>").appendTo(s),n=f("<td style='display:flex'>").appendTo(s),(l=f('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">').attr("id","tombioEsbLegend").appendTo(n)).css("width",this.keyItemWidth).css("height",0),f(".tombioEsbMorphoLabel").hover(function(){f(this).animate({color:"#D55E00"},"fast")},function(){f(this).animate({color:"black"},"fast")}).click(function(){var t=f('#tombioEsbHelpTabs a[href="#tombioEsbHelpTab-'+f(this).attr("morphokey")+'"]').parent().index();f("#tombioEsbHelpTabs").tabs("option","active",t),f("#tombioEsbHelpDialog").dialog("open")}),f("<div>").attr("id","tombioEsbOptionsDialog").appendTo(f("#tombioEsbKeyInput")),i=f("<table>").appendTo(f("#tombioEsbOptionsDialog")),s=f("<tr>").appendTo(i),n=f("<td>").text("Tolerance").appendTo(s),n=f("<td>").appendTo(s),f("<input>").attr("id","tombioEsbTolerance").appendTo(n),f("<p>").text("(Consult the information dialog for details of how the tolerance value affects the display of species in the 'possible species' and 'unlikely species' lists.)").appendTo(f("#tombioEsbOptionsDialog")),f("#tombioEsbOptionsDialog").dialog({title:"Options",autoOpen:!1,modal:!0,width:410,height:200,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}}),f("#tombioEsbTolerance").spinner({min:0,max:5,step:1}).on("spinstop",function(){e.otherState.tolerance=f("#tombioEsbTolerance").spinner("value"),y()}),f("#tombioEsbTolerance").spinner("value",2),this.otherState.tolerance=2,f.get(g.opts.tombiopath+"/visEarthworm2/characterHelp.html?ver="+g.opts.tombiover,function(t){f("#tombioEsbKeyInput").append(t.replace(/##tombiopath##/g,g.opts.tombiopath)),f("#tombioEsbHelpDialog").dialog({title:"Morphological features",width:600,height:470,autoOpen:!1,modal:!0,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}}),f("#tombioEsbHelpTabs").tabs()}),setTimeout(g.gui.main.resizeControlsAndTaxa,100),g.f.checkInterface("keyInputEarthworm",g.templates.gui.keyInput,g.gui.keyInputEarthworm)},g.gui.keyInputEarthworm.initFromCharacterState=function(){g.d.characters.forEach(function(e,t){if("spin"===e.ControlType){(a=f("#tombioEsbInput-"+e.Character)).spinner("value",e.stateSet?e.userInput:"")}else{var a=f("#tombioEsbInput-"+e.Character);if(e.stateSet){var o=e.userInput.map(function(t){return e.CharacterStateValues[t]});if(0==o.length)var r="";else r=o[0]}else r="";a.val(r).selectmenu("refresh")}})},g.gui.keyInputEarthworm.initStateFromParams=function(t){this.initFromCharacterState(),f("#tombioEsbTolerance").spinner("value",t.tolerance),f("#tombioEsbColourBy").val(t.colourby).selectmenu("refresh"),this.otherState.colourby=t.colourby,a()},g.gui.keyInputEarthworm.setParamsFromState=function(t){return t.push("colourby="+this.otherState.colourby),t.push("tolerance="+this.otherState.tolerance),t}}(jQuery,this.tombiovis.templates.loading?this.tombiovis.templates:this.tombiovis);