!function(e,c){"use strict";c.d.stateValue={v:null},c.d.stateValue.init=function(e,r){var n=c.d.oCharacters[r];this.valueType=n.ValueType,this.status=n.Status,this.character=n.Character;var s,l=this;this.v.trim().split("|").forEach(function(e,t){var a,o;if((e=e.trim()).endsWith("(m)")||e.endsWith("(f)")?(a=e.substr(0,e.length-4).trim(),o=e.substr(e.length-4,4)):(a=e,o=""),n.stateGroups&&-1<n.stateGroups.indexOf(a)){var i=[];c.d.values.forEach(function(e){e.Character==r&&e.StateGroup==a&&i.push(e.CharacterState)})}else i=[a];i.forEach(function(e){var t=l.translateStateValue(l.character,e);""!=o&&(t=t+" "+o),s=s?s+" | "+t:t}),0<s.length&&"#"==s.substr(0,1)&&(s=""),"?"==s.length&&(s="")}),this.kbValue=s,"key"==n.Status&&(this.score={na:0,for:0,against:0,overall:0})},c.d.stateValue.translateStateValue=function(e,t){function a(t,a){var e=c.d.values.filter(function(e){return e.Character==t&&e.CharacterState.trim()==a});if(e[0]&&e[0].CharacterStateTranslation&&""!=e[0].CharacterStateTranslation)var o=e[0].CharacterStateTranslation;else o=a;return o=o.replace(/ +(?= )/g,"")}if(/^\[[^-]+-[^-]+\]$/.test(t)){var o=t.substr(1,t.length-2).split("-");return"["+a(e,o[0])+"-"+a(e,o[1])+"]"}return a(e,t)},c.d.stateValue.getStates=function(e){e||(e="");for(var t=[],a=this.kbValue.split("|"),o=0;o<a.length;o++){var i=a[o];"n/a"!=(i=i.trim())&&"novalue"!=i&&"?"!=i&&""!=i&&("male"!=e||i.endsWith("(f)")?"female"!=e||i.endsWith("(m)")?""==e&&t.push(i.replace("(m)","").replace("(f)","").trim()):t.push(i.replace("(f)","").trim()):t.push(i.replace("(m)","").trim()))}return t},c.d.stateValue.getRange=function(){var e={};if(""==String(this.kbValue)?e.hasValue=!1:e.hasValue=!0,0==String(this.kbValue).indexOf("[")){var t=this.kbValue.substr(1,this.kbValue.length-2).split("-");e.min=Number(t[0]),e.max=Number(t[1]),e.mid=e.min+(e.max-e.min)/2}else e.min=Number(this.kbValue),e.max=Number(this.kbValue),e.mid=Number(this.kbValue);return e},c.d.stateValue.getOrdinalRanges=function(e){var n=this,s=[];return"ordinal"!=this.valueType&&"ordinalCircular"!=this.valueType||this.getStates(e).forEach(function(e){var t=[];if(0==e.indexOf("[")){var a=e.substr(1,e.length-2).split("-"),o=a[0],i=a[1],r=!1;c.d.oCharacters[n.character].CharacterStateValues.forEach(function(e){e==o&&(r=!0),r&&t.push(e),e==i&&(r=!1)}),r&&c.d.oCharacters[n.character].CharacterStateValues.forEach(function(e){r&&t.push(e),e==i&&(r=!1)})}else t.push(e);s.push(t)}),s},c.d.stateValue.toHtml1=function(){if("n/a"==this.kbValue)return"<i>not applicable</i>";if("novalue"==this.kbValue)return"<i>not manifest</i>";if(""==this.kbValue||"?"==this.kbValue)return"<i>no value specified</i>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalCircular"==this.valueType)return t=(t=(t=(t=(t=(t=this.kbValue.replace(/([^|]+)/g,"<b>$1</b>")).replace(/(\(m\)\s*<\/b>)/g,"</b> (male)")).replace(/(\(f\)\s*<\/b>)/g,"</b> (female)")).replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>")).replace(/\s*\|\s*/g," or "),"display"==this.status&&(t=t.replace(/<b>/g,"").replace(/<\/b>/g,"")),t;if("numeric"==this.valueType){var e=this.getRange();if(0==e.hasValue)var t="<b>no value in knowledge-base</b>";else if(e.min==e.max)t="<b>"+e.min+"</b>";else t="<b>"+e.min+"-"+e.max+"</b> (range)";return"display"==this.status&&(t=t.replace(/<b>/g,"").replace(/<\/b>/g,"")),t}return this.kbValue},c.d.stateValue.toHtml2=function(e){var t="<li>",a="</li>";if(e&&(a=t=""),"n/a"==this.kbValue)return"<li><i>not applicable</i></li>";if("novalue"==this.kbValue)return"<li><i>not manifest</i></li>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalCircular"==this.valueType){for(var o="",i=this.kbValue.split("|"),r=0;r<i.length;r++){var n=i[r].trim();n=(n=(n=/\(m\)$/.test(n)?"<b>"+n.replace(/\(m\)$/,"</b> (male)"):/\(f\)$/.test(n)?"<b>"+n.replace(/\(f\)$/,"</b> (female)"):"<b>"+n.trim()+"</b>").replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>"),r<i.length-1&&(n+=" <i>or</i> "),o+=t,o+=n,o+=a}return o}if("numeric"==this.valueType){var s=this.getRange();return 0==s.hasValue?t+"<i>no value in knowledge-base</i>"+a:s.min==s.max?t+"<b>"+s.min+"</b>"+a:t+"<b>"+s.min+" - "+s.max+"</b> (range)"+a}return this.kbValue},c.d.stateValue.toString=function(){return this.kbValue}}(jQuery,this.tombiovis),function(u,b){"use strict";function i(){return b.v.selectedTool in b.v.visualisations?b.v.visualisations[b.v.selectedTool]:null}b.f.loadcomplete=function(e){if(u("#tombiod3-header").text(b.d.kbmetadata.title),u("#tombiod3-footer").html(b.f.getCitation(b.d.kbmetadata,"Knowledge-base",b.d.softwareMetadata.title)),e||b.f.checkKnowledgeBase()){b.d.oCharacters={},b.d.characters.forEach(function(t){(b.d.oCharacters[t.Character]=t).CharacterStates=[],t.CharacterStateValues=[],t.stateSet=!1,t.userInput=null,t.minVal=null,t.maxVal=null,"key"==t.Status&&"none"!=t.Group.toLowerCase()&&(b.d.oCharacters.grouped=!0),t.stateGroups=[],b.d.values.forEach(function(e){e.Character==t.Character&&e.StateGroup&&-1==t.stateGroups.indexOf(e.StateGroup)&&t.stateGroups.push(e.StateGroup)})}),b.d.groupedCharacters={},b.d.groupedCharacters.groups=[],b.d.characters.forEach(function(e){"key"==e.Status&&(b.d.groupedCharacters[e.Group]||(b.d.groupedCharacters[e.Group]=[],b.d.groupedCharacters.groups.push(e.Group)),b.d.groupedCharacters[e.Group].push(e))}),b.d.oTaxa={};var a=0;b.d.taxa.forEach(function(e){for(var t in b.d.oTaxa[e.Taxon]=e)e.hasOwnProperty(t)&&(e[t]=Object.create(b.d.stateValue,{v:{writable:!0,value:e[t]}}),e[t].init(e,t));e.kbPosition=++a,e.visState={score:{for:null,against:null,overall:null}}}),b.d.characters.forEach(function(o){if("numeric"==o.ValueType&&b.d.taxa.forEach(function(e){var t=e[o.Character].getRange().min,a=e[o.Character].getRange().max;(!o.minVal||t<o.minVal)&&(o.minVal=t),(!o.maxVal||a>o.maxVal)&&(o.maxVal=a)}),"numeric"==o.ValueType||"ordinal"==o.ValueType||"ordinalCircular"==o.ValueType)if(void 0!==o.Latitude)o.Latitude=Number(o.Latitude);else{var e=""==o.Strictness?10:Number(o.Strictness);if("numeric"==o.ValueType)o.Latitude=(1-e/10)*(o.maxVal-o.minVal);else{var t=b.d.values.filter(function(e){return e.Character==o.Character}).length;o.Latitude=(1-e/10)*t,"ordinalCircular"==o.ValueType&&(o.Latitude=o.Latitude/2)}}}),b.d.media.forEach(function(e){"html-local"==e.Type?e.URI=b.opts.tombiokbpath+e.URI+"?t=kbtxt":"image-local"==e.Type&&(e.URI=b.opts.tombiokbpath+e.URI+"?t=kbimgstd",e.SmallURI&&(e.SmallURI=b.opts.tombiokbpath+e.SmallURI+"?t=kbimgsml"),e.LargeURI&&(e.LargeURI=b.opts.tombiokbpath+e.LargeURI+"?t=kbimglrg"))}),b.d.values.forEach(function(e){var t=b.d.oCharacters[e.Character];if(t){if(e.CharacterStateTranslation&&""!=e.CharacterStateTranslation)var a=e.CharacterStateTranslation;else var a=e.CharacterState;t.CharacterStates.push({CharacterState:a,StateHelp:e.StateHelp,StateHelpShort:e.StateHelpShort}),t.CharacterStateValues.push(a)}}),b.d.characters.forEach(function(a){("Taxonomy"==a.Group||"key"==a.Status&&"text"==a.ValueType)&&b.d.taxa.forEach(function(e){var t=e[a.Character].getStates("");t.forEach(function(e){""!=e&&-1==a.CharacterStateValues.indexOf(e)&&(a.CharacterStates.push({CharacterState:e,StateHelp:""}),a.CharacterStateValues.push(e))})})});var t=b.f.getURLParameter("selectedTool");t?b.v.selectedTool=t:b.opts.selectedTool?b.v.selectedTool=b.opts.selectedTool:b.d.kbconfig.selectedTool?b.v.selectedTool=b.d.kbconfig.selectedTool:b.v.selectedTool=b.v.includedVisualisations[0],b.gui.main.init(),b.gui.main.createUIControls(),u("#downloadspin").remove(),b.f.resizeControlsAndTaxa(),b.f.visChanged(b.v.selectedTool),b.loadCallback&&b.loadCallback()}},b.f.visChanged=function(t,e){if(t){if(b.opts.devel&&b.templates.visTemplate.initP("visTemplate"),"reload"==(b.v.selectedTool=t))return caches?void caches.keys().then(function(e){return Promise.all(e.map(function(e){if(e.startsWith("tombio-"))return console.log("[ServiceWorker] Removing cache",e),caches.delete(e)}))}).then(function(){window.location.reload()}):void window.location.reload(!0);if("reloadkb"!=t)if("reloadGuiOnsen"!=t)if("reloadGuiJQuery"!=t)if("visInfo"!=t&&"kbInfo"!=t){var a;if("tombioCitation"==t||"currentVisInfo"==t)return a=e||(b.v.lastVis?b.v.lastVis:b.opts.lastVisualisation?b.opts.lastVisualisation:b.v.includedVisualisations[0].visName),b.f.showDownloadSpinner(),void b.js.jsFiles[a].loadJs().then(function(){if(b.f.hideDownloadSpinner(),!b.v.visualisations[a].visName){var e=b.v.visualisations[a];e.initP(a),e.hide()}b.v.lastVis=a,b.gui.main.visShow(t)});"mediaFilesCheck"!=t&&"tvkCheck"!=t?(b.f.showDownloadSpinner(),b.js.jsFiles[t].loadJs().then(function(){(b.f.hideDownloadSpinner(),b.v.visualisations[t].initialised)||b.v.visualisations[t].initP(t);console.log("Starting",t),b.gui.main.visShow(t)}).catch(function(){b.gui.main.dialog("Currently unavailable","<p>You are working offline but the tool you tried to load was not previously loaded into memory.</p><p>Load the tool when you next have an internet connection. Then you will be able to use it offline.</p>")}),b.gui.main.setSelectedTool(t)):b.gui.main.visShow(t)}else b.gui.main.visShow(t);else{location.pathname;window.location.replace(location.pathname+"?gui=guiLargeJqueryUi")}else{location.pathname;window.location.replace(location.pathname+"?gui=guiOnsenUi")}else caches?caches.keys().then(function(e){return Promise.all(e.map(function(e){if(e.startsWith("tombio-kb-"))return console.log("[ServiceWorker] Removing cache",e),caches.delete(e)}))}).then(function(){window.location.reload()}):window.location.reload(!0)}},b.f.initControlsFromParams=function(e){for(name in e)if(name.startsWith("c-")){var t=name.split("-")[1],a=b.d.characters[t];"spin"===a.ControlType?a.userInput=e[name]:a.userInput=e[name].split(","),a.stateSet=!0}i().inputControl.initStateFromParams(e),b.f.refreshVisualisation()},b.f.setParamsFromControls=function(){var o=[];return b.d.characters.forEach(function(e,t){if(e.userInput){var a="c-"+t;"spin"===e.ControlType?o.push(a+"="+e.userInput):o.push(a+"="+e.userInput.join(","))}}),i().inputControl.setParamsFromState(o)},b.f.getCitation=function(e,t,a){var o,i=u("<div class='tombioCitation'>"),r=new Date;return o=e.authors+" ",o+="("+e.year+") ",o+="<i>"+e.title+"</i>",o+=" (Version "+e.version+") ["+t+"]",a&&(o+=" (for "+a+")"),o+=". ",e.publisher&&(o+=e.publisher+". "),e.location&&(o+=e.location+". "),o+="Accessed "+r.toDateString()+". ",o+=window.location.href.split("?")[0],i.append(u("<div>").html(o)),i},b.f.setKbInfo=function(r){u.get(b.opts.tombiokbpath+"info.html",function(e){r.append(e.replace(/##tombiopath##/g,b.opts.tombiopath).replace(/##tombiokbpath##/g,b.opts.tombiokbpath))}).always(function(){var e=u("<h3>").attr("id","tombioKbCitation").text("Citation");r.append(e),r.append(b.f.getCitation(b.d.kbmetadata,"Knowledge-base",b.d.softwareMetadata.title));var t=u("<h3>").attr("id","tombioKbRevisionHistory").text("Knowledge-base revision history");r.append(t);var a=u("<p>").html("<b>Current version: "+b.d.kbmetadata.version+"</b>");r.append(a);var o=u("<table>"),i=u("<tr>").css("background-color","black").css("color","white");i.append(u("<td>").text("Date").css("padding","3px")),i.append(u("<td>").text("Version").css("padding","3px")),i.append(u("<td>").text("Notes").css("padding","3px")),o.append(i),b.d.kbreleaseHistory.forEach(function(e,t){i=u("<tr>"),t%2==0?i.css("background-color","rgb(200,200,200)"):i.css("background-color","rgb(230,230,230)");var a=new Date(e.Date);i.append(u("<td>").css("padding","3px").text(a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear())),i.append(u("<td>").css("padding","3px").text(e.Value)),i.append(u("<td>").css("padding","3px").text(e.Notes)),o.append(i)}),r.append(o)})},b.f.setVisInfo=function(t){u.get(b.opts.tombiopath+"visInfo.html",function(e){t.html(e.replace(/##tombiopath##/g,b.opts.tombiopath).replace(/##tombiokbpath##/g,b.opts.tombiokbpath))})},b.f.setSelectedToolInfo=function(e){var i=new Array(b.v.visualisations[b.v.lastVis].helpFiles.length),t=[];b.v.visualisations[b.v.lastVis].helpFiles.forEach(function(a,o){t.push(new Promise(function(t,e){u.get(a,function(e){i[o]=e,t()})}))}),Promise.all(t).then(function(){var t="";i.forEach(function(e){t+=e}),t=t.replace(/##tombiopath##/g,b.opts.tombiopath).replace(/##tombiokbpath##/g,b.opts.tombiokbpath),e.html(t)})},b.f.createCitationPage=function(){var e,t=u("<div>");t.append(u("<h3>").text("Citation for FSC Identikit (core software)")),e="This is the reference you can use for the FSC Identikit - in other words the core software.",e+=" The core version number is updated whenever there is a new major release of the core software.",t.append(u("<p>").html(e)),t.append(u("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationCore' id='tbCitationCore'>")),t.append(u("<span>").text("Copy citation")),t.append(u("<b>").html(b.f.getCitation(b.d.softwareMetadata,"Software"))),t.append(u("<h3>").text("Citation for last selected visualisation tool")),e="This is the reference you can use for the last selected visualisation tool.",e+=" The tool version number is updated whenever there is a new release of the tool.",e+=" If you cite a tool, there's no need to cite the core software separately since it is implicit.",t.append(u("<p>").html(e)),t.append(u("<input style='position: relative; top: 0.2em' type='checkbox' name='tbCitationVis' id='tbCitationVis'>")),t.append(u("<span>").text("Copy citation")),t.append(u("<b>").html(b.f.getCitation(b.v.visualisations[b.v.lastVis].metadata,"Software",b.d.softwareMetadata.title))),t.append(u("<h3>").text("Citation for knowledge-base")),e="This is the reference you can use for the knowledge-base currently driving the software.",e+=" The knowledge-base version number is updated whenever there is a new release of the knowledge-base.",t.append(u("<p>").html(e)),t.append(u("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationKb' id='tbCitationKb'>")),t.append(u("<span>").text("Copy citation")),t.append(u("<b>").html(b.f.getCitation(b.d.kbmetadata,"Knowledge-base",b.d.softwareMetadata.title)));var a=u("<button>Copy citations</button>");return a.button(),a.click(function(){u("#tbSelectedCitations").html(""),document.getElementById("tbCitationCore").checked&&u("#tbSelectedCitations").append(b.f.getCitation(b.d.softwareMetadata,"Software")),document.getElementById("tbCitationVis").checked&&u("#tbSelectedCitations").append(b.f.getCitation(b.v.visualisations[b.v.lastVis].metadata,"Software",b.d.softwareMetadata.title)),document.getElementById("tbCitationKb").checked&&u("#tbSelectedCitations").append(b.f.getCitation(b.d.kbmetadata,"Knowledge-base",b.d.softwareMetadata.title)),b.f.selectElementText(document.getElementById("tbSelectedCitations")),u("#tbCitationInstructions").show()}),t.append(u("<p>").append(a).append("&nbsp;The selected citations will appear together below - just copy and paste")),t.append(u("<div id='tbSelectedCitations'>")),t.append(u("<p id='tbCitationInstructions' style='display: none'>").text("You can now copy and paste the selected citation text.")),t},b.f.refreshVisualisation=function(){var m;m=u("#Sex").val(),b.d.taxa.forEach(function(f){f.visState.score.for=0,f.visState.score.against=0,f.visState.score.overall=0,f.visState.score.charFor=0,f.visState.score.charAgainst=0,f.visState.score.charNeutral=0,f.visState.score.charUsed=0,b.d.characters.filter(function(e){return"key"==e.Status}).forEach(function(t){var e,a,o,i,r=t.Character;if(t.stateSet){if("numeric"==t.ValueType)if(""==f[r])o=a=i=e=0;else if("n/a"==f[r])e=1,i=b.opts.ignoreNegativeScoring?0:1,o=a=0;else if("novalue"==f[r])e=1,a=i=0,o=b.opts.ignoreNegativeScoring?0:1;else{var n=Number(t.userInput),s=f[r].getRange(),l=(t.maxVal,t.minVal,b.f.score.numberVsRange(n,s,t.Latitude));a=l[0],o=l[1],e=1,i=0}else if("ordinal"==t.ValueType||"ordinalCircular"==t.ValueType||"text"==t.ValueType)if("n/a"==f[r])e=1,i=b.opts.ignoreNegativeScoring?0:1,o=a=0;else if("novalue"==f[r])a=i=0,o=e=1;else{var c=t.userInput.map(function(e){return t.CharacterStateValues[e]});if("ordinal"==t.ValueType||"ordinalCircular"==t.ValueType)var u=f[r].getOrdinalRanges(m),d=t.CharacterStateValues,p="ordinalCircular"==t.ValueType,l=b.f.score.ordinal(c,u,d,t.Latitude,p);else if("Sex"==r)var l=[0,0];else var u=f[r].getStates(m),l=b.f.score.character(c,u);a=l[0],o=l[1],e=1,i=0}}else o=a=i=e=0;f[r].score.na=i,f[r].score.for=a,f[r].score.against=o,f[r].score.overall=a-o-i;var h=Number(t.Weight)/10;f.visState.score.for+=a*h,f.visState.score.against+=o*h,f.visState.score.against+=i*h,f.visState.score.overall+=(a-o-i)*h,1==e&&(0<a-o-i?f.visState.score.charFor+=1:f.visState.score.charAgainst+=1),f.visState.score.charUsed+=e})}),i()&&i().refresh(),b.f.resizeControlsAndTaxa()},b.f.resizeControlsAndTaxa=function(){b.gui.main.resizeControlsAndTaxa()},b.f.characterHasHelp=function(t){return 0<b.d.oCharacters[t].Help.length||(0<b.d.values.filter(function(e){if(e.Character==t&&e.StateHelp)return!0}).length||0<b.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==t)return!0}).length)},b.f.getURLParameter=function(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var o=t[a].split("=");if(o[0]==e)return o[1]}return null},b.f.createMediaCheckPage=function(){var e=u("<div id='tombioMediaChecks'>"),t=u("<h2>").appendTo(e),a=u("<div id='tombioMediaNotFound'>").appendTo(e),o=u("<div id='tombioMediaFound'>").appendTo(e);return a.append("<h3>Not found</h3>"),a.append("<p>If a file cannot be found but you think it is present, check the case carefully. The case used to name the file must match exactly the case used in the knowledge-base. For example, a file with extension '.JPG' will not match the same filename in the knowledge-base if it is written there as '.jpg'.</p>"),o.append("<h3>Found</h3>"),t.text("Checking media files..."),b.f.mediaCheck("URI",function(e){u("#tombioMediaFound").append(u("<p>").html("The media file '"+e+"' found okay."))},function(e){u("#tombioMediaNotFound").append(u("<p>").html("The media file '"+e+"' cannot be found."))}).then(function(){b.f.mediaCheck("SmallURI",function(e){u("#tombioMediaFound").append(u("<p>").html("The small media file '"+e+"' found okay."))},function(e){u("#tombioMediaNotFound").append(u("<p>").html("The small media file '"+e+"' cannot be found."))})}).then(function(){b.f.mediaCheck("LargeURI",function(e){u("#tombioMediaFound").append(u("<p>").html("The large media file '"+e+"' found okay."))},function(e){u("#tombioMediaNotFound").append(u("<p>").html("The large media file '"+e+"' cannot be found."))})}).then(function(){t.text("Completed checking media files")}),e},b.f.createTvkCheckPage=function(){var e=u("<div id='tombioTvkChecks'>"),t=u("<h2>").appendTo(e),a=u("<div id='tombioTvkNotFound'>").appendTo(e),o=u("<div id='tombioTvkFound'>").appendTo(e);return a.append("<h3>Not found</h3>"),a.append("<p>If a TVK cannot be found by the NBN web service used for this checking, then you can double-check by going directly to the NBN Atlas page and searching on the TVK (https://nbnatlas.org/). To resolve problems with TVKs not being recognised, you may have to contact the NBN or the NHM who look after the UKSI.</p>"),o.append("<h3>Found</h3>"),t.text("Checking TVKs..."),b.f.tvkCheck(function(e){u("#tombioTvkFound").append(u("<p>").html("TVK '"+e.TVK+"' found."))},function(e){u("#tombioTvkNotFound").append(u("<p>").html("TVK '"+e.TVK+"' for '"+e.Taxon+"' cannot be found."))},function(){t.text("Completed checking TVKs")}),e},b.f.getTaxonCharacterValues=function(r){var n=u("<table>");n.css("width","100%"),n.css("margin","0px");var s=0,l="";return b.d.characters.forEach(function(e){if("key"==e.Status||"display"==e.Status){if(b.d.oCharacters.grouped&&e.Group!=l){(a=u("<tr>")).css("background-color","rgb(100,100,100)"),a.css("color","rgb(255,255,255)");var t=u("<td colspan='3'>");a.append(t.append(e.Group)),n.append(a),l=e.Group}s++;var a=u("<tr>");s%2!=0?a.css("background-color","rgb(200,200,200)"):a.css("background-color","rgb(230,230,230)");var o=u("<td>").append(e.Label),i=u("<td>").append(r[e.Character].toHtml1());a.append(o),a.append(i),n.append(a)}}),n.find("td").css("padding","2"),n},b.f.addTaxonImagesToContainer=function(e){var t=e.taxon,a=e.container,o=e.indexSelected?e.indexSelected:0,i=!!e.imageRemovalButton&&e.imageRemovalButton,r=e.fImageSelect?e.fImageSelect:null,n=e.height?e.height:400,s=b.f.getTaxonImages(t);if(0!=s.length){var l=u("<div>").addClass("tombio-galleria-pane").css("position","relative").css("max-width","2000px").css("height",n).appendTo(a),c=[];s.forEach(function(e){var t={image:e.URI,thumb:e.SmallURI?e.SmallURI:null,big:e.LargeURI?e.LargeURI:null,alt:e.Caption,title:e.Caption};c.push(t)}),Galleria.run(l,{transition:"fade",wait:!0,dataSource:c,theme:"classic",show:o}),l.data("galleria").bind("loadfinish",function(e){r&&r(e.index)}),u("<img>").attr("src",b.opts.tombiopath+"resources/enlarge.png").appendTo(l).addClass("tombio-galleria-lightbox-button").on("click",function(){l.data("galleria").openLightbox()}),i&&u("<img>").attr("src",b.opts.tombiopath+"resources/remove.png").appendTo(l).addClass("tombio-galleria-remove-button").on("click",function(){l.data("galleria").destroy(),a.addClass("userRemoved"),a.remove()})}else{u("<div>").css("margin","10px").text("No images are specified in the knowledge-base for this taxon.").appendTo(a)}},b.f.getTaxonImages=function(t){return b.d.media.filter(function(e){if(e.Taxon==t&&("image-local"==e.Type||"image-web"==e.Type))return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},b.f.getCharacterImages=function(t,a,o){return b.d.media.filter(function(e){if(e.Character==t&&("image-local"==e.Type||"image-web"==e.Type)&&!(a&&e.State!=a||o&&e.UseFor&&!(-1<e.UseFor.split(",").indexOf(o))))return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},b.f.addNBNMapToContainer=function(e,t){e=e+="";var a=u("<div>").appendTo(t).css("border","1px solid black").css("padding","5px").css("border-radius","10px"),o=u("<img>").addClass("tombioNbnLogo").attr("src",b.opts.tombiopath+"/resources/nbn-logo-centred.png").addClass(function(){if(e)return"tombioSpiningNbn"}()).appendTo(a),i=u("<div>").addClass("tombioNbnLoading").css("font-size","0.8em").text(e?"Loading distribution map from NBN...":"No TVK specified for this taxon").appendTo(a);if(e)if(b.d.nbnMapCache[e]){var r=b.d.nbnMapCache[e];o.attr("src",b.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),i.hide()}else{var n="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+e+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100";r=u("<img>").attr("id","tombioNbnMapImage").on("load",function(){o.attr("src",b.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),i.hide()}).on("error",function(){o.removeClass("tombioSpiningNbn"),i.text("An error was encountered attemping to retrieve an NBN distribution map for the TVK "+e),r.hide()}).attr("src",n);b.d.nbnMapCache[e]=r}u("<div>").append(r).appendTo(a)},b.f.addTaxonHtmlToContainer=function(e,r,t){var a=b.f.getTaxonHtmlFiles(e);t<=a.length-1?u.get(a[t].URI,function(e){var t=e.indexOf("<body"),a=e.indexOf("</body"),o=e.slice(t,a),i=u("<div>").html(o);r.html(i.html())}):r.html(null)},b.f.getTaxonHtmlFiles=function(t){return b.d.media.filter(function(e){if(e.Taxon==t&&"html-local"==e.Type)return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},b.f.getCharacterScoreDetails=function(e,t){var a;return a="<p>Specified state(s) for character <b>"+t.Label+"</b>: </p>",a+="<ul>","numeric"!=t.ValueType?b.d.oCharacters[t.Character].userInput.forEach(function(e){a+="<li><b>",a+=b.d.oCharacters[t.Character].CharacterStateValues[e],a+="</b></li>"}):(a+="<li><b>",a+=b.d.oCharacters[t.Character].userInput,a+="</b></li>"),a+="</ul>",a+="<p>Valid state(s) for <b>"+t.Label+"</b> recorded against ",a+="<b><i>"+e.Taxon+"</i></b> in the knowledge base: ",a+="<ul>",a+=e[t.Character].toHtml2(),a+="</ul>",a+="<hr/>",a+="<p>Knowledge-base <b>weighting</b> for this character: <b>"+t.Weight+"</b></p>",a+="<p>Knowledge-base <b>latitude</b> for this character: <b>"+t.Latitude+"</b></p>",a+="<hr/>",a+="<p>Unweighted character score: <b>"+Math.round(100*e[t.Character].score.overall)/100+"</b>; ",a+="(for, "+Math.round(100*e[t.Character].score.for)/100,a+="; against, "+Math.round(100*(e[t.Character].score.against+e[t.Character].score.na))/100+")</p>",a+="<p>Weighted character score: <b>"+Math.round(e[t.Character].score.overall*t.Weight*10)/100+"</b></p>"},b.f.sortTaxa=function(e,a){return a||(a="all"),e.sort(function(e,t){if("matched"==a){if(e.visState.score.charFor>t.visState.score.charFor)return-1;if(t.visState.score.charFor>e.visState.score.charFor)return 1}return e.visState.score.overall>t.visState.score.overall?-1:t.visState.score.overall>e.visState.score.overall?1:t.visState.score.overall==e.visState.score.overall?e.visState.score.for>t.visState.score.for?1:t.visState.score.for>e.visState.score.for?-1:e.kbPosition>t.kbPosition?1:-1:void 0})},b.f.getTaxonTipImage=function(a,e){var t=b.d.media.filter(function(e){if(e.Taxon==a&&("image-local"==e.Type||"image-web"==e.Type)){if(e.UseFor){var t=!1;return e.UseFor.split(",").forEach(function(e){"tip"==e.toLowerCase().trim()&&(t=!0)}),t}return!0}}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)});if(0<t.length){var o=u("<div/>"),i=t[0],r=u("<img/>",{src:i.URI}).appendTo(o).css("margin-top",2);u("<figcaption/>",{html:i.Caption}).appendTo(o);return i.ImageWidth&&r.css("width",i.ImageWidth),o}return null},b.f.taxonTag=function(e){return e.replace(/[\/|&;$%@"<>()+:.,' ]/g,"")},b.f.copyTextToClipboard=function(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();try{var a=document.execCommand("copy")?"successful":"unsuccessful";console.log("Copying text "+a)}catch(e){console.log("Oops, unable to copy text")}document.body.removeChild(t)},b.f.createViewURL=function(e){var t=window.location.href.split("tbv=")[0],a=-1==t.indexOf("?")?"?":"&",o=encodeURI(t+a+"tbv=&"+e.join("&"));b.f.copyTextToClipboard(o)},b.f.selectElementText=function(e,t){var a,o,i=(t=t||window).document;t.getSelection&&i.createRange?(a=t.getSelection(),(o=i.createRange()).selectNodeContents(e),a.removeAllRanges(),a.addRange(o)):i.body.createTextRange&&((o=i.body.createTextRange()).moveToElementText(e),o.select())},b.f.checkInterface=function(r,e,t){b.opts.devel&&function e(t,a,o){for(var i in a)a.hasOwnProperty(i)&&(o[i]?"object"==typeof a[i]&&e(t+"."+i,a[i],o[i]):console.log("%cInterface warning: "+r+t+"."+i+" not found in "+r,"color: red"))}("",e,t)},b.f.stateValueHelpPresent=function(e){for(var t=0;t<b.d.values.length;t++){var a=b.d.values[t];if(a.Character==e&&a.StateHelp)return!0}return!1},b.f.getFullCharacterHelp=function(r){var n=u("<div>");return u("<p>").html(b.d.oCharacters[r].Help).appendTo(n),b.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==r&&!e.State){if(e.UseFor){var t=!1;return e.UseFor.split(",").forEach(function(e){"full"==e.toLowerCase().trim()&&(t=!0)}),t}return!0}}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)}).forEach(function(e,t){var a=u("<figure/>").appendTo(n);a.addClass("helpFigure");var o=u("<img/>",{src:e.URI}),i=u("<figcaption/>",{html:e.Caption});a.append(o).append(i),0<t&&o.css("margin-top",10),i.appendTo(n),e.ImageWidth&&o.css("width",e.ImageWidth)}),b.d.values.filter(function(e){if(e.Character==r&&e.StateHelp)return!0}).forEach(function(t){if(t.CharacterStateTranslation&&""!=t.CharacterStateTranslation)var e=t.CharacterStateTranslation;else e=t.CharacterState;var a=u("<p/>").appendTo(n),o=u("<span/>",{text:e+": "}).css("font-weight","Bold");a.append(o);var i=u("<span/>",{html:t.StateHelp}).css("font-weight","Normal");a.append(i),b.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==r&&e.State==t.CharacterState)return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)}).forEach(function(e,t){var a=u("<img/>",{src:e.URI}),o=u("<figcaption/>",{html:e.Caption});a.appendTo(n),0<t&&a.css("margin-top",10),o.appendTo(n),e.ImageWidth&&a.css("width",e.ImageWidth)})}),n.html()}}(jQuery,this.tombiovis);