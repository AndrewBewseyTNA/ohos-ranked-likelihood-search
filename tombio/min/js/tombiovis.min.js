!function(e,c){"use strict";c.d.stateValue={v:null},c.d.stateValue.init=function(e,i){var r=c.d.oCharacters[i];this.valueType=r.ValueType,this.status=r.Status,this.character=r.Character;var s,l=this;this.v.trim().split("|").forEach(function(e,t){var a,o;if(e=e.trim(),o=e.endsWith("(m)")||e.endsWith("(f)")?(a=e.substr(0,e.length-4).trim(),e.substr(e.length-4,4)):(a=e,""),r.stateGroups&&-1<r.stateGroups.indexOf(a)){var n=[];c.d.values.forEach(function(e){e.Character==i&&e.StateGroup==a&&n.push(e.CharacterState)})}else n=[a];n.forEach(function(e){var t=l.translateStateValue(l.character,e);""!=o&&(t=t+" "+o),s=s?s+" | "+t:t}),0<s.length&&"#"==s.substr(0,1)&&(s=""),"?"==s.length&&(s="")}),this.kbValue=s,"key"==r.Status&&(this.score={na:0,for:0,against:0,overall:0})},c.d.stateValue.translateStateValue=function(e,t){function a(t,a){var e=c.d.values.filter(function(e){return e.Character==t&&e.CharacterState.trim()==a});if(e[0]&&e[0].CharacterStateTranslation&&""!=e[0].CharacterStateTranslation)var o=e[0].CharacterStateTranslation;else o=a;return o}if(/^\[[^-]+-[^-]+\]$/.test(t)){var o=t.substr(1,t.length-2).split("-");return"["+a(e,o[0])+"-"+a(e,o[1])+"]"}return a(e,t)},c.d.stateValue.getStates=function(e){e||(e="");for(var t=[],a=this.kbValue.split("|"),o=0;o<a.length;o++){var n=a[o];"n/a"!=(n=n.trim())&&"novalue"!=n&&"?"!=n&&""!=n&&("male"!=e||n.endsWith("(f)")?"female"!=e||n.endsWith("(m)")?""==e&&t.push(n.replace("(m)","").replace("(f)","").trim()):t.push(n.replace("(f)","").trim()):t.push(n.replace("(m)","").trim()))}return t},c.d.stateValue.getRange=function(){var e={};if(""==String(this.kbValue)?e.hasValue=!1:e.hasValue=!0,0==String(this.kbValue).indexOf("[")){var t=this.kbValue.substr(1,this.kbValue.length-2).split("-");e.min=Number(t[0]),e.max=Number(t[1]),e.mid=e.min+(e.max-e.min)/2}else e.min=Number(this.kbValue),e.max=Number(this.kbValue),e.mid=Number(this.kbValue);return e},c.d.stateValue.getOrdinalRanges=function(e){var r=this,s=[];return"ordinal"!=this.valueType&&"ordinalCircular"!=this.valueType||this.getStates(e).forEach(function(e){var t=[];if(0==e.indexOf("[")){var a=e.substr(1,e.length-2).split("-"),o=a[0],n=a[1],i=!1;c.d.oCharacters[r.character].CharacterStateValues.forEach(function(e){e==o&&(i=!0),i&&t.push(e),e==n&&(i=!1)}),i&&c.d.oCharacters[r.character].CharacterStateValues.forEach(function(e){i&&t.push(e),e==n&&(i=!1)})}else t.push(e);s.push(t)}),s},c.d.stateValue.toHtml1=function(){if("n/a"==this.kbValue)return"<i>not applicable</i>";if("novalue"==this.kbValue)return"<i>not manifest</i>";if(""==this.kbValue||"?"==this.kbValue)return"<i>no value specified</i>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalCircular"==this.valueType)return t=(t=(t=(t=(t=(t=this.kbValue.replace(/([^|]+)/g,"<b>$1</b>")).replace(/(\(m\)\s*<\/b>)/g,"</b> (male)")).replace(/(\(f\)\s*<\/b>)/g,"</b> (female)")).replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>")).replace(/\s*\|\s*/g," or "),"display"==this.status&&(t=t.replace(/<b>/g,"").replace(/<\/b>/g,"")),t;if("numeric"!=this.valueType)return this.kbValue;var e=this.getRange();if(0==e.hasValue)var t="<b>no value in knowledge-base</b>";else if(e.min==e.max)t="<b>"+e.min+"</b>";else t="<b>"+e.min+"-"+e.max+"</b> (range)";return"display"==this.status&&(t=t.replace(/<b>/g,"").replace(/<\/b>/g,"")),t},c.d.stateValue.toHtml2=function(e){var t="<li>",a="</li>";if(e&&(a=t=""),"n/a"==this.kbValue)return"<li><i>not applicable</i></li>";if("novalue"==this.kbValue)return"<li><i>not manifest</i></li>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalCircular"==this.valueType){for(var o="",n=this.kbValue.split("|"),i=0;i<n.length;i++){var r=n[i].trim();r=(r=(r=/\(m\)$/.test(r)?"<b>"+r.replace(/\(m\)$/,"</b> (male)"):/\(f\)$/.test(r)?"<b>"+r.replace(/\(f\)$/,"</b> (female)"):"<b>"+r.trim()+"</b>").replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>"),i<n.length-1&&(r+=" <i>or</i> "),o+=t,o+=r,o+=a}return o}if("numeric"!=this.valueType)return this.kbValue;var s=this.getRange();return 0==s.hasValue?t+"<i>no value in knowledge-base</i>"+a:s.min==s.max?t+"<b>"+s.min+"</b>"+a:t+"<b>"+s.min+" - "+s.max+"</b> (range)"+a},c.d.stateValue.toString=function(){return this.kbValue}}(jQuery,this.tombiovis),function(u,g){"use strict";function n(){return g.v.selectedTool in g.v.visualisations?g.v.visualisations[g.v.selectedTool]:null}g.f.loadcomplete=function(e){if(u("#tombiod3-header").text(g.d.kbmetadata.title),u("#tombiod3-footer").html(g.f.getCitation(g.d.kbmetadata,"Knowledge-base",g.d.softwareMetadata.title)),e||g.f.checkKnowledgeBase()){g.d.values.forEach(function(e){e.CharacterStateTranslation&&(e.CharacterStateTranslation=e.CharacterStateTranslation.replace(/ +(?= )/g,""))}),g.d.oCharacters={},g.d.characters.forEach(function(t){(g.d.oCharacters[t.Character]=t).CharacterStates=[],t.CharacterStateValues=[],t.stateSet=!1,t.userInput=null,t.minVal=null,t.maxVal=null,"key"==t.Status&&"none"!=t.Group.toLowerCase()&&(g.d.oCharacters.grouped=!0),t.stateGroups=[],g.d.values.forEach(function(e){e.Character==t.Character&&e.StateGroup&&-1==t.stateGroups.indexOf(e.StateGroup)&&t.stateGroups.push(e.StateGroup)})}),g.d.groupedCharacters={},g.d.groupedCharacters.groups=[],g.d.characters.forEach(function(e){"key"==e.Status&&(g.d.groupedCharacters[e.Group]||(g.d.groupedCharacters[e.Group]=[],g.d.groupedCharacters.groups.push(e.Group)),g.d.groupedCharacters[e.Group].push(e))}),g.d.oTaxa={};var a=0;g.d.taxa.forEach(function(e){for(var t in g.d.oTaxa[e.Taxon]=e)e.hasOwnProperty(t)&&(e[t]=Object.create(g.d.stateValue,{v:{writable:!0,value:e[t]}}),e[t].init(e,t));e.kbPosition=++a,e.visState={score:{for:null,against:null,overall:null}}}),g.d.characters.forEach(function(o){if("numeric"==o.ValueType&&g.d.taxa.forEach(function(e){var t=e[o.Character].getRange().min,a=e[o.Character].getRange().max;(!o.minVal||t<o.minVal)&&(o.minVal=t),(!o.maxVal||a>o.maxVal)&&(o.maxVal=a)}),"numeric"==o.ValueType||"ordinal"==o.ValueType||"ordinalCircular"==o.ValueType)if(void 0!==o.Latitude)o.Latitude=Number(o.Latitude);else{var e=""==o.Strictness?10:Number(o.Strictness);if("numeric"==o.ValueType)o.Latitude=(1-e/10)*(o.maxVal-o.minVal);else{var t=g.d.values.filter(function(e){return e.Character==o.Character}).length;o.Latitude=(1-e/10)*t,"ordinalCircular"==o.ValueType&&(o.Latitude=o.Latitude/2)}}}),g.d.media.forEach(function(e){"html-local"==e.Type?e.URI=g.opts.tombiokbpath+e.URI+"?t=kbtxt":"image-local"==e.Type&&(e.URI=g.opts.tombiokbpath+e.URI+"?t=kbimgstd",e.SmallURI&&(e.SmallURI=g.opts.tombiokbpath+e.SmallURI+"?t=kbimgsml"),e.LargeURI&&(e.LargeURI=g.opts.tombiokbpath+e.LargeURI+"?t=kbimglrg"))}),g.d.values.forEach(function(e){var t=g.d.oCharacters[e.Character];if(t){if(e.CharacterStateTranslation&&""!=e.CharacterStateTranslation)var a=e.CharacterStateTranslation;else var a=e.CharacterState;"Mass3"==e.Character&&"IIa"==e.CharacterState&&(console.log("val.CharacterStateTranslation",e.CharacterStateTranslation),console.log("translated character state is",a)),t.CharacterStates.push({CharacterState:a,StateHelp:e.StateHelp,StateHelpShort:e.StateHelpShort}),t.CharacterStateValues.push(a)}}),g.d.characters.forEach(function(a){("Taxonomy"==a.Group||"key"==a.Status&&"text"==a.ValueType)&&g.d.taxa.forEach(function(e){var t=e[a.Character].getStates("");t.forEach(function(e){""!=e&&-1==a.CharacterStateValues.indexOf(e)&&(a.CharacterStates.push({CharacterState:e,StateHelp:""}),a.CharacterStateValues.push(e))})})});var t=g.f.getURLParameter("selectedTool");t?g.v.selectedTool=t:g.opts.selectedTool?g.v.selectedTool=g.opts.selectedTool:g.d.kbconfig.selectedTool?g.v.selectedTool=g.d.kbconfig.selectedTool:g.v.selectedTool=g.v.includedVisualisations[0],g.gui.main.init(),g.gui.main.createUIControls(),u("#downloadspin").remove(),g.f.resizeControlsAndTaxa(),g.f.visChanged(g.v.selectedTool),g.loadCallback&&g.loadCallback()}},g.f.cacheAll=function(){console.log("caching all");var t=0,a=0,o=[];g.opts.tools.forEach(function(e){console.log("Caching tool "+e);var t=g.js.jsFiles[e].loadJs().then(function(){console.log("Tool "+e+" successfully cached.")}).catch(function(){console.log("Tool "+e+" unsuccessfully cached.")});a+=1,u(t),o.push(t)});var e=[];e.push(g.opts.tombiokbpath+"info.html");var n=g.opts.tombiopath+"common/",i=[];i.push(n+"character-help.png"),i.push(n+"character-input.png"),i.push(n+"full-details.html"),i.push(n+"nbn-map.jpg"),i.push(n+"stateInputHelp.html"),i.push(n+"taxon-details-2.png"),i.push(n+"taxon-select-help.html"),i.push(n+"taxon-select.png"),i.push(n+"taxonDetailsHelp.html"),i.push(n+"text-selection-input.png");var r=g.d.media.filter(function(e){return e.SmallURI&&"image-local"==e.Type}).map(function(e){return e.SmallURI}),s=g.d.media.filter(function(e){return e.URI&&"image-local"==e.Type}).map(function(e){return e.URI}),l=g.d.media.filter(function(e){return e.LargeURI&&"image-local"==e.Type}).map(function(e){return e.LargeURI}),c=g.d.media.filter(function(e){return e.URI&&"html-local"==e.Type}).map(function(e){return e.URI});function u(e){e.then(function(){t+=1,g.gui.main.updateProgress(100*t/a)})}function d(e,t,n){return a+=e.length,caches.open(t).then(function(a){console.log("Caching "+n);var o=[];return e.forEach(function(e){var t=a.add(e);u(t),o.push(t)}),Promise.all(o).then(function(){console.log("Sucessfully cached "+n)}).catch(function(){console.log("One or more files failed to cache "+n)})})}o.push(d(r,"tombio-kb-img-sml-cache-1","small images from knowledge-base")),o.push(d(s,"tombio-kb-img-std-cache-1","standard images from knowledge-base")),o.push(d(l,"tombio-kb-img-lrg-cache-1","large images from knowledge-base")),o.push(d(c,"tombio-kb-txt-cache-1","text files from knowledge-base")),o.push(d(e,"tombio-kb-cache-1","core knowledge-base")),o.push(d(i,"tombio-gen-cache-1","common help resources")),Promise.all(o).then(function(){console.log("All caches completed"),g.gui.main.offerRefresh()}).catch(function(){console.log("Not all caches completed successfully")})},g.f.visChanged=function(a,e){if(a){if(g.opts.devel&&g.templates.visTemplate.initP("visTemplate"),"reload"==(g.v.selectedTool=a))return caches?void caches.keys().then(function(e){return Promise.all(e.map(function(e){if(e.startsWith("tombio-"))return console.log("[ServiceWorker] Removing cache",e),caches.delete(e)}))}).then(function(){window.location.reload()}):void window.location.reload(!0);if("reloadkb"!=a)if("reloadGuiOnsen"!=a)if("reloadGuiJQuery"!=a)if("offline"!=a)if("visInfo"!=a&&"kbInfo"!=a){var t;if("tombioCitation"==a||"currentVisInfo"==a)return t=e||(g.v.lastVis?g.v.lastVis:g.opts.lastVisualisation?g.opts.lastVisualisation:g.v.includedVisualisations[0].visName),g.f.showDownloadSpinner(),void g.js.jsFiles[t].loadJs().then(function(){if(g.f.hideDownloadSpinner(),!g.v.visualisations[t].visName){var e=g.v.visualisations[t];e.initP(t),e.hide()}g.v.lastVis=t,g.gui.main.visShow(a)});"mediaFilesCheck"!=a&&"tvkCheck"!=a?(g.f.showDownloadSpinner(),g.js.jsFiles[a].loadJs().then(function(){(g.f.hideDownloadSpinner(),g.v.visualisations[a].initialised)||g.v.visualisations[a].initP(a);console.log("Starting",a),g.gui.main.visShow(a)}).catch(function(e){console.log("Error",e);var t="";t+="<p>You are working offline but the tool you tried to load( "+a+") was not previously loaded into memory.</p>",t+="<p>Load the tool when you next have an internet connection. Then you will be able to use it offline.</p>",g.gui.main.dialog("Currently unavailable",t)}),g.gui.main.setSelectedTool(a)):g.gui.main.visShow(a)}else g.gui.main.visShow(a);else g.gui.main.offlineOptions();else{location.pathname;window.location.replace(location.pathname+"?gui=guiLargeJqueryUi")}else{location.pathname;window.location.replace(location.pathname+"?gui=guiOnsenUi")}else caches?caches.keys().then(function(e){return Promise.all(e.map(function(e){if(e.startsWith("tombio-kb-"))return console.log("[ServiceWorker] Removing cache",e),caches.delete(e)}))}).then(function(){window.location.reload()}):window.location.reload(!0)}},g.f.initControlsFromParams=function(e){for(name in e)if(name.startsWith("c-")){var t=name.split("-")[1],a=g.d.characters[t];"spin"===a.ControlType?a.userInput=e[name]:a.userInput=e[name].split(","),a.stateSet=!0}n().inputControl.initStateFromParams(e),g.f.refreshVisualisation()},g.f.setParamsFromControls=function(){var o=[];return g.d.characters.forEach(function(e,t){if(e.userInput){var a="c-"+t;"spin"===e.ControlType?o.push(a+"="+e.userInput):o.push(a+"="+e.userInput.join(","))}}),n().inputControl.setParamsFromState(o)},g.f.getCitation=function(e,t,a){var o,n=u("<div class='tombioCitation'>"),i=new Date;return o=e.authors+" ",o+="("+e.year+") ",o+="<i>"+e.title+"</i>",o+=" (Version "+e.version+") ["+t+"]",a&&(o+=" (for "+a+")"),o+=". ",e.publisher&&(o+=e.publisher+". "),e.location&&(o+=e.location+". "),o+="Accessed "+i.toDateString()+". ",o+=window.location.href.split("?")[0],n.append(u("<div>").html(o)),n},g.f.setKbInfo=function(i){u.get(g.opts.tombiokbpath+"info.html",function(e){i.append(e.replace(/##tombiopath##/g,g.opts.tombiopath).replace(/##tombiokbpath##/g,g.opts.tombiokbpath))}).always(function(){var e=u("<h3>").attr("id","tombioKbCitation").text("Citation");i.append(e),i.append(g.f.getCitation(g.d.kbmetadata,"Knowledge-base",g.d.softwareMetadata.title));var t=u("<h3>").attr("id","tombioKbRevisionHistory").text("Knowledge-base revision history");i.append(t);var a=u("<p>").html("<b>Current version: "+g.d.kbmetadata.version+"</b>");i.append(a);var o=u("<table>"),n=u("<tr>").css("background-color","black").css("color","white");n.append(u("<td>").text("Date").css("padding","3px")),n.append(u("<td>").text("Version").css("padding","3px")),n.append(u("<td>").text("Notes").css("padding","3px")),o.append(n),g.d.kbreleaseHistory.forEach(function(e,t){n=u("<tr>"),t%2==0?n.css("background-color","rgb(200,200,200)"):n.css("background-color","rgb(230,230,230)");var a=new Date(e.Date);n.append(u("<td>").css("padding","3px").text(a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear())),n.append(u("<td>").css("padding","3px").text(e.Value)),n.append(u("<td>").css("padding","3px").text(e.Notes)),o.append(n)}),i.append(o)})},g.f.setVisInfo=function(t){u.get(g.opts.tombiopath+"visInfo.html",function(e){t.html(e.replace(/##tombiopath##/g,g.opts.tombiopath).replace(/##tombiokbpath##/g,g.opts.tombiokbpath))})},g.f.setSelectedToolInfo=function(e){var n=new Array(g.v.visualisations[g.v.lastVis].helpFiles.length),t=[];g.v.visualisations[g.v.lastVis].helpFiles.forEach(function(a,o){t.push(new Promise(function(t,e){u.get(a,function(e){n[o]=e,t()})}))}),Promise.all(t).then(function(){var t="";n.forEach(function(e){t+=e}),t=t.replace(/##tombiopath##/g,g.opts.tombiopath).replace(/##tombiokbpath##/g,g.opts.tombiokbpath),e.html(t)})},g.f.createCitationPage=function(){var e,t=u("<div>");t.append(u("<h3>").text("Citation for FSC Identikit (core software)")),e="This is the reference you can use for the FSC Identikit - in other words the core software.",e+=" The core version number is updated whenever there is a new major release of the core software.",t.append(u("<p>").html(e)),t.append(u("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationCore' id='tbCitationCore'>")),t.append(u("<span>").text("Copy citation")),t.append(u("<b>").html(g.f.getCitation(g.d.softwareMetadata,"Software"))),t.append(u("<h3>").text("Citation for knowledge-base")),e="This is the reference you can use for the knowledge-base currently driving the software.",e+=" The knowledge-base version number is updated whenever there is a new release of the knowledge-base.",t.append(u("<p>").html(e)),t.append(u("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationKb' id='tbCitationKb'>")),t.append(u("<span>").text("Copy citation")),t.append(u("<b>").html(g.f.getCitation(g.d.kbmetadata,"Knowledge-base",g.d.softwareMetadata.title)));var a=u("<button>Copy citations</button>");return a.button(),a.click(function(){u("#tbSelectedCitations").html(""),document.getElementById("tbCitationCore").checked&&u("#tbSelectedCitations").append(g.f.getCitation(g.d.softwareMetadata,"Software")),document.getElementById("tbCitationKb").checked&&u("#tbSelectedCitations").append(g.f.getCitation(g.d.kbmetadata,"Knowledge-base",g.d.softwareMetadata.title)),g.f.selectElementText(document.getElementById("tbSelectedCitations")),u("#tbCitationInstructions").show()}),t.append(u("<p>").append(a).append("&nbsp;The selected citations will appear together below - just copy and paste")),t.append(u("<div id='tbSelectedCitations'>")),t.append(u("<p id='tbCitationInstructions' style='display: none'>").text("You can now copy and paste the selected citation text.")),t},g.f.refreshVisualisation=function(){var m;m=u("#Sex").val(),g.d.taxa.forEach(function(f){f.visState.score.for=0,f.visState.score.against=0,f.visState.score.overall=0,f.visState.score.charFor=0,f.visState.score.charAgainst=0,f.visState.score.charNeutral=0,f.visState.score.charUsed=0,g.d.characters.filter(function(e){return"key"==e.Status}).forEach(function(t){var e,a,o,n,i=t.Character;if(t.stateSet){if("numeric"==t.ValueType)if(""==f[i])o=a=n=e=0;else if("n/a"==f[i])e=1,n=g.opts.ignoreNegativeScoring?0:1,o=a=0;else if("novalue"==f[i])e=1,a=n=0,o=g.opts.ignoreNegativeScoring?0:1;else{var r=Number(t.userInput),s=f[i].getRange(),l=(t.maxVal,t.minVal,g.f.score.numberVsRange(r,s,t.Latitude));a=l[0],o=l[1],e=1,n=0}else if("ordinal"==t.ValueType||"ordinalCircular"==t.ValueType||"text"==t.ValueType)if("n/a"==f[i])e=1,n=g.opts.ignoreNegativeScoring?0:1,o=a=0;else if("novalue"==f[i])a=n=0,o=e=1;else{var c=t.userInput.map(function(e){return t.CharacterStateValues[e]});if("ordinal"==t.ValueType||"ordinalCircular"==t.ValueType)var u=f[i].getOrdinalRanges(m),d=t.CharacterStateValues,p="ordinalCircular"==t.ValueType,l=g.f.score.ordinal(c,u,d,t.Latitude,p);else if("Sex"==i)var l=[0,0];else var u=f[i].getStates(m),l=g.f.score.character(c,u);a=l[0],o=l[1],e=1,n=0}}else o=a=n=e=0;f[i].score.na=n,f[i].score.for=a,f[i].score.against=o,f[i].score.overall=a-o-n;var h=Number(t.Weight)/10;f.visState.score.for+=a*h,f.visState.score.against+=o*h,f.visState.score.against+=n*h,f.visState.score.overall+=(a-o-n)*h,1==e&&(0<a-o-n?f.visState.score.charFor+=1:f.visState.score.charAgainst+=1),f.visState.score.charUsed+=e})}),n()&&n().refresh(),g.f.resizeControlsAndTaxa()},g.f.resizeControlsAndTaxa=function(){g.gui.main.resizeControlsAndTaxa()},g.f.characterHasHelp=function(t){return 0<g.d.oCharacters[t].Help.length||(0<g.d.values.filter(function(e){if(e.Character==t&&e.StateHelp)return!0}).length||0<g.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==t)return!0}).length)},g.f.getURLParameter=function(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var o=t[a].split("=");if(o[0]==e)return o[1]}return null},g.f.createMediaCheckPage=function(){var e=u("<div id='tombioMediaChecks'>"),t=u("<h2>").appendTo(e),a=u("<div id='tombioMediaNotFound'>").appendTo(e),o=u("<div id='tombioMediaFound'>").appendTo(e);return a.append("<h3>Not found</h3>"),a.append("<p>If a file cannot be found but you think it is present, check the case carefully. The case used to name the file must match exactly the case used in the knowledge-base. For example, a file with extension '.JPG' will not match the same filename in the knowledge-base if it is written there as '.jpg'.</p>"),o.append("<h3>Found</h3>"),t.text("Checking media files..."),g.f.mediaCheck("URI",function(e){u("#tombioMediaFound").append(u("<p>").html("The media file '"+e+"' found okay."))},function(e){u("#tombioMediaNotFound").append(u("<p>").html("The media file '"+e+"' cannot be found."))}).then(function(){g.f.mediaCheck("SmallURI",function(e){u("#tombioMediaFound").append(u("<p>").html("The small media file '"+e+"' found okay."))},function(e){u("#tombioMediaNotFound").append(u("<p>").html("The small media file '"+e+"' cannot be found."))})}).then(function(){g.f.mediaCheck("LargeURI",function(e){u("#tombioMediaFound").append(u("<p>").html("The large media file '"+e+"' found okay."))},function(e){u("#tombioMediaNotFound").append(u("<p>").html("The large media file '"+e+"' cannot be found."))})}).then(function(){t.text("Completed checking media files")}),e},g.f.createTvkCheckPage=function(){var e=u("<div id='tombioTvkChecks'>"),t=u("<h2>").appendTo(e),a=u("<div id='tombioTvkNotFound'>").appendTo(e),o=u("<div id='tombioTvkFound'>").appendTo(e);return a.append("<h3>Not found</h3>"),a.append("<p>If a TVK cannot be found by the NBN web service used for this checking, then you can double-check by going directly to the NBN Atlas page and searching on the TVK (https://nbnatlas.org/). To resolve problems with TVKs not being recognised, you may have to contact the NBN or the NHM who look after the UKSI.</p>"),o.append("<h3>Found</h3>"),t.text("Checking TVKs..."),g.f.tvkCheck(function(e){u("#tombioTvkFound").append(u("<p>").html("TVK '"+e.TVK+"' found."))},function(e){u("#tombioTvkNotFound").append(u("<p>").html("TVK '"+e.TVK+"' for '"+e.Taxon+"' cannot be found."))},function(){t.text("Completed checking TVKs")}),e},g.f.getTaxonCharacterValues=function(i){var r=u("<table>");r.css("width","100%"),r.css("margin","0px");var s=0,l="";return g.d.characters.forEach(function(e){if("key"==e.Status||"display"==e.Status){if(g.d.oCharacters.grouped&&e.Group!=l){(a=u("<tr>")).css("background-color","rgb(100,100,100)"),a.css("color","rgb(255,255,255)");var t=u("<td colspan='3'>");a.append(t.append(e.Group)),r.append(a),l=e.Group}s++;var a=u("<tr>");s%2!=0?a.css("background-color","rgb(200,200,200)"):a.css("background-color","rgb(230,230,230)");var o=u("<td>").append(e.Label),n=u("<td>").append(i[e.Character].toHtml1());a.append(o),a.append(n),r.append(a)}}),r.find("td").css("padding","2"),r},g.f.addTaxonImagesToContainer=function(e){var t=e.taxon,a=e.container,o=e.indexSelected?e.indexSelected:0,n=!!e.imageRemovalButton&&e.imageRemovalButton,i=e.fImageSelect?e.fImageSelect:null,r=e.height?e.height:400,s=g.f.getTaxonImages(t);if(0!=s.length){var l=u("<div>").addClass("tombio-galleria-pane").css("position","relative").css("max-width","2000px").css("height",r).appendTo(a),c=[];s.forEach(function(e){var t={image:e.URI,thumb:e.SmallURI?e.SmallURI:null,big:e.LargeURI?e.LargeURI:null,alt:e.Caption,title:e.Caption};c.push(t)}),Galleria.run(l,{transition:"fade",wait:!0,dataSource:c,theme:"classic",show:o}),l.data("galleria").bind("loadfinish",function(e){i&&i(e.index)}),u("<img>").attr("src",g.opts.tombiopath+"resources/enlarge.png").appendTo(l).addClass("tombio-galleria-lightbox-button").on("click",function(){l.data("galleria").openLightbox()}),n&&u("<img>").attr("src",g.opts.tombiopath+"resources/remove.png").appendTo(l).addClass("tombio-galleria-remove-button").on("click",function(){l.data("galleria").destroy(),a.addClass("userRemoved"),a.remove()})}else{u("<div>").css("margin","10px").text("No images are specified in the knowledge-base for this taxon.").appendTo(a)}},g.f.getTaxonImages=function(t){return g.d.media.filter(function(e){if(e.Taxon==t&&("image-local"==e.Type||"image-web"==e.Type))return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},g.f.getCharacterImages=function(t,a,o){return g.d.media.filter(function(e){if(e.Character==t&&("image-local"==e.Type||"image-web"==e.Type)&&!(a&&e.State!=a||o&&e.UseFor&&!(-1<e.UseFor.split(",").indexOf(o))))return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},g.f.addNBNMapToContainer=function(e,t){e=e+="";var a=u("<div>").appendTo(t).css("border","1px solid black").css("padding","5px").css("border-radius","10px"),o=u("<img>").addClass("tombioNbnLogo").attr("src",g.opts.tombiopath+"/resources/nbn-logo-centred.png").addClass(function(){if(e)return"tombioSpiningNbn"}()).appendTo(a),n=u("<div>").addClass("tombioNbnLoading").css("font-size","0.8em").text(e?"Loading distribution map from NBN...":"No TVK specified for this taxon").appendTo(a);if(e)if(g.d.nbnMapCache[e]){var i=g.d.nbnMapCache[e];o.attr("src",g.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),n.hide()}else{var r="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+e+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100";i=u("<img>").attr("id","tombioNbnMapImage").on("load",function(){o.attr("src",g.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),n.hide()}).on("error",function(){o.removeClass("tombioSpiningNbn"),n.text("An error was encountered attemping to retrieve an NBN distribution map for the TVK "+e),i.hide()}).attr("src",r);g.d.nbnMapCache[e]=i}u("<div>").append(i).appendTo(a)},g.f.addTaxonHtmlToContainer=function(e,i,t){var a=g.f.getTaxonHtmlFiles(e);t<=a.length-1?u.get(a[t].URI,function(e){var t=e.indexOf("<body"),a=e.indexOf("</body"),o=e.slice(t,a),n=u("<div>").html(o);i.html(n.html())}):i.html(null)},g.f.getTaxonHtmlFiles=function(t){return g.d.media.filter(function(e){if(e.Taxon==t&&"html-local"==e.Type)return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},g.f.getCharacterScoreDetails=function(e,t){var a;return a="<p>Specified state(s) for character <b>"+t.Label+"</b>: </p>",a+="<ul>","numeric"!=t.ValueType?g.d.oCharacters[t.Character].userInput.forEach(function(e){a+="<li><b>",a+=g.d.oCharacters[t.Character].CharacterStateValues[e],a+="</b></li>"}):(a+="<li><b>",a+=g.d.oCharacters[t.Character].userInput,a+="</b></li>"),a+="</ul>",a+="<p>Valid state(s) for <b>"+t.Label+"</b> recorded against ",a+="<b><i>"+e.Taxon+"</i></b> in the knowledge base: ",a+="<ul>",a+=e[t.Character].toHtml2(),a+="</ul>",a+="<hr/>",a+="<p>Knowledge-base <b>weighting</b> for this character: <b>"+t.Weight+"</b></p>",a+="<p>Knowledge-base <b>latitude</b> for this character: <b>"+t.Latitude+"</b></p>",a+="<hr/>",a+="<p>Unweighted character score: <b>"+Math.round(100*e[t.Character].score.overall)/100+"</b>; ",a+="(for, "+Math.round(100*e[t.Character].score.for)/100,a+="; against, "+Math.round(100*(e[t.Character].score.against+e[t.Character].score.na))/100+")</p>",a+="<p>Weighted character score: <b>"+Math.round(e[t.Character].score.overall*t.Weight*10)/100+"</b></p>"},g.f.sortTaxa=function(e,a){return a||(a="all"),e.sort(function(e,t){if("matched"==a){if(e.visState.score.charFor>t.visState.score.charFor)return-1;if(t.visState.score.charFor>e.visState.score.charFor)return 1}return e.visState.score.overall>t.visState.score.overall?-1:t.visState.score.overall>e.visState.score.overall?1:t.visState.score.overall==e.visState.score.overall?e.visState.score.for>t.visState.score.for?1:t.visState.score.for>e.visState.score.for?-1:e.kbPosition>t.kbPosition?1:-1:void 0})},g.f.getTaxonTipImage=function(a,e){var t=g.d.media.filter(function(e){if(e.Taxon==a&&("image-local"==e.Type||"image-web"==e.Type)){if(e.UseFor){var t=!1;return e.UseFor.split(",").forEach(function(e){"tip"==e.toLowerCase().trim()&&(t=!0)}),t}return!0}}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)});if(0<t.length){var o=u("<div/>"),n=t[0],i=u("<img/>",{src:n.URI}).appendTo(o).css("margin-top",2);u("<figcaption/>",{html:n.Caption}).appendTo(o);return n.ImageWidth&&i.css("width",n.ImageWidth),o}return null},g.f.taxonTag=function(e){return e.replace(/[\/|&;$%@"<>()+:.,' ]/g,"")},g.f.copyTextToClipboard=function(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();try{var a=document.execCommand("copy")?"successful":"unsuccessful";console.log("Copying text "+a)}catch(e){console.log("Oops, unable to copy text")}document.body.removeChild(t)},g.f.createViewURL=function(e){var t=window.location.href.split("tbv=")[0],a=-1==t.indexOf("?")?"?":"&",o=encodeURI(t+a+"tbv=&"+e.join("&"));g.f.copyTextToClipboard(o)},g.f.selectElementText=function(e,t){var a,o,n=(t=t||window).document;t.getSelection&&n.createRange?(a=t.getSelection(),(o=n.createRange()).selectNodeContents(e),a.removeAllRanges(),a.addRange(o)):n.body.createTextRange&&((o=n.body.createTextRange()).moveToElementText(e),o.select())},g.f.checkInterface=function(i,e,t){g.opts.devel&&function e(t,a,o){for(var n in a)a.hasOwnProperty(n)&&(o[n]?"object"==typeof a[n]&&e(t+"."+n,a[n],o[n]):console.log("%cInterface warning: "+i+t+"."+n+" not found in "+i,"color: red"))}("",e,t)},g.f.stateValueHelpPresent=function(e){for(var t=0;t<g.d.values.length;t++){var a=g.d.values[t];if(a.Character==e&&a.StateHelp)return!0}return!1},g.f.getFullCharacterHelp=function(i){var r=u("<div>");return u("<p>").html(g.d.oCharacters[i].Help).appendTo(r),g.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==i&&!e.State){if(e.UseFor){var t=!1;return e.UseFor.split(",").forEach(function(e){"full"==e.toLowerCase().trim()&&(t=!0)}),t}return!0}}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)}).forEach(function(e,t){var a=u("<figure/>").appendTo(r);a.addClass("helpFigure");var o=u("<img/>",{src:e.URI}),n=u("<figcaption/>",{html:e.Caption});a.append(o).append(n),0<t&&o.css("margin-top",10),n.appendTo(r),e.ImageWidth&&o.css("width",e.ImageWidth)}),g.d.values.filter(function(e){if(e.Character==i&&e.StateHelp)return!0}).forEach(function(t){if(t.CharacterStateTranslation&&""!=t.CharacterStateTranslation)var e=t.CharacterStateTranslation;else e=t.CharacterState;var a=u("<p/>").appendTo(r),o=u("<span/>",{text:e+": "}).css("font-weight","Bold");a.append(o);var n=u("<span/>",{html:t.StateHelp}).css("font-weight","Normal");a.append(n),g.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==i&&e.State==t.CharacterState)return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)}).forEach(function(e,t){var a=u("<div>").appendTo(r);a.css("background-color","rgb(220,220,220)"),a.css("border-radius","5px"),a.css("padding","5px"),a.css("margin-bottom","10px");var o=u("<img/>",{src:e.URI}),n=u("<figcaption/>",{html:e.Caption});o.appendTo(a),n.appendTo(a),e.ImageWidth&&o.css("width",e.ImageWidth)})}),r.html()}}(jQuery,this.tombiovis);