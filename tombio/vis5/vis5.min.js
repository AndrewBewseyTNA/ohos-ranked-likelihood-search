(function(n,t){"use strict";function yt(){var n=[];n.push("selectedTool="+v);Array.prototype.push.apply(n,t.f.setParamsFromControls());n.push("abbrvnames="+i.abbrvnames);n.push("rank="+i.selectedRank);s==l&&n.push("highertaxa=false");n.push("imgtips="+i.displayToolTips);t.f.createViewURL(n)}function pt(n){var r=d3.max(t.d.taxa,function(n){return n.visState.score.overall});b.transition(n).filter(function(n){return n.data.data.taxon}).style("stroke",function(n){return r>0&&n.data.data.taxon.visState.score.overall==r?"black":i.selectedRank=="Taxon"?"black":null}).style("stroke-width",function(n){return r>0&&n.data.data.taxon.visState.score.overall==r?"2px":i.selectedRank=="Taxon"?"1px":"0px"}).style("stroke-linecap",function(n){return r>0&&n.data.data.taxon.visState.score.overall==r?"round":null}).style("stroke-dasharray",function(n){return r>0&&n.data.data.taxon.visState.score.overall==r?"1, 5":null})}function st(n){o=n;d3.transition().duration(750).tween("zoom",function(){var n=d3.interpolateZoom(f,[o.x,o.y,o.r*2+c]);return function(t){k(n(t),[o.x,o.y,o.r*2+c],null,!0)}})}function k(i,r,u,e){t.opts.toolconfig[v].prototype=="visPjQueryUILargeFormat"&&n(".node-taxa").tooltip("close");var o=h/i[2];f=i;u?a.selectAll("circle,text").transition(u).attr("transform",function(n){return"translate("+(n.x-i[0])*o+","+(n.y-i[1])*o+")"}).attr("r",function(n){return n.r*o}):a.selectAll("circle,text").attr("transform",function(n){return"translate("+(n.x-i[0])*o+","+(n.y-i[1])*o+")"}).attr("r",function(n){return n.r*o});Math.round(i[0]*100)/100==Math.round(r[0]*100)/100&&Math.round(i[1]*100)/100==Math.round(r[1]*100)/100&&Math.round(i[2]*100)/100==Math.round(r[2]*100)/100&&e&&ht(u)}function ht(n){if(n)a.selectAll("text").transition(n).on("end",function(n){ct(d3.select(this),n)});else a.selectAll("text").each(function(n){ct(d3.select(this),n)})}function wt(){var n,t,i,r,u;nt=!0;d3.event.transform.k>g?n=120:d3.event.transform.k<g&&(n=-120);n?(t=n>0?100/n:Math.abs(n/100),i=0,r=0):(t=1,i=(d3.event.transform.x-et)*(f[2]/h),r=(d3.event.transform.y-ot)*(f[2]/h));u=[f[0]-i,f[1]-r,f[2]*t];ft=t==1;g=d3.event.transform.k;et=d3.event.transform.x;ot=d3.event.transform.y;vt||k(u,u,null,!1)}function bt(){nt&&(ft||ht(null));nt=!1}function tt(n,t){var r=n.split(/\s+/).reverse(),f,i,u;if(r.length>1){if(t==1)return f=r.pop(),f.substring(0,1)+". "+r.reverse().join(" ");if(t==2){for(f=r.pop(),i=f.substr(0,1)+".";u=r.pop();)i+=" "+u.substr(0,3),u.length>3&&(i+=".");return i}for(i="";u=r.pop();)i+=u.substr(0,1);return i}return t==1?n.length>5?n.substr(0,5)+".":n:t==2?n.length>3?n.substr(0,3)+".":n:n.substr(0,1)+"."}function p(n){console.log("displayTextForRank",n);i.selectedRank=n;d3.selectAll(".label").style("display","none");d3.selectAll("text."+n).style("display","inline");d3.selectAll("circle").style("stroke-width","0px");d3.selectAll("circle."+n).style("stroke","black").style("stroke-width","1px")}function ct(n,t){var e,u,f,r;if(n.style("display")!="none"){if(e=d3.select("#"+n.attr("circleId")),u=e.node().getBBox().width,!i.abbrvnames){lt(n,u,t.data.data.abbrv[0]);return}if(u<20&&i.abbrvnames){n.text(null);return}f=[80,55,30];r=-1;f.forEach(function(n,t){r==-1&&u>n&&(r=t)});r==-1&&(r=f.length);lt(n,u,t.data.data.abbrv[r])}}function lt(n,t,i){for(var s=i.split(/\s+/).reverse(),f,r=[],e=1,o=n.attr("y"),u=n.text(null).append("tspan").attr("class","tspan").attr("x",0).attr("y",o);f=s.pop();)r.push(f),u.text(r.join(" ")),u.node().getComputedTextLength()>t&&(r.pop(),r.length>0?u.text(r.join(" ")):(u.remove(),e--),r=[f],u=n.append("tspan").attr("class","tspan").attr("x",0).attr("y",o).text(f),++e>1&&u.attr("dy","1em"));n.attr("dy",(1.5-e)/2+"em")}var v="vis5",r=t.v.visualisations[v]=Object.create(t.v.visP);r.visName=v;var i,u,o,w,it,d,rt,b,at,f,h,c,e,y,l,s,a,ut,ft,g=1,et=0,ot=0,nt,vt=/Mobi/.test(navigator.userAgent);r.initialise=function(){function b(n,t){for(var i=0;i<n.length;i++)if(n[i].name==t)return!0;return!1}var o,k,p,f;i=this;this.metadata.title="Circle-pack key";this.metadata.authors="Rich Burkmar";this.metadata.year="2016";this.metadata.publisher="Field Studies Council";this.metadata.location="Preston Montford, Shropshire";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="1.0";this.abbrvnames=!0;this.displayToolTips=!1;this.helpFiles=[t.opts.tombiopath+"vis5/vis5Help.html",t.opts.tombiopath+"common/taxonDetailsHelp.html",t.opts.tombiopath+"common/full-details.html",t.opts.tombiopath+"common/stateInputHelp.html"];w=d3.select("#"+this.visName).append("svg").attr("id","vis5Svg").attr("width","500").attr("height","500").attr("overflow","visible").call(d3.zoom().on("zoom",wt).on("end",n.proxy(bt,i)));w.on("click",function(){st(u)});c=20;h=+w.attr("width");a=w.append("g").attr("transform","translate("+h/2+","+h/2+")");ut=d3.scaleLinear().domain([-1,5]).range(["hsl(152,0%,80%)","hsl(228,0%,40%)"]).interpolate(d3.interpolateHcl);it=d3.pack().size([h-c,h-c]).padding(2);e=[];t.d.characters.forEach(function(n){(n.Group=="Taxonomy"||n.Character=="Taxon")&&e.push(n.Character)});console.log("taxonRanks",e);o=[{name:"All taxa",parent:""}];k=0;e.forEach(function(n,i){t.d.taxa.forEach(function(r){var u=r[n].kbValue,f,s;if(u!=""&&!b(o,u)){for(f="",s=i-1;s>-1;s-=1)if(f=r[e[s]].kbValue,f!="")break;f==""&&(f="All taxa");o.push({name:u,parent:f,rankColumn:n,rank:t.d.oCharacters[n].Label,abbrv:[u,tt(u,1,n=="Taxon"),tt(u,2,n=="Taxon"),tt(u,3,n=="Taxon")],taxon:n=="Taxon"?r:null})}})});y=d3.stratify().id(function(n){return n.name}).parentId(function(n){return n.parent})(o);l=d3.stratify().id(function(n){return n.name}).parentId(function(n){return n.parent==""?"":"All taxa"})(o);p=l.children.filter(function(n){return n.data.rankColumn=="Taxon"});l.children=p;s=y;f=t.opts.toolconfig[this.visName].keyinput;t.gui.sharedKeyInput[f]||(t.gui.sharedKeyInput[f]=Object.create(t.gui[f]),t.gui.sharedKeyInput[f].init(n(t.gui.main.divInput)));r.inputControl=t.gui.sharedKeyInput[f];this.initialised=!0;t.f.checkInterface(v,t.templates.visTemplate,t.v.visualisations[v])};r.refresh=function(){function et(n){var r,u;return r=n.data.data.taxon?"<i>"+n.data.id+"<\/i> <span style='background-color: "+w(n.data.data.taxon.visState.score.overall)+"; padding: 2px 5px 2px 5px; margin-left: 5px'>"+Math.round(n.data.data.taxon.visState.score.overall*100)/100+"<\/span>":"<i>"+n.data.id+"<\/i>",i.displayToolTips&&(u=t.f.getTaxonTipImage(n.data.id),u&&(u.css("margin-top",5),r=r+u[0].outerHTML)),r}var nt,h,w,tt,g,r,v,ft;i=this;nt=d3.max(t.d.taxa,function(n){return n.visState.score.overall});h=d3.min(t.d.taxa,function(n){return n.visState.score.overall});t.gui.main.contextMenu.addItem("Get URL for circle-pack key",function(){yt()},!1,[i.visName]);t.gui.main.contextMenu.addItem("Toggle name abbreviation",function(){i.abbrvnames=!i.abbrvnames;i.refresh()},!1,[i.visName]);e.length>1&&s==y?(t.gui.main.contextMenu.addItem("Ignore higher taxa",function(){s=l;p("Taxon");i.refresh()},!1,[i.visName]),e.forEach(function(n){t.gui.main.contextMenu.addItem("Show names for each "+t.d.oCharacters[n].Label,function(){p(n);i.refresh()},!1,[i.visName])}),t.gui.main.contextMenu.removeItem("Show higher taxa")):e.length>1&&s==l&&(t.gui.main.contextMenu.addItem("Show higher taxa",function(){s=y;p("Taxon");i.refresh()},!1,[i.visName]),e.forEach(function(n){t.gui.main.contextMenu.removeItem("Show names for each "+t.d.oCharacters[n].Label)}),t.gui.main.contextMenu.removeItem("Ignore higher taxa"));this.displayToolTips?(t.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){i.displayToolTips=!1;t.gui.main.contextMenu.removeItem("Remove taxon image tooltips");i.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),t.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(t.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0;t.gui.main.contextMenu.removeItem("Display taxon image tooltips");i.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),t.gui.main.contextMenu.removeItem("Remove taxon image tooltips"));w=d3.scaleLinear().domain([h,0,nt]).range(t.d.scoreColours);tt=h<0?0-h:0;u=d3.hierarchy(s).sum(function(n){return n.data.taxon?Math.pow(n.data.taxon.visState.score.overall+tt+.1,1.5):0}).sort(function(n,t){return t.value-n.value});o=u;g=it(u).descendants();d=a.selectAll("circle").data(g,function(n){return n.data.id});rt=d.enter().append("circle").attr("class",function(n){var t=n.children?"node-taxa node-higher-taxa":"node-taxa";return t+(" "+n.data.data.rankColumn)}).attr("id",function(n){return t.f.taxonTag(n.data.id)}).on("click",function(n){o!==n&&(d3.event.stopPropagation(),st(n))});b=rt.merge(d);b.attr("title",function(n){return n.children?n.data.data.rank?n.data.id+" ("+n.data.data.rank+")":n.data.id:et(n)});s==y&&e.length>1?n(".node-higher-taxa").css("visibility","visible"):n(".node-higher-taxa").css("visibility","hidden");r=d3.transition().duration(750);b.transition(r).style("fill",function(n){return n.children?ut(n.depth):n.data.data.taxon?w(n.data.data.taxon.visState.score.overall):0});v=a.selectAll("text").data(g,function(n){return n.data.id});ft=v.enter().append("text").text(function(n){return n.data.id}).style("background-color","red").attr("taxonName",function(n){return n.data.id}).attr("class",function(n){return"label "+n.data.data.rankColumn}).attr("circleId",function(n){return t.f.taxonTag(n.data.id)}).style("display","none").on("click",function(n){n.data.data.taxon&&(d3.event.stopPropagation(),t.gui.main.showFullDetails(n.data.data.taxon.Taxon,0))});at=ft.merge(v).attr("title",function(n){return n.children?n.data.id:et(n)});v.exit().remove();t.opts.gui=="guiLargeJqueryUi"&&n("circle, text").tooltip({classes:{"ui-tooltip":"taxon-tooltip ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(t,i){setTimeout(function(){n(i.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return n(this).attr("title")}});f?k(f,f,r,!0):(k([u.x,u.y,u.r*2+c],[u.x,u.y,u.r*2+c],r,!0),p("Taxon"));pt(r)};r.urlParams=function(n){n.abbrvnames&&(i.abbrvnames=n.abbrvnames==="true");n.rank&&(i.selectedRank=n.rank,p(i.selectedRank));n.highertaxa&&(s=l);n.imgtips&&(i.displayToolTips=n.imgtips==="true");t.f.initControlsFromParams(n)};r.show=function(){n("#vis5").show();r.inputControl.$div.show();r.inputControl.initFromCharacterState()};r.hide=function(){n("#vis5").hide();r.inputControl.$div.hide()}})(jQuery,this.tombiovis);