(function(n,t){"use strict";function pt(n){var i=d3.max(t.taxa,function(n){return n.scoreoverall});y.transition(n).filter(function(n){return n.data.data.taxon}).style("stroke",function(n){return i>0&&n.data.data.taxon.scoreoverall==i?"black":nt=="Taxon"?"black":null}).style("stroke-width",function(n){return i>0&&n.data.data.taxon.scoreoverall==i?"2px":nt=="Taxon"?"1px":"0px"}).style("stroke-linecap",function(n){return i>0&&n.data.data.taxon.scoreoverall==i?"round":null}).style("stroke-dasharray",function(n){return i>0&&n.data.data.taxon.scoreoverall==i?"1, 5":null})}function ht(n){u=n;d3.transition().duration(750).tween("zoom",function(){var n=d3.interpolateZoom(r,[u.x,u.y,u.r*2+o]);return function(t){w(n(t),[u.x,u.y,u.r*2+o],null,!0)}})}function w(t,i,u,f){n(".node-taxa").tooltip("close");var o=e/t[2];r=t;u?h.selectAll("circle,text").transition(u).attr("transform",function(n){return"translate("+(n.x-t[0])*o+","+(n.y-t[1])*o+")"}).attr("r",function(n){return n.r*o}):h.selectAll("circle,text").attr("transform",function(n){return"translate("+(n.x-t[0])*o+","+(n.y-t[1])*o+")"}).attr("r",function(n){return n.r*o});Math.round(t[0]*100)/100==Math.round(i[0]*100)/100&&Math.round(t[1]*100)/100==Math.round(i[1]*100)/100&&Math.round(t[2]*100)/100==Math.round(i[2]*100)/100&&f&&ct(u)}function ct(n){if(n)h.selectAll("text").transition(n).on("end",function(n){lt(d3.select(this),n)});else h.selectAll("text").each(function(n){lt(d3.select(this),n)})}function wt(){var n,t,i,u,f;g=!0;d3.event.transform.k>d?n=120:d3.event.transform.k<d&&(n=-120);n?(t=n>0?100/n:Math.abs(n/100),i=0,u=0):(t=1,i=(d3.event.transform.x-ot)*(r[2]/e),u=(d3.event.transform.y-st)*(r[2]/e));f=[r[0]-i,r[1]-u,r[2]*t];et=t==1;d=d3.event.transform.k;ot=d3.event.transform.x;st=d3.event.transform.y;yt||w(f,f,null,!1)}function bt(){g&&(et||ct(null));g=!1}function tt(n,t){var r=n.split(/\s+/).reverse(),f,i,u;if(r.length>1){if(t==1)return f=r.pop(),f.substring(0,1)+". "+r.reverse().join(" ");if(t==2){for(f=r.pop(),i=f.substr(0,1)+".";u=r.pop();)i+=" "+u.substr(0,3),u.length>3&&(i+=".");return i}for(i="";u=r.pop();)i+=u.substr(0,1);return i}return t==1?n.length>5?n.substr(0,5)+".":n:t==2?n.length>3?n.substr(0,3)+".":n:n.substr(0,1)+"."}function b(n){nt=n;d3.selectAll(".label").style("display","none");d3.selectAll("text."+n).style("display","inline");d3.selectAll("circle").style("stroke-width","0px");d3.selectAll("circle."+n).style("stroke","black").style("stroke-width","1px")}function lt(n,t){var f,r,u,i;if(n.style("display")!="none"){if(f=d3.select("#"+n.attr("circleId")),r=f.node().getBBox().width,!p){at(n,r,t.data.data.abbrv[0]);return}if(r<20&&p){n.text(null);return}u=[80,55,30];i=-1;u.forEach(function(n,t){i==-1&&r>n&&(i=t)});i==-1&&(i=u.length);at(n,r,t.data.data.abbrv[i])}}function at(n,t,i){for(var s=i.split(/\s+/).reverse(),f,r=[],e=1,o=n.attr("y"),u=n.text(null).append("tspan").attr("class","tspan").attr("x",0).attr("y",o);f=s.pop();)r.push(f),u.text(r.join(" ")),u.node().getComputedTextLength()>t&&(r.pop(),r.length>0?u.text(r.join(" ")):(u.remove(),e--),r=[f],u=n.append("tspan").attr("class","tspan").attr("x",0).attr("y",o).text(f),++e>1&&u.attr("dy","1em"));n.attr("dy",(1.5-e)/2+"em")}var it="vis5",a=t[it]={},i,u,v,rt,k,ut,y,vt,r,e,o,f,c,l,s,p=!0,h,ft,et,d=1,ot=0,st=0,g,nt,yt=/Mobi/.test(navigator.userAgent);a.Obj=function(n,t,i){i.visP.Obj.call(this,it,n,t,i);this.metadata.title="Circle-pack key";this.metadata.authors="Rich Burkmar";this.metadata.year="2016";this.metadata.publisher="Field Studies Council";this.metadata.location="Preston Montford, Shropshire";this.metadata.contact=null;this.metadata.version="0.1.0"};a.Obj.prototype=Object.create(t.visP.Obj.prototype);a.Obj.prototype.initialise=function(){function y(n,t){for(var i=0;i<n.length;i++)if(n[i].name==t)return!0;return!1}var a=this,r,p,u;this.charStateInput=!0;this.displayToolTips=!1;this.helpFiles=[t.tombiopath+"vis5/vis5Help.html",t.tombiopath+"common/taxonDetailsHelp.html",t.tombiopath+"common/stateInputHelp.html"];v=d3.select("#"+this.visName).append("svg").attr("id","vis5Svg").attr("width","500").attr("height","500").attr("overflow","visible").call(d3.zoom().on("zoom",wt).on("end",n.proxy(bt,a)));v.on("click",function(){ht(i)});o=20;e=+v.attr("width");h=v.append("g").attr("transform","translate("+e/2+","+e/2+")");ft=d3.scaleLinear().domain([-1,5]).range(["hsl(152,0%,80%)","hsl(228,0%,40%)"]).interpolate(d3.interpolateHcl);rt=d3.pack().size([e-o,e-o]).padding(2);f=[];t.characters.forEach(function(n){(n.Group=="Taxonomy"||n.Character=="Taxon")&&f.push(n.Character)});r=[{name:"All taxa",parent:""}];p=0;f.forEach(function(n,i){t.taxa.forEach(function(u){var e=u[n].kbValue,o,s;if(e!=""&&!y(r,e)){for(o="",s=i-1;s>-1;s-=1)if(o=u[f[s]].kbValue,o!="")break;o==""&&(o="All taxa");r.push({name:e,parent:o,rankColumn:n,rank:t.oCharacters[n].Label,abbrv:[e,tt(e,1,n=="Taxon"),tt(e,2,n=="Taxon"),tt(e,3,n=="Taxon")],taxon:n=="Taxon"?u:null})}})});c=d3.stratify().id(function(n){return n.name}).parentId(function(n){return n.parent})(r);l=d3.stratify().id(function(n){return n.name}).parentId(function(n){return n.parent==""?"":"All taxa"})(r);u=l.children.filter(function(n){return n.data.rankColumn=="Taxon"});l.children=u;s=c};a.Obj.prototype.refresh=function(){function et(n){var t,i;return t=n.data.data.taxon?"<i>"+n.data.id+"<\/i> <span style='background-color: "+g(n.data.data.taxon.scoreoverall)+"; padding: 2px 5px 2px 5px; margin-left: 5px'>"+Math.round(n.data.data.taxon.scoreoverall*100)/100+"<\/span>":"<i>"+n.data.id+"<\/i>",e.displayToolTips&&(i=e.getTaxonTipImage(n.data.id),i&&(i.css("margin-top",5),t=t+i[0].outerHTML)),t}var e=this,ot=d3.max(t.taxa,function(n){return n.scoreoverall}),d=d3.min(t.taxa,function(n){return n.scoreoverall}),g,tt,nt,a,v,it;e.contextMenu.addItem("Toggle name abbreviation",function(){p=!p;e.refresh()},[e.visName]);f.length>1&&s==c?(e.contextMenu.addItem("Ignore higher taxa",function(){s=l;b("Taxon");e.refresh()},[e.visName]),f.forEach(function(n){e.contextMenu.addItem("Show names for each "+t.oCharacters[n].Label,function(){b(n);e.refresh()},[e.visName])}),e.contextMenu.removeItem("Show higher taxa")):f.length>1&&s==l&&(e.contextMenu.addItem("Show higher taxa",function(){s=c;b("Taxon");e.refresh()},[e.visName]),f.forEach(function(n){e.contextMenu.removeItem("Show names for each "+t.oCharacters[n].Label)}),e.contextMenu.removeItem("Ignore higher taxa"));this.displayToolTips?(this.contextMenu.addItem("Remove taxon image tooltips",function(){e.displayToolTips=!1;e.contextMenu.removeItem("Remove taxon image tooltips");e.refresh()},[this.visName],!0),this.contextMenu.removeItem("Display taxon image tooltips")):(this.contextMenu.addItem("Display taxon image tooltips",function(){e.displayToolTips=!0;e.contextMenu.removeItem("Display taxon image tooltips");e.refresh()},[this.visName],!0),this.contextMenu.removeItem("Remove taxon image tooltips"));g=d3.scaleLinear().domain([d,0,ot]).range(e.scoreColours);tt=d<0?0-d:0;i=d3.hierarchy(s).sum(function(n){return n.data.taxon?Math.pow(n.data.taxon.scoreoverall+tt+.1,1.5):0}).sort(function(n,t){return t.value-n.value});u=i;nt=rt(i).descendants();k=h.selectAll("circle").data(nt,function(n){return n.data.id});ut=k.enter().append("circle").attr("class",function(n){var t=n.children?"node-taxa node-higher-taxa":"node-taxa";return t+(" "+n.data.data.rankColumn)}).attr("id",function(n){return e.taxonTag(n.data.id)}).on("click",function(n){u!==n&&(d3.event.stopPropagation(),ht(n))});y=ut.merge(k);y.attr("title",function(n){return n.children?n.data.data.rank?n.data.id+" ("+n.data.data.rank+")":n.data.id:et(n)});s==c&&f.length>1?n(".node-higher-taxa").css("visibility","visible"):n(".node-higher-taxa").css("visibility","hidden");a=d3.transition().duration(750);y.transition(a).style("fill",function(n){return n.children?ft(n.depth):n.data.data.taxon?g(n.data.data.taxon.scoreoverall):0});v=h.selectAll("text").data(nt,function(n){return n.data.id});it=v.enter().append("text").text(function(n){return n.data.id}).style("background-color","red").attr("taxonName",function(n){return n.data.id}).attr("class",function(n){return"label "+n.data.data.rankColumn}).attr("circleId",function(n){return e.taxonTag(n.data.id)}).style("display","none").on("click",function(n){n.data.data.taxon&&(d3.event.stopPropagation(),e.fullDetails(n.data.data.taxon.Taxon,0))});vt=it.merge(v).attr("title",function(n){return n.children?n.data.id:et(n)});v.exit().remove();n("circle, text").tooltip({classes:{"ui-tooltip":"taxon-tooltip ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(t,i){setTimeout(function(){n(i.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return n(this).attr("title")}});r?w(r,r,a,!0):(w([i.x,i.y,i.r*2+o],[i.x,i.y,i.r*2+o],a,!0),b("Taxon"));pt(a)}})(jQuery,this.tombiovis);