(function(n,t){"use strict";function yt(){var n=[];n.push("selectedTool="+y);Array.prototype.push.apply(n,t.f.setParamsFromControls());n.push("abbrvnames="+i.abbrvnames);n.push("rank="+i.selectedRank);o==c&&n.push("highertaxa=false");n.push("imgtips="+i.displayToolTips);i.createViewURL(n)}function pt(n){var r=d3.max(t.d.taxa,function(n){return n.visState.score.overall});b.transition(n).filter(function(n){return n.data.data.taxon}).style("stroke",function(n){return r>0&&n.data.data.taxon.visState.score.overall==r?"black":i.selectedRank=="Taxon"?"black":null}).style("stroke-width",function(n){return r>0&&n.data.data.taxon.visState.score.overall==r?"2px":i.selectedRank=="Taxon"?"1px":"0px"}).style("stroke-linecap",function(n){return r>0&&n.data.data.taxon.visState.score.overall==r?"round":null}).style("stroke-dasharray",function(n){return r>0&&n.data.data.taxon.visState.score.overall==r?"1, 5":null})}function st(n){e=n;d3.transition().duration(750).tween("zoom",function(){var n=d3.interpolateZoom(u,[e.x,e.y,e.r*2+h]);return function(t){k(n(t),[e.x,e.y,e.r*2+h],null,!0)}})}function k(t,i,r,f){n(".node-taxa").tooltip("close");var e=s/t[2];u=t;r?l.selectAll("circle,text").transition(r).attr("transform",function(n){return"translate("+(n.x-t[0])*e+","+(n.y-t[1])*e+")"}).attr("r",function(n){return n.r*e}):l.selectAll("circle,text").attr("transform",function(n){return"translate("+(n.x-t[0])*e+","+(n.y-t[1])*e+")"}).attr("r",function(n){return n.r*e});Math.round(t[0]*100)/100==Math.round(i[0]*100)/100&&Math.round(t[1]*100)/100==Math.round(i[1]*100)/100&&Math.round(t[2]*100)/100==Math.round(i[2]*100)/100&&f&&ht(r)}function ht(n){if(n)l.selectAll("text").transition(n).on("end",function(n){ct(d3.select(this),n)});else l.selectAll("text").each(function(n){ct(d3.select(this),n)})}function wt(){var n,t,i,r,f;nt=!0;d3.event.transform.k>g?n=120:d3.event.transform.k<g&&(n=-120);n?(t=n>0?100/n:Math.abs(n/100),i=0,r=0):(t=1,i=(d3.event.transform.x-et)*(u[2]/s),r=(d3.event.transform.y-ot)*(u[2]/s));f=[u[0]-i,u[1]-r,u[2]*t];ft=t==1;g=d3.event.transform.k;et=d3.event.transform.x;ot=d3.event.transform.y;vt||k(f,f,null,!1)}function bt(){nt&&(ft||ht(null));nt=!1}function tt(n,t){var r=n.split(/\s+/).reverse(),f,i,u;if(r.length>1){if(t==1)return f=r.pop(),f.substring(0,1)+". "+r.reverse().join(" ");if(t==2){for(f=r.pop(),i=f.substr(0,1)+".";u=r.pop();)i+=" "+u.substr(0,3),u.length>3&&(i+=".");return i}for(i="";u=r.pop();)i+=u.substr(0,1);return i}return t==1?n.length>5?n.substr(0,5)+".":n:t==2?n.length>3?n.substr(0,3)+".":n:n.substr(0,1)+"."}function v(n){console.log("displayTextForRank",n);i.selectedRank=n;d3.selectAll(".label").style("display","none");d3.selectAll("text."+n).style("display","inline");d3.selectAll("circle").style("stroke-width","0px");d3.selectAll("circle."+n).style("stroke","black").style("stroke-width","1px")}function ct(n,t){var e,u,f,r;if(n.style("display")!="none"){if(e=d3.select("#"+n.attr("circleId")),u=e.node().getBBox().width,!i.abbrvnames){lt(n,u,t.data.data.abbrv[0]);return}if(u<20&&i.abbrvnames){n.text(null);return}f=[80,55,30];r=-1;f.forEach(function(n,t){r==-1&&u>n&&(r=t)});r==-1&&(r=f.length);lt(n,u,t.data.data.abbrv[r])}}function lt(n,t,i){for(var s=i.split(/\s+/).reverse(),f,r=[],e=1,o=n.attr("y"),u=n.text(null).append("tspan").attr("class","tspan").attr("x",0).attr("y",o);f=s.pop();)r.push(f),u.text(r.join(" ")),u.node().getComputedTextLength()>t&&(r.pop(),r.length>0?u.text(r.join(" ")):(u.remove(),e--),r=[f],u=n.append("tspan").attr("class","tspan").attr("x",0).attr("y",o).text(f),++e>1&&u.attr("dy","1em"));n.attr("dy",(1.5-e)/2+"em")}var y="vis5";t.f.setVisOpts(y);var p=t.v.visualisations[y]=Object.create(t.v[t.opts.toolconfig[y].prototype]),i,r,e,w,it,d,rt,b,at,u,s,h,f,a,c,o,l,ut,ft,g=1,et=0,ot=0,nt,vt=/Mobi/.test(navigator.userAgent);p.initialise=function(){function y(n,t){for(var i=0;i<n.length;i++)if(n[i].name==t)return!0;return!1}var e,b,v,u;i=this;this.metadata.title="Circle-pack key";this.metadata.authors="Rich Burkmar";this.metadata.year="2016";this.metadata.publisher="Field Studies Council";this.metadata.location="Preston Montford, Shropshire";this.metadata.contact=null;this.metadata.version="1.0";this.abbrvnames=!0;this.charStateInput=!0;this.displayToolTips=!1;this.helpFiles=[t.opts.tombiopath+"vis5/vis5Help.html",t.opts.tombiopath+"common/taxonDetailsHelp.html",t.opts.tombiopath+"common/full-details.html",t.opts.tombiopath+"common/stateInputHelp.html"];w=d3.select("#"+this.visName).append("svg").attr("id","vis5Svg").attr("width","500").attr("height","500").attr("overflow","visible").call(d3.zoom().on("zoom",wt).on("end",n.proxy(bt,i)));w.on("click",function(){st(r)});h=20;s=+w.attr("width");l=w.append("g").attr("transform","translate("+s/2+","+s/2+")");ut=d3.scaleLinear().domain([-1,5]).range(["hsl(152,0%,80%)","hsl(228,0%,40%)"]).interpolate(d3.interpolateHcl);it=d3.pack().size([s-h,s-h]).padding(2);f=[];t.d.characters.forEach(function(n){(n.Group=="Taxonomy"||n.Character=="Taxon")&&f.push(n.Character)});console.log("taxonRanks",f);e=[{name:"All taxa",parent:""}];b=0;f.forEach(function(n,i){t.d.taxa.forEach(function(r){var u=r[n].kbValue,o,s;if(u!=""&&!y(e,u)){for(o="",s=i-1;s>-1;s-=1)if(o=r[f[s]].kbValue,o!="")break;o==""&&(o="All taxa");e.push({name:u,parent:o,rankColumn:n,rank:t.d.oCharacters[n].Label,abbrv:[u,tt(u,1,n=="Taxon"),tt(u,2,n=="Taxon"),tt(u,3,n=="Taxon")],taxon:n=="Taxon"?r:null})}})});a=d3.stratify().id(function(n){return n.name}).parentId(function(n){return n.parent})(e);c=d3.stratify().id(function(n){return n.name}).parentId(function(n){return n.parent==""?"":"All taxa"})(e);v=c.children.filter(function(n){return n.data.rankColumn=="Taxon"});c.children=v;o=a;u=t.opts.toolconfig[this.visName].keyinput;t.gui.sharedKeyInput[u]||(t.gui.sharedKeyInput[u]=Object.create(t.gui[u]),t.gui.sharedKeyInput[u].init(n(t.gui.main.visControls)));p.inputControl=t.gui.sharedKeyInput[u]};p.refresh=function(){function et(n){var t,r;return t=n.data.data.taxon?"<i>"+n.data.id+"<\/i> <span style='background-color: "+w(n.data.data.taxon.visState.score.overall)+"; padding: 2px 5px 2px 5px; margin-left: 5px'>"+Math.round(n.data.data.taxon.visState.score.overall*100)/100+"<\/span>":"<i>"+n.data.id+"<\/i>",i.displayToolTips&&(r=i.getTaxonTipImage(n.data.id),r&&(r.css("margin-top",5),t=t+r[0].outerHTML)),t}var nt,y,w,tt,g,s,p,ft;i=this;nt=d3.max(t.d.taxa,function(n){return n.visState.score.overall});y=d3.min(t.d.taxa,function(n){return n.visState.score.overall});i.contextMenu.addItem("Get URL for circle-pack key",function(){yt()},[i.visName]);i.contextMenu.addItem("Toggle name abbreviation",function(){i.abbrvnames=!i.abbrvnames;i.refresh()},[i.visName]);f.length>1&&o==a?(i.contextMenu.addItem("Ignore higher taxa",function(){o=c;v("Taxon");i.refresh()},[i.visName]),f.forEach(function(n){i.contextMenu.addItem("Show names for each "+t.d.oCharacters[n].Label,function(){v(n);i.refresh()},[i.visName])}),i.contextMenu.removeItem("Show higher taxa")):f.length>1&&o==c&&(i.contextMenu.addItem("Show higher taxa",function(){o=a;v("Taxon");i.refresh()},[i.visName]),f.forEach(function(n){i.contextMenu.removeItem("Show names for each "+t.d.oCharacters[n].Label)}),i.contextMenu.removeItem("Ignore higher taxa"));this.displayToolTips?(this.contextMenu.addItem("Remove taxon image tooltips",function(){i.displayToolTips=!1;i.contextMenu.removeItem("Remove taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Display taxon image tooltips")):(this.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0;i.contextMenu.removeItem("Display taxon image tooltips");i.refresh()},[this.visName],!0),this.contextMenu.removeItem("Remove taxon image tooltips"));w=d3.scaleLinear().domain([y,0,nt]).range(i.scoreColours);tt=y<0?0-y:0;r=d3.hierarchy(o).sum(function(n){return n.data.taxon?Math.pow(n.data.taxon.visState.score.overall+tt+.1,1.5):0}).sort(function(n,t){return t.value-n.value});e=r;g=it(r).descendants();d=l.selectAll("circle").data(g,function(n){return n.data.id});rt=d.enter().append("circle").attr("class",function(n){var t=n.children?"node-taxa node-higher-taxa":"node-taxa";return t+(" "+n.data.data.rankColumn)}).attr("id",function(n){return i.taxonTag(n.data.id)}).on("click",function(n){e!==n&&(d3.event.stopPropagation(),st(n))});b=rt.merge(d);b.attr("title",function(n){return n.children?n.data.data.rank?n.data.id+" ("+n.data.data.rank+")":n.data.id:et(n)});o==a&&f.length>1?n(".node-higher-taxa").css("visibility","visible"):n(".node-higher-taxa").css("visibility","hidden");s=d3.transition().duration(750);b.transition(s).style("fill",function(n){return n.children?ut(n.depth):n.data.data.taxon?w(n.data.data.taxon.visState.score.overall):0});p=l.selectAll("text").data(g,function(n){return n.data.id});ft=p.enter().append("text").text(function(n){return n.data.id}).style("background-color","red").attr("taxonName",function(n){return n.data.id}).attr("class",function(n){return"label "+n.data.data.rankColumn}).attr("circleId",function(n){return i.taxonTag(n.data.id)}).style("display","none").on("click",function(n){n.data.data.taxon&&(d3.event.stopPropagation(),i.showFullDetails(n.data.data.taxon.Taxon,0))});at=ft.merge(p).attr("title",function(n){return n.children?n.data.id:et(n)});p.exit().remove();n("circle, text").tooltip({classes:{"ui-tooltip":"taxon-tooltip ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(t,i){setTimeout(function(){n(i.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return n(this).attr("title")}});u?k(u,u,s,!0):(k([r.x,r.y,r.r*2+h],[r.x,r.y,r.r*2+h],s,!0),v("Taxon"));pt(s)};p.urlParams=function(n){n.abbrvnames&&(i.abbrvnames=n.abbrvnames==="true");n.rank&&(i.selectedRank=n.rank,v(i.selectedRank));n.highertaxa&&(o=c);n.imgtips&&(i.displayToolTips=n.imgtips==="true");t.f.initControlsFromParams(n)}})(jQuery,this.tombiovis);