(function(n,t){"use strict";function y(){t.taxa.forEach(function(n){t.characters.forEach(function(t){n[t.Character].valueType=t.ValueType;n[t.Character].status=t.Status;n[t.Character].character=t.Character;var r=n[t.Character].value.split("|"),i;r.forEach(function(n){var f,u,r;n=n.trim();s(n,"(m)")||s(n,"(f)")?(f=n.substr(0,n.length-4).trim(),u=n.substr(n.length-4,4)):(f=n,u="");r=tt(t.Character,f);u!=""&&(r=r+" "+u);i=i?i+" | "+r:r;i.length>0&&i.substr(0,1)=="#"&&(i="")});n[t.Character].kbValue=i})})}function p(){t.values.forEach(function(n){var i=t.oCharacters[n.Character],r;i&&(r=n.CharacterStateTranslation&&n.CharacterStateTranslation!=""?n.CharacterStateTranslation:n.CharacterState,i.CharacterStates.push({CharacterState:r,StateHelp:n.StateHelp}),i.CharacterStateValues.push(r))});t.characters.forEach(function(n){n.Status=="key"&&n.ValueType=="text"&&t.taxa.forEach(function(t){var i=t[n.Character].getStates("");i.forEach(function(t){t!=""&&n.CharacterStateValues.indexOf(t)==-1&&(n.CharacterStates.push({CharacterState:t,StateHelp:""}),n.CharacterStateValues.push(t))})})})}function w(){t.taxa.forEach(function(n){n.matchscore={};t.characters.forEach(function(t){t.Status=="key"&&(n.matchscore[t.Character]={label:t.Label,scorena:0,scorefor:0,scoreagainst:0,scoreoverall:0})})})}function b(){var s={All:[]},l,u,f,k,w,y,c,p,lt,at,ft;t.characters.forEach(function(n){n.Status=="key"&&(s[n.Group]||(s[n.Group]=[],i.inputCharGroups.push(n.Group)),s[n.Group].push(n))});for(l in s){var b="tombioControlTab-"+l.replace(/\s+/g,"-"),et=n("<li/>"),vt=n("<a/>").text(l).attr("href","#"+b);if(et.append(vt),n("#tombioControlsListElements").append(et),u=n("<div/>").attr("id",b),n("#tombioControlTabs").append(u),b=="tombioControlTab-All"){u.append(n("<div>").text("Un-used characters:"));f=n("<fieldset>").css("display","inline-block").css("padding","0px").css("border","none");f.append(n("<label>").attr("for","charvisible").text("show"));f.append(n("<input>").attr("type","radio").attr("name","charvisibility").attr("id","charvisible").attr("value","visible").attr("checked","checked"));f.append(n("<label>").attr("for","incharvisible").text("hide"));f.append(n("<input>").attr("type","radio").attr("name","charvisibility").attr("id","incharvisible").attr("value","invisible"));u.append(f);n("[name='charvisibility']").checkboxradio({icon:!1});f.on("change",o);k=n("<button>").attr("id","tombioReset").text("Reset all");k.button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(){n(".statespinner").spinner("value","");n(".stateselect").each(function(){n(this).val()&&n(this).val("").pqSelect("refreshData")});t.characters.forEach(function(n){n.stateSet=!1});e();o()});u.append(k)}for(w=0;w<s[l].length;w++){var r=s[l][w],d=n("<span/>").attr("class","characterlabel").text(r.Label),ot=n("<div/>").append(d);if(u.append(ot),it(r.Character)&&(d.attr("character",r.Character),d.addClass("characterhelp")),y=n("<div/>").attr("class","cloneInput"),y.append(ot.clone()),n("#tombioControlTab-All").append(y),r.ValueType=="numeric"){var h=r.Character,g=r.Params.split(","),st=Number(g[0]),ht=Number(g[1]),ct=Number(g[2]),nt=n("<div><\/div>"),yt=n("<input><\/input>").attr("class","spinner").attr("id",h),pt=n("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id",h+"-clear");nt.append(yt);nt.append(pt);u.append(nt);v(h,st,ht,ct);var tt=n("<div><\/div>"),wt=n("<input><\/input>").attr("class","spinner").attr("id","clone-"+h),bt=n("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id","clone-"+h+"-clear");tt.append(wt);tt.append(bt);y.append(tt);v("clone-"+h,st,ht,ct)}else c=r.Character,p=r.ControlType=="multi"?n("<select multiple=multiple><\/select>").attr("class","characterSelect"):n("<select><\/select>").attr("class","characterSelect"),p.attr("id",c),u.append(p),r.ControlType=="single"&&(lt=n("<option/>").text(""),p.append(lt)),at=r.CharacterStateValues,at.forEach(function(t){var r=n("<option/>").text(i.bullet+t);p.append(r)}),a(c),ft=n("#"+c).clone(),ft.attr("id","clone-"+c),y.append(ft),a("clone-"+c)}}i.charactersGrouped||(n("#tombioControlsListElements").css("display","none"),n("#tombioControlTabs").css("padding-left","0px"));n(".characterhelp").hover(function(){n(this).animate({color:"#D55E00"},"fast")},function(){n(this).animate({color:"black"},"fast")}).tooltip({track:!0,items:"span",content:function(){return rt(n(this).attr("character"))}}).click(function(){ut(n(this).attr("character"))})}function k(){var r,u,e,o,h,s;ft();i.visualisations={};r=[];r.push(n('<option value="reload" class="html" data-class="reload">Reload<\/option>'));t.includedTools.forEach(function(i){var u=n('<option class="needsclick">').attr("value",i).attr("data-class","vis").addClass("visualisation").text(t.jsFiles[i].toolName);r.push(u)});r.push(n('<option id="optCurrentVisInfo" value="currentVisInfo" class="html" data-class="info"><\/option>'));r.push(n('<option value="kbInfo" class="html" data-class="info">About the Knowledge-base<\/option>'));r.push(n('<option value="visInfo" class="html" data-class="info">About Tom.bio ID Visualisations<\/option>'));r.push(n('<option value="tombioCitation" class="html" data-class="info">Get citation text<\/option>'));e=ot("selectedTool");e?u=e:t.opts.selectedTool?u=t.opts.selectedTool:t.kbconfig.selectedTool&&(u=t.kbconfig.selectedTool);o=!1;r.forEach(function(n){n.attr("value")==u&&(n.attr("selected","selected"),o=!0)});o||r[1].attr("selected","selected");n("#tombioVisualisation").append(r);n.widget("custom.iconselectmenu",n.ui.selectmenu,{_renderItem:function(t,i){var r=n("<li>"),u=n("<div>",{text:i.label});return i.disabled&&r.addClass("ui-state-disabled"),n("<span>",{style:i.element.attr("data-style"),"class":"ui-icon "+i.element.attr("data-class")}).appendTo(u),r.append(u).appendTo(t)}});n("#tombioVisualisation").iconselectmenu({change:function(){l()}}).iconselectmenu("menuWidget").addClass("ui-menu-icons customicons");t.opts.hideVisDropdown==!0&&n("#tombioVisualisation-button").hide();h=n("#tombioControlTabs").tabs({activate:function(){n(".stateselect").each(function(){});f()}});t.kbconfig.defaultControlGroup&&t.kbconfig.defaultControlGroup!=""&&(s=i.inputCharGroups.indexOf(t.kbconfig.defaultControlGroup),s>-1&&h.tabs("option","active",s+1));n("#tombioInfotoggle").button({icons:{primary:null,secondary:"ui-icon-info20"}}).click(function(){n("#tombioInfoDialog").dialog("open")});n("#tombioHelpAndInfoDialog").dialog({modal:!1,width:i.helpAndInfoDialogWidth,height:i.helpAndInfoDialogHeight,resizable:!0,draggable:!0,autoOpen:!1,show:{effect:"highlight",duration:500},hide:{effect:"fade",duration:250}});n("#tombioVisInfoDialog").dialog({modal:!1,width:i.visInfoDialogWidth,height:i.visInfoDialogHeight,resizable:!0,draggable:!0,autoOpen:!1,show:{effect:"highlight",duration:500},hide:{effect:"fade",duration:250}});n("#tombioOptions").button({icons:{primary:null,secondary:"ui-icon-options"},disabled:!1}).click(function(){});i.visWithInput=[];for(name in i.visualisations)i.visualisations[name].charStateInput&&i.visWithInput.push(name);i.contextMenu.addItem("Toggle key input visibility",function(){c()},i.visWithInput)}function d(i){var u=!0,r="";i.forEach(function(n){n?r+=n:u=!1});u&&(r=r.replace(/##tombiopath##/g,t.tombiopath).replace(/##tombiokbpath##/g,t.tombiokbpath),n("#currentVisInfo").html(r))}function g(){var r=n("<div>"),f,e;r.append(n("<h3>").text("Citation for general framework (core software)"));f="This is the reference you can use for the main Tom.bio Framework - in other words the core software.";f+=" The core version number is updated whenever there is a new major release of the core software.";r.append(n("<p>").html(f));r.append(n("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationCore' id='tbCitationCore'>"));r.append(n("<span>").text("Copy citation"));r.append(n("<b>").html(u(t.metadata,"Software")));r.append(n("<h3>").text("Citation for last selected visualisation tool"));f="This is the reference you can use for the last selected visualisation tool.";f+=" The tool version number is updated whenever there is a new release of the tool.";f+=" If you cite a tool, there's no need to cite the core software separately since it is implicit.";r.append(n("<p>").html(f));r.append(n("<input style='position: relative; top: 0.2em' type='checkbox' name='tbCitationVis' id='tbCitationVis'>"));r.append(n("<span>").text("Copy citation"));r.append(n("<b>").html(u(i.lastVisualisation.metadata,"Software",t.metadata.title)));r.append(n("<h3>").text("Citation for knowledge-base"));f="This is the reference you can use for the knowledge-base currently driving the software.";f+=" The knowledge-base version number is updated whenever there is a new release of the knowledge-base.";r.append(n("<p>").html(f));r.append(n("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationKb' id='tbCitationKb'>"));r.append(n("<span>").text("Copy citation"));r.append(n("<b>").html(u(t.kbmetadata,"Knowledge-base",t.metadata.title)));e=n("<button>Copy citations<\/button>").button();e.on("click",function(){n("#tbSelectedCitations").html("");document.getElementById("tbCitationCore").checked&&n("#tbSelectedCitations").append(u(t.metadata,"Software"));document.getElementById("tbCitationVis").checked&&n("#tbSelectedCitations").append(u(i.lastVisualisation.metadata,"Software",t.metadata.title));document.getElementById("tbCitationKb").checked&&n("#tbSelectedCitations").append(u(t.kbmetadata,"Knowledge-base",t.metadata.title));nt(document.getElementById("tbSelectedCitations"));n("#tbCitationInstructions").show()});return r.append(n("<p>").append(e).append("&nbsp;The selected citations will appear together below - just copy and paste")),r.append(n("<div id='tbSelectedCitations'>")),r.append(n("<p id='tbCitationInstructions' style='display: none'>").text("You can now copy and paste the selected citation text.")),r}function nt(n,t){t=t||window;var r=t.document,u,i;t.getSelection&&r.createRange?(u=t.getSelection(),i=r.createRange(),i.selectNodeContents(n),u.removeAllRanges(),u.addRange(i)):r.body.createTextRange&&(i=r.body.createTextRange(),i.moveToElementText(n),i.select())}function u(t,i,r){var f=n("<div class='tombioCitation'>"),u,e=new Date;return u=t.authors+" ",u+="("+t.year+") ",u+="<i>"+t.title+"<\/i>",u+=" (Version "+t.version+") ["+i+"]",r&&(u+=" (for "+r+")"),u+=". ",t.publisher&&(u+=t.publisher+". "),t.location&&(u+=t.location+". "),u+="Accessed "+e.toDateString()+". ",u+=window.location.href.split("?")[0],f.append(n("<p>").html(u)),f}function l(){var r=n("#tombioVisualisation").val();if(console.log(r),r=="reload"){n.ajax({url:window.location.href,headers:{Pragma:"no-cache",Expires:-1,"Cache-Control":"no-cache"}}).done(function(){window.location.reload(!0)});return}if(r=="tombioCitation"||r=="kbInfo"||r=="currentVisInfo"||r=="visInfo"){t.opts.lastVisualisation&&!i.lastVisualisation?(t.showDownloadSpinner(),t.jsFiles[t.opts.lastVisualisation].loadReady(),t.loadScripts(function(){var u=new t[t.opts.lastVisualisation].Obj("#tombioTaxa",i.contextMenu,t);i.lastVisualisation=u;n("#optCurrentVisInfo").text("Using the "+u.metadata.title);n("#tombioVisualisation").iconselectmenu("refresh");t.hideDownloadSpinner();h(r)})):h(r);return}t.showDownloadSpinner();t.jsFiles[r].loadReady();t.loadScripts(function(){if(t.hideDownloadSpinner(),!i.visualisations[r]){var n=new t[r].Obj("#tombioTaxa",i.contextMenu,t);i.visualisations[r]=n}h(r)})}function h(r){var h=i.visualisations[r],l,o,f,s;if(r=="tombioCitation"&&n("#tombioCitation").html(g()),r=="kbInfo"&&n("#kbInfo").html().length==0&&(l=n("<h2>").text(t.kbmetadata.title),n("#kbInfo").html(l),n.get(t.tombiokbpath+"info.html",function(i){n("#kbInfo").append(i.replace(/##tombiopath##/g,t.tombiopath).replace(/##tombiokbpath##/g,t.tombiokbpath))}).always(function(){var o=n("<h3>").attr("id","tombioKbCitation").text("Citation"),f,e,r,i;n("#kbInfo").append(o);n("#kbInfo").append(u(t.kbmetadata,"Knowledge-base",t.metadata.title));f=n("<h3>").attr("id","tombioKbRevisionHistory").text("Knowledge-base revision history");n("#kbInfo").append(f);e=n("<p>").html("<b>Current version: "+t.kbmetadata.version+"<\/b>");n("#kbInfo").append(e);r=n("<table>");i=n("<tr>").css("background-color","black").css("color","white");i.append(n("<td>").text("Date").css("padding","3px"));i.append(n("<td>").text("Version").css("padding","3px"));i.append(n("<td>").text("Notes").css("padding","3px"));r.append(i);t.kbreleaseHistory.forEach(function(t,u){i=n("<tr>");u%2==0?i.css("background-color","rgb(200,200,200)"):i.css("background-color","rgb(230,230,230)");var f=new Date(t.Date);i.append(n("<td>").css("padding","3px").text(f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()));i.append(n("<td>").css("padding","3px").text(t.Value));i.append(n("<td>").css("padding","3px").text(t.Notes));r.append(i)});n("#kbInfo").append(r)})),r=="visInfo"&&n("#visInfo").html().length==0&&n.get(t.tombiopath+"visInfo.html",function(i){n("#visInfo").html(i.replace(/##tombiopath##/g,t.tombiopath).replace(/##tombiokbpath##/g,t.tombiokbpath))}),r=="currentVisInfo"&&(o=new Array(i.lastVisualisation.helpFiles.length),i.lastVisualisation.helpFiles.forEach(function(t,i){n.get(t,function(n){o[i]=n;d(o)})})),r!=i.currentTool&&(i.currentTool&&n("#"+i.currentTool).hide(),n("#"+r).show()),h&&h.charStateInput?c(!0):c(!1),e(),i.currentTool=r,Object.keys(i.visualisations).indexOf(r)>-1&&(i.lastVisualisation=i.visualisations[r],n("#optCurrentVisInfo").text("Using the "+i.lastVisualisation.metadata.title),n("#tombioVisualisation").iconselectmenu("refresh")),i.contextMenu.contextChanged(r),i.initialising&&i.visualisations[r]){var a={},y=decodeURI(window.location.search.substring(1)),v=y.split("&");for(f=0;f<v.length;f++)s=v[f].split("="),a[s[0]]=s[1];i.visualisations[r].urlParams(a);i.initialising=!1}}function c(t){var r;r=t!=undefined?t:!n("#tombioControls").is(":visible");r?n("#tombioControls").show(0,f):(i.controlsWidth=n("#tombioControls").width(),n("#tombioControls").hide(0,f))}function e(){et();var t=n("#tombioVisualisation").val();t in i.visualisations&&i.visualisations[t].refresh();f()}function o(){var t=n("input[name=charvisibility]:checked").val();n(".cloneInput .stateselect, .cloneInput .statespinner").each(function(){var r=n(this).attr("id"),i;typeof r!="undefined"&&(t=="visible"?n(this).parents(".cloneInput").show(500,f):(i=n(this).val(),i&&i!=""?n(this).parents(".cloneInput").show(500,f):n(this).parents(".cloneInput").hide(500,f)))})}function f(){if(n("#tombioControls").is(":visible")){var t=n("#tombioControls").width();n("#tombioControlsAndTaxa").css("min-width",t+n("#tombioTaxa").width()+50)}else n("#tombioControlsAndTaxa").css("min-width","0px")}function a(i){var r=n("#"+i).pqSelect({multiplePlaceholder:"select option(s)",singlePlaceholder:"select option",checkbox:!0,search:!1,maxDisplay:20,width:240,selectallText:""});r.addClass("stateselect");r.on("change",function(){var u,f;u=i.substring(0,6)=="clone-"?i.substring(6):"clone-"+i;n("#"+u).val(r.val());n("#"+u).pqSelect("refreshData");n("#"+i).pqSelect("refresh");o();f=i.substring(0,6)=="clone-"?i.substring(6):i;t.oCharacters[f].stateSet=r.val()!=null&&r.val()!="";[i,u].forEach(function(i){var r=n("#"+i).next().children().find(".pq-select-item-text");r.attr("title",function(){var r=this,i=t.values.filter(function(t){if(t.Character==f&&t.CharacterState==n(r).text())return!0});return i.length==1?i[0].StateHelpShort?i[0].StateHelpShort:i[0].StateHelp:""});r.tooltip({track:!0})});e()});r.val(n("#"+i+" option:first").val()).pqSelect("refreshData");r.val("").pqSelect("refreshData")}function v(i,r,u,f){var s=n("#"+i).spinner({min:r,max:u,step:f}),h;s.addClass("statespinner");s.on("spinstop",function(){var u,r,f;i.substring(0,6)=="clone-"?(u=!0,r=i.substring(6)):(u=!1,r="clone-"+i);n("#"+r).spinner("value",s.spinner("value"));f=i.substring(0,6)=="clone-"?i.substring(6):i;t.oCharacters[f].stateSet=!0;e();o()});h=n("#"+i+"-clear").button({icon:"ui-icon-close",showLabel:!1});h.on("click",function(){var u,r,f;s.spinner("value","");i.substring(0,6)=="clone-"?(u=!0,r=i.substring(6)):(u=!1,r="clone-"+i);n("#"+r).spinner("value",s.spinner("value"));f=i.substring(0,6)=="clone-"?i.substring(6):i;t.oCharacters[f].stateSet=!1;e()})}function tt(n,i){function r(n,i){var r=t.values.filter(function(t){return t.Character==n&&t.CharacterState.trim()==i?!0:!1}),u;return u=r[0]&&r[0].CharacterStateTranslation&&r[0].CharacterStateTranslation!=""?r[0].CharacterStateTranslation:i,u.replace(/ +(?= )/g,"")}if(/^\[[^-]+-[^-]+\]$/.test(i)){var f=i.substr(1,i.length-2),u=f.split("-");return"["+r(n,u[0])+"-"+r(n,u[1])+"]"}return r(n,i)}function s(n,t){return n.indexOf(t,n.length-t.length)!==-1}function it(n){var u=t.oCharacters[n].Help,i,r;return u.length>0?!0:(i=t.values.filter(function(t){if(t.Character==n&&t.StateHelp)return!0}),i.length>0)?!0:(r=t.media.filter(function(t){if(t.Type=="image-local"&&t.Character==n)return!0}),r.length>0)?!0:!1}function rt(i){var h=n("<div/>"),c=!1,o,r,s,v,k,f,w,e;t.oCharacters[i].HelpShort&&t.oCharacters[i].HelpShort!=""?(o=t.oCharacters[i].HelpShort,c=!0):o=t.oCharacters[i].Help;var b=t.media.filter(function(n){if(n.Type=="image-local"&&n.Character==i)return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)}),u,l=0,a=0;if(b.forEach(function(n){var t=!1,i=!1;n.UseFor?n.UseFor.split(",").forEach(function(r){r.toLowerCase().trim()=="tip"&&(i=n.State?!1:!0);r.toLowerCase().trim()=="full"&&(t=!0)}):(i=n.State?!1:!0,t=!0);i&&!u?u=n:t&&l++;t&&a++}),s=!1,u&&(r=n("<figure/>"),r.addClass("helpFigure"),v=n("<img/>",{src:u.URI}).appendTo(r).css("margin-top",2),u.ImageWidth&&v.css("width",u.ImageWidth),k=n("<figcaption/>",{html:u.Caption}).appendTo(r),u.TipStyle&&u.TipStyle!="")){var y=u.TipStyle.split("-"),p=y[0],d=y[1];r.css("width",d+"%");r.css("float",p);r.css("margin-bottom",5);p=="right"?r.css("margin-left",5):r.css("margin-right",5);s=!0}return f=[],s&&f.push(r),o.length>0&&f.push(n("<span/>").html(o)),!s&&r&&f.push(r),f.forEach(function(n){h.append(n)}),w=t.values.filter(function(n){if(n.Character==i&&n.StateHelp)return!0}),e="",c||l>0||w.length>0?e="(Click for <b>more detailed help<\/b>.)":u&&a>0&&(e="(Click for resizeable help window.)"),e&&n("<div/>").css("margin-top",5).css("font-weight","normal").html(e).appendTo(h),h}function ut(i){var r,u;n("#tombioHelpAndInfoDialog").html("");n("<h3/>",{text:t.oCharacters[i].Label}).appendTo("#tombioHelpAndInfoDialog");n("<p/>",{html:t.oCharacters[i].Help}).appendTo("#tombioHelpAndInfoDialog");r=t.media.filter(function(n){if(n.Type=="image-local"&&n.Character==i&&!n.State){if(n.UseFor){var t=!1;return n.UseFor.split(",").forEach(function(n){n.toLowerCase().trim()=="full"&&(t=!0)}),t}return!0}}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});r.forEach(function(t,i){var f=n("<figure/>").appendTo("#tombioHelpAndInfoDialog"),r,u;f.addClass("helpFigure");r=n("<img/>",{src:t.URI});u=n("<figcaption/>",{html:t.Caption});f.append(r).append(u);i>0&&r.css("margin-top",10);u.appendTo("#tombioHelpAndInfoDialog");t.ImageWidth&&r.css("width",t.ImageWidth)});u=t.values.filter(function(n){if(n.Character==i&&n.StateHelp)return!0});u.forEach(function(r){var f,u,e,o,s;f=r.CharacterStateTranslation&&r.CharacterStateTranslation!=""?r.CharacterStateTranslation:r.CharacterState;u=n("<p/>").appendTo("#tombioHelpAndInfoDialog");e=n("<span/>",{text:f+": "}).css("font-weight","Bold");u.append(e);o=n("<span/>",{html:r.StateHelp}).css("font-weight","Normal");u.append(o);s=t.media.filter(function(n){if(n.Type=="image-local"&&n.Character==i&&n.State==r.CharacterState)return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});s.forEach(function(t,i){var r=n("<img/>",{src:t.URI}),u=n("<figcaption/>",{html:t.Caption});r.appendTo("#tombioHelpAndInfoDialog");i>0&&r.css("margin-top",10);u.appendTo("#tombioHelpAndInfoDialog");t.ImageWidth&&r.css("width",t.ImageWidth)})});n("#tombioHelpAndInfoDialog").dialog("option","title","Character help and information");n("#tombioHelpAndInfoDialog").dialog("open")}function ft(){i.contextMenu={};i.contextMenu.items={};i.contextMenu.contexts={};i.contextMenu.menu=n("<ul>").css("white-space","nowrap").appendTo("#tombioMain").addClass("contextMenu").css("position","absolute").css("display","none").css("z-index",999999);i.contextMenu.menu.menu();n("#tombioMain").on("contextmenu",function(t){i.contextMenu.menu.position({});var r=n(this).parent().offset(),u=t.pageX-r.left,f=t.pageY-r.top;return i.contextMenu.menu.css({left:u,top:f}),i.contextMenu.menu.show(),!1});n("#tombioMain").on("click",function(){i.contextMenu.menu.hide()});i.contextMenu.addItem=function(t,r,u,f){if(f&&t in i.contextMenu.items&&(i.contextMenu.items[t].remove(),delete i.contextMenu.items[t],delete i.contextMenu.contexts[t]),!(t in i.contextMenu.items)){var e=n("<li>").append(n("<div>").text(t).click(r));i.contextMenu.menu.append(e);i.contextMenu.menu.menu("refresh");i.contextMenu.items[t]=e;i.contextMenu.contexts[t]=u}};i.contextMenu.removeItem=function(n){n in i.contextMenu.items&&(i.contextMenu.items[n].remove(),delete i.contextMenu.items[n],delete i.contextMenu.contexts[n])};i.contextMenu.contextChanged=function(n){for(var t in i.contextMenu.items)i.contextMenu.contexts[t].indexOf(n)>-1?i.contextMenu.items[t].show():i.contextMenu.items[t].hide()}}function et(){var i=n("#Sex").val();t.taxa.forEach(function(r){r.scorefor=0;r.scoreagainst=0;r.scoreoverall=0;r.charcount=0;n(".statespinner").each(function(){var i=n(this).attr("id"),u,f,o,e,s;if(i.substring(0,6)!="clone-"){if(n(this).val()=="")o=0,e=0,u=0,f=0;else if(r[i]=="")o=0,e=0,u=0,f=0;else if(r[i]=="n/a")o=1,e=1,u=0,f=0;else{var c=Number(n(this).val()),l=r[i].getRange(),a=Number(t.oCharacters[i].Strictness),v=t.oCharacters[i].maxVal-t.oCharacters[i].minVal,h=tombioScore.numberVsRange(c,l,v,a);u=h[0];f=h[1];o=1;e=0}r.matchscore[i].scorena=e;r.matchscore[i].scorefor=u;r.matchscore[i].scoreagainst=f;r.matchscore[i].scoreoverall=u-f-e;s=Number(t.oCharacters[i].Weight)/10;r.scorefor+=u*s;r.scoreagainst+=f*s;r.scoreagainst+=e*s;r.scoreoverall+=(u-f-e)*s;r.charcount+=o}});n(".stateselect").each(function(){var e=0,o=0,s=0,c=0,u=n(this).attr("id"),v,y,f,a,h,l;if(typeof u!="undefined"&&u.substring(0,6)!="clone-"&&n(this).val()!=null&&n(this).val()!=""){if(t.oCharacters[u].ValueType=="ordinal"||t.oCharacters[u].ValueType=="ordinalCircular"){var p=Number(t.oCharacters[u].Strictness),w=n(this).val(),f=[];r[u]=="n/a"?(s=1,c=1):(t.oCharacters[u].ControlType=="single"?n(this).val()!=""&&f.push(n(this).val()):f=n(this).val()==null?[]:n(this).val(),f.length>0&&(v=t.oCharacters[u].CharacterStateValues,a=r[u].getOrdinalRanges(i),console.log(r.Taxon.toString()),y=t.oCharacters[u].ValueType=="ordinalCircular",h=tombioScore.ordinal2(f,a,v,p,y),e=h[0],o=h[1],c=1))}else f=[],r[u]=="n/a"?(s=1,c=1):(t.oCharacters[u].ControlType=="single"?n(this).val()!=""&&f.push(n(this).val()):f=n(this).val()==null?[]:n(this).val(),f.length>0&&(a=r[u].getStates(i),h=tombioScore.character(f,a),e=h[0],o=h[1],c=1));r.matchscore[u].scorena=s;r.matchscore[u].scorefor=e;r.matchscore[u].scoreagainst=o;r.matchscore[u].scoreoverall=e-o-s;l=Number(t.oCharacters[u].Weight)/10;r.scoreagainst+=s*l;r.scorefor+=e*l;r.scoreagainst+=o*l;r.scoreoverall+=(e-o-s)*l;r.charcount+=c}})})}function ot(n){for(var i,u=window.location.search.substring(1),r=u.split("&"),t=0;t<r.length;t++)if(i=r[t].split("="),i[0]==n)return i[1];return null}var i={xbullet:"&#x26AB ",bullet:"",delay:250,duration:1e3,infowidth:750,infoheight:700,helpAndInfoDialogWidth:550,helpAndInfoDialogHeight:400,visInfoDialogWidth:650,visInfoDialogHeight:350,scriptsLoaded:!1,htmlLoaded:!1,inputCharGroups:[],initialising:!0},r;t.loadComplete=function(e){(n("#tombiod3-header").text(t.kbmetadata.title),n("#tombiod3-footer").html(u(t.kbmetadata,"Knowledge-base",t.metadata.title)),e||t.checkKnowledgeBase())&&(t.oTaxa={},t.taxa.forEach(function(n){t.oTaxa[n.Taxon]=n;for(var i in n)n.hasOwnProperty(i)&&(n[i]=new r(n[i]))}),t.characters.forEach(function(n){n.CharacterStates=[];n.CharacterStateValues=[];n.stateSet=!1;n.minVal=null;n.maxVal=null;n.ValueType=="numeric"&&t.taxa.forEach(function(t){var i=t[n.Character].getRange().min,r=t[n.Character].getRange().max;(!n.minVal||i<n.minVal)&&(n.minVal=i);(!n.maxVal||r>n.maxVal)&&(n.maxVal=r)})}),t.oCharacters={},t.characters.forEach(function(n){t.oCharacters[n.Character]=n}),t.media.forEach(function(n){n.Type=="image-local"&&(n.URI=t.tombiokbpath+n.URI)}),y(),p(),i.charactersGrouped=!1,t.characters.forEach(function(n){n.Status=="key"&&n.Group.toLowerCase()!="none"&&(i.charactersGrouped=!0)}),b(),n("#tombioMain").css("display",""),k(),n("#downloadspin").remove(),w(),f(),l())};r=function(n){this.kbValue=n.trim();this.valueType=null;this.status=null;this.character=null};Object.defineProperty(r.prototype,"value",{get:function(){return this.kbValue.trim()=="?"?"":this.kbValue.trim()}});r.prototype.toString=function(){return this.kbValue=="?"?"":this.kbValue};r.prototype.getStates=function(n){var i,u,r,t;for(n||(n=""),i=[],u=this.kbValue.split("|"),r=0;r<u.length;r++)t=u[r],t=t.trim(),t!="n/a"&&t!="?"&&t!=""&&(n!="male"||s(t,"(f)")?n!="female"||s(t,"(m)")?n==""&&i.push(t.replace("(m)","").replace("(f)","").trim()):i.push(t.replace("(f)","").trim()):i.push(t.replace("(m)","").trim()));return i};r.prototype.getRange=function(){var n={},i,t;return n.hasValue=String(this.kbValue)==""?!1:!0,String(this.kbValue).indexOf("[")==0?(i=this.kbValue.substr(1,this.kbValue.length-2),t=i.split("-"),n.min=Number(t[0]),n.max=Number(t[1]),n.mid=n.min+(n.max-n.min)/2):(n.min=Number(this.kbValue),n.max=Number(this.kbValue),n.mid=Number(this.kbValue)),n};r.prototype.getOrdinalRanges=function(n){var i=this,r=[];return(this.valueType=="ordinal"||this.valueType=="ordinalCircular")&&this.getStates(n).forEach(function(n){var f=[];if(n.indexOf("[")==0){var s=n.substr(1,n.length-2),e=s.split("-"),h=e[0],o=e[1],u=!1;t.oCharacters[i.character].CharacterStateValues.forEach(function(n){n==h&&(u=!0);u&&f.push(n);n==o&&(u=!1)});u&&t.oCharacters[i.character].CharacterStateValues.forEach(function(n){u&&f.push(n);n==o&&(u=!1)})}else f.push(n);r.push(f)}),r};r.prototype.toHtml1=function(){var t,n;return this.kbValue=="n/a"?"<i>not applicable<\/i>":this.kbValue==""||this.kbValue=="?"?"<i>no value specified<\/i>":this.valueType=="text"||this.valueType=="ordinal"||this.valueType=="ordinalCircular"?(n=this.kbValue.replace(/([^|]+)/g,"<b>$1<\/b>"),n=n.replace(/(\(m\)\s*<\/b>)/g,"<\/b> (male)"),n=n.replace(/(\(f\)\s*<\/b>)/g,"<\/b> (female)"),n=n.replace(/<b>\s*\[/g,"<b>"),n=n.replace(/\]\s*<\/b>/g,"<\/b>"),n=n.replace(/\s*\|\s*/g," or "),this.status=="display"&&(n=n.replace(/<b>/g,"").replace(/<\/b>/g,"")),n):this.valueType=="numeric"?(t=this.getRange(),n=t.hasValue==!1?"<b>no value in knowledge-base<\/b>":t.min==t.max?"<b>"+t.min+"<\/b>":"<b>"+t.min+"-"+t.max+"<\/b> (range)",this.status=="display"&&(n=n.replace(/<b>/g,"").replace(/<\/b>/g,"")),n):this.kbValue};r.prototype.toHtml2=function(){var i,u,r,n,t;if(this.kbValue=="n/a")return"<li><i>not applicable<\/i><\/li>";if(this.valueType=="text"||this.valueType=="ordinal"||this.valueType=="ordinalCircular"){for(i="",u=this.kbValue.split("|"),r=0;r<u.length;r++)n=u[r].trim(),n=/\(m\)$/.test(n)?"<b>"+n.replace(/\(m\)$/,"<\/b> (male)"):/\(f\)$/.test(n)?"<b>"+n.replace(/\(f\)$/,"<\/b> (female)"):"<b>"+n.trim()+"<\/b>",n=n.replace(/<b>\s*\[/g,"<b>"),n=n.replace(/\]\s*<\/b>/g,"<\/b>"),r<u.length-1&&(n+=" or"),i+="<li>",i+=n,i+="<\/li>";return i}return this.valueType=="numeric"?(t=this.getRange(),t.hasValue==!1?"<li><i>no value in knowledge-base<\/i><\/li>":t.min==t.max?"<li><b>"+t.min+"<\/b><\/li>":"<li><b>"+t.min+" - "+t.max+"<\/b> (range)<\/li>"):this.kbValue}})(jQuery,this.tombiovis);