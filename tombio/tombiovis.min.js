(function(n,t){"use strict";t.d.stateValue={v:null};t.d.stateValue.init=function(n,i){var u=t.d.oCharacters[i],f,e,r;this.valueType=u.ValueType;this.status=u.Status;this.character=u.Character;f=this;e=this.v.trim().split("|");e.forEach(function(n){var e,o,s;n=n.trim();n.endsWith("(m)")||n.endsWith("(f)")?(e=n.substr(0,n.length-4).trim(),o=n.substr(n.length-4,4)):(e=n,o="");u.stateGroups&&u.stateGroups.indexOf(e)>-1?(s=[],t.d.values.forEach(function(n){n.Character==i&&n.StateGroup==e&&s.push(n.CharacterState)})):s=[e];s.forEach(function(n){var t=f.translateStateValue(f.character,n);o!=""&&(t=t+" "+o);r=r?r+" | "+t:t});r.length>0&&r.substr(0,1)=="#"&&(r="");r.length=="?"&&(r="")});this.kbValue=r;u.Status=="key"&&(this.score={na:0,"for":0,against:0,overall:0})};t.d.stateValue.translateStateValue=function(n,i){function r(n,i){var r=t.d.values.filter(function(t){return t.Character==n&&t.CharacterState.trim()==i?!0:!1}),u;return u=r[0]&&r[0].CharacterStateTranslation&&r[0].CharacterStateTranslation!=""?r[0].CharacterStateTranslation:i,u.replace(/ +(?= )/g,"")}if(/^\[[^-]+-[^-]+\]$/.test(i)){var f=i.substr(1,i.length-2),u=f.split("-");return"["+r(n,u[0])+"-"+r(n,u[1])+"]"}return r(n,i)};t.d.stateValue.getStates=function(n){var i,u,r,t;for(n||(n=""),i=[],u=this.kbValue.split("|"),r=0;r<u.length;r++)t=u[r],t=t.trim(),t!="n/a"&&t!="novalue"&&t!="?"&&t!=""&&(n!="male"||t.endsWith("(f)")?n!="female"||t.endsWith("(m)")?n==""&&i.push(t.replace("(m)","").replace("(f)","").trim()):i.push(t.replace("(f)","").trim()):i.push(t.replace("(m)","").trim()));return i};t.d.stateValue.getRange=function(){var n={},i,t;return n.hasValue=String(this.kbValue)==""?!1:!0,String(this.kbValue).indexOf("[")==0?(i=this.kbValue.substr(1,this.kbValue.length-2),t=i.split("-"),n.min=Number(t[0]),n.max=Number(t[1]),n.mid=n.min+(n.max-n.min)/2):(n.min=Number(this.kbValue),n.max=Number(this.kbValue),n.mid=Number(this.kbValue)),n};t.d.stateValue.getOrdinalRanges=function(n){var i=this,r=[];return(this.valueType=="ordinal"||this.valueType=="ordinalCircular")&&this.getStates(n).forEach(function(n){var f=[];if(n.indexOf("[")==0){var s=n.substr(1,n.length-2),e=s.split("-"),h=e[0],o=e[1],u=!1;t.d.oCharacters[i.character].CharacterStateValues.forEach(function(n){n==h&&(u=!0);u&&f.push(n);n==o&&(u=!1)});u&&t.d.oCharacters[i.character].CharacterStateValues.forEach(function(n){u&&f.push(n);n==o&&(u=!1)})}else f.push(n);r.push(f)}),r};t.d.stateValue.toHtml1=function(){var t,n;return this.kbValue=="n/a"?"<i>not applicable<\/i>":this.kbValue=="novalue"?"<i>not manifest<\/i>":this.kbValue==""||this.kbValue=="?"?"<i>no value specified<\/i>":this.valueType=="text"||this.valueType=="ordinal"||this.valueType=="ordinalCircular"?(n=this.kbValue.replace(/([^|]+)/g,"<b>$1<\/b>"),n=n.replace(/(\(m\)\s*<\/b>)/g,"<\/b> (male)"),n=n.replace(/(\(f\)\s*<\/b>)/g,"<\/b> (female)"),n=n.replace(/<b>\s*\[/g,"<b>"),n=n.replace(/\]\s*<\/b>/g,"<\/b>"),n=n.replace(/\s*\|\s*/g," or "),this.status=="display"&&(n=n.replace(/<b>/g,"").replace(/<\/b>/g,"")),n):this.valueType=="numeric"?(t=this.getRange(),n=t.hasValue==!1?"<b>no value in knowledge-base<\/b>":t.min==t.max?"<b>"+t.min+"<\/b>":"<b>"+t.min+"-"+t.max+"<\/b> (range)",this.status=="display"&&(n=n.replace(/<b>/g,"").replace(/<\/b>/g,"")),n):this.kbValue};t.d.stateValue.toHtml2=function(){var i,u,r,n,t;if(this.kbValue=="n/a")return"<li><i>not applicable<\/i><\/li>";if(this.kbValue=="novalue")return"<li><i>not manifest<\/i><\/li>";if(this.valueType=="text"||this.valueType=="ordinal"||this.valueType=="ordinalCircular"){for(i="",u=this.kbValue.split("|"),r=0;r<u.length;r++)n=u[r].trim(),n=/\(m\)$/.test(n)?"<b>"+n.replace(/\(m\)$/,"<\/b> (male)"):/\(f\)$/.test(n)?"<b>"+n.replace(/\(f\)$/,"<\/b> (female)"):"<b>"+n.trim()+"<\/b>",n=n.replace(/<b>\s*\[/g,"<b>"),n=n.replace(/\]\s*<\/b>/g,"<\/b>"),r<u.length-1&&(n+=" or"),i+="<li>",i+=n,i+="<\/li>";return i}return this.valueType=="numeric"?(t=this.getRange(),t.hasValue==!1?"<li><i>no value in knowledge-base<\/i><\/li>":t.min==t.max?"<li><b>"+t.min+"<\/b><\/li>":"<li><b>"+t.min+" - "+t.max+"<\/b> (range)<\/li>"):this.kbValue};t.d.stateValue.toString=function(){return this.kbValue}})(jQuery,this.tombiovis),function(n,t){"use strict";function r(){t.d.values.forEach(function(n){var i=t.d.oCharacters[n.Character],r;i&&(r=n.CharacterStateTranslation&&n.CharacterStateTranslation!=""?n.CharacterStateTranslation:n.CharacterState,i.CharacterStates.push({CharacterState:r,StateHelp:n.StateHelp}),i.CharacterStateValues.push(r))});t.d.characters.forEach(function(n){(n.Group=="Taxonomy"||n.Status=="key"&&n.ValueType=="text")&&t.d.taxa.forEach(function(t){var i=t[n.Character].getStates("");i.forEach(function(t){t!=""&&n.CharacterStateValues.indexOf(t)==-1&&(n.CharacterStates.push({CharacterState:t,StateHelp:""}),n.CharacterStateValues.push(t))})})})}function i(){return t.v.selectedTool in t.v.visualisations?t.v.visualisations[t.v.selectedTool]:null}function u(){var i=n("#Sex").val();t.d.taxa.forEach(function(n){n.visState.score.for=0;n.visState.score.against=0;n.visState.score.overall=0;t.d.characters.filter(function(n){return n.Status=="key"}).forEach(function(r){var s,f,e,o,u=r.Character,l,a,h,c;if(r.stateSet){if(r.ValueType=="numeric")if(n[u]=="")s=0,o=0,f=0,e=0;else if(n[u]=="n/a")s=1,o=t.opts.ignoreNegativeScoring?0:1,f=0,e=0;else if(n[u]=="novalue")s=1,o=0,f=0,e=t.opts.ignoreNegativeScoring?0:1;else{var v=Number(r.userInput),y=n[u].getRange(),b=r.maxVal-r.minVal,h=t.f.score.numberVsRange(v,y,r.Latitude);f=h[0];e=h[1];s=1;o=0}else if(r.ValueType=="ordinal"||r.ValueType=="ordinalCircular"||r.ValueType=="text")if(n[u]=="n/a")s=1,o=t.opts.ignoreNegativeScoring?0:1,f=0,e=0;else if(n[u]=="novalue")s=1,o=0,f=0,e=1;else{if(l=r.userInput.map(function(n){return r.CharacterStateValues[n]}),r.ValueType=="ordinal"||r.ValueType=="ordinalCircular")var a=n[u].getOrdinalRanges(i),p=r.CharacterStateValues,w=r.ValueType=="ordinalCircular",h=t.f.score.ordinal(l,a,p,r.Latitude,w);else u=="Sex"?h=[0,0]:(a=n[u].getStates(i),h=t.f.score.character(l,a));f=h[0];e=h[1];s=1;o=0}}else s=0,o=0,f=0,e=0;n[u].score.na=o;n[u].score.for=f;n[u].score.against=e;n[u].score.overall=f-e-o;c=Number(r.Weight)/10;n.visState.score.for+=f*c;n.visState.score.against+=e*c;n.visState.score.against+=o*c;n.visState.score.overall+=(f-e-o)*c})})}t.f.loadcomplete=function(i){if(n("#tombiod3-header").text(t.d.kbmetadata.title),n("#tombiod3-footer").html(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title)),i||t.f.checkKnowledgeBase()){t.d.oCharacters={};t.d.characters.forEach(function(n){t.d.oCharacters[n.Character]=n;n.CharacterStates=[];n.CharacterStateValues=[];n.stateSet=!1;n.userInput=null;n.minVal=null;n.maxVal=null;n.Status=="key"&&n.Group.toLowerCase()!="none"&&(t.d.oCharacters.grouped=!0);n.stateGroups=[];t.d.values.forEach(function(t){t.Character==n.Character&&t.StateGroup&&n.stateGroups.indexOf(t.StateGroup)==-1&&n.stateGroups.push(t.StateGroup)})});t.d.oTaxa={};var u=0;t.d.taxa.forEach(function(n){t.d.oTaxa[n.Taxon]=n;for(var i in n)n.hasOwnProperty(i)&&(n[i]=Object.create(t.d.stateValue,{v:{writable:!0,value:n[i]}}),n[i].init(n,i));n.kbPosition=++u;n.visState={score:{"for":null,against:null,overall:null}}});t.d.characters.forEach(function(n){var i,r;n.ValueType=="numeric"&&t.d.taxa.forEach(function(t){var i=t[n.Character].getRange().min,r=t[n.Character].getRange().max;(!n.minVal||i<n.minVal)&&(n.minVal=i);(!n.maxVal||r>n.maxVal)&&(n.maxVal=r)});(n.ValueType=="numeric"||n.ValueType=="ordinal"||n.ValueType=="ordinalCircular")&&(typeof n.Latitude!="undefined"?n.Latitude=Number(n.Latitude):(i=n.Strictness==""?10:Number(n.Strictness),n.ValueType=="numeric"?n.Latitude=(1-i/10)*(n.maxVal-n.minVal):(r=t.d.values.filter(function(t){return t.Character==n.Character}).length,n.Latitude=(1-i/10)*r,n.ValueType=="ordinalCircular"&&(n.Latitude=n.Latitude/2))))});t.d.media.forEach(function(n){(n.Type=="image-local"||n.Type=="html-local")&&(n.URI=t.opts.tombiokbpath+n.URI,n.SmallURI&&(n.SmallURI=t.opts.tombiokbpath+n.SmallURI),n.LargeURI&&(n.LargeURI=t.opts.tombiokbpath+n.LargeURI))});r();t.gui.main.addTopPageElements();t.gui.main.createUIControls();n("#downloadspin").remove();t.f.resizeControlsAndTaxa();t.f.visChanged(t.v.selectedTool);t.loadCallback&&t.loadCallback()}};t.f.visChanged=function(i,r){if(i=="reload"){n.ajax({url:window.location.href,headers:{Pragma:"no-cache",Expires:-1,"Cache-Control":"no-cache"}}).done(function(){window.location.reload(!0)});return}if(i=="visInfo"||i=="kbInfo"){t.gui.main.visShow(i);return}if(i=="tombioCitation"||i=="currentVisInfo"){var u;u=r?r:t.v.lastVis?t.v.lastVis:t.opts.lastVisualisation?t.opts.lastVisualisation:t.v.includedVisualisations[0].visName;t.f.showDownloadSpinner();t.js.jsFiles[u].loadJs().then(function(){if(t.f.hideDownloadSpinner(),!t.v.visualisations[u].visName){var n=t.v.visualisations[u];n.initP(u,t.gui.main)}t.v.lastVis=u;t.gui.main.visShow(i)});return}if(i=="mediaFilesCheck"||i=="tvkCheck"){t.gui.main.visShow(i);return}t.f.showDownloadSpinner();t.js.jsFiles[i].loadJs().then(function(){if(t.f.hideDownloadSpinner(),!t.v.visualisations[i].visName){var n=t.v.visualisations[i];n.initP(i,t.gui.main)}console.log("Starting",i);t.gui.main.visShow(i)});t.gui.main.setSelectedTool(i)};t.f.initControlsFromParams=function(n){for(name in n)if(name.startsWith("c-")){var u=name.split("-")[1],r=t.d.characters[u];r.userInput=r.ControlType==="spin"?n[name]:n[name].split(",");r.stateSet=!0}i().inputControl.initStateFromParams(n);t.f.refreshVisualisation()};t.f.setParamsFromControls=function(){var n=[];return t.d.characters.forEach(function(t,i){if(t.userInput){var r="c-"+i;t.ControlType==="spin"?n.push(r+"="+t.userInput):n.push(r+"="+t.userInput.join(","))}}),i().inputControl.setParamsFromState(n)};t.f.getCitation=function(t,i,r){var f=n("<div class='tombioCitation'>"),u,e=new Date;return u=t.authors+" ",u+="("+t.year+") ",u+="<i>"+t.title+"<\/i>",u+=" (Version "+t.version+") ["+i+"]",r&&(u+=" (for "+r+")"),u+=". ",t.publisher&&(u+=t.publisher+". "),t.location&&(u+=t.location+". "),u+="Accessed "+e.toDateString()+". ",u+=window.location.href.split("?")[0],f.append(n("<div>").html(u)),f};t.f.refreshVisualisation=function(){u();i()&&i().refresh();t.f.resizeControlsAndTaxa()};t.f.resizeControlsAndTaxa=function(){t.gui.main.resizeControlsAndTaxa()};t.f.characterHasHelp=function(n){var u=t.d.oCharacters[n].Help,i,r;return u.length>0?!0:(i=t.d.values.filter(function(t){if(t.Character==n&&t.StateHelp)return!0}),i.length>0)?!0:(r=t.d.media.filter(function(t){if((t.Type=="image-local"||t.Type=="image-web")&&t.Character==n)return!0}),r.length>0)?!0:!1};t.f.getURLParameter=function(n){for(var i,u=window.location.search.substring(1),r=u.split("&"),t=0;t<r.length;t++)if(i=r[t].split("="),i[0]==n)return i[1];return null};t.f.createMediaCheckPage=function(){var i=n("<div id='tombioMediaChecks'>"),r=n("<h2>").appendTo(i),u=n("<div id='tombioMediaNotFound'>").appendTo(i),f=n("<div id='tombioMediaFound'>").appendTo(i);return u.append("<h3>Not found<\/h3>"),u.append("<p>If a file cannot be found but you think it is present, check the case carefully. The case used to name the file must match exactly the case used in the knowledge-base. For example, a file with extension '.JPG' will not match the same filename in the knowledge-base if it is written there as '.jpg'.<\/p>"),f.append("<h3>Found<\/h3>"),r.text("Checking media files..."),t.f.mediaCheck("URI",function(t){n("#tombioMediaFound").append(n("<p>").html("The media file '"+t+"' found okay."))},function(t){n("#tombioMediaNotFound").append(n("<p>").html("The media file '"+t+"' cannot be found."))}).then(function(){t.f.mediaCheck("SmallURI",function(t){n("#tombioMediaFound").append(n("<p>").html("The small media file '"+t+"' found okay."))},function(t){n("#tombioMediaNotFound").append(n("<p>").html("The small media file '"+t+"' cannot be found."))})}).then(function(){t.f.mediaCheck("LargeURI",function(t){n("#tombioMediaFound").append(n("<p>").html("The large media file '"+t+"' found okay."))},function(t){n("#tombioMediaNotFound").append(n("<p>").html("The large media file '"+t+"' cannot be found."))})}).then(function(){r.text("Completed checking media files")}),i};t.f.createTvkCheckPage=function(){var i=n("<div id='tombioTvkChecks'>"),r=n("<h2>").appendTo(i),u=n("<div id='tombioTvkNotFound'>").appendTo(i),f=n("<div id='tombioTvkFound'>").appendTo(i);return u.append("<h3>Not found<\/h3>"),u.append("<p>If a TVK cannot be found by the NBN web service used for this checking, then you can double-check by going directly to the NBN Atlas page and searching on the TVK (https://nbnatlas.org/). To resolve problems with TVKs not being recognised, you may have to contact the NBN or the NHM who look after the UKSI.<\/p>"),f.append("<h3>Found<\/h3>"),r.text("Checking TVKs..."),t.f.tvkCheck(function(t){n("#tombioTvkFound").append(n("<p>").html("TVK '"+t.TVK+"' found."))},function(t){n("#tombioTvkNotFound").append(n("<p>").html("TVK '"+t.TVK+"' for '"+t.Taxon+"' cannot be found."))},function(){r.text("Completed checking TVKs")}),i};t.f.getCitationText;t.f.selectElementText=function(n,t){t=t||window;var r=t.document,u,i;t.getSelection&&r.createRange?(u=t.getSelection(),i=r.createRange(),i.selectNodeContents(n),u.removeAllRanges(),u.addRange(i)):r.body.createTextRange&&(i=r.body.createTextRange(),i.moveToElementText(n),i.select())}}(jQuery,this.tombiovis);