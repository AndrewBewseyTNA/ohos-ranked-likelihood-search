(function(n,t){"use strict";t.d.stateValue={v:null};t.d.stateValue.init=function(n,i){var u=t.d.oCharacters[i],f,e,r;this.valueType=u.ValueType;this.status=u.Status;this.character=u.Character;f=this;e=this.v.trim().split("|");e.forEach(function(n){var e,o,s;n=n.trim();n.endsWith("(m)")||n.endsWith("(f)")?(e=n.substr(0,n.length-4).trim(),o=n.substr(n.length-4,4)):(e=n,o="");u.stateGroups&&u.stateGroups.indexOf(e)>-1?(s=[],t.d.values.forEach(function(n){n.Character==i&&n.StateGroup==e&&s.push(n.CharacterState)})):s=[e];s.forEach(function(n){var t=f.translateStateValue(f.character,n);o!=""&&(t=t+" "+o);r=r?r+" | "+t:t});r.length>0&&r.substr(0,1)=="#"&&(r="");r.length=="?"&&(r="")});this.kbValue=r;u.Status=="key"&&(this.score={na:0,"for":0,against:0,overall:0})};t.d.stateValue.translateStateValue=function(n,i){function r(n,i){var r=t.d.values.filter(function(t){return t.Character==n&&t.CharacterState.trim()==i?!0:!1}),u;return u=r[0]&&r[0].CharacterStateTranslation&&r[0].CharacterStateTranslation!=""?r[0].CharacterStateTranslation:i,u.replace(/ +(?= )/g,"")}if(/^\[[^-]+-[^-]+\]$/.test(i)){var f=i.substr(1,i.length-2),u=f.split("-");return"["+r(n,u[0])+"-"+r(n,u[1])+"]"}return r(n,i)};t.d.stateValue.getStates=function(n){var i,u,r,t;for(n||(n=""),i=[],u=this.kbValue.split("|"),r=0;r<u.length;r++)t=u[r],t=t.trim(),t!="n/a"&&t!="novalue"&&t!="?"&&t!=""&&(n!="male"||t.endsWith("(f)")?n!="female"||t.endsWith("(m)")?n==""&&i.push(t.replace("(m)","").replace("(f)","").trim()):i.push(t.replace("(f)","").trim()):i.push(t.replace("(m)","").trim()));return i};t.d.stateValue.getRange=function(){var n={},i,t;return n.hasValue=String(this.kbValue)==""?!1:!0,String(this.kbValue).indexOf("[")==0?(i=this.kbValue.substr(1,this.kbValue.length-2),t=i.split("-"),n.min=Number(t[0]),n.max=Number(t[1]),n.mid=n.min+(n.max-n.min)/2):(n.min=Number(this.kbValue),n.max=Number(this.kbValue),n.mid=Number(this.kbValue)),n};t.d.stateValue.getOrdinalRanges=function(n){var i=this,r=[];return(this.valueType=="ordinal"||this.valueType=="ordinalCircular")&&this.getStates(n).forEach(function(n){var f=[];if(n.indexOf("[")==0){var s=n.substr(1,n.length-2),e=s.split("-"),h=e[0],o=e[1],u=!1;t.d.oCharacters[i.character].CharacterStateValues.forEach(function(n){n==h&&(u=!0);u&&f.push(n);n==o&&(u=!1)});u&&t.d.oCharacters[i.character].CharacterStateValues.forEach(function(n){u&&f.push(n);n==o&&(u=!1)})}else f.push(n);r.push(f)}),r};t.d.stateValue.toHtml1=function(){var t,n;return this.kbValue=="n/a"?"<i>not applicable<\/i>":this.kbValue=="novalue"?"<i>not manifest<\/i>":this.kbValue==""||this.kbValue=="?"?"<i>no value specified<\/i>":this.valueType=="text"||this.valueType=="ordinal"||this.valueType=="ordinalCircular"?(n=this.kbValue.replace(/([^|]+)/g,"<b>$1<\/b>"),n=n.replace(/(\(m\)\s*<\/b>)/g,"<\/b> (male)"),n=n.replace(/(\(f\)\s*<\/b>)/g,"<\/b> (female)"),n=n.replace(/<b>\s*\[/g,"<b>"),n=n.replace(/\]\s*<\/b>/g,"<\/b>"),n=n.replace(/\s*\|\s*/g," or "),this.status=="display"&&(n=n.replace(/<b>/g,"").replace(/<\/b>/g,"")),n):this.valueType=="numeric"?(t=this.getRange(),n=t.hasValue==!1?"<b>no value in knowledge-base<\/b>":t.min==t.max?"<b>"+t.min+"<\/b>":"<b>"+t.min+"-"+t.max+"<\/b> (range)",this.status=="display"&&(n=n.replace(/<b>/g,"").replace(/<\/b>/g,"")),n):this.kbValue};t.d.stateValue.toHtml2=function(){var i,u,r,n,t;if(this.kbValue=="n/a")return"<li><i>not applicable<\/i><\/li>";if(this.kbValue=="novalue")return"<li><i>not manifest<\/i><\/li>";if(this.valueType=="text"||this.valueType=="ordinal"||this.valueType=="ordinalCircular"){for(i="",u=this.kbValue.split("|"),r=0;r<u.length;r++)n=u[r].trim(),n=/\(m\)$/.test(n)?"<b>"+n.replace(/\(m\)$/,"<\/b> (male)"):/\(f\)$/.test(n)?"<b>"+n.replace(/\(f\)$/,"<\/b> (female)"):"<b>"+n.trim()+"<\/b>",n=n.replace(/<b>\s*\[/g,"<b>"),n=n.replace(/\]\s*<\/b>/g,"<\/b>"),r<u.length-1&&(n+=" or"),i+="<li>",i+=n,i+="<\/li>";return i}return this.valueType=="numeric"?(t=this.getRange(),t.hasValue==!1?"<li><i>no value in knowledge-base<\/i><\/li>":t.min==t.max?"<li><b>"+t.min+"<\/b><\/li>":"<li><b>"+t.min+" - "+t.max+"<\/b> (range)<\/li>"):this.kbValue};t.d.stateValue.toString=function(){return this.kbValue}})(jQuery,this.tombiovis),function(n,t){"use strict";function r(){t.d.values.forEach(function(n){var i=t.d.oCharacters[n.Character],r;i&&(r=n.CharacterStateTranslation&&n.CharacterStateTranslation!=""?n.CharacterStateTranslation:n.CharacterState,i.CharacterStates.push({CharacterState:r,StateHelp:n.StateHelp}),i.CharacterStateValues.push(r))});t.d.characters.forEach(function(n){(n.Group=="Taxonomy"||n.Status=="key"&&n.ValueType=="text")&&t.d.taxa.forEach(function(t){var i=t[n.Character].getStates("");i.forEach(function(t){t!=""&&n.CharacterStateValues.indexOf(t)==-1&&(n.CharacterStates.push({CharacterState:t,StateHelp:""}),n.CharacterStateValues.push(t))})})})}function i(){return t.v.selectedTool in t.v.visualisations?t.v.visualisations[t.v.selectedTool]:null}function u(){var i=n("#Sex").val();t.d.taxa.forEach(function(n){n.visState.score.for=0;n.visState.score.against=0;n.visState.score.overall=0;t.d.characters.filter(function(n){return n.Status=="key"}).forEach(function(r){var s,f,e,o,u=r.Character,l,a,h,c;if(r.stateSet){if(r.ValueType=="numeric")if(n[u]=="")s=0,o=0,f=0,e=0;else if(n[u]=="n/a")s=1,o=t.opts.ignoreNegativeScoring?0:1,f=0,e=0;else if(n[u]=="novalue")s=1,o=0,f=0,e=t.opts.ignoreNegativeScoring?0:1;else{var v=Number(r.userInput),y=n[u].getRange(),b=r.maxVal-r.minVal,h=t.f.score.numberVsRange(v,y,r.Latitude);f=h[0];e=h[1];s=1;o=0}else if(r.ValueType=="ordinal"||r.ValueType=="ordinalCircular"||r.ValueType=="text")if(n[u]=="n/a")s=1,o=t.opts.ignoreNegativeScoring?0:1,f=0,e=0;else if(n[u]=="novalue")s=1,o=0,f=0,e=1;else{if(l=r.userInput.map(function(n){return r.CharacterStateValues[n]}),r.ValueType=="ordinal"||r.ValueType=="ordinalCircular")var a=n[u].getOrdinalRanges(i),p=r.CharacterStateValues,w=r.ValueType=="ordinalCircular",h=t.f.score.ordinal(l,a,p,r.Latitude,w);else u=="Sex"?h=[0,0]:(a=n[u].getStates(i),h=t.f.score.character(l,a));f=h[0];e=h[1];s=1;o=0}}else s=0,o=0,f=0,e=0;n[u].score.na=o;n[u].score.for=f;n[u].score.against=e;n[u].score.overall=f-e-o;c=Number(r.Weight)/10;n.visState.score.for+=f*c;n.visState.score.against+=e*c;n.visState.score.against+=o*c;n.visState.score.overall+=(f-e-o)*c})})}t.f.loadcomplete=function(i){var f,u;(n("#tombiod3-header").text(t.d.kbmetadata.title),n("#tombiod3-footer").html(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title)),i||t.f.checkKnowledgeBase())&&(t.d.oCharacters={},t.d.characters.forEach(function(n){t.d.oCharacters[n.Character]=n;n.CharacterStates=[];n.CharacterStateValues=[];n.stateSet=!1;n.userInput=null;n.minVal=null;n.maxVal=null;n.Status=="key"&&n.Group.toLowerCase()!="none"&&(t.d.oCharacters.grouped=!0);n.stateGroups=[];t.d.values.forEach(function(t){t.Character==n.Character&&t.StateGroup&&n.stateGroups.indexOf(t.StateGroup)==-1&&n.stateGroups.push(t.StateGroup)})}),t.d.oTaxa={},f=0,t.d.taxa.forEach(function(n){t.d.oTaxa[n.Taxon]=n;for(var i in n)n.hasOwnProperty(i)&&(n[i]=Object.create(t.d.stateValue,{v:{writable:!0,value:n[i]}}),n[i].init(n,i));n.kbPosition=++f;n.visState={score:{"for":null,against:null,overall:null}}}),t.d.characters.forEach(function(n){var i,r;n.ValueType=="numeric"&&t.d.taxa.forEach(function(t){var i=t[n.Character].getRange().min,r=t[n.Character].getRange().max;(!n.minVal||i<n.minVal)&&(n.minVal=i);(!n.maxVal||r>n.maxVal)&&(n.maxVal=r)});(n.ValueType=="numeric"||n.ValueType=="ordinal"||n.ValueType=="ordinalCircular")&&(typeof n.Latitude!="undefined"?n.Latitude=Number(n.Latitude):(i=n.Strictness==""?10:Number(n.Strictness),n.ValueType=="numeric"?n.Latitude=(1-i/10)*(n.maxVal-n.minVal):(r=t.d.values.filter(function(t){return t.Character==n.Character}).length,n.Latitude=(1-i/10)*r,n.ValueType=="ordinalCircular"&&(n.Latitude=n.Latitude/2))))}),t.d.media.forEach(function(n){(n.Type=="image-local"||n.Type=="html-local")&&(n.URI=t.opts.tombiokbpath+n.URI,n.SmallURI&&(n.SmallURI=t.opts.tombiokbpath+n.SmallURI),n.LargeURI&&(n.LargeURI=t.opts.tombiokbpath+n.LargeURI))}),r(),u=t.f.getURLParameter("selectedTool"),t.v.selectedTool=u?u:t.opts.selectedTool?t.opts.selectedTool:t.d.kbconfig.selectedTool?t.d.kbconfig.selectedTool:t.v.includedVisualisations[0],t.gui.main.init(),t.gui.main.createUIControls(),n("#downloadspin").remove(),t.f.resizeControlsAndTaxa(),t.f.visChanged(t.v.selectedTool),t.loadCallback&&t.loadCallback())};t.f.visChanged=function(i,r){var f,u;if(i){if(t.opts.devel&&t.templates.visTemplate.initP("visTemplate"),t.v.selectedTool=i,i=="reload"){n.ajax({url:window.location.href,headers:{Pragma:"no-cache",Expires:-1,"Cache-Control":"no-cache"}}).done(function(){window.location.reload(!0)});return}if(i=="reloadGuiOnsen"){f=location.pathname;window.location.replace(location.pathname+"?gui=guiOnsenUi");return}if(i=="reloadGuiJQuery"){f=location.pathname;window.location.replace(location.pathname+"?gui=guiLargeJqueryUi");return}if(i=="visInfo"||i=="kbInfo"){t.gui.main.visShow(i);return}if(i=="tombioCitation"||i=="currentVisInfo"){u=r?r:t.v.lastVis?t.v.lastVis:t.opts.lastVisualisation?t.opts.lastVisualisation:t.v.includedVisualisations[0].visName;t.f.showDownloadSpinner();t.js.jsFiles[u].loadJs().then(function(){if(t.f.hideDownloadSpinner(),!t.v.visualisations[u].visName){var n=t.v.visualisations[u];n.initP(u);n.hide()}t.v.lastVis=u;t.gui.main.visShow(i)});return}if(i=="mediaFilesCheck"||i=="tvkCheck"){t.gui.main.visShow(i);return}t.f.showDownloadSpinner();t.js.jsFiles[i].loadJs().then(function(){if(t.f.hideDownloadSpinner(),!t.v.visualisations[i].initialised){var n=t.v.visualisations[i];n.initP(i)}console.log("Starting",i);t.gui.main.visShow(i)});t.gui.main.setSelectedTool(i)}};t.f.initControlsFromParams=function(n){for(name in n)if(name.startsWith("c-")){var u=name.split("-")[1],r=t.d.characters[u];r.userInput=r.ControlType==="spin"?n[name]:n[name].split(",");r.stateSet=!0}i().inputControl.initStateFromParams(n);t.f.refreshVisualisation()};t.f.setParamsFromControls=function(){var n=[];return t.d.characters.forEach(function(t,i){if(t.userInput){var r="c-"+i;t.ControlType==="spin"?n.push(r+"="+t.userInput):n.push(r+"="+t.userInput.join(","))}}),i().inputControl.setParamsFromState(n)};t.f.getCitation=function(t,i,r){var f=n("<div class='tombioCitation'>"),u,e=new Date;return u=t.authors+" ",u+="("+t.year+") ",u+="<i>"+t.title+"<\/i>",u+=" (Version "+t.version+") ["+i+"]",r&&(u+=" (for "+r+")"),u+=". ",t.publisher&&(u+=t.publisher+". "),t.location&&(u+=t.location+". "),u+="Accessed "+e.toDateString()+". ",u+=window.location.href.split("?")[0],f.append(n("<div>").html(u)),f};t.f.setKbInfo=function(i){n.get(t.opts.tombiokbpath+"info.html",function(n){i.append(n.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath))}).always(function(){var o=n("<h3>").attr("id","tombioKbCitation").text("Citation"),f,e,u,r;i.append(o);i.append(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title));f=n("<h3>").attr("id","tombioKbRevisionHistory").text("Knowledge-base revision history");i.append(f);e=n("<p>").html("<b>Current version: "+t.d.kbmetadata.version+"<\/b>");i.append(e);u=n("<table>");r=n("<tr>").css("background-color","black").css("color","white");r.append(n("<td>").text("Date").css("padding","3px"));r.append(n("<td>").text("Version").css("padding","3px"));r.append(n("<td>").text("Notes").css("padding","3px"));u.append(r);t.d.kbreleaseHistory.forEach(function(t,i){r=n("<tr>");i%2==0?r.css("background-color","rgb(200,200,200)"):r.css("background-color","rgb(230,230,230)");var f=new Date(t.Date);r.append(n("<td>").css("padding","3px").text(f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()));r.append(n("<td>").css("padding","3px").text(t.Value));r.append(n("<td>").css("padding","3px").text(t.Notes));u.append(r)});i.append(u)})};t.f.setVisInfo=function(i){n.get(t.opts.tombiopath+"visInfo.html",function(n){i.html(n.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath))})};t.f.setSelectedToolInfo=function(i){var r=new Array(t.v.visualisations[t.v.lastVis].helpFiles.length),u=[];t.v.visualisations[t.v.lastVis].helpFiles.forEach(function(t,i){u.push(new Promise(function(u){n.get(t,function(n){r[i]=n;u()})}))});Promise.all(u).then(function(){var n="";r.forEach(function(t){n+=t});n=n.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath);i.html(n)})};t.f.createCitationPage=function(){var i=n("<div>"),r,u;return i.append(n("<h3>").text("Citation for FSC Identikit (core software)")),r="This is the reference you can use for the FSC Identikit - in other words the core software.",r+=" The core version number is updated whenever there is a new major release of the core software.",i.append(n("<p>").html(r)),i.append(n("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationCore' id='tbCitationCore'>")),i.append(n("<span>").text("Copy citation")),i.append(n("<b>").html(t.f.getCitation(t.d.softwareMetadata,"Software"))),i.append(n("<h3>").text("Citation for last selected visualisation tool")),r="This is the reference you can use for the last selected visualisation tool.",r+=" The tool version number is updated whenever there is a new release of the tool.",r+=" If you cite a tool, there's no need to cite the core software separately since it is implicit.",i.append(n("<p>").html(r)),i.append(n("<input style='position: relative; top: 0.2em' type='checkbox' name='tbCitationVis' id='tbCitationVis'>")),i.append(n("<span>").text("Copy citation")),i.append(n("<b>").html(t.f.getCitation(t.v.visualisations[t.v.lastVis].metadata,"Software",t.d.softwareMetadata.title))),i.append(n("<h3>").text("Citation for knowledge-base")),r="This is the reference you can use for the knowledge-base currently driving the software.",r+=" The knowledge-base version number is updated whenever there is a new release of the knowledge-base.",i.append(n("<p>").html(r)),i.append(n("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationKb' id='tbCitationKb'>")),i.append(n("<span>").text("Copy citation")),i.append(n("<b>").html(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title))),u=n("<button>Copy citations<\/button>"),u.button(),u.click(function(){n("#tbSelectedCitations").html("");document.getElementById("tbCitationCore").checked&&n("#tbSelectedCitations").append(t.f.getCitation(t.d.softwareMetadata,"Software"));document.getElementById("tbCitationVis").checked&&n("#tbSelectedCitations").append(t.f.getCitation(t.v.visualisations[t.v.lastVis].metadata,"Software",t.d.softwareMetadata.title));document.getElementById("tbCitationKb").checked&&n("#tbSelectedCitations").append(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title));t.f.selectElementText(document.getElementById("tbSelectedCitations"));n("#tbCitationInstructions").show()}),i.append(n("<p>").append(u).append("&nbsp;The selected citations will appear together below - just copy and paste")),i.append(n("<div id='tbSelectedCitations'>")),i.append(n("<p id='tbCitationInstructions' style='display: none'>").text("You can now copy and paste the selected citation text.")),i};t.f.refreshVisualisation=function(){u();i()&&i().refresh();t.f.resizeControlsAndTaxa()};t.f.resizeControlsAndTaxa=function(){t.gui.main.resizeControlsAndTaxa()};t.f.characterHasHelp=function(n){var u=t.d.oCharacters[n].Help,i,r;return u.length>0?!0:(i=t.d.values.filter(function(t){if(t.Character==n&&t.StateHelp)return!0}),i.length>0)?!0:(r=t.d.media.filter(function(t){if((t.Type=="image-local"||t.Type=="image-web")&&t.Character==n)return!0}),r.length>0)?!0:!1};t.f.getURLParameter=function(n){for(var i,u=window.location.search.substring(1),r=u.split("&"),t=0;t<r.length;t++)if(i=r[t].split("="),i[0]==n)return i[1];return null};t.f.createMediaCheckPage=function(){var i=n("<div id='tombioMediaChecks'>"),r=n("<h2>").appendTo(i),u=n("<div id='tombioMediaNotFound'>").appendTo(i),f=n("<div id='tombioMediaFound'>").appendTo(i);return u.append("<h3>Not found<\/h3>"),u.append("<p>If a file cannot be found but you think it is present, check the case carefully. The case used to name the file must match exactly the case used in the knowledge-base. For example, a file with extension '.JPG' will not match the same filename in the knowledge-base if it is written there as '.jpg'.<\/p>"),f.append("<h3>Found<\/h3>"),r.text("Checking media files..."),t.f.mediaCheck("URI",function(t){n("#tombioMediaFound").append(n("<p>").html("The media file '"+t+"' found okay."))},function(t){n("#tombioMediaNotFound").append(n("<p>").html("The media file '"+t+"' cannot be found."))}).then(function(){t.f.mediaCheck("SmallURI",function(t){n("#tombioMediaFound").append(n("<p>").html("The small media file '"+t+"' found okay."))},function(t){n("#tombioMediaNotFound").append(n("<p>").html("The small media file '"+t+"' cannot be found."))})}).then(function(){t.f.mediaCheck("LargeURI",function(t){n("#tombioMediaFound").append(n("<p>").html("The large media file '"+t+"' found okay."))},function(t){n("#tombioMediaNotFound").append(n("<p>").html("The large media file '"+t+"' cannot be found."))})}).then(function(){r.text("Completed checking media files")}),i};t.f.createTvkCheckPage=function(){var i=n("<div id='tombioTvkChecks'>"),r=n("<h2>").appendTo(i),u=n("<div id='tombioTvkNotFound'>").appendTo(i),f=n("<div id='tombioTvkFound'>").appendTo(i);return u.append("<h3>Not found<\/h3>"),u.append("<p>If a TVK cannot be found by the NBN web service used for this checking, then you can double-check by going directly to the NBN Atlas page and searching on the TVK (https://nbnatlas.org/). To resolve problems with TVKs not being recognised, you may have to contact the NBN or the NHM who look after the UKSI.<\/p>"),f.append("<h3>Found<\/h3>"),r.text("Checking TVKs..."),t.f.tvkCheck(function(t){n("#tombioTvkFound").append(n("<p>").html("TVK '"+t.TVK+"' found."))},function(t){n("#tombioTvkNotFound").append(n("<p>").html("TVK '"+t.TVK+"' for '"+t.Taxon+"' cannot be found."))},function(){r.text("Completed checking TVKs")}),i};t.f.getTaxonCharacterValues=function(i){var r=n("<table>"),u,f;return r.css("width","100%"),r.css("margin","0px"),u=0,f="",t.d.characters.forEach(function(e){var s,o,h,c;(e.Status=="key"||e.Status=="display")&&(t.d.oCharacters.grouped&&e.Group!=f&&(o=n("<tr>"),o.css("background-color","rgb(100,100,100)"),o.css("color","rgb(255,255,255)"),s=n("<td colspan='3'>"),o.append(s.append(e.Group)),r.append(o),f=e.Group),u++,o=n("<tr>"),u%2!=0?o.css("background-color","rgb(200,200,200)"):o.css("background-color","rgb(230,230,230)"),h=n("<td>").append(e.Label),c=n("<td>").append(i[e.Character].toHtml1()),o.append(h),o.append(c),r.append(o))}),r.find("td").css("padding","2"),r};t.f.addTaxonImagesToContainer=function(i){var h=i.taxon,u=i.container,c=i.indexSelected?i.indexSelected:0,l=i.imageRemovalButton?i.imageRemovalButton:!1,e=i.fImageSelect?i.fImageSelect:null,a=i.height?i.height:400,v=this,o=t.f.getTaxonImages(h),s,r,f;if(o.length==0){s=n("<div>").css("margin","10px");s.text("No images are specified in the knowledge-base for this taxon.").appendTo(u);return}r=n("<div>").addClass("tombio-galleria-pane").css("position","relative").css("max-width","2000px").css("height",a).appendTo(u);f=[];o.forEach(function(n){var t={image:n.URI,thumb:n.SmallURI?n.SmallURI:null,big:n.LargeURI?n.LargeURI:null,alt:n.Caption,title:n.Caption};f.push(t)});Galleria.run(r,{transition:"fade",wait:!0,dataSource:f,theme:"classic",show:c});r.data("galleria").bind("loadfinish",function(n){e&&e(n.index)});n("<img>").attr("src",t.opts.tombiopath+"resources/enlarge.png").appendTo(r).addClass("tombio-galleria-lightbox-button").on("click",function(){r.data("galleria").openLightbox()});if(l)n("<img>").attr("src",t.opts.tombiopath+"resources/remove.png").appendTo(r).addClass("tombio-galleria-remove-button").on("click",function(){r.data("galleria").destroy();u.addClass("userRemoved");u.remove()})};t.f.getTaxonImages=function(n){return t.d.media.filter(function(t){if(t.Taxon==n&&(t.Type=="image-local"||t.Type=="image-web"))return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)})};t.f.addNBNMapToContainer=function(i,r){var s,u;i=i+="";var f=n("<div>").appendTo(r).css("border","1px solid black").css("padding","5px").css("border-radius","10px"),e=n("<img>").addClass("tombioNbnLogo").attr("src",t.opts.tombiopath+"/resources/nbn-logo-centred.png").addClass(function(){if(i)return"tombioSpiningNbn"}()).appendTo(f),o=n("<div>").addClass("tombioNbnLoading").css("font-size","0.8em").text(function(){return i?"Loading distribution map from NBN...":"No TVK specified for this taxon"}()).appendTo(f);i&&(t.d.nbnMapCache[i]?(u=t.d.nbnMapCache[i],e.attr("src",t.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),o.hide()):(s="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+i+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100",u=n("<img>").attr("id","tombioNbnMapImage").on("load",function(){e.attr("src",t.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn");o.hide()}).on("error",function(){e.removeClass("tombioSpiningNbn");o.text("An error was encountered attemping to retrieve an NBN distribution map for the TVK "+i);u.hide()}).attr("src",s),t.d.nbnMapCache[i]=u));n("<div>").append(u).appendTo(f)};t.f.addTaxonHtmlToContainer=function(i,r,u){var f=t.f.getTaxonHtmlFiles(i);u<=f.length-1?n.get(f[u].URI+"?ver="+t.opts.tombiover,function(t){var i=t.indexOf("<body"),u=t.indexOf("<\/body"),f=t.slice(i,u),e=n("<div>").html(f);r.html(e.html())}):r.html(null)};t.f.getTaxonHtmlFiles=function(n){return t.d.media.filter(function(t){if(t.Taxon==n&&t.Type=="html-local")return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)})};t.f.getCharacterScoreDetails=function(t,i){var r,u;return r="<p>Specified state(s) for character <b>"+i.Label+"<\/b>: <\/p>",u=n("#"+i.Character),r+="<ul>",i.ControlType=="spin"||i.ControlType=="single"?(r+="<li><b>",r+=u.val(),r+="<\/b><\/li>"):i.ControlType=="multi"&&u.val().forEach(function(n){r+="<li><b>";r+=n;r+="<\/b><\/li>"}),r+="<\/ul>",r+="<p>Valid state(s) for <b>"+i.Label+"<\/b> recorded against ",r+="<b><i>"+t.Taxon+"<\/i><\/b> in the knowledge base: ",r+="<ul>",r+=t[i.Character].toHtml2(),r+="<\/ul>",r+="<hr/>",r+="<p>Knowledge-base <b>weighting<\/b> for this character: <b>"+i.Weight+"<\/b><\/p>",r+="<p>Knowledge-base <b>latitude<\/b> for this character: <b>"+i.Latitude+"<\/b><\/p>",r+="<hr/>",r+="<p>Unweighted character score: <b>"+Math.round(t[i.Character].score.overall*100)/100+"<\/b>; ",r+="(for, "+Math.round(t[i.Character].score.for*100)/100,r+="; against, "+Math.round((t[i.Character].score.against+t[i.Character].score.na)*100)/100+")<\/p>",r+="<p>Weighted character score: <b>"+Math.round(t[i.Character].score.overall*i.Weight*10)/100+"<\/b><\/p>"};t.f.sortTaxa=function(n){return n.sort(function(n,t){return n.visState.score.overall>t.visState.score.overall?-1:t.visState.score.overall>n.visState.score.overall?1:t.visState.score.overall==n.visState.score.overall?n.visState.score.for>t.visState.score.for?1:t.visState.score.for>n.visState.score.for?-1:n.kbPosition>t.kbPosition?1:-1:void 0})};t.f.getTaxonTipImage=function(i){var f=t.d.media.filter(function(n){if(n.Taxon==i&&(n.Type=="image-local"||n.Type=="image-web")){if(n.UseFor){var t=!1;return n.UseFor.split(",").forEach(function(n){n.toLowerCase().trim()=="tip"&&(t=!0)}),t}return!0}}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});if(f.length>0){var u=n("<div/>"),r=f[0],e=n("<img/>",{src:r.URI}).appendTo(u).css("margin-top",2),o=n("<figcaption/>",{html:r.Caption}).appendTo(u);return r.ImageWidth&&e.css("width",r.ImageWidth),u}return null};t.f.taxonTag=function(n){return n.replace(/[\/|&;$%@"<>()+:.,' ]/g,"")};t.f.copyTextToClipboard=function(n){var t=document.createElement("textarea"),i,r;t.value=n;document.body.appendChild(t);t.select();try{i=document.execCommand("copy");r=i?"successful":"unsuccessful";console.log("Copying text "+r)}catch(u){console.log("Oops, unable to copy text")}document.body.removeChild(t)};t.f.createViewURL=function(n){var i=window.location.href.split("tbv=")[0],r=i.indexOf("?")==-1?"?":"&",u=encodeURI(i+r+"tbv=&"+n.join("&"));t.f.copyTextToClipboard(u)};t.f.selectElementText=function(n,t){t=t||window;var r=t.document,u,i;t.getSelection&&r.createRange?(u=t.getSelection(),i=r.createRange(),i.selectNodeContents(n),u.removeAllRanges(),u.addRange(i)):r.body.createTextRange&&(i=r.body.createTextRange(),i.moveToElementText(n),i.select())};t.f.checkInterface=function(n,i,r){function u(t,i,r){for(var f in i)i.hasOwnProperty(f)&&(r[f]?(console.log("%cInterface: "+n+t+"."+f+" found.","color: grey"),typeof i[f]=="object"&&u(t+"."+f,i[f],r[f])):console.log("%cInterface warning: "+n+t+"."+f+" not found in "+n,"color: red"))}t.opts.devel&&u("",i,r)}}(jQuery,this.tombiovis);