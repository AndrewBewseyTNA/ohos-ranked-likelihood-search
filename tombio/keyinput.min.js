(function(n,t){"use strict";function i(){var i=n("input[name=charvisibility]:checked").val();n(".cloneInput .stateselect, .cloneInput .statespinner").each(function(){var u=n(this).attr("id"),r;typeof u!="undefined"&&(i=="visible"?n(this).parents(".cloneInput").show(500,t.f.resizeControlsAndTaxa):(r=n(this).val(),r&&r!=""?n(this).parents(".cloneInput").show(500,t.f.resizeControlsAndTaxa):n(this).parents(".cloneInput").hide(500,t.f.resizeControlsAndTaxa)))})}function r(r){var u=n("#"+r).pqSelect({multiplePlaceholder:"select option(s)",singlePlaceholder:"select option",checkbox:!0,search:!1,maxDisplay:20,width:240,selectallText:""});u.addClass("stateselect");u.on("change",function(){var e,f,o,h,s;e=r.substring(0,6)=="clone-"?r.substring(6):"clone-"+r;n("#"+e).val(u.val());n("#"+e).pqSelect("refreshData");n("#"+r).pqSelect("refresh");i();f=r.substring(0,6)=="clone-"?r.substring(6):r;o=u.val()!=null&&u.val()!="";t.d.oCharacters[f].stateSet=o;o?(h=typeof u.val()=="string"?[u.val()]:u.val(),s=[],t.d.oCharacters[f].CharacterStateValues.forEach(function(n,t){h.indexOf(n)>-1&&s.push(t)}),t.d.oCharacters[f].userInput=s):t.d.oCharacters[f].userInput=null;[r,e].forEach(function(i){var r=n("#"+i).next().children().find(".pq-select-item-text");r.attr("title",function(){var r=this,i=t.d.values.filter(function(t){if(t.Character==f&&t.CharacterState==n(r).text())return!0});return i.length==1?i[0].StateHelpShort?i[0].StateHelpShort:i[0].StateHelp:""});r.tooltip({track:!0})});t.f.refreshVisualisation()});u.val(n("#"+r+" option:first").val()).pqSelect("refreshData");u.val("").pqSelect("refreshData")}function u(r,u,f,e){var h=this,o=n("#"+r).spinner({min:u,max:f,step:e}),s;o.addClass("statespinner");o.on("spinstop",function(){var e=o.spinner("value"),s,u,f;r.substring(0,6)=="clone-"?(s=!0,u=r.substring(6)):(s=!1,u="clone-"+r);n("#"+u).spinner("value",e);f=r.substring(0,6)=="clone-"?r.substring(6):r;t.d.oCharacters[f].stateSet=!0;t.d.oCharacters[f].userInput=e;t.f.refreshVisualisation();i()});s=n("#"+r+"-clear").button({icon:"ui-icon-close",showLabel:!1});s.on("click",function(){var f,i,u;o.spinner("value","");r.substring(0,6)=="clone-"?(f=!0,i=r.substring(6)):(f=!1,i="clone-"+r);n("#"+i).spinner("value",o.spinner("value"));u=r.substring(0,6)=="clone-"?r.substring(6):r;t.d.oCharacters[u].stateSet=!1;t.d.oCharacters[u].userInput=null;t.f.refreshVisualisation()})}function f(i){var r=n("<div>"),u,f;n("<h3/>",{text:t.d.oCharacters[i].Label}).appendTo(r);n("<p/>",{html:t.d.oCharacters[i].Help}).appendTo(r);u=t.d.media.filter(function(n){if((n.Type=="image-local"||n.Type=="image-web")&&n.Character==i&&!n.State){if(n.UseFor){var t=!1;return n.UseFor.split(",").forEach(function(n){n.toLowerCase().trim()=="full"&&(t=!0)}),t}return!0}}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});u.forEach(function(t,i){var e=n("<figure/>").appendTo(r),u,f;e.addClass("helpFigure");u=n("<img/>",{src:t.URI});f=n("<figcaption/>",{html:t.Caption});e.append(u).append(f);i>0&&u.css("margin-top",10);f.appendTo(r);t.ImageWidth&&u.css("width",t.ImageWidth)});f=t.d.values.filter(function(n){if(n.Character==i&&n.StateHelp)return!0});f.forEach(function(u){var e,f,o,s,h;e=u.CharacterStateTranslation&&u.CharacterStateTranslation!=""?u.CharacterStateTranslation:u.CharacterState;f=n("<p/>").appendTo(r);o=n("<span/>",{text:e+": "}).css("font-weight","Bold");f.append(o);s=n("<span/>",{html:u.StateHelp}).css("font-weight","Normal");f.append(s);h=t.d.media.filter(function(n){if((n.Type=="image-local"||n.Type=="image-web")&&n.Character==i&&n.State==u.CharacterState)return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});h.forEach(function(t,i){var u=n("<img/>",{src:t.URI}),f=n("<figcaption/>",{html:t.Caption});u.appendTo(r);i>0&&u.css("margin-top",10);f.appendTo(r);t.ImageWidth&&u.css("width",t.ImageWidth)})});t.gui.main.dialog("Character help & info",r.html())}t.gui.keyInput={width:360,otherState:{keys:[]},bullet:"",inputCharGroups:[],verticalTabSpace:33};t.gui.keyInput.init=function(e){var b=this,h,vt,v,s,c,d,w,y,a,p,ct,lt,rt,at,ut;n("<div>").attr("id","tombioKeyInputTabs").css("background-color","rgba( 255,255, 255, 0.7)").appendTo(e);n("<ul>").attr("id","tombioKeyInputListElements").appendTo("#tombioKeyInputTabs");t.gui.keyInput.divSel="#tombioKeyInputTabs";h={All:[]};vt={};t.d.characters.forEach(function(n){n.Status=="key"&&(h[n.Group]||(h[n.Group]=[],b.inputCharGroups.push(n.Group)),h[n.Group].push(n))});n(t.gui.main.divInput).css("min-height",this.verticalTabSpace*(this.inputCharGroups.length+2));for(v in h){var k="tombioKeyInputTab-"+v.replace(/\s+/g,"-"),ft=n("<li/>"),yt=n("<a/>").text(v).attr("href","#"+k);if(ft.append(yt),n("#tombioKeyInputListElements").append(ft),s=n("<div/>").attr("id",k),n("#tombioKeyInputTabs").append(s),k=="tombioKeyInputTab-All"){s.append(n("<div>").text("Un-used characters:").css("font-weight","bold"));c=n("<fieldset>").attr("id","visCheckboxes").css("display","inline-block").css("padding","0px").css("border","none");c.append(n("<label>").attr("for","charvisible").text("show"));c.append(n("<input>").attr("type","radio").attr("name","charvisibility").attr("id","charvisible").attr("value","visible").attr("checked","checked"));c.append(n("<label>").attr("for","incharvisible").text("hide"));c.append(n("<input>").attr("type","radio").attr("name","charvisibility").attr("id","incharvisible").attr("value","invisible"));s.append(c);n("[name='charvisibility']").checkboxradio({icon:!1});c.on("change",i);d=n("<button>").attr("id","tombioReset").text("Reset all");d.button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(){n(".statespinner").spinner("value","");n(".stateselect").each(function(){n(this).val()&&n(this).val("").pqSelect("refreshData")});t.d.characters.forEach(function(n){n.stateSet=!1;n.userInput=null});t.f.refreshVisualisation();i()});s.append(d)}for(w=0;w<h[v].length;w++){var o=h[v][w],g=n("<span/>").attr("class","characterlabel").text(o.Label),et=n("<div/>").append(g);if(s.append(et),t.f.characterHasHelp(o.Character)&&(g.attr("character",o.Character),g.addClass("characterhelp")),y=n("<div/>").attr("class","cloneInput"),y.append(et.clone()),n("#tombioKeyInputTab-All").css("display","inline-block").append(y),o.ValueType=="numeric"){var l=o.Character,nt=o.Params.split(","),ot=Number(nt[0]),st=Number(nt[1]),ht=Number(nt[2]),tt=n("<div>"),pt=n("<input><\/input>").attr("class","spinner").attr("id",l),wt=n("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id",l+"-clear");tt.append(pt);tt.append(wt);s.append(tt);u(l,ot,st,ht);var it=n("<div>"),bt=n("<input><\/input>").attr("class","spinner").attr("id","clone-"+l),kt=n("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id","clone-"+l+"-clear");it.append(bt);it.append(kt);y.append(it);u("clone-"+l,ot,st,ht)}else a=o.Character,p=o.ControlType=="multi"?n("<select multiple=multiple><\/select>").attr("class","characterSelect"):n("<select><\/select>").attr("class","characterSelect"),p.attr("id",a),s.append(p),o.ControlType=="single"&&(ct=n("<option/>").text(""),p.append(ct)),lt=o.CharacterStateValues,lt.forEach(function(t){var i=n("<option/>").text(b.bullet+t);p.append(i)}),r(a),rt=n("#"+a).clone(),rt.attr("id","clone-"+a),y.append(rt),r("clone-"+a)}}t.d.oCharacters.grouped||(n("#tombioKeyInputListElements").css("display","none"),n("#tombioKeyInputTabs").css("padding-left","0px"),t.gui.keyInput.width=255);at=n("#tombioKeyInputTabs").tabs({activate:function(){n(".stateselect").each(function(){});t.f.resizeControlsAndTaxa()}});t.opts.toolconfig.keyinput||(t.opts.toolconfig.keyinput={});typeof t.opts.toolconfig.keyinput.selectedGroup=="undefined"&&(t.opts.toolconfig.keyinput.selectedGroup=typeof t.opts.selectedGroup=="undefined"?t.d.kbconfig.defaultControlGroup?t.d.kbconfig.defaultControlGroup:null:t.opts.selectedGroup?t.opts.selectedGroup:null);t.opts.toolconfig.keyinput.selectedGroup&&(ut=b.inputCharGroups.indexOf(t.opts.toolconfig.keyinput.selectedGroup),ut>-1&&at.tabs("option","active",ut+1));n(".characterhelp").hover(function(){n(this).animate({color:"#D55E00"},"fast")},function(){n(this).animate({color:"black"},"fast")}).click(function(){f(n(this).attr("character"))});t.gui.main.createCharacterTooltips(".characterhelp");t.f.checkInterface("keyInput",t.templates.gui.keyInput,t.gui.keyInput)};t.gui.keyInput.initFromCharacterState=function(){t.d.characters.forEach(function(t){var i,r,u;if(t.ControlType==="spin"){var i=n("#"+t.Character+".statespinner"),r=n("#clone-"+t.Character+".statespinner"),f=t.stateSet?t.userInput:"";i.spinner("value",t.userInput);r.spinner("value",f)}else i=n("#"+t.Character+".stateselect"),r=n("#clone-"+t.Character+".stateselect"),u=t.stateSet?t.userInput.map(function(n){return t.CharacterStateValues[n]}):[],i.val(u).pqSelect("refreshData"),r.val(u).pqSelect("refreshData")})};t.gui.keyInput.initStateFromParams=function(t){this.initFromCharacterState();n("#tombioKeyInputTabs").tabs("option","active",t.grp);n("[name='charvisibility']").removeProp("checked").filter('[value="'+t.cvis+'"]').prop("checked",!0);n("[name='charvisibility']").checkboxradio("refresh");i()};t.gui.keyInput.setParamsFromState=function(t){return t.push("grp="+n("#tombioKeyInputTabs").tabs("option","active")),t.push("cvis="+n("input[name=charvisibility]:checked").val()),t}})(jQuery,this.tombiovis.templates.loading?this.tombiovis.templates:this.tombiovis);