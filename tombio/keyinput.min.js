(function(n,t){"use strict";function i(){var i=n("input[name=charvisibility]:checked").val();n(".cloneInput .stateselect, .cloneInput .statespinner").each(function(){var u=n(this).attr("id"),r;typeof u!="undefined"&&(i=="visible"?n(this).parents(".cloneInput").show(500,t.f.resizeControlsAndTaxa):(r=n(this).val(),r&&r!=""?n(this).parents(".cloneInput").show(500,t.f.resizeControlsAndTaxa):n(this).parents(".cloneInput").hide(500,t.f.resizeControlsAndTaxa)))})}function r(r){var u=n("#"+r).pqSelect({multiplePlaceholder:"select option(s)",singlePlaceholder:"select option",checkbox:!0,search:!1,maxDisplay:20,width:240,selectallText:""});u.addClass("stateselect");u.on("change",function(){var e,f,o,s;e=r.substring(0,6)=="clone-"?r.substring(6):"clone-"+r;n("#"+e).val(u.val());n("#"+e).pqSelect("refreshData");n("#"+r).pqSelect("refresh");i();f=r.substring(0,6)=="clone-"?r.substring(6):r;o=u.val()!=null&&u.val()!="";t.d.oCharacters[f].stateSet=o;o?(s=[],t.d.oCharacters[f].CharacterStateValues.forEach(function(n,t){u.val().indexOf(n)>-1&&s.push(t)}),t.d.oCharacters[f].userInput=s):t.d.oCharacters[f].userInput=null;[r,e].forEach(function(i){var r=n("#"+i).next().children().find(".pq-select-item-text");r.attr("title",function(){var r=this,i=t.d.values.filter(function(t){if(t.Character==f&&t.CharacterState==n(r).text())return!0});return i.length==1?i[0].StateHelpShort?i[0].StateHelpShort:i[0].StateHelp:""});r.tooltip({track:!0})});t.f.refreshVisualisation()});u.val(n("#"+r+" option:first").val()).pqSelect("refreshData");u.val("").pqSelect("refreshData")}function u(r,u,f,e){var h=this,o=n("#"+r).spinner({min:u,max:f,step:e}),s;o.addClass("statespinner");o.on("spinstop",function(){var u=o.spinner("value"),s,f,e;r.substring(0,6)=="clone-"?(s=!0,f=r.substring(6)):(s=!1,f="clone-"+r);n("#"+f).spinner("value",u);e=r.substring(0,6)=="clone-"?r.substring(6):r;t.d.oCharacters[e].stateSet=!0;t.d.oCharacters[e].userInput=u;console.log(u);t.f.refreshVisualisation();i()});s=n("#"+r+"-clear").button({icon:"ui-icon-close",showLabel:!1});s.on("click",function(){var f,i,u;o.spinner("value","");r.substring(0,6)=="clone-"?(f=!0,i=r.substring(6)):(f=!1,i="clone-"+r);n("#"+i).spinner("value",o.spinner("value"));u=r.substring(0,6)=="clone-"?r.substring(6):r;t.d.oCharacters[u].stateSet=!1;t.d.oCharacters[u].userInput=null;t.f.refreshVisualisation()})}function f(i){var h=n("<div/>"),c=!1,o,r,s,v,k,f,w,e;t.d.oCharacters[i].HelpShort&&t.d.oCharacters[i].HelpShort!=""?(o=t.d.oCharacters[i].HelpShort,c=!0):o=t.d.oCharacters[i].Help;var b=t.d.media.filter(function(n){if((n.Type=="image-local"||n.Type=="image-web")&&n.Character==i)return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)}),u,l=0,a=0;if(b.forEach(function(n){var t=!1,i=!1;n.UseFor?n.UseFor.split(",").forEach(function(r){r.toLowerCase().trim()=="tip"&&(i=n.State?!1:!0);r.toLowerCase().trim()=="full"&&(t=!0)}):(i=n.State?!1:!0,t=!0);i&&!u?u=n:t&&l++;t&&a++}),s=!1,u&&(r=n("<figure/>"),r.addClass("keyInputHelpFigure"),v=n("<img/>",{src:u.URI}).appendTo(r).css("margin-top",2),u.ImageWidth&&v.css("width",u.ImageWidth),k=n("<figcaption/>",{html:u.Caption}).appendTo(r),u.TipStyle&&u.TipStyle!="")){var y=u.TipStyle.split("-"),p=y[0],d=y[1];r.css("width",d+"%");r.css("float",p);r.css("margin-bottom",5);p=="right"?r.css("margin-left",5):r.css("margin-right",5);s=!0}return f=[],s&&f.push(r),o.length>0&&f.push(n("<span/>").html(o)),!s&&r&&f.push(r),f.forEach(function(n){h.append(n)}),w=t.d.values.filter(function(n){if(n.Character==i&&n.StateHelp)return!0}),e="",c||l>0||w.length>0?e="(Click for <b>more detailed help<\/b>.)":u&&a>0&&(e="(Click for resizeable help window.)"),e&&n("<div/>").css("margin-top",5).css("font-weight","normal").html(e).appendTo(h),h}function e(i){var r,u;n("#tombioKeyInputDialog").html("");n("<h3/>",{text:t.d.oCharacters[i].Label}).appendTo("#tombioKeyInputDialog");n("<p/>",{html:t.d.oCharacters[i].Help}).appendTo("#tombioKeyInputDialog");r=t.d.media.filter(function(n){if((n.Type=="image-local"||n.Type=="image-web")&&n.Character==i&&!n.State){if(n.UseFor){var t=!1;return n.UseFor.split(",").forEach(function(n){n.toLowerCase().trim()=="full"&&(t=!0)}),t}return!0}}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});r.forEach(function(t,i){var f=n("<figure/>").appendTo("#tombioKeyInputDialog"),r,u;f.addClass("helpFigure");r=n("<img/>",{src:t.URI});u=n("<figcaption/>",{html:t.Caption});f.append(r).append(u);i>0&&r.css("margin-top",10);u.appendTo("#tombioKeyInputDialog");t.ImageWidth&&r.css("width",t.ImageWidth)});u=t.d.values.filter(function(n){if(n.Character==i&&n.StateHelp)return!0});u.forEach(function(r){var f,u,e,o,s;f=r.CharacterStateTranslation&&r.CharacterStateTranslation!=""?r.CharacterStateTranslation:r.CharacterState;u=n("<p/>").appendTo("#tombioKeyInputDialog");e=n("<span/>",{text:f+": "}).css("font-weight","Bold");u.append(e);o=n("<span/>",{html:r.StateHelp}).css("font-weight","Normal");u.append(o);s=t.d.media.filter(function(n){if((n.Type=="image-local"||n.Type=="image-web")&&n.Character==i&&n.State==r.CharacterState)return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});s.forEach(function(t,i){var r=n("<img/>",{src:t.URI}),u=n("<figcaption/>",{html:t.Caption});r.appendTo("#tombioKeyInputDialog");i>0&&r.css("margin-top",10);u.appendTo("#tombioKeyInputDialog");t.ImageWidth&&r.css("width",t.ImageWidth)})});n("#tombioKeyInputDialog").dialog("option","title","Character help and information");n("#tombioKeyInputDialog").dialog("open")}t.gui.keyInput={bullet:"",inputCharGroups:[],helpAndInfoDialogWidth:550,helpAndInfoDialogHeight:400,verticalTabSpace:33};t.gui.keyInput.init=function(o){var k=this,c,yt,y,h,l,g,b,p,v,w,lt,at,ut,vt,ft;n("<div>").attr("id","tombioKeyInputDialog").css("display","none").appendTo(o);n("#tombioKeyInputDialog").dialog({modal:!1,width:this.helpAndInfoDialogWidth,height:this.helpAndInfoDialogHeight,resizable:!0,draggable:!0,autoOpen:!1,show:{effect:"highlight",duration:500},hide:{effect:"fade",duration:250}});n("<div>").attr("id","tombioKeyInputTabs").css("background-color","rgba( 255,255, 255, 0.7)").appendTo(o);n("<ul>").attr("id","tombioKeyInputListElements").appendTo("#tombioKeyInputTabs");t.gui.keyInput.$div=n("#tombioKeyInputTabs");c={All:[]};yt={};t.d.characters.forEach(function(n){n.Status=="key"&&(c[n.Group]||(c[n.Group]=[],k.inputCharGroups.push(n.Group)),c[n.Group].push(n))});n(t.gui.main.visControls).css("min-height",this.verticalTabSpace*(this.inputCharGroups.length+2));for(y in c){var d="tombioKeyInputTab-"+y.replace(/\s+/g,"-"),et=n("<li/>"),pt=n("<a/>").text(y).attr("href","#"+d);if(et.append(pt),n("#tombioKeyInputListElements").append(et),h=n("<div/>").attr("id",d),n("#tombioKeyInputTabs").append(h),d=="tombioKeyInputTab-All"){h.append(n("<div>").text("Un-used characters:").css("font-weight","bold"));l=n("<fieldset>").attr("id","visCheckboxes").css("display","inline-block").css("padding","0px").css("border","none");l.append(n("<label>").attr("for","charvisible").text("show"));l.append(n("<input>").attr("type","radio").attr("name","charvisibility").attr("id","charvisible").attr("value","visible").attr("checked","checked"));l.append(n("<label>").attr("for","incharvisible").text("hide"));l.append(n("<input>").attr("type","radio").attr("name","charvisibility").attr("id","incharvisible").attr("value","invisible"));h.append(l);n("[name='charvisibility']").checkboxradio({icon:!1});l.on("change",i);g=n("<button>").attr("id","tombioReset").text("Reset all");g.button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(){n(".statespinner").spinner("value","");n(".stateselect").each(function(){n(this).val()&&n(this).val("").pqSelect("refreshData")});t.d.characters.forEach(function(n){n.stateSet=!1;n.userInput=null});t.f.refreshVisualisation();i()});h.append(g)}for(b=0;b<c[y].length;b++){var s=c[y][b],nt=n("<span/>").attr("class","characterlabel").text(s.Label),ot=n("<div/>").append(nt);if(h.append(ot),t.f.characterHasHelp(s.Character)&&(nt.attr("character",s.Character),nt.addClass("characterhelp")),p=n("<div/>").attr("class","cloneInput"),p.append(ot.clone()),n("#tombioKeyInputTab-All").append(p),s.ValueType=="numeric"){var a=s.Character,tt=s.Params.split(","),st=Number(tt[0]),ht=Number(tt[1]),ct=Number(tt[2]),it=n("<div><\/div>"),wt=n("<input><\/input>").attr("class","spinner").attr("id",a),bt=n("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id",a+"-clear");it.append(wt);it.append(bt);h.append(it);u(a,st,ht,ct);var rt=n("<div><\/div>"),kt=n("<input><\/input>").attr("class","spinner").attr("id","clone-"+a),dt=n("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id","clone-"+a+"-clear");rt.append(kt);rt.append(dt);p.append(rt);u("clone-"+a,st,ht,ct)}else v=s.Character,w=s.ControlType=="multi"?n("<select multiple=multiple><\/select>").attr("class","characterSelect"):n("<select><\/select>").attr("class","characterSelect"),w.attr("id",v),h.append(w),s.ControlType=="single"&&(lt=n("<option/>").text(""),w.append(lt)),at=s.CharacterStateValues,at.forEach(function(t){var i=n("<option/>").text(k.bullet+t);w.append(i)}),r(v),ut=n("#"+v).clone(),ut.attr("id","clone-"+v),p.append(ut),r("clone-"+v)}}t.d.oCharacters.grouped||(n("#tombioKeyInputListElements").css("display","none"),n("#tombioKeyInputTabs").css("padding-left","0px"));vt=n("#tombioKeyInputTabs").tabs({activate:function(){n(".stateselect").each(function(){});t.f.resizeControlsAndTaxa()}});t.opts.toolconfig.keyinput||(t.opts.toolconfig.keyinput={});typeof t.opts.toolconfig.keyinput.selectedGroup=="undefined"&&(t.opts.toolconfig.keyinput.selectedGroup=typeof t.opts.selectedGroup=="undefined"?t.d.kbconfig.defaultControlGroup?t.d.kbconfig.defaultControlGroup:null:t.opts.selectedGroup?t.opts.selectedGroup:null);t.opts.toolconfig.keyinput.selectedGroup&&(ft=k.inputCharGroups.indexOf(t.opts.toolconfig.keyinput.selectedGroup),ft>-1&&vt.tabs("option","active",ft+1));n(".characterhelp").hover(function(){n(this).animate({color:"#D55E00"},"fast")},function(){n(this).animate({color:"black"},"fast")}).tooltip({track:!0,items:"span",content:function(){return f(n(this).attr("character"))}}).click(function(){e(n(this).attr("character"))})};t.gui.keyInput.initFromCharacterState=function(){t.d.characters.forEach(function(t){var i,r,u;if(t.ControlType==="spin"){var i=n("#"+t.Character+".statespinner"),r=n("#clone-"+t.Character+".statespinner"),f=t.stateSet?t.userInput:"";i.spinner("value",t.userInput);r.spinner("value",f)}else i=n("#"+t.Character+".stateselect"),r=n("#clone-"+t.Character+".stateselect"),u=t.stateSet?t.userInput.map(function(n){return t.CharacterStateValues[n]}):[],i.val(u).pqSelect("refreshData"),r.val(u).pqSelect("refreshData")})};t.gui.keyInput.initStateFromParams=function(t){this.initFromCharacterState();n("#tombioKeyInputTabs").tabs("option","active",t.grp);n("[name='charvisibility']").removeProp("checked").filter('[value="'+t.cvis+'"]').prop("checked",!0);n("[name='charvisibility']").checkboxradio("refresh");i()};t.gui.keyInput.setParamsFromState=function(t){return t.push("grp="+n("#tombioKeyInputTabs").tabs("option","active")),t.push("cvis="+n("input[name=charvisibility]:checked").val()),t};t.gui.keyInput.otherState={keys:[]}})(jQuery,this.tombiovis);