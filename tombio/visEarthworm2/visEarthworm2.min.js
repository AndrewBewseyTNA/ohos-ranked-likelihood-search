(function(n,t){"use strict";function f(n,t){return n.sort(function(n,i){var r=n.visState.visEarthworm2.segdiffTotal,u=i.visState.visEarthworm2.segdiffTotal;return u>r?-1:r>u?1:u==r?n.visState.visEarthworm2[t]>i.visState.visEarthworm2[t]?1:-1:void 0})}function e(){var n=[];n.push("selectedTool="+u);Array.prototype.push.apply(n,t.f.setParamsFromControls());t.f.createViewURL(n)}function o(n,t){var i,r;if(n==""||n==null||String(t)=="")return null;if(String(t)=="n/a")return n;if(String(t).indexOf("[")===0)var f=t.substr(1,t.length-2),u=f.split("-"),i=Number(u[0]),r=Number(u[1]);else i=Number(t),r=Number(t);return n<i?i-n:n>r?n-r:0}function s(n,t){var i,r;if(n==""||n==null||String(t)=="")return null;if(String(t).indexOf("[")===0)var f=t.substr(1,t.length-2),u=f.split("-"),i=Number(u[0]),r=Number(u[1]);else i=Number(t),r=Number(t);return n<i?(i-n)/n<1?(i-n)/n:.48:n>r?(n-r)/n<1?(n-r)/n:.48:0}function h(n,t){var r=d3.select(this),u=d3.select(this.parentNode).select("text");u.style("opacity","1").attr("x",Number(r.attr("cx"))).attr("y",Number(r.attr("cy"))+4);r.attr("oR",r.attr("r"));r.attr("r",function(){var u=i.scoreChars[t];return n.visState.visEarthworm2.scores[u.Character]!=null?u.EsbScoreType=="segnum"?Number(r.attr("r"))+i.taxspace:Number(Number(r.attr("r"))):Number(Number(r.attr("r")))}).attr("cursor",function(){var r=i.scoreChars[t];return n.visState.visEarthworm2.scores[r.Character]!=null?r.EsbScoreType=="segnum"?"none":"auto":"auto"})}function c(){var n=d3.select(this),t=d3.select(this.parentNode).select("text");n.attr("r",Number(n.attr("oR")));t.style("opacity","0")}function l(i){n("#tombioEsbNbnLogo").attr("src",t.opts.tombiopath+"/visEarthworm2/resources/nbn-logo-centred.png").addClass("tombioEsbSpiningNbn");n("#tombioEsbNbnLoading").show();var r="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+i+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100";n("#tombioEsbMapDiv").html("<img id='tombioEsbPopupMap' width='100%' />");n("#tombioEsbPopupMap").on("load",function(){n("#tombioEsbNbnLogo").attr("src",t.opts.tombiopath+"/visEarthworm2/resources/nbn-logo-colour-centred.png").removeClass("tombioEsbSpiningNbn");n("#tombioEsbNbnLoading").hide()}).attr("src",r)}var u="visEarthworm2",r=t.v.visualisations[u]=Object.create(t.v.visP),i;r.initialise=function(){var o,s,h,u,c,a,v,r,f,e;i=this;this.metadata.title="Bespoke earthworm key";this.metadata.authors="Rich Burkmar";this.metadata.year="2018";this.metadata.publisher="Field Studies Council";this.metadata.location="Preston Montford";this.metadata.contact="richardb@field-studies-council.org";this.metadata.version="4.0";this.taxwidth=205;this.taxheight=32;this.taxspace=5;this.taxexpanded=null;this.delay=200;this.indrad=6;this.imagedim=12;this.inputControl=Object.create(t.gui.keyInputEarthworm);this.inputControl.init(n(t.gui.main.divInput));this.helpFiles=[t.opts.tombiopath+"visEarthworm2/visEarthwormHelp2.html"];o=n("<div>").appendTo(n("#"+this.visName));s=n("<div>").attr("id","tombioEsbHeaderTaxa").appendTo(o);s.html('<span id="tombioEsbCandidateTaxa">Possible species  <span class="tombioEsbConfidenceLevel" id="tombioEsbConfidenceLevelButton">!<\/span><\/span><span id="tombioEsbExcludedTaxa">Unlikely species<\/span>');
//!!!Important lesson here. The first method of creating the SVG creates an element in which 
//!!!text items do not position correctly. So always use the D3 method to create SVG.
for(v=d3.select("#"+this.visName).append("svg").attr("id","tombioEsbMultiaccess"),n("#tombioEsbHeaderTaxa").css("width",this.taxspace*3+this.taxwidth*2),n("#tombioEsbCandidateTaxa").css("left",this.taxspace*1),n("#tombioEsbExcludedTaxa").css("left",this.taxspace*2+this.taxwidth),n.get(t.opts.tombiopath+"/visEarthworm2/confidence.html?ver="+t.opts.tombiover,function(r){var u=n("<div>").appendTo(n("#"+i.visName));u.html(r.replace(/##tombiopath##/g,t.opts.tombiopath));n("#tombioEsbConfidenceLevelButton").click(function(){var t=i.scoreChars.filter(function(n){return n.stateSet}).length;n("#tombioEsbCharCount").html(i.scoreChars.length);n("#tombioEsbCharUsed").html(t);n("#tombioEsbConfidenceDialog").dialog("open")});n("#tombioEsbConfidenceDialog").dialog({title:"Identification confidence",autoOpen:!1,modal:!0,width:410,height:450,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}})}),n("<div>").attr("id","tombioEsbPopup").appendTo(n("#"+i.visName)),n("<div>").attr("id","tombioEsbPopupTabs").appendTo(n("#tombioEsbPopup")),u=n("<ul>").appendTo(n("#tombioEsbPopupTabs")),c=n("<li>").appendTo(u),n("<a>").attr("href","#tombioEsbPopupTabs1").text("Map").appendTo(c),a=n("<li>").appendTo(u),n("<a>").attr("href","#tombioEsbPopupTabs2").text("Information").appendTo(a),n("<div>").attr("id","tombioEsbPopupTabs1").appendTo(n("#tombioEsbPopupTabs")),n("<div>").attr("id","tombioEsbMapDiv").appendTo(n("#tombioEsbPopupTabs1")),n("<img>").attr("id","tombioEsbNbnLogo").appendTo(n("#tombioEsbPopupTabs1")),n("<div>").attr("id","tombioEsbNbnLoading").text("Loading distribution map from NBN...").appendTo(n("#tombioEsbPopupTabs1")),n("<div>").attr("id","tombioEsbPopupTabs2").appendTo(n("#tombioEsbPopupTabs")),n("<div>").attr("id","tombioEsbSpInfo").appendTo(n("#tombioEsbPopupTabs2")),h=n("<a>").attr("target","_blank").attr("href","http://www.field-studies-council.org/publications/pubs/earthworms.aspx").appendTo(n("#tombioEsbPopupTabs2")),n("<img>").attr("src",t.opts.tombiopath+"/visEarthworm2/resources/sherlock.png").css("float","left").css("width","120px").css("padding","0 10px 10px 0").appendTo(h),n("<p>").html('More information on the morphology and ecology of <i><span id="tombioEsbInfoSpName"><\/span><\/i>can be found in Emma Sherlock\'s FSC AIDGAP publication,<a href="http://www.field-studies-council.org/publications/pubs/earthworms.aspx" target="_blank"> <span class="tombioEsbBooklink">Key to the earthworms of UK and Ireland<\/span><\/a>, on <b>pages <span id="tombioEsbInfoSpAccount"><\/span> (species account) and <span id="tombioEsbInfoSpTable"><\/span> (species comparison chart)<\/b>.(The knowledge base behind this visualisation is drawn from Emma Sherlock\'s key.)').appendTo(n("#tombioEsbPopupTabs2")),n("<p>").html('Additional information can be found in the Linnean Society synopsis,<a href="http://www.field-studies-council.org/publications/pubs/earthworms-synopsis.aspx" target="_blank"> <span class="tombioEsbBooklink">Earthworms<\/span><\/a>, by Sims and Gerard, also published by FSC.').appendTo(n("#tombioEsbPopupTabs2")),n("#tombioEsbPopup").dialog({autoOpen:!1,width:410,height:610,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}}),n("#tombioEsbPopup").parent().find(".ui-dialog-title").css("font-style","italic"),n("#tombioEsbPopupTabs").tabs(),this.scoreChars=[],t.d.characters.filter(function(n){return n.EsbKeyOrder}).sort(function(n,t){return n.EsbKeyOrder-t.EsbKeyOrder}).forEach(function(n){i.scoreChars.push(n)}),this.displayChars=[],t.d.characters.filter(function(n){return n.EsbKeyOrder||n.EsbColourParams}).sort(function(n,t){return n.EsbKeyOrder&&t.EsbKeyOrder?n.EsbKeyOrder-t.EsbKeyOrder:n.EsbKeyOrder&&!t.EsbKeyOrder?-1:!n.EsbKeyOrder&&t.EsbKeyOrder?1:n.EsbColourParams.split(" ")[0]-t.EsbColourParams.split(" ")[0]}).forEach(function(n){i.displayChars.push(n)}),this.taxexpanded=(this.displayChars.length+1)*2*(this.indrad+this.taxspace),t.d.taxa.forEach(function(n){n.visState.visEarthworm2.scores={};i.scoreChars.forEach(function(t){n.visState.visEarthworm2.scores[t.Character]=null});n.visState.visEarthworm2.x=0;n.visState.visEarthworm2.y=0;n.visState.visEarthworm2.height=i.taxheight}),v=d3.select("#tombioEsbMultiaccess"),this.worms=d3.select("#tombioEsbMultiaccess").selectAll(".tombioEsbWorm").data(t.d.taxa).enter().append("g").attr("x",0).attr("class","tombioEsbWorm").on("click",function(n){n.visState.visEarthworm2.height=n.visState.visEarthworm2.height==i.taxheight?i.taxexpanded:i.taxheight;i.refresh()}),this.worms.append("rect").attr("x",0).attr("y",0).attr("rx",5).attr("ry",5).attr("height",this.taxheight).attr("width",this.taxwidth),this.worms.append("text").attr("x",0).attr("y",0).attr("class","tombioEsbScientificnames").style("opacity",0).text(function(n){return n.Taxon.kbValue}),r=0;r<this.displayChars.length;r++)this.worms.append("text").attr("x",0).attr("y",0).attr("class","tombioEsbCharactervalue").style("opacity",0).attr("pointer-events","none").text(function(n){return i.displayChars[r].Label+": "+n[i.displayChars[r].Character].toString()});this.worms.append("image").attr("x",0).attr("y",0).attr("width",this.imagedim).attr("height",this.imagedim).style("opacity",0).attr("xlink:href",t.opts.tombiopath+"/visEarthworm2/resources/info20.png").attr("class","tombioEsbInfoimage").attr("id",function(n,t){return"tombioEsbInfoimage-"+t}).on("click",function(t){n(this).css("opacity")>0&&(d3.event.stopPropagation(),n("#tombioEsbPopup").dialog("open"),n("#tombioEsbPopupTitleText").html(t.Taxon.kbValue),n("#tombioEsbInfoSpName").html(t.Taxon.kbValue),n("#tombioEsbInfoSpAccount").html(t.AccountPage.kbValue),n("#tombioEsbInfoSpTable").html(t.TablePage.kbValue),n("#tombioEsbPopup").dialog("option","title",t.Taxon.kbValue),l(t.TVK.kbValue))});for(r=1;r<=this.scoreChars.length;r++)f=this.scoreChars[r-1],e=this.worms.append("g").attr("class","tombioEsbIndg"),e.append("circle").attr("class","tombioEsbIndicator"+r).attr("cx",0).attr("cy",0).attr("r",function(){return f.EsbScoreType=="redline"?i.indrad:f.EsbScoreType=="segnum"?i.indrad*.8:i.indrad*.6}),e.append("text").attr("pointer-events","none").attr("class","tombioEsbIndText");d3.select("#tombioEsbMultiaccess").style("width",this.taxwidth*2+this.taxspace*3)};r.refresh=function(){var nt,it,l,u,r,p,a,v,y,w,b,k,d;for(t.gui.main.contextMenu.addItem("Get URL for earthworm key",function(){e()},!1,[this.visName]),nt=this.scoreChars.filter(function(n){return n.stateSet}).length,nt>0?n("#tombioEsbConfidenceLevelButton").show():n("#tombioEsbConfidenceLevelButton").hide(),it=d3.scaleLinear().domain([0,this.scoreChars.length/2,this.scoreChars.length]).range(t.d.scoreColours),n(".tombioEsbConfidenceLevel").css("background",it(nt)),l=[],u=[],t.d.taxa.forEach(function(n){n.visState.visEarthworm2.redlineTotal=0;n.visState.visEarthworm2.segdiffTotal=0;i.scoreChars.forEach(function(t){t.EsbScoreType=="redline"&&(t.userInput&&n[t.Character].kbValue==t.CharacterStateValues[t.userInput]?n.visState.visEarthworm2.scores[t.Character]=0:t.userInput?(n.visState.visEarthworm2.scores[t.Character]=100,n.visState.visEarthworm2.redlineTotal+=100):n.visState.visEarthworm2.scores[t.Character]=null);t.EsbScoreType=="segnum"&&(n.visState.visEarthworm2.scores[t.Character]=o(t.userInput,n[t.Character].kbValue),n.visState.visEarthworm2.segdiffTotal+=n.visState.visEarthworm2.scores[t.Character]);t.EsbScoreType=="size"&&(n.visState.visEarthworm2.scores[t.Character]=s(t.userInput,n[t.Character].kbValue))});n.visState.visEarthworm2.redlineTotal>0?u.push(n):n.visState.visEarthworm2.segdiffTotal>i.inputControl.otherState.tolerance?u.push(n):l.push(n)}),f(l,"lastPosInTaxain"),f(u,"lastPosInTaxaout"),r=0;r<l.length;r++)l[r].visState.visEarthworm2.lastPosInTaxain=r,l[r].visState.visEarthworm2.lastPosInTaxaout=r-100;for(r=0;r<u.length;r++)u[r].visState.visEarthworm2.lastPosInTaxaout=r,u[r].visState.visEarthworm2.lastPosInTaxain=100+r;for(p=0,r=0;r<l.length;r++)l[r].visState.visEarthworm2.x=this.taxspace,l[r].visState.visEarthworm2.y=p+this.taxspace,p=l[r].visState.visEarthworm2.y+l[r].visState.visEarthworm2.height;for(p=0,r=0;r<u.length;r++)u[r].visState.visEarthworm2.x=this.taxwidth+2*this.taxspace,u[r].visState.visEarthworm2.y=p+this.taxspace,p=u[r].visState.visEarthworm2.y+u[r].visState.visEarthworm2.height;a=t.v.visualisations.visEarthworm2.inputControl.otherState.colourby;a&&(v=t.d.oCharacters[a].EsbColourParams.split(" ")[1],v=="number"||v=="log"?(w=t.d.oCharacters[a].minVal,b=t.d.oCharacters[a].maxVal,v=="log"&&(w=Math.log(w),b=Math.log(b)),y=d3.scaleLinear().domain([w,b]).range(["yellow","blue"])):(v=="default"||v=="specified")&&(v=="default"?(k=t.d.oCharacters[a].CharacterStateValues,d=t.d.oCharacters[a].CharacterStateValues.length<=10?d3.schemeCategory10:d3.schemeCategory20):(k=[],d=[],t.d.values.filter(function(n){return n.Character==a}).forEach(function(n){k.push(n.CharacterState);d.push(n.EsbColour.replace("*","#"))})),y=d3.scaleOrdinal().domain(k).range(d)));t.d.taxa.forEach(function(n){var f,t,i,r,u;if(a){if(n[a].kbValue=="")n.visState.visEarthworm2.fill="lightgrey";else if(v=="number"||v=="log")if(t=n[a].kbValue.trim(),t.startsWith("[")){t=t.substr(1,t.length-2);var i=t.split("-"),r=Number(i[0].trim()),u=Number(i[1].trim());v=="log"&&(r=Math.log(r),u=Math.log(u));f="url(#"+e(r,u,y)+")";console.log("Gradient name: ",f);n.visState.visEarthworm2.fill=f}else n.visState.visEarthworm2.fill=y(n[a].kbValue);else(v=="default"||v=="specified")&&(t=n[a].kbValue,i=t.split("|"),i.length>1?(r=i[0].trim(),u=i[i.length-1].trim(),n.visState.visEarthworm2.fill="url(#"+e(r,u)+")"):n.visState.visEarthworm2.fill=y(n[a].kbValue));function e(n,t){var u=String(Math.round(n,2)),f=String(Math.round(t,2)),i=a+"-"+u+"-"+f,r;return i=i.replace(/ /g,""),document.getElementById(i)||(r=d3.select("#tombioEsbMultiaccess").append("linearGradient").attr("id",i),r.append("stop").attr("offset","0%").attr("stop-color",y(n)),r.append("stop").attr("offset","100%").attr("stop-color",y(t))),i}}else n.visState.visEarthworm2.fill="lightgrey"});this.worms.select("rect").style("opacity",.5).style("fill",function(n){return n.visState.visEarthworm2.fill}).transition().duration(1e3).delay(i.delay).attr("x",function(n){return n.visState.visEarthworm2.x}).attr("y",function(n){return n.visState.visEarthworm2.y}).attr("height",function(n){return n.visState.visEarthworm2.height});this.worms.select(".tombioEsbScientificnames").transition().duration(1e3).delay(i.delay).style("opacity",1).attr("x",function(n){return n.visState.visEarthworm2.x+i.taxspace}).attr("y",function(n){return 1+n.visState.visEarthworm2.y+i.taxheight/2-2});this.worms.select("text").text(function(n){return n.Taxon.kbValue+" - "}).append("tspan").style("font-style","normal").style("font-weight","bold").style("font-size","0.9em").style("color","red").text(function(n){return n.visState.visEarthworm2.segdiffTotal});this.worms.selectAll(".tombioEsbCharactervalue").transition().duration(1e3).delay(this.delay).style("opacity",function(n){return n.visState.visEarthworm2.height==i.taxheight?0:1}).attr("x",function(n){return n.visState.visEarthworm2.x+2*(i.taxspace+i.indrad)}).attr("y",function(n,t){return n.visState.visEarthworm2.y+i.taxheight+i.indrad-1+t*2*(i.indrad+i.taxspace)});this.worms.selectAll(".tombioEsbInfoimage").transition().duration(1e3).delay(this.delay).style("opacity",function(n){return n.visState.visEarthworm2.height==i.taxheight?0:1}).attr("x",function(n){return n.visState.visEarthworm2.x+i.taxwidth-i.imagedim-3}).attr("y",function(n){return n.visState.visEarthworm2.y+i.imagedim/2-2});var tt=this.inputControl.otherState.tolerance,g=this.scoreChars.filter(function(n){return n.EsbScoreType=="redline"}).length,rt=this.scoreChars.filter(function(n){return n.EsbScoreType=="segnum"}).length,ft=d3.scaleLinear().domain([0,100]).range(["#0072B2","#D55E00"]),ut=d3.scaleLinear().domain([0,tt+1]).range(["#0072B2","#D55E00"]),et=d3.scaleLinear().domain([0,.48]).range(["#0072B2","#D55E00"]);this.worms.selectAll("circle").on("mouseover",h).on("mouseout",c).transition().duration(1e3).delay(i.delay).attr("cx",function(n,t,r){var u;if(n.visState.visEarthworm2.height==i.taxheight){if(u=i.scoreChars[t],u.EsbScoreType=="redline")var e=n.visState.visEarthworm2.x,r=t,f=1;else if(u.EsbScoreType=="segnum")var e=n.visState.visEarthworm2.x+g*(2*i.indrad+i.taxspace),r=t-g,f=.8;else var e=n.visState.visEarthworm2.x+g*(2*i.indrad+i.taxspace)+rt*(1.6*i.indrad+i.taxspace),r=t-g-rt,f=.6;return e+i.taxspace+f*i.indrad+r*(2*f*i.indrad+i.taxspace)}return n.visState.visEarthworm2.x+i.taxspace+i.indrad}).attr("cy",function(n,t){return n.visState.visEarthworm2.height==i.taxheight?n.visState.visEarthworm2.y+i.taxheight-i.indrad-2:n.visState.visEarthworm2.y+i.taxheight+t*2*(i.indrad+i.taxspace)}).style("fill",function(n,t){var r=i.scoreChars[t];return n.visState.visEarthworm2.scores[r.Character]!=null?t<2?ft(n.visState.visEarthworm2.scores[r.Character]):t<8?n.visState.visEarthworm2.scores[r.Character]>tt+1?ut(tt+1):ut(n.visState.visEarthworm2.scores[r.Character]):n.visState.visEarthworm2.scores[r.Character]>1?1:et(n.visState.visEarthworm2.scores[r.Character]):"white"});this.worms.selectAll(".tombioEsbIndText").text(function(n,t){var r=i.scoreChars[t];return n.visState.visEarthworm2.scores[r.Character]!=null?r.EsbScoreType=="segnum"?n.visState.visEarthworm2.scores[r.Character]:"":""});d3.select("#tombioEsbMultiaccess").transition().duration(1e3).delay(i.delay).attr("height",function(){var n,t;return n=u.length==0?0:u[u.length-1].visState.visEarthworm2.y+u[u.length-1].visState.visEarthworm2.height,t=l.length==0?0:l[l.length-1].visState.visEarthworm2.y+l[l.length-1].visState.visEarthworm2.height,Math.max(t,n)})};r.urlParams=function(){};r.show=function(){n("#visEarthworm2").show();r.inputControl.$div.show();r.inputControl.initFromCharacterState()};r.hide=function(){n("#visEarthworm2").hide();r.inputControl.$div.hide()}})(jQuery,this.tombiovis),function(n,t){"use strict";function i(){t.f.refreshVisualisation()}function r(){var b=this,w=t.gui.keyInputEarthworm.keyItemWidth,o=t.gui.keyInputEarthworm.keyItemHeight,f=t.gui.keyInputEarthworm.keyItemSpace,l=[],r,e,v,s,h,c,a,p,y;d3.select("#tombioEsbLegend").selectAll(".tombioesb-legenditem").remove();r=n("#tombioEsbColourBy").val();r!=""&&(e=t.d.oCharacters[r].EsbColourParams.split(" ")[1],e=="number"||e=="log"?(s=t.d.oCharacters[r].minVal,h=t.d.oCharacters[r].maxVal,e=="log"&&(s=Math.log(s),h=Math.log(h)),v=d3.scaleLinear().domain([s,h]).range(["yellow","blue"]),l=[{colval:"url(#"+u("yellow","blue",s+"-"+h)+")",coltext:t.d.oCharacters[r].Label,coltitle:"Range is "+t.d.oCharacters[r].minVal+"-"+t.d.oCharacters[r].maxVal}]):(e=="default"||e=="specified")&&(e=="default"?(c=t.d.oCharacters[r].CharacterStateValues,a=t.d.oCharacters[r].CharacterStateValues.length<=10?d3.schemeCategory10:d3.schemeCategory20):(c=[],a=[],t.d.values.filter(function(n){return n.Character==r}).forEach(function(n){c.push(n.CharacterState);a.push(n.EsbColour.replace("*","#"))})),v=d3.scaleOrdinal().domain(c).range(a),l=c.map(function(n){return{colval:v(n),coltext:n}})),p=d3.select("#tombioEsbLegend").selectAll(".tombioesb-legenditem").data(l),y=p.enter().append("g").attr("class","tombioesb-legenditem"),y.append("rect").attr("class","tombioEsbLegendRect").attr("x",0).attr("y",function(n,t){return f+t*(o+f)}).attr("rx",5).attr("ry",5).attr("height",o).attr("width",w).style("opacity",.5).attr("fill",function(n){return n.colval}).attr("title",function(n){return n.coltitle?n.coltitle:""}),y.append("text").attr("class","tombioEsbLegendText").attr("x",f).attr("y",function(n,t){return f+t*(o+f)+o*2/3}).text(function(n){return n.coltext}).attr("title",function(n){return n.coltitle?n.coltitle:""}),n(".tombioEsbLegendRect[title!='']").tooltip({track:!0}),n(".tombioEsbLegendText[title!='']").tooltip({track:!0}));d3.select("#tombioEsbLegend").style("height",f+l.length*(o+f));i()}function u(n,t,i){var r=i.replace("[","").replace("]","").replace(/,/g,"").replace(/ /g,""),u=d3.select("#tombioEsbLegend").append("linearGradient").attr("id",r);return u.append("stop").attr("offset","0%").attr("stop-color",n),u.append("stop").attr("offset","100%").attr("stop-color",t),r}t.gui.keyInputEarthworm={width:280,keyItemWidth:130,keyItemHeight:30,keyItemSpace:5};t.gui.keyInputEarthworm.init=function(u){var l=this,a=n("<div>").attr("id","tombioEsbKeyInput").appendTo(u),h,e,f,s,o,c;this.$div=a;h=n("<table>").attr("id","tombioEsbControlsTable");h.appendTo(n("#tombioEsbKeyInput"));e=n("<tr>").appendTo(h);n("<td>").appendTo(e);f=n("<td>").attr("colspan","2").appendTo(e);s=n("<button>").attr("id","tombioEsbOptions").text("Options").appendTo(f);s.button({icons:{primary:null,secondary:"ui-icon-options"},disabled:!1}).click(function(){n("#tombioEsbOptionsDialog").dialog("open")});e=n("<tr>").appendTo(h);n("<td>").appendTo(e);f=n("<td>").attr("colspan","2").appendTo(e);s=n("<button>").attr("id","tombioEsbReset").text("Reset all").appendTo(f);s.button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(){n(".tombioEsbInputSpin").val("").spinner("value","");n(".tombioEsbInputMenu").val("").selectmenu("refresh");t.d.characters.forEach(function(n){n.stateSet=!1;n.userInput=null});i();n("#tombioEsbColourBy").val("").selectmenu("refresh");l.otherState.colourby="";r()});t.d.characters.filter(function(n){return n.EsbKeyOrder==""?!1:!0}).sort(function(n,t){return n.EsbKeyOrder-t.EsbKeyOrder}).forEach(function(r){if(e=n("<tr>").appendTo(h),f=n("<td>").attr("morphokey",r.EsbMorphoKey).appendTo(e),f.addClass("tombioEsbMorphoLabel").text(r.Label).appendTo(f),f=n("<td>").appendTo(e),r.ControlType=="spin"?(o=n("<input>"),o.addClass("tombioEsbInputSpin")):(o=n("<select>"),r.ControlType=="multi"&&o.attr("multiple","multiple"),o.addClass("tombioEsbInputMenu")),o.addClass("tombioEsbInput").attr("id","tombioEsbInput-"+r.Character).appendTo(f),f=n("<td>").appendTo(e),c=n("<img>").attr("src",t.opts.tombiopath+"/visEarthworm2/resources/reset2.png").addClass("tombioEsbResetImage").attr("id","tombioEsbReset-"+r.Character).appendTo(f),r.ControlType=="spin"){var u=r.Params.split(","),l=Number(u[0]),a=Number(u[1]),v=Number(u[2]),y=o.spinner({min:l,max:a,step:v});y.on("spinstop",function(){var t=n("#tombioEsbInput-"+r.Character).spinner("value");r.stateSet=t!=null&&t!="";r.userInput=t;i()});c.click(function(){var t=n("#tombioEsbInput-"+r.Character);t.val("").spinner("value","");r.stateSet=!1;r.userInput=null;i()})}else{o.attr("name","tombioEsbInput-"+r.Character);s=n("<option>").attr("value","").attr("selected","selected").text("");o.append(s);r.CharacterStateValues.forEach(function(t){s=n("<option>").text(t);o.append(s)});o.selectmenu().on("selectmenuchange",function(){var t=r.CharacterStateValues.indexOf(n("#tombioEsbInput-"+r.Character).val());t==-1?(r.stateSet=!1,r.userInput=null):(r.stateSet=!0,r.userInput=[t]);i()});c.click(function(){n("#tombioEsbInput-"+r.Character).val("").selectmenu("refresh");r.stateSet=!1;r.userInput=null;i()})}});e=n("<tr>").appendTo(h);f=n("<td>").addClass("tombioEsbMorphoLabelNoLink").text("Colour by").appendTo(e);f=n("<td>").appendTo(e);o=n("<select>").attr("id","tombioEsbColourBy").addClass("tombioEsbInputMenu").appendTo(f);s=n("<option>").attr("value","").attr("selected","selected").text("").appendTo(o);t.d.characters.filter(function(n){return n.EsbColourParams==""?!1:!0}).sort(function(n,t){return n.EsbColourParams.split(" ")[0]-t.EsbColourParams.split(" ")[0]}).forEach(function(t){s=n("<option>").attr("value",t.Character).text(t.Label).appendTo(o)});o.selectmenu().on("selectmenuchange",function(){l.otherState.colourby=n("#tombioEsbColourBy").val();r()});f=n("<td>").appendTo(e);c=n("<img>").attr("src",t.opts.tombiopath+"/visEarthworm2/resources/reset2.png").addClass("tombioEsbResetImage").attr("id","tombioEsbReset-colour").appendTo(f);c.click(function(){n("#tombioEsbColourBy").val("").selectmenu("refresh");l.otherState.colourby="";r()});e=n("<tr>").appendTo(h);n("<td>").appendTo(e);f=n("<td style='display:flex'>").appendTo(e);s=n('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">').attr("id","tombioEsbLegend").appendTo(f);s.css("width",this.keyItemWidth).css("height",0);n(".tombioEsbMorphoLabel").hover(function(){n(this).animate({color:"#D55E00"},"fast")},function(){n(this).animate({color:"black"},"fast")}).click(function(){var t=n('#tombioEsbHelpTabs a[href="#tombioEsbHelpTab-'+n(this).attr("morphokey")+'"]').parent().index();n("#tombioEsbHelpTabs").tabs("option","active",t);n("#tombioEsbHelpDialog").dialog("open")});n("<div>").attr("id","tombioEsbOptionsDialog").appendTo(n("#tombioEsbKeyInput"));h=n("<table>").appendTo(n("#tombioEsbOptionsDialog"));e=n("<tr>").appendTo(h);f=n("<td>").text("Tolerance").appendTo(e);f=n("<td>").appendTo(e);n("<input>").attr("id","tombioEsbTolerance").appendTo(f);n("<p>").text("(Consult the information dialog for details of how the tolerance value affects the display of species in the 'possible species' and 'unlikely species' lists.)").appendTo(n("#tombioEsbOptionsDialog"));n("#tombioEsbOptionsDialog").dialog({title:"Options",autoOpen:!1,modal:!0,width:410,height:200,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}});n("#tombioEsbTolerance").spinner({min:0,max:5,step:1}).on("spinstop",function(){l.otherState.tolerance=n("#tombioEsbTolerance").spinner("value");i()});n("#tombioEsbTolerance").spinner("value",2);this.otherState.tolerance=2;n.get(t.opts.tombiopath+"/visEarthworm2/characterHelp.html?ver="+t.opts.tombiover,function(i){n("#tombioEsbKeyInput").append(i.replace(/##tombiopath##/g,t.opts.tombiopath));n("#tombioEsbHelpDialog").dialog({title:"Morphological features",width:600,height:470,autoOpen:!1,modal:!0,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}});n("#tombioEsbHelpTabs").tabs()});setTimeout(t.gui.main.resizeControlsAndTaxa,100)};t.gui.keyInputEarthworm.initFromCharacterState=function(){t.d.characters.forEach(function(t){var i,r,u;t.ControlType==="spin"?(i=n("#tombioEsbInput-"+t.Character),i.spinner("value",t.stateSet?t.userInput:"")):(i=n("#tombioEsbInput-"+t.Character),t.stateSet?(r=t.userInput.map(function(n){return t.CharacterStateValues[n]}),u=r.length==0?"":r[0]):u="",i.val(u).selectmenu("refresh"))})};t.gui.keyInputEarthworm.initStateFromParams=function(t){this.initFromCharacterState();n("#tombioEsbTolerance").spinner("value",t.tolerance);n("#tombioEsbColourBy").val(t.colourby).selectmenu("refresh");this.otherState.colourby=t.colourby;r()};t.gui.keyInputEarthworm.setParamsFromState=function(n){return n.push("colourby="+this.otherState.colourby),n.push("tolerance="+this.otherState.tolerance),n};t.gui.keyInputEarthworm.otherState={keys:["colourby","tolerance"],colourby:null,tolerance:null}}(jQuery,this.tombiovis);