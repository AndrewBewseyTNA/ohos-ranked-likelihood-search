!function(e,c){"use strict";c.d.stateValue={v:null},c.d.stateValue.init=function(e,n){var r=c.d.oCharacters[n];this.valueType=r.ValueType,this.status=r.Status,this.character=r.Character;var s,l=this;this.v.trim().split("|").forEach(function(e,t){var a,i;if((e=e.trim()).endsWith("(m)")||e.endsWith("(f)")?(a=e.substr(0,e.length-4).trim(),i=e.substr(e.length-4,4)):(a=e,i=""),r.stateGroups&&-1<r.stateGroups.indexOf(a)){var o=[];c.d.values.forEach(function(e){e.Character==n&&e.StateGroup==a&&o.push(e.CharacterState)})}else o=[a];o.forEach(function(e){var t=l.translateStateValue(l.character,e);""!=i&&(t=t+" "+i),s=s?s+" | "+t:t}),0<s.length&&"#"==s.substr(0,1)&&(s=""),"?"==s.length&&(s="")}),this.kbValue=s,"key"==r.Status&&(this.score={na:0,for:0,against:0,overall:0})},c.d.stateValue.translateStateValue=function(e,t){function a(t,a){var e=c.d.values.filter(function(e){return e.Character==t&&e.CharacterState.trim()==a});if(e[0]&&e[0].CharacterStateTranslation&&""!=e[0].CharacterStateTranslation)var i=e[0].CharacterStateTranslation;else i=a;return i=i.replace(/ +(?= )/g,"")}if(/^\[[^-]+-[^-]+\]$/.test(t)){var i=t.substr(1,t.length-2).split("-");return"["+a(e,i[0])+"-"+a(e,i[1])+"]"}return a(e,t)},c.d.stateValue.getStates=function(e){e||(e="");for(var t=[],a=this.kbValue.split("|"),i=0;i<a.length;i++){var o=a[i];"n/a"!=(o=o.trim())&&"novalue"!=o&&"?"!=o&&""!=o&&("male"!=e||o.endsWith("(f)")?"female"!=e||o.endsWith("(m)")?""==e&&t.push(o.replace("(m)","").replace("(f)","").trim()):t.push(o.replace("(f)","").trim()):t.push(o.replace("(m)","").trim()))}return t},c.d.stateValue.getRange=function(){var e={};if(""==String(this.kbValue)?e.hasValue=!1:e.hasValue=!0,0==String(this.kbValue).indexOf("[")){var t=this.kbValue.substr(1,this.kbValue.length-2).split("-");e.min=Number(t[0]),e.max=Number(t[1]),e.mid=e.min+(e.max-e.min)/2}else e.min=Number(this.kbValue),e.max=Number(this.kbValue),e.mid=Number(this.kbValue);return e},c.d.stateValue.getOrdinalRanges=function(e){var r=this,s=[];return"ordinal"!=this.valueType&&"ordinalCircular"!=this.valueType||this.getStates(e).forEach(function(e){var t=[];if(0==e.indexOf("[")){var a=e.substr(1,e.length-2).split("-"),i=a[0],o=a[1],n=!1;c.d.oCharacters[r.character].CharacterStateValues.forEach(function(e){e==i&&(n=!0),n&&t.push(e),e==o&&(n=!1)}),n&&c.d.oCharacters[r.character].CharacterStateValues.forEach(function(e){n&&t.push(e),e==o&&(n=!1)})}else t.push(e);s.push(t)}),s},c.d.stateValue.toHtml1=function(){if("n/a"==this.kbValue)return"<i>not applicable</i>";if("novalue"==this.kbValue)return"<i>not manifest</i>";if(""==this.kbValue||"?"==this.kbValue)return"<i>no value specified</i>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalCircular"==this.valueType)return t=(t=(t=(t=(t=(t=this.kbValue.replace(/([^|]+)/g,"<b>$1</b>")).replace(/(\(m\)\s*<\/b>)/g,"</b> (male)")).replace(/(\(f\)\s*<\/b>)/g,"</b> (female)")).replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>")).replace(/\s*\|\s*/g," or "),"display"==this.status&&(t=t.replace(/<b>/g,"").replace(/<\/b>/g,"")),t;if("numeric"==this.valueType){var e=this.getRange();if(0==e.hasValue)var t="<b>no value in knowledge-base</b>";else if(e.min==e.max)t="<b>"+e.min+"</b>";else t="<b>"+e.min+"-"+e.max+"</b> (range)";return"display"==this.status&&(t=t.replace(/<b>/g,"").replace(/<\/b>/g,"")),t}return this.kbValue},c.d.stateValue.toHtml2=function(){if("n/a"==this.kbValue)return"<li><i>not applicable</i></li>";if("novalue"==this.kbValue)return"<li><i>not manifest</i></li>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalCircular"==this.valueType){for(var e="",t=this.kbValue.split("|"),a=0;a<t.length;a++){var i=t[a].trim();i=(i=(i=/\(m\)$/.test(i)?"<b>"+i.replace(/\(m\)$/,"</b> (male)"):/\(f\)$/.test(i)?"<b>"+i.replace(/\(f\)$/,"</b> (female)"):"<b>"+i.trim()+"</b>").replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>"),a<t.length-1&&(i+=" or"),e+="<li>",e+=i,e+="</li>"}return e}if("numeric"==this.valueType){var o=this.getRange();return 0==o.hasValue?"<li><i>no value in knowledge-base</i></li>":o.min==o.max?"<li><b>"+o.min+"</b></li>":"<li><b>"+o.min+" - "+o.max+"</b> (range)</li>"}return this.kbValue},c.d.stateValue.toString=function(){return this.kbValue}}(jQuery,this.tombiovis),function(d,m){"use strict";function o(){return m.v.selectedTool in m.v.visualisations?m.v.visualisations[m.v.selectedTool]:null}m.f.loadcomplete=function(e){if(d("#tombiod3-header").text(m.d.kbmetadata.title),d("#tombiod3-footer").html(m.f.getCitation(m.d.kbmetadata,"Knowledge-base",m.d.softwareMetadata.title)),e||m.f.checkKnowledgeBase()){m.d.oCharacters={},m.d.characters.forEach(function(t){(m.d.oCharacters[t.Character]=t).CharacterStates=[],t.CharacterStateValues=[],t.stateSet=!1,t.userInput=null,t.minVal=null,t.maxVal=null,"key"==t.Status&&"none"!=t.Group.toLowerCase()&&(m.d.oCharacters.grouped=!0),t.stateGroups=[],m.d.values.forEach(function(e){e.Character==t.Character&&e.StateGroup&&-1==t.stateGroups.indexOf(e.StateGroup)&&t.stateGroups.push(e.StateGroup)})}),m.d.oTaxa={};var a=0;m.d.taxa.forEach(function(e){for(var t in m.d.oTaxa[e.Taxon]=e)e.hasOwnProperty(t)&&(e[t]=Object.create(m.d.stateValue,{v:{writable:!0,value:e[t]}}),e[t].init(e,t));e.kbPosition=++a,e.visState={score:{for:null,against:null,overall:null}}}),m.d.characters.forEach(function(i){if("numeric"==i.ValueType&&m.d.taxa.forEach(function(e){var t=e[i.Character].getRange().min,a=e[i.Character].getRange().max;(!i.minVal||t<i.minVal)&&(i.minVal=t),(!i.maxVal||a>i.maxVal)&&(i.maxVal=a)}),"numeric"==i.ValueType||"ordinal"==i.ValueType||"ordinalCircular"==i.ValueType)if(void 0!==i.Latitude)i.Latitude=Number(i.Latitude);else{var e=""==i.Strictness?10:Number(i.Strictness);if("numeric"==i.ValueType)i.Latitude=(1-e/10)*(i.maxVal-i.minVal);else{var t=m.d.values.filter(function(e){return e.Character==i.Character}).length;i.Latitude=(1-e/10)*t,"ordinalCircular"==i.ValueType&&(i.Latitude=i.Latitude/2)}}}),m.d.media.forEach(function(e){"image-local"!=e.Type&&"html-local"!=e.Type||(e.URI=m.opts.tombiokbpath+e.URI,e.SmallURI&&(e.SmallURI=m.opts.tombiokbpath+e.SmallURI),e.LargeURI&&(e.LargeURI=m.opts.tombiokbpath+e.LargeURI))}),m.d.values.forEach(function(e){var t=m.d.oCharacters[e.Character];if(t){if(e.CharacterStateTranslation&&""!=e.CharacterStateTranslation)var a=e.CharacterStateTranslation;else var a=e.CharacterState;t.CharacterStates.push({CharacterState:a,StateHelp:e.StateHelp}),t.CharacterStateValues.push(a)}}),m.d.characters.forEach(function(a){("Taxonomy"==a.Group||"key"==a.Status&&"text"==a.ValueType)&&m.d.taxa.forEach(function(e){var t=e[a.Character].getStates("");t.forEach(function(e){""!=e&&-1==a.CharacterStateValues.indexOf(e)&&(a.CharacterStates.push({CharacterState:e,StateHelp:""}),a.CharacterStateValues.push(e))})})});var t=m.f.getURLParameter("selectedTool");t?m.v.selectedTool=t:m.opts.selectedTool?m.v.selectedTool=m.opts.selectedTool:m.d.kbconfig.selectedTool?m.v.selectedTool=m.d.kbconfig.selectedTool:m.v.selectedTool=m.v.includedVisualisations[0],m.gui.main.init(),m.gui.main.createUIControls(),d("#downloadspin").remove(),m.f.resizeControlsAndTaxa(),m.f.visChanged(m.v.selectedTool),m.loadCallback&&m.loadCallback()}},m.f.visChanged=function(t,e){if(t)if(m.opts.devel&&m.templates.visTemplate.initP("visTemplate"),"reload"!=(m.v.selectedTool=t))if("reloadGuiOnsen"!=t)if("reloadGuiJQuery"!=t)if("visInfo"!=t&&"kbInfo"!=t){var a;if("tombioCitation"==t||"currentVisInfo"==t)return a=e||(m.v.lastVis?m.v.lastVis:m.opts.lastVisualisation?m.opts.lastVisualisation:m.v.includedVisualisations[0].visName),m.f.showDownloadSpinner(),void m.js.jsFiles[a].loadJs().then(function(){if(m.f.hideDownloadSpinner(),!m.v.visualisations[a].visName){var e=m.v.visualisations[a];e.initP(a),e.hide()}m.v.lastVis=a,m.gui.main.visShow(t)});"mediaFilesCheck"!=t&&"tvkCheck"!=t?(m.f.showDownloadSpinner(),m.js.jsFiles[t].loadJs().then(function(){(m.f.hideDownloadSpinner(),m.v.visualisations[t].initialised)||m.v.visualisations[t].initP(t);console.log("Starting",t),m.gui.main.visShow(t)}),m.gui.main.setSelectedTool(t)):m.gui.main.visShow(t)}else m.gui.main.visShow(t);else{location.pathname;window.location.replace(location.pathname+"?gui=guiLargeJqueryUi")}else{location.pathname;window.location.replace(location.pathname+"?gui=guiOnsenUi")}else d.ajax({url:window.location.href,headers:{Pragma:"no-cache",Expires:-1,"Cache-Control":"no-cache"}}).done(function(){window.location.reload(!0)})},m.f.initControlsFromParams=function(e){for(name in e)if(name.startsWith("c-")){var t=name.split("-")[1],a=m.d.characters[t];"spin"===a.ControlType?a.userInput=e[name]:a.userInput=e[name].split(","),a.stateSet=!0}o().inputControl.initStateFromParams(e),m.f.refreshVisualisation()},m.f.setParamsFromControls=function(){var i=[];return m.d.characters.forEach(function(e,t){if(e.userInput){var a="c-"+t;"spin"===e.ControlType?i.push(a+"="+e.userInput):i.push(a+"="+e.userInput.join(","))}}),o().inputControl.setParamsFromState(i)},m.f.getCitation=function(e,t,a){var i,o=d("<div class='tombioCitation'>"),n=new Date;return i=e.authors+" ",i+="("+e.year+") ",i+="<i>"+e.title+"</i>",i+=" (Version "+e.version+") ["+t+"]",a&&(i+=" (for "+a+")"),i+=". ",e.publisher&&(i+=e.publisher+". "),e.location&&(i+=e.location+". "),i+="Accessed "+n.toDateString()+". ",i+=window.location.href.split("?")[0],o.append(d("<div>").html(i)),o},m.f.setKbInfo=function(n){d.get(m.opts.tombiokbpath+"info.html",function(e){n.append(e.replace(/##tombiopath##/g,m.opts.tombiopath).replace(/##tombiokbpath##/g,m.opts.tombiokbpath))}).always(function(){var e=d("<h3>").attr("id","tombioKbCitation").text("Citation");n.append(e),n.append(m.f.getCitation(m.d.kbmetadata,"Knowledge-base",m.d.softwareMetadata.title));var t=d("<h3>").attr("id","tombioKbRevisionHistory").text("Knowledge-base revision history");n.append(t);var a=d("<p>").html("<b>Current version: "+m.d.kbmetadata.version+"</b>");n.append(a);var i=d("<table>"),o=d("<tr>").css("background-color","black").css("color","white");o.append(d("<td>").text("Date").css("padding","3px")),o.append(d("<td>").text("Version").css("padding","3px")),o.append(d("<td>").text("Notes").css("padding","3px")),i.append(o),m.d.kbreleaseHistory.forEach(function(e,t){o=d("<tr>"),t%2==0?o.css("background-color","rgb(200,200,200)"):o.css("background-color","rgb(230,230,230)");var a=new Date(e.Date);o.append(d("<td>").css("padding","3px").text(a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear())),o.append(d("<td>").css("padding","3px").text(e.Value)),o.append(d("<td>").css("padding","3px").text(e.Notes)),i.append(o)}),n.append(i)})},m.f.setVisInfo=function(t){d.get(m.opts.tombiopath+"visInfo.html",function(e){t.html(e.replace(/##tombiopath##/g,m.opts.tombiopath).replace(/##tombiokbpath##/g,m.opts.tombiokbpath))})},m.f.setSelectedToolInfo=function(e){var o=new Array(m.v.visualisations[m.v.lastVis].helpFiles.length),t=[];m.v.visualisations[m.v.lastVis].helpFiles.forEach(function(a,i){t.push(new Promise(function(t,e){d.get(a,function(e){o[i]=e,t()})}))}),Promise.all(t).then(function(){var t="";o.forEach(function(e){t+=e}),t=t.replace(/##tombiopath##/g,m.opts.tombiopath).replace(/##tombiokbpath##/g,m.opts.tombiokbpath),e.html(t)})},m.f.createCitationPage=function(){var e,t=d("<div>");t.append(d("<h3>").text("Citation for FSC Identikit (core software)")),e="This is the reference you can use for the FSC Identikit - in other words the core software.",e+=" The core version number is updated whenever there is a new major release of the core software.",t.append(d("<p>").html(e)),t.append(d("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationCore' id='tbCitationCore'>")),t.append(d("<span>").text("Copy citation")),t.append(d("<b>").html(m.f.getCitation(m.d.softwareMetadata,"Software"))),t.append(d("<h3>").text("Citation for last selected visualisation tool")),e="This is the reference you can use for the last selected visualisation tool.",e+=" The tool version number is updated whenever there is a new release of the tool.",e+=" If you cite a tool, there's no need to cite the core software separately since it is implicit.",t.append(d("<p>").html(e)),t.append(d("<input style='position: relative; top: 0.2em' type='checkbox' name='tbCitationVis' id='tbCitationVis'>")),t.append(d("<span>").text("Copy citation")),t.append(d("<b>").html(m.f.getCitation(m.v.visualisations[m.v.lastVis].metadata,"Software",m.d.softwareMetadata.title))),t.append(d("<h3>").text("Citation for knowledge-base")),e="This is the reference you can use for the knowledge-base currently driving the software.",e+=" The knowledge-base version number is updated whenever there is a new release of the knowledge-base.",t.append(d("<p>").html(e)),t.append(d("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationKb' id='tbCitationKb'>")),t.append(d("<span>").text("Copy citation")),t.append(d("<b>").html(m.f.getCitation(m.d.kbmetadata,"Knowledge-base",m.d.softwareMetadata.title)));var a=d("<button>Copy citations</button>");return a.button(),a.click(function(){d("#tbSelectedCitations").html(""),document.getElementById("tbCitationCore").checked&&d("#tbSelectedCitations").append(m.f.getCitation(m.d.softwareMetadata,"Software")),document.getElementById("tbCitationVis").checked&&d("#tbSelectedCitations").append(m.f.getCitation(m.v.visualisations[m.v.lastVis].metadata,"Software",m.d.softwareMetadata.title)),document.getElementById("tbCitationKb").checked&&d("#tbSelectedCitations").append(m.f.getCitation(m.d.kbmetadata,"Knowledge-base",m.d.softwareMetadata.title)),m.f.selectElementText(document.getElementById("tbSelectedCitations")),d("#tbCitationInstructions").show()}),t.append(d("<p>").append(a).append("&nbsp;The selected citations will appear together below - just copy and paste")),t.append(d("<div id='tbSelectedCitations'>")),t.append(d("<p id='tbCitationInstructions' style='display: none'>").text("You can now copy and paste the selected citation text.")),t},m.f.refreshVisualisation=function(){var f;f=d("#Sex").val(),m.d.taxa.forEach(function(h){h.visState.score.for=0,h.visState.score.against=0,h.visState.score.overall=0,m.d.characters.filter(function(e){return"key"==e.Status}).forEach(function(t){var e,a,i,o=t.Character;if(t.stateSet){if("numeric"==t.ValueType)if(""==h[o])a=e=i=0;else if("n/a"==h[o])i=m.opts.ignoreNegativeScoring?0:1,a=e=0;else if("novalue"==h[o])e=i=0,a=m.opts.ignoreNegativeScoring?0:1;else{var n=Number(t.userInput),r=h[o].getRange(),s=(t.maxVal,t.minVal,m.f.score.numberVsRange(n,r,t.Latitude));e=s[0],a=s[1],i=0}else if("ordinal"==t.ValueType||"ordinalCircular"==t.ValueType||"text"==t.ValueType)if("n/a"==h[o])i=m.opts.ignoreNegativeScoring?0:1,a=e=0;else if("novalue"==h[o])e=i=0,a=1;else{var l=t.userInput.map(function(e){return t.CharacterStateValues[e]});if("ordinal"==t.ValueType||"ordinalCircular"==t.ValueType)var c=h[o].getOrdinalRanges(f),d=t.CharacterStateValues,u="ordinalCircular"==t.ValueType,s=m.f.score.ordinal(l,c,d,t.Latitude,u);else if("Sex"==o)var s=[0,0];else var c=h[o].getStates(f),s=m.f.score.character(l,c);e=s[0],a=s[1],i=0}}else a=e=i=0;h[o].score.na=i,h[o].score.for=e,h[o].score.against=a,h[o].score.overall=e-a-i;var p=Number(t.Weight)/10;h.visState.score.for+=e*p,h.visState.score.against+=a*p,h.visState.score.against+=i*p,h.visState.score.overall+=(e-a-i)*p})}),o()&&o().refresh(),m.f.resizeControlsAndTaxa()},m.f.resizeControlsAndTaxa=function(){m.gui.main.resizeControlsAndTaxa()},m.f.characterHasHelp=function(t){return 0<m.d.oCharacters[t].Help.length||(0<m.d.values.filter(function(e){if(e.Character==t&&e.StateHelp)return!0}).length||0<m.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==t)return!0}).length)},m.f.getURLParameter=function(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]==e)return i[1]}return null},m.f.createMediaCheckPage=function(){var e=d("<div id='tombioMediaChecks'>"),t=d("<h2>").appendTo(e),a=d("<div id='tombioMediaNotFound'>").appendTo(e),i=d("<div id='tombioMediaFound'>").appendTo(e);return a.append("<h3>Not found</h3>"),a.append("<p>If a file cannot be found but you think it is present, check the case carefully. The case used to name the file must match exactly the case used in the knowledge-base. For example, a file with extension '.JPG' will not match the same filename in the knowledge-base if it is written there as '.jpg'.</p>"),i.append("<h3>Found</h3>"),t.text("Checking media files..."),m.f.mediaCheck("URI",function(e){d("#tombioMediaFound").append(d("<p>").html("The media file '"+e+"' found okay."))},function(e){d("#tombioMediaNotFound").append(d("<p>").html("The media file '"+e+"' cannot be found."))}).then(function(){m.f.mediaCheck("SmallURI",function(e){d("#tombioMediaFound").append(d("<p>").html("The small media file '"+e+"' found okay."))},function(e){d("#tombioMediaNotFound").append(d("<p>").html("The small media file '"+e+"' cannot be found."))})}).then(function(){m.f.mediaCheck("LargeURI",function(e){d("#tombioMediaFound").append(d("<p>").html("The large media file '"+e+"' found okay."))},function(e){d("#tombioMediaNotFound").append(d("<p>").html("The large media file '"+e+"' cannot be found."))})}).then(function(){t.text("Completed checking media files")}),e},m.f.createTvkCheckPage=function(){var e=d("<div id='tombioTvkChecks'>"),t=d("<h2>").appendTo(e),a=d("<div id='tombioTvkNotFound'>").appendTo(e),i=d("<div id='tombioTvkFound'>").appendTo(e);return a.append("<h3>Not found</h3>"),a.append("<p>If a TVK cannot be found by the NBN web service used for this checking, then you can double-check by going directly to the NBN Atlas page and searching on the TVK (https://nbnatlas.org/). To resolve problems with TVKs not being recognised, you may have to contact the NBN or the NHM who look after the UKSI.</p>"),i.append("<h3>Found</h3>"),t.text("Checking TVKs..."),m.f.tvkCheck(function(e){d("#tombioTvkFound").append(d("<p>").html("TVK '"+e.TVK+"' found."))},function(e){d("#tombioTvkNotFound").append(d("<p>").html("TVK '"+e.TVK+"' for '"+e.Taxon+"' cannot be found."))},function(){t.text("Completed checking TVKs")}),e},m.f.getTaxonCharacterValues=function(n){var r=d("<table>");r.css("width","100%"),r.css("margin","0px");var s=0,l="";return m.d.characters.forEach(function(e){if("key"==e.Status||"display"==e.Status){if(m.d.oCharacters.grouped&&e.Group!=l){(a=d("<tr>")).css("background-color","rgb(100,100,100)"),a.css("color","rgb(255,255,255)");var t=d("<td colspan='3'>");a.append(t.append(e.Group)),r.append(a),l=e.Group}s++;var a=d("<tr>");s%2!=0?a.css("background-color","rgb(200,200,200)"):a.css("background-color","rgb(230,230,230)");var i=d("<td>").append(e.Label),o=d("<td>").append(n[e.Character].toHtml1());a.append(i),a.append(o),r.append(a)}}),r.find("td").css("padding","2"),r},m.f.addTaxonImagesToContainer=function(e){var t=e.taxon,a=e.container,i=e.indexSelected?e.indexSelected:0,o=!!e.imageRemovalButton&&e.imageRemovalButton,n=e.fImageSelect?e.fImageSelect:null,r=e.height?e.height:400,s=m.f.getTaxonImages(t);if(0!=s.length){var l=d("<div>").addClass("tombio-galleria-pane").css("position","relative").css("max-width","2000px").css("height",r).appendTo(a),c=[];s.forEach(function(e){var t={image:e.URI,thumb:e.SmallURI?e.SmallURI:null,big:e.LargeURI?e.LargeURI:null,alt:e.Caption,title:e.Caption};c.push(t)}),Galleria.run(l,{transition:"fade",wait:!0,dataSource:c,theme:"classic",show:i}),l.data("galleria").bind("loadfinish",function(e){n&&n(e.index)}),d("<img>").attr("src",m.opts.tombiopath+"resources/enlarge.png").appendTo(l).addClass("tombio-galleria-lightbox-button").on("click",function(){l.data("galleria").openLightbox()}),o&&d("<img>").attr("src",m.opts.tombiopath+"resources/remove.png").appendTo(l).addClass("tombio-galleria-remove-button").on("click",function(){l.data("galleria").destroy(),a.addClass("userRemoved"),a.remove()})}else{d("<div>").css("margin","10px").text("No images are specified in the knowledge-base for this taxon.").appendTo(a)}},m.f.getTaxonImages=function(t){return m.d.media.filter(function(e){if(e.Taxon==t&&("image-local"==e.Type||"image-web"==e.Type))return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},m.f.addNBNMapToContainer=function(e,t){e=e+="";var a=d("<div>").appendTo(t).css("border","1px solid black").css("padding","5px").css("border-radius","10px"),i=d("<img>").addClass("tombioNbnLogo").attr("src",m.opts.tombiopath+"/resources/nbn-logo-centred.png").addClass(function(){if(e)return"tombioSpiningNbn"}()).appendTo(a),o=d("<div>").addClass("tombioNbnLoading").css("font-size","0.8em").text(e?"Loading distribution map from NBN...":"No TVK specified for this taxon").appendTo(a);if(e)if(m.d.nbnMapCache[e]){var n=m.d.nbnMapCache[e];i.attr("src",m.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),o.hide()}else{var r="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+e+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100";n=d("<img>").attr("id","tombioNbnMapImage").on("load",function(){i.attr("src",m.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),o.hide()}).on("error",function(){i.removeClass("tombioSpiningNbn"),o.text("An error was encountered attemping to retrieve an NBN distribution map for the TVK "+e),n.hide()}).attr("src",r);m.d.nbnMapCache[e]=n}d("<div>").append(n).appendTo(a)},m.f.addTaxonHtmlToContainer=function(e,n,t){var a=m.f.getTaxonHtmlFiles(e);t<=a.length-1?d.get(a[t].URI+"?ver="+m.opts.tombiover,function(e){var t=e.indexOf("<body"),a=e.indexOf("</body"),i=e.slice(t,a),o=d("<div>").html(i);n.html(o.html())}):n.html(null)},m.f.getTaxonHtmlFiles=function(t){return m.d.media.filter(function(e){if(e.Taxon==t&&"html-local"==e.Type)return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},m.f.getCharacterScoreDetails=function(e,t){var a;a="<p>Specified state(s) for character <b>"+t.Label+"</b>: </p>";var i=d("#"+t.Character);return a+="<ul>","spin"==t.ControlType||"single"==t.ControlType?(a+="<li><b>",a+=i.val(),a+="</b></li>"):"multi"==t.ControlType&&i.val().forEach(function(e){a+="<li><b>",a+=e,a+="</b></li>"}),a+="</ul>",a+="<p>Valid state(s) for <b>"+t.Label+"</b> recorded against ",a+="<b><i>"+e.Taxon+"</i></b> in the knowledge base: ",a+="<ul>",a+=e[t.Character].toHtml2(),a+="</ul>",a+="<hr/>",a+="<p>Knowledge-base <b>weighting</b> for this character: <b>"+t.Weight+"</b></p>",a+="<p>Knowledge-base <b>latitude</b> for this character: <b>"+t.Latitude+"</b></p>",a+="<hr/>",a+="<p>Unweighted character score: <b>"+Math.round(100*e[t.Character].score.overall)/100+"</b>; ",a+="(for, "+Math.round(100*e[t.Character].score.for)/100,a+="; against, "+Math.round(100*(e[t.Character].score.against+e[t.Character].score.na))/100+")</p>",a+="<p>Weighted character score: <b>"+Math.round(e[t.Character].score.overall*t.Weight*10)/100+"</b></p>"},m.f.sortTaxa=function(e){return e.sort(function(e,t){return e.visState.score.overall>t.visState.score.overall?-1:t.visState.score.overall>e.visState.score.overall?1:t.visState.score.overall==e.visState.score.overall?e.visState.score.for>t.visState.score.for?1:t.visState.score.for>e.visState.score.for?-1:e.kbPosition>t.kbPosition?1:-1:void 0})},m.f.getTaxonTipImage=function(a,e){var t=m.d.media.filter(function(e){if(e.Taxon==a&&("image-local"==e.Type||"image-web"==e.Type)){if(e.UseFor){var t=!1;return e.UseFor.split(",").forEach(function(e){"tip"==e.toLowerCase().trim()&&(t=!0)}),t}return!0}}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)});if(0<t.length){var i=d("<div/>"),o=t[0],n=d("<img/>",{src:o.URI}).appendTo(i).css("margin-top",2);d("<figcaption/>",{html:o.Caption}).appendTo(i);return o.ImageWidth&&n.css("width",o.ImageWidth),i}return null},m.f.taxonTag=function(e){return e.replace(/[\/|&;$%@"<>()+:.,' ]/g,"")},m.f.copyTextToClipboard=function(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();try{var a=document.execCommand("copy")?"successful":"unsuccessful";console.log("Copying text "+a)}catch(e){console.log("Oops, unable to copy text")}document.body.removeChild(t)},m.f.createViewURL=function(e){var t=window.location.href.split("tbv=")[0],a=-1==t.indexOf("?")?"?":"&",i=encodeURI(t+a+"tbv=&"+e.join("&"));m.f.copyTextToClipboard(i)},m.f.selectElementText=function(e,t){var a,i,o=(t=t||window).document;t.getSelection&&o.createRange?(a=t.getSelection(),(i=o.createRange()).selectNodeContents(e),a.removeAllRanges(),a.addRange(i)):o.body.createTextRange&&((i=o.body.createTextRange()).moveToElementText(e),i.select())},m.f.checkInterface=function(n,e,t){m.opts.devel&&function e(t,a,i){for(var o in a)a.hasOwnProperty(o)&&(i[o]?"object"==typeof a[o]&&e(t+"."+o,a[o],i[o]):console.log("%cInterface warning: "+n+t+"."+o+" not found in "+n,"color: red"))}("",e,t)}}(jQuery,this.tombiovis);