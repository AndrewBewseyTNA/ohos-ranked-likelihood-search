!function(e,m){"use strict";var g,f="vis2",i=m.v.visualisations[f]=Object.create(m.v.visP);i.visName=f,i.initialise=function(){(g=this).metadata.title="Single-column key",this.metadata.year="2016",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="richardb@field-studies-council.org",this.metadata.version="1.1",this.helpFiles=[m.opts.tombiopath+"vis2/vis2Help.html",m.opts.tombiopath+"common/taxonDetailsHelp.html",m.opts.tombiopath+"common/full-details.html",m.opts.tombiopath+"common/stateInputHelp.html"],this.showWeightedScores=!0,this.displayToolTips=!0,d3.select("#"+this.visName).append("svg").attr("id","vis2Svg");var t=m.opts.toolconfig[this.visName].keyinput;m.gui.sharedKeyInput[t]||(m.gui.sharedKeyInput[t]=Object.create(m.gui[t]),m.gui.sharedKeyInput[t].init(e(m.gui.main.divInput))),i.inputControl=m.gui.sharedKeyInput[t],this.initialised=!0,m.f.checkInterface(f,m.templates.visTemplate,m.v.visualisations[f])},i.refresh=function(){g=this;var s=34,o=d3.scaleLinear().domain([-1,0,1]).range(m.d.scoreColours),t=d3.max(m.d.taxa,function(t){return t.visState.score.overall}),e=d3.min(m.d.taxa,function(t){return t.visState.score.overall}),a=d3.scaleLinear().domain([e,0,t]).range(m.d.scoreColours),i=[];m.d.taxa.forEach(function(t){i.push(t)}),m.f.sortTaxa(i);var c=0;i.forEach(function(t){d3.select("#vis2Svg").append("text").attr("class","scientificnames tmpTaxonText").style("opacity",0).text(t.Taxon)}),d3.selectAll(".tmpTaxonText").each(function(){var t=this.getBBox();t.width>c&&(c=t.width)}),c+=56,d3.selectAll(".tmpTaxonText").remove();var l=0,u=[];m.d.characters.forEach(function(t){t.stateSet&&u.push(t)}),u.forEach(function(t){d3.select("#vis2Svg").append("text").attr("class","type2VisCharacter tmpCharacterText").style("opacity",0).text(t.Label)}),d3.selectAll(".tmpCharacterText").each(function(){var t=this.getBBox();t.width>l&&(l=t.width)}),d3.selectAll(".tmpCharacterText").remove();var n=d3.select("#vis2Svg").selectAll(".type2VisTaxon").data(i,function(t,e){return t.Taxon}),r=n.enter(),h=n.exit(),d=r.append("g").attr("class","type2VisTaxon").style("opacity",0).each(function(e,t){d3.select(this).append("rect").attr("class","taxarect"),d3.select(this).append("text").attr("class","scientificnames").text(function(){return e.Taxon}).style("cursor","pointer").on("click",function(){m.gui.main.showFullDetails(e.Taxon,0)}),d3.select(this).append("rect").attr("class","type2VisOverallInd").attr("width",30).attr("height",26).attr("x",2).attr("title","Overall weighted score"),d3.select(this).append("text").attr("class","type2VisOverallIndText").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",15).attr("opacity",0).attr("text",0).attr("cursor","default").attr("title","Overall weighted score"),d3.select(this).append("svg:image").attr("xlink:href",m.opts.tombiopath+"resources/camera.png").attr("class","taxonImageLink").attr("width",16).attr("height",16).attr("x",function(){return 36}).style("display",function(){return 0<m.d.media.filter(function(t){if(t.Taxon==e.Taxon.kbValue)return!0}).length?null:"none"}).on("click",function(){m.gui.main.showFullDetails(e.Taxon,1)})}).merge(n);d.transition().duration(1e3).style("opacity",1).each(function(e,i){d3.select(this).select(".taxarect").transition().duration(1e3).attr("x",function(){return 0}).attr("y",function(){return l+i*s+2}).attr("width",function(){return c+2+u.length*s}).attr("height",function(){return 30}),d3.select(this).select(".scientificnames").transition().duration(1e3).attr("x",function(){var t=this.getBBox();return c-t.width}).attr("y",function(){var t=this.getBBox();return l+i*s+t.height+(s-t.height)/3}),d3.select(this).select(".type2VisOverallInd").transition().duration(1e3).attr("y",function(){return l+4+i*s}).attr("fill",function(){return a(e.visState.score.overall)}),d3.select(this).select(".type2VisOverallIndText").transition().duration(1e3).attr("y",function(){return l+(i+.5)*s}).attr("text",function(){var t=100*e.visState.score.overall;t=Math.round(t)/100,d3.select(this).text(t)}).attr("opacity",1),d3.select(this).select(".taxonImageLink").transition().duration(1e3).attr("y",function(){return l+i*s+2+7})}),h.transition().duration(1e3).style("opacity",0).remove(),m.gui.main.createTaxonToolTips(".scientificnames",this.displayToolTips),m.gui.main.tooltip(".type2VisOverallInd"),m.gui.main.tooltip(".type2VisOverallIndText"),d.each(function(t,e){var a=e,n=t,i=m.f.taxonTag(t.Taxon.kbValue),r=d3.select(this).selectAll(".type2VisIndicators-"+i).data(u,function(t,e){return t.Character+"-"+i});r.enter().append("g").attr("class","type2VisIndicators-"+i).style("cursor","pointer").on("click",function(t,e){m.gui.main.dialog("Character score details",m.f.getCharacterScoreDetails(n,t))}).each(function(){d3.select(this).append("circle").attr("r",13).attr("class","type2VisInd").attr("fill","white").style("opacity",0),d3.select(this).append("text").style("opacity",0).attr("class","type2VisIndtext").attr("text-anchor","middle").attr("alignment-baseline","central")}).merge(r).each(function(i,t){d3.select(this).select(".type2VisInd").transition().duration(1e3).attr("cx",function(){return c+2+(t+.5)*s}).attr("cy",function(){return l+(a+.5)*s}).attr("fill",function(){return o(n[i.Character].score.overall)}).style("opacity",1),d3.select(this).select(".type2VisIndtext").transition().duration(1e3).attr("text",function(){if(g.showWeightedScores)var t=Number(m.d.oCharacters[i.Character].Weight)/10;else t=1;var e=n[i.Character].score.overall*t*10;e=Math.floor(e)/10,d3.select(this).text(e)}).attr("x",function(){return c+2+(t+.5)*s}).attr("y",function(){return l+(a+.5)*s}).style("opacity",1)}),r.exit().transition().duration(1e3).style("opacity",0).remove()});var p=d3.select("#vis2Svg").selectAll(".type2VisCharacter").data(u,function(t,e){return t.Character});p.enter().append("text").attr("class","type2VisCharacter").style("opacity",0).text(function(t){return t.Label}).merge(p).transition().duration(1e3).style("opacity",1).attr("x",function(t,e){return c+2+(e+.5)*s}).attr("y",function(){var t=this.getBBox();return l-t.width}).attr("transform",function(t,e){var i=this.getBBox();return"rotate(90 "+(c+2+(e+.5)*s)+","+(l-i.width)+")"}),p.exit().transition().duration(1e3).attr("x",0).attr("y",0).style("opacity",0).remove(),d3.select("#vis2Svg").transition().duration(1e3).attr("width",function(t,e){return c+2+u.length*s}).attr("height",function(t,e){return l+m.d.taxa.length*s}),m.gui.main.contextMenu.addItem("Get URL for single-column key",function(){var t;(t=[]).push("selectedTool="+f),Array.prototype.push.apply(t,m.f.setParamsFromControls()),t.push("weighted="+g.showWeightedScores),t.push("imgtips="+g.displayToolTips),m.f.createViewURL(t)},!1,[this.visName]),this.showWeightedScores?(m.gui.main.contextMenu.removeItem("Show weighted scores"),m.gui.main.contextMenu.addItem("Show unweighted scores",function(){g.showWeightedScores=!1,g.refresh()},!1,[this.visName])):(m.gui.main.contextMenu.removeItem("Show unweighted scores"),m.gui.main.contextMenu.addItem("Show weighted scores",function(){g.showWeightedScores=!0,g.refresh()},!1,[this.visName])),this.displayToolTips?(m.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){g.displayToolTips=!1,m.gui.main.contextMenu.removeItem("Remove taxon image tooltips"),g.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),m.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(m.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){g.displayToolTips=!0,m.gui.main.contextMenu.removeItem("Display taxon image tooltips"),g.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),m.gui.main.contextMenu.removeItem("Remove taxon image tooltips"))},i.urlParams=function(t){t.weighted&&(g.showWeightedScores="true"===t.weighted),t.imgtips&&(g.displayToolTips="true"===t.imgtips),m.f.initControlsFromParams(t)},i.show=function(){e("#vis2").show(),e(i.inputControl.divSel).show(),i.inputControl.initFromCharacterState()},i.hide=function(){e("#vis2").hide(),e(i.inputControl.divSel).hide()}}(jQuery,this.tombiovis);