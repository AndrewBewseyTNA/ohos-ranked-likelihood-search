!function(u,g){"use strict";var n,T,o,f="vis4",e=g.v.visualisations[f]=Object.create(g.v.visP);function a(e){s(o=e.selected)}function s(a){if(T.html(null),a){var e,t;if(g.opts.toolconfig.vis4&&g.opts.toolconfig.vis4.subTitleChar){var i=g.opts.toolconfig.vis4.subTitleChar;e=g.d.oTaxa[a][i].kbValue}t=e?a+" ("+e+")":a+" ",t+="<span id='vis4TaxonHeaderPadding'>x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x x</span>",u("<div id='vis4TaxonHeader'>").html(t).appendTo(T);var s=document.getElementById("tbVis4Images").checked,n=document.getElementById("tbVis4NbnMap")&&document.getElementById("tbVis4NbnMap").checked,o=document.getElementById("tbVis4Kb").checked,x=document.getElementById("tbVis4Text").checked,d=g.f.getTaxonHtmlFiles(a);if(x=x&&0<d.length,s=s&&0<g.f.getTaxonImages(a).length,n=n&&g.d.oTaxa[a].TVK,s){var l=u('<div style="position: relative">').appendTo(T);x?l.attr("class","vis4ImageWithText"):l.attr("class","vis4ImageNoText");var c=g.d.oTaxa[a].visState[f].indexselectedImg?g.d.oTaxa[a].visState[f].indexselectedImg:0;g.f.addTaxonImagesToContainer({taxon:a,container:l,indexSelected:c,height:x?400:600,fImageSelect:function(e){g.d.oTaxa[a].visState[f].indexselectedImg=e}})}if(n){var m=u('<div style="position: relative">').appendTo(T);x?m.attr("class","vis4ImageWithText"):m.attr("class","vis4ImageNoText"),g.f.addNBNMapToContainer(g.d.oTaxa[a].TVK,m)}if(x){if(1<d.length){var p=u('<div style="margin-bottom: 20px; display: inline">').appendTo(T),h=u("<select id='vis4html'></select>").appendTo(p);d.forEach(function(e,t){var a=u("<option/>").text(e.Caption).attr("value",t);h.append(a)}),h.selectmenu({change:function(e,t){g.f.addTaxonHtmlToContainer(a,r,t.item.value),g.d.oTaxa[a].visState[f].indexselectedText=t.item.value}}).selectmenu("menuWidget")}var r=u('<div class="htmlFile">').appendTo(T),v=g.d.oTaxa[a].visState[f].indexselectedText?g.d.oTaxa[a].visState[f].indexselectedText:0;g.f.addTaxonHtmlToContainer(a,r,v),1<d.length&&h.val(v).selectmenu("refresh")}o&&(T.append(u("<h2>").css("clear","both").text("Knowledge-base values")),T.append(g.f.getTaxonCharacterValues(g.d.oTaxa[a]))),l&&u(window).resize(function(){l.find(".baseimage").trigger("change")})}}e.visName=f,e.initialise=function(){this.metadata.title="Full taxon details",this.metadata.authors="Burkmar, R.",this.metadata.year="2016",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="richardb@field-studies-council.org",this.metadata.version="1.1",this.helpFiles=[g.opts.tombiopath+"vis4/vis4Help.html",g.opts.tombiopath+"common/full-details.html",g.opts.tombiopath+"common/taxon-select-help.html"],g.gui.main.contextMenu.addItem("Get URL for full details view",function(){!function(){var e=[];e.push("selectedTool="+f),e.push("taxon="+o);var t=document.getElementById("tbVis4Images").checked,a=document.getElementById("tbVis4Kb").checked,i=document.getElementById("tbVis4Text").checked;if(!(t&&a&&i)){var s=[];t&&s.push("image"),i&&s.push("text"),a&&s.push("kb"),e.push("opts="+s.join("-"))}e=n.setParamsFromState(e),g.d.oTaxa[o].visState[f].indexselectedImg&&e.push("imgi="+g.d.oTaxa[o].visState[f].indexselectedImg);g.d.oTaxa[o].visState[f].indexselectedText&&e.push("txti="+g.d.oTaxa[o].visState[f].indexselectedText);g.f.createViewURL(e)}()},!1,[this.visName]);var e=u("<div/>").css("display","block").css("overflow","hidden");function t(e,t,a){if("tbVis4NbnMap"!=e||g.d.oCharacters.TVK){var i=u('<div style="display: inline-block; vertical-align:top; margin-left: 20px">').appendTo(a);i.append(u("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='"+e+"' id='"+e+"'>")),i.append(u("<span>").text(t)),i.change(function(){s(o)})}}u(this.cssSel).append(e),(n=Object.create(g.gui.taxonSelect)).init(g.gui.main.divInput,!1,a),t("tbVis4Images","Images",e),t("tbVis4NbnMap","NBN Map",e),t("tbVis4Kb","Knowledge-base",e),t("tbVis4Text","Show text",e),T=u("<div>").css("margin","10px"),e.append(T),this.taxonSelect=n,this.initialised=!0,g.f.checkInterface(f,g.templates.visTemplate,g.v.visualisations[f])},e.refresh=function(){u("#vis4taxon").selectmenu("menuWidget").css("height",200)},e.urlParams=function(e){if(e.opts){var t=e.opts.split("-");u("#tbVis4Text").prop("checked",-1<t.indexOf("text")),u("#tbVis4Images").prop("checked",-1<t.indexOf("image")),u("#tbVis4Kb").prop("checked",-1<t.indexOf("kb"))}var a=e.taxon?e.taxon.replace(/%20/g," "):"";e.imgi&&(g.d.oTaxa[a].visState[f].indexselectedImg=e.imgi),e.txti&&(g.d.oTaxa[a].visState[f].indexselectedText=e.txti),a&&n.taxonClick(a),n.initStateFromParams(e)},e.show=function(){console.log("Show vis4"),u("#vis4").show(),n.$div.show()},e.hide=function(){u("#vis4").hide(),n.$div.hide()}}(jQuery,this.tombiovis);