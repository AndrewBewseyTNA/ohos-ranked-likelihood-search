!function(D,H){"use strict";function N(){var a=D("input[name=charvisibility]:checked").val();D(".cloneInput .stateselect, .cloneInput .statespinner").each(function(t){if(void 0!==D(this).attr("id"))if("visible"==a)D(this).parents(".cloneInput").show(500,H.f.resizeControlsAndTaxa);else{var e=D(this).val();e&&""!=e?D(this).parents(".cloneInput").show(500,H.f.resizeControlsAndTaxa):D(this).parents(".cloneInput").hide(500,H.f.resizeControlsAndTaxa)}})}function V(n){var s=D("#"+n).pqSelect({multiplePlaceholder:"select option(s)",singlePlaceholder:"select option",checkbox:!0,search:!1,maxDisplay:20,width:240,selectallText:""});s.addClass("stateselect"),s.on("change",function(){if("clone-"==n.substring(0,6))var t=n.substring(6);else t="clone-"+n;if(D("#"+t).val(s.val()),D("#"+t).pqSelect("refreshData"),D("#"+n).pqSelect("refresh"),N(),"clone-"==n.substring(0,6))var a=n.substring(6);else a=n;var e=null!=s.val()&&""!=s.val();if(H.d.oCharacters[a].stateSet=e){if("string"==typeof s.val())var r=[s.val()];else r=s.val();var i=[];H.d.oCharacters[a].CharacterStateValues.forEach(function(t,e){-1<r.indexOf(t)&&i.push(e)}),H.d.oCharacters[a].userInput=i}else H.d.oCharacters[a].userInput=null;[n,t].forEach(function(t){var e=D("#"+t).next().children().find(".pq-select-item-text");e.attr("title",function(){var e=this,t=H.d.values.filter(function(t){if(t.Character==a&&t.CharacterState==D(e).text())return!0});return 1==t.length?t[0].StateHelpShort?t[0].StateHelpShort:t[0].StateHelp:""}),e.tooltip({track:!0})}),H.f.refreshVisualisation()}),s.val(D("#"+n+" option:first").val()).pqSelect("refreshData"),s.val("").pqSelect("refreshData")}function A(n,t,e,a){var s=D("#"+n).spinner({min:t,max:e,step:a});s.addClass("statespinner"),s.on("spinstop",function(t,e){var a=s.spinner("value");if("clone-"==n.substring(0,6))var r=n.substring(6);else r="clone-"+n;if(D("#"+r).spinner("value",a),"clone-"==n.substring(0,6))var i=n.substring(6);else i=n;H.d.oCharacters[i].stateSet=!0,H.d.oCharacters[i].userInput=a,H.f.refreshVisualisation(),N()}),D("#"+n+"-clear").button({icon:"ui-icon-close",showLabel:!1}).on("click",function(){if(s.spinner("value",""),"clone-"==n.substring(0,6))var t=n.substring(6);else t="clone-"+n;if(D("#"+t).spinner("value",s.spinner("value")),"clone-"==n.substring(0,6))var e=n.substring(6);else e=n;H.d.oCharacters[e].stateSet=!1,H.d.oCharacters[e].userInput=null,H.f.refreshVisualisation()})}H.gui.keyInput={width:360,otherState:{keys:[]},bullet:"",inputCharGroups:[],verticalTabSpace:33},H.gui.keyInput.init=function(t){var a=this;D("<div>").attr("id","tombioKeyInputTabs").css("background-color","rgba( 255,255, 255, 0.7)").appendTo(t),D("<ul>").attr("id","tombioKeyInputListElements").appendTo("#tombioKeyInputTabs"),H.gui.keyInput.divSel="#tombioKeyInputTabs";var e={All:[]};for(var r in H.d.characters.forEach(function(t){"key"==t.Status&&(e[t.Group]||(e[t.Group]=[],a.inputCharGroups.push(t.Group)),e[t.Group].push(t))}),D(H.gui.main.divInput).css("min-height",this.verticalTabSpace*(this.inputCharGroups.length+2)),e){var i="tombioKeyInputTab-"+r.replace(/\s+/g,"-"),n=D("<li/>"),s=D("<a/>").text(r).attr("href","#"+i);n.append(s),D("#tombioKeyInputListElements").append(n);var o=D("<div/>").attr("id",i);if(D("#tombioKeyInputTabs").append(o),"tombioKeyInputTab-All"==i){o.append(D("<div>").text("Un-used characters:").css("font-weight","bold"));var c=D("<fieldset>").attr("id","visCheckboxes").css("display","inline-block").css("padding","0px").css("border","none");c.append(D("<label>").attr("for","charvisible").text("show")),c.append(D("<input>").attr("type","radio").attr("name","charvisibility").attr("id","charvisible").attr("value","visible").attr("checked","checked")),c.append(D("<label>").attr("for","incharvisible").text("hide")),c.append(D("<input>").attr("type","radio").attr("name","charvisibility").attr("id","incharvisible").attr("value","invisible")),o.append(c),D("[name='charvisibility']").checkboxradio({icon:!1}),c.on("change",N);var l=D("<button>").attr("id","tombioReset").text("Reset all");l.button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(t){D(".statespinner").spinner("value",""),D(".stateselect").each(function(){D(this).val()&&D(this).val("").pqSelect("refreshData")}),H.d.characters.forEach(function(t){t.stateSet=!1,t.userInput=null}),H.f.refreshVisualisation(),N()}),o.append(l)}for(var p=0;p<e[r].length;p++){var u=e[r][p],h=D("<span/>").attr("class","characterlabel").text(u.Label),d=D("<div/>").append(h);o.append(d),H.f.characterHasHelp(u.Character)&&(h.attr("character",u.Character),h.addClass("characterhelp"));var f=D("<div/>").attr("class","cloneInput");if(f.append(d.clone()),D("#tombioKeyInputTab-All").css("display","inline-block").append(f),"numeric"==u.ValueType){var v=u.Character,b=u.Params.split(","),m=Number(b[0]),g=Number(b[1]),y=Number(b[2]),C=D("<div>"),I=D("<input></input>").attr("class","spinner").attr("id",v),S=D("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id",v+"-clear");C.append(I),C.append(S),o.append(C),A(v,m,g,y);var k=D("<div>"),T=D("<input></input>").attr("class","spinner").attr("id","clone-"+v),x=D("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id","clone-"+v+"-clear");k.append(T),k.append(x),f.append(k),A("clone-"+v,m,g,y)}else{var G=u.Character;if("multi"==u.ControlType)var w=D("<select multiple=multiple></select>").attr("class","characterSelect");else w=D("<select></select>").attr("class","characterSelect");if(w.attr("id",G),o.append(w),"single"==u.ControlType){var E=D("<option/>").text("");w.append(E)}u.CharacterStateValues.forEach(function(t){var e=D("<option/>").text(a.bullet+t);w.append(e)}),V(G);var K=D("#"+G).clone();K.attr("id","clone-"+G),f.append(K),V("clone-"+G)}}}H.d.oCharacters.grouped||(D("#tombioKeyInputListElements").css("display","none"),D("#tombioKeyInputTabs").css("padding-left","0px"),H.gui.keyInput.width=255);var P=D("#tombioKeyInputTabs").tabs({activate:function(t,e){D(".stateselect").each(function(){}),H.f.resizeControlsAndTaxa()}});if(H.opts.toolconfig.keyinput||(H.opts.toolconfig.keyinput={}),void 0===H.opts.toolconfig.keyinput.selectedGroup&&(void 0===H.opts.selectedGroup?H.opts.toolconfig.keyinput.selectedGroup=H.d.kbconfig.defaultControlGroup?H.d.kbconfig.defaultControlGroup:null:H.opts.toolconfig.keyinput.selectedGroup=H.opts.selectedGroup?H.opts.selectedGroup:null),H.opts.toolconfig.keyinput.selectedGroup){var q=a.inputCharGroups.indexOf(H.opts.toolconfig.keyinput.selectedGroup);-1<q&&P.tabs("option","active",q+1)}D(".characterhelp").hover(function(){D(this).animate({color:"#D55E00"},"fast")},function(){D(this).animate({color:"black"},"fast")}).click(function(){var s,o;s=D(this).attr("character"),o=D("<div>"),D("<h3/>",{text:H.d.oCharacters[s].Label}).appendTo(o),D("<p/>",{html:H.d.oCharacters[s].Help}).appendTo(o),H.d.media.filter(function(t){if(("image-local"==t.Type||"image-web"==t.Type)&&t.Character==s&&!t.State){if(t.UseFor){var e=!1;return t.UseFor.split(",").forEach(function(t){"full"==t.toLowerCase().trim()&&(e=!0)}),e}return!0}}).sort(function(t,e){return Number(t.Priority)-Number(e.Priority)}).forEach(function(t,e){var a=D("<figure/>").appendTo(o);a.addClass("helpFigure");var r=D("<img/>",{src:t.URI}),i=D("<figcaption/>",{html:t.Caption});a.append(r).append(i),0<e&&r.css("margin-top",10),i.appendTo(o),t.ImageWidth&&r.css("width",t.ImageWidth)}),H.d.values.filter(function(t){if(t.Character==s&&t.StateHelp)return!0}).forEach(function(e){if(e.CharacterStateTranslation&&""!=e.CharacterStateTranslation)var t=e.CharacterStateTranslation;else var t=e.CharacterState;var a=D("<p/>").appendTo(o),r=D("<span/>",{text:t+": "}).css("font-weight","Bold");a.append(r);var i=D("<span/>",{html:e.StateHelp}).css("font-weight","Normal");a.append(i);var n=H.d.media.filter(function(t){if(("image-local"==t.Type||"image-web"==t.Type)&&t.Character==s&&t.State==e.CharacterState)return!0}).sort(function(t,e){return Number(t.Priority)-Number(e.Priority)});n.forEach(function(t,e){var a=D("<img/>",{src:t.URI}),r=D("<figcaption/>",{html:t.Caption});a.appendTo(o),0<e&&a.css("margin-top",10),r.appendTo(o),t.ImageWidth&&a.css("width",t.ImageWidth)})}),H.gui.main.dialog("Character help & info",o.html())}),H.gui.main.createCharacterTooltips(".characterhelp"),H.f.checkInterface("keyInput",H.templates.gui.keyInput,H.gui.keyInput)},H.gui.keyInput.initFromCharacterState=function(){H.d.characters.forEach(function(e,t){if("spin"===e.ControlType){var a=D("#"+e.Character+".statespinner"),r=D("#clone-"+e.Character+".statespinner"),i=e.stateSet?e.userInput:"";a.spinner("value",e.userInput),r.spinner("value",i)}else{a=D("#"+e.Character+".stateselect"),r=D("#clone-"+e.Character+".stateselect");if(e.stateSet)var n=e.userInput.map(function(t){return e.CharacterStateValues[t]});else n=[];a.val(n).pqSelect("refreshData"),r.val(n).pqSelect("refreshData")}})},H.gui.keyInput.initStateFromParams=function(t){this.initFromCharacterState(),D("#tombioKeyInputTabs").tabs("option","active",t.grp),D("[name='charvisibility']").removeProp("checked").filter('[value="'+t.cvis+'"]').prop("checked",!0),D("[name='charvisibility']").checkboxradio("refresh"),N()},H.gui.keyInput.setParamsFromState=function(t){return t.push("grp="+D("#tombioKeyInputTabs").tabs("option","active")),t.push("cvis="+D("input[name=charvisibility]:checked").val()),t}}(jQuery,this.tombiovis.templates.loading?this.tombiovis.templates:this.tombiovis);