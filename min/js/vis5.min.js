!function(c,p){"use strict";var h,m="vis5",e=p.v.visualisations[m]=Object.create(p.v.visP);e.visName=m;var f,v,n,x,g,y,b,k,i,T,I,M,S,C,w,A,o,s,l=1,u=0,d=0,R=/Mobi/.test(navigator.userAgent);function L(t){v=t,d3.transition().duration(750).tween("zoom",function(){var a=d3.interpolateZoom(k,[v.x,v.y,2*v.r+T]);return function(t){N(a(t),[v.x,v.y,2*v.r+T],null,!0)}})}function N(a,t,e,n){"visPjQueryUILargeFormat"==p.opts.toolconfig[m].prototype&&c(".node-taxa").tooltip("close");var r=i/a[2];k=a,e?w.selectAll("circle,text").transition(e).attr("transform",function(t){return"translate("+(t.x-a[0])*r+","+(t.y-a[1])*r+")"}).attr("r",function(t){return t.r*r}):w.selectAll("circle,text").attr("transform",function(t){return"translate("+(t.x-a[0])*r+","+(t.y-a[1])*r+")"}).attr("r",function(t){return t.r*r}),Math.round(100*a[0])/100==Math.round(100*t[0])/100&&Math.round(100*a[1])/100==Math.round(100*t[1])/100&&Math.round(100*a[2])/100==Math.round(100*t[2])/100&&n&&F(e)}function F(t){t?w.selectAll("text").transition(t).on("end",function(t){a(d3.select(this),t)}):w.selectAll("text").each(function(t){a(d3.select(this),t)})}function r(){var t,a;if(s=!0,d3.event.transform.k>l?t=120:d3.event.transform.k<l&&(t=-120),t){a=0<t?100/t:Math.abs(t/100);var e=0,n=0}else{a=1;e=(d3.event.transform.x-u)*(k[2]/i),n=(d3.event.transform.y-d)*(k[2]/i)}var r=[k[0]-e,k[1]-n,k[2]*a];o=1==a,l=d3.event.transform.k,u=d3.event.transform.x,d=d3.event.transform.y,R||N(r,r,null,!1)}function P(){s&&(o||F(null)),s=!1}function j(t,a,e){var n=t.split(/\s+/).reverse();if(1<n.length){if(1==a)return n.pop().substring(0,1)+". "+n.reverse().join(" ");if(2==a){for(var r=n.pop().substr(0,1)+".";i=n.pop();)r+=" "+i.substr(0,3),3<i.length&&(r+=".");return r}var i;for(r="";i=n.pop();)r+=i.substr(0,1);return r}return 1==a?5<t.length?t.substr(0,5)+".":t:2==a?3<t.length?t.substr(0,3)+".":t:t.substr(0,1)+"."}function E(t){console.log("displayTextForRank",t),h.selectedRank=t,d3.selectAll(".label").style("display","none"),d3.selectAll("text."+t).style("display","inline"),d3.selectAll("circle").style("stroke-width","0px"),d3.selectAll("circle."+t).style("stroke","black").style("stroke-width","1px")}function a(t,a){if("none"!=t.style("display")){var e=d3.select("#"+t.attr("circleId")).node().getBBox().width;if(h.abbrvnames)if(e<20&&h.abbrvnames)t.text(null);else{var n=[80,55,30],r=-1;n.forEach(function(t,a){-1==r&&t<e&&(r=a)}),-1==r&&(r=n.length),U(t,e,a.data.data.abbrv[r])}else U(t,e,a.data.data.abbrv[0])}}function U(t,a,e){for(var n,r=e.split(/\s+/).reverse(),i=[],o=1,s=t.attr("y"),l=t.text(null).append("tspan").attr("class","tspan").attr("x",0).attr("y",s);n=r.pop();)i.push(n),l.text(i.join(" ")),l.node().getComputedTextLength()>a&&(i.pop(),0<i.length?l.text(i.join(" ")):(l.remove(),o--),i=[n],l=t.append("tspan").attr("class","tspan").attr("x",0).attr("y",s).text(n),1<++o&&l.attr("dy","1em"));t.attr("dy",(1.5-o)/2+"em")}e.initialise=function(){(h=this).metadata.title="Circle-pack key",this.metadata.authors="Rich Burkmar",this.metadata.year="2016",this.metadata.publisher="Field Studies Council",this.metadata.location="Preston Montford, Shropshire",this.metadata.contact="richardb@field-studies-council.org",this.metadata.version="1.0",this.abbrvnames=!0,this.displayToolTips=!1,this.helpFiles=[p.opts.tombiopath+"vis5/vis5Help.html",p.opts.tombiopath+"common/taxonDetailsHelp.html",p.opts.tombiopath+"common/full-details.html",p.opts.tombiopath+"common/stateInputHelp.html"],(n=d3.select("#"+this.visName).append("svg").attr("id","vis5Svg").attr("width","500").attr("height","500").attr("overflow","visible").call(d3.zoom().on("zoom",r).on("end",c.proxy(P,h)))).on("click",function(){L(f)}),T=20,i=+n.attr("width"),w=n.append("g").attr("transform","translate("+i/2+","+i/2+")"),A=d3.scaleLinear().domain([-1,5]).range(["hsl(152,0%,80%)","hsl(228,0%,40%)"]).interpolate(d3.interpolateHcl),x=d3.pack().size([i-T,i-T]).padding(2),I=[],p.d.characters.forEach(function(t){"Taxonomy"!=t.Group&&"Taxon"!=t.Character||I.push(t.Character)}),console.log("taxonRanks",I);var s=[{name:"All taxa",parent:""}];I.forEach(function(i,o){p.d.taxa.forEach(function(t,a){var e=t[i].kbValue;if(""!=e&&!function(t,a){for(var e=0;e<t.length;e++)if(t[e].name==a)return!0;return!1}(s,e)){for(var n="",r=o-1;-1<r&&""==(n=t[I[r]].kbValue);r-=1);""==n&&(n="All taxa"),s.push({name:e,parent:n,rankColumn:i,rank:p.d.oCharacters[i].Label,abbrv:[e,j(e,1,"Taxon"==i),j(e,2,"Taxon"==i),j(e,3,"Taxon"==i)],taxon:"Taxon"==i?t:null})}})}),M=d3.stratify().id(function(t){return t.name}).parentId(function(t){return t.parent})(s);var t=(S=d3.stratify().id(function(t){return t.name}).parentId(function(t){return""==t.parent?"":"All taxa"})(s)).children.filter(function(t){return"Taxon"==t.data.rankColumn});S.children=t,C=M;var a=p.opts.toolconfig[this.visName].keyinput;p.gui.sharedKeyInput[a]||(p.gui.sharedKeyInput[a]=Object.create(p.gui[a]),p.gui.sharedKeyInput[a].init(c(p.gui.main.divInput))),e.inputControl=p.gui.sharedKeyInput[a],this.initialised=!0,p.f.checkInterface(m,p.templates.visTemplate,p.v.visualisations[m])},e.refresh=function(){h=this;var t=d3.max(p.d.taxa,function(t){return t.visState.score.overall}),a=d3.min(p.d.taxa,function(t){return t.visState.score.overall});p.gui.main.contextMenu.addItem("Get URL for circle-pack key",function(){!function(){var t=[];t.push("selectedTool="+m),Array.prototype.push.apply(t,p.f.setParamsFromControls()),t.push("abbrvnames="+h.abbrvnames),t.push("rank="+h.selectedRank),C==S&&t.push("highertaxa=false");t.push("imgtips="+h.displayToolTips),p.f.createViewURL(t)}()},!1,[h.visName]),p.gui.main.contextMenu.addItem("Toggle name abbreviation",function(){h.abbrvnames=!h.abbrvnames,h.refresh()},!1,[h.visName]),1<I.length&&C==M?(p.gui.main.contextMenu.addItem("Ignore higher taxa",function(){C=S,E("Taxon"),h.refresh()},!1,[h.visName]),I.forEach(function(t){p.gui.main.contextMenu.addItem("Show names for each "+p.d.oCharacters[t].Label,function(){E(t),h.refresh()},!1,[h.visName])}),p.gui.main.contextMenu.removeItem("Show higher taxa")):1<I.length&&C==S&&(p.gui.main.contextMenu.addItem("Show higher taxa",function(){C=M,E("Taxon"),h.refresh()},!1,[h.visName]),I.forEach(function(t){p.gui.main.contextMenu.removeItem("Show names for each "+p.d.oCharacters[t].Label)}),p.gui.main.contextMenu.removeItem("Ignore higher taxa")),this.displayToolTips?(p.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){h.displayToolTips=!1,p.gui.main.contextMenu.removeItem("Remove taxon image tooltips"),h.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),p.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(p.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){h.displayToolTips=!0,p.gui.main.contextMenu.removeItem("Display taxon image tooltips"),h.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),p.gui.main.contextMenu.removeItem("Remove taxon image tooltips"));var n=d3.scaleLinear().domain([a,0,t]).range(p.d.scoreColours),e=a<0?0-a:0;f=d3.hierarchy(C).sum(function(t){return t.data.taxon?Math.pow(t.data.taxon.visState.score.overall+e+.1,1.5):0}).sort(function(t,a){return a.value-t.value});var r=x(v=f).descendants();g=w.selectAll("circle").data(r,function(t){return t.data.id}),y=g.enter().append("circle").attr("class",function(t){var a=t.children?"node-taxa node-higher-taxa":"node-taxa";return a+=" "+t.data.data.rankColumn}).attr("id",function(t){return p.f.taxonTag(t.data.id)}).on("click",function(t){v!==t&&(d3.event.stopPropagation(),L(t))}),(b=y.merge(g)).attr("title",function(t){return t.children?t.data.data.rank?t.data.id+" ("+t.data.data.rank+")":t.data.id:d(t)}),C==M&&1<I.length?c(".node-higher-taxa").css("visibility","visible"):c(".node-higher-taxa").css("visibility","hidden");var i=d3.transition().duration(750);b.transition(i).style("fill",function(t){return t.children?A(t.depth):t.data.data.taxon?n(t.data.data.taxon.visState.score.overall):0});var o,s,l=w.selectAll("text").data(r,function(t){return t.data.id}),u=l.enter().append("text").text(function(t){return t.data.id}).style("background-color","red").attr("taxonName",function(t){return t.data.id}).attr("class",function(t){return"label "+t.data.data.rankColumn}).attr("circleId",function(t){return p.f.taxonTag(t.data.id)}).style("display","none").on("click",function(t){t.data.data.taxon&&(d3.event.stopPropagation(),p.gui.main.showFullDetails(t.data.data.taxon.Taxon,0))});function d(t){var a;if(a=t.data.data.taxon?"<i>"+t.data.id+"</i> <span style='background-color: "+n(t.data.data.taxon.visState.score.overall)+"; padding: 2px 5px 2px 5px; margin-left: 5px'>"+Math.round(100*t.data.data.taxon.visState.score.overall)/100+"</span>":"<i>"+t.data.id+"</i>",h.displayToolTips){var e=p.f.getTaxonTipImage(t.data.id);e&&(e.css("margin-top",5),a+=e[0].outerHTML)}return a}u.merge(l).attr("title",function(t){return t.children?t.data.id:d(t)}),l.exit().remove(),"guiLargeJqueryUi"==p.opts.gui&&c("circle, text").tooltip({classes:{"ui-tooltip":"taxon-tooltip ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(t,a){setTimeout(function(){c(a.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return c(this).attr("title")}}),k?N(k,k,i,!0):(N([f.x,f.y,2*f.r+T],[f.x,f.y,2*f.r+T],i,!0),E("Taxon")),o=i,s=d3.max(p.d.taxa,function(t){return t.visState.score.overall}),b.transition(o).filter(function(t){return t.data.data.taxon}).style("stroke",function(t){return 0<s&&t.data.data.taxon.visState.score.overall==s?"black":"Taxon"==h.selectedRank?"black":null}).style("stroke-width",function(t){return 0<s&&t.data.data.taxon.visState.score.overall==s?"2px":"Taxon"==h.selectedRank?"1px":"0px"}).style("stroke-linecap",function(t){return 0<s&&t.data.data.taxon.visState.score.overall==s?"round":null}).style("stroke-dasharray",function(t){return 0<s&&t.data.data.taxon.visState.score.overall==s?"1, 5":null})},e.urlParams=function(t){t.abbrvnames&&(h.abbrvnames="true"===t.abbrvnames),t.rank&&(h.selectedRank=t.rank,E(h.selectedRank)),t.highertaxa&&(C=S),t.imgtips&&(h.displayToolTips="true"===t.imgtips),p.f.initControlsFromParams(t)},e.show=function(){c("#vis5").show(),c(e.inputControl.divSel).show(),e.inputControl.initFromCharacterState()},e.hide=function(){c("#vis5").hide(),console.log("hiding ",e.inputControl.divSel),c(e.inputControl.divSel).hide()}}(jQuery,this.tombiovis);