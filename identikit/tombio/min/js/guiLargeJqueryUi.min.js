!function(v,b){"use strict";function s(){for(var i in b.gui.main.contextMenu.items){var e=!0;-1==b.gui.main.contextMenu.visContexts[i].indexOf(b.v.currentTool)&&(e=!1),b.gui.main.contextMenu.guiContexts[i]&&-1==b.gui.main.contextMenu.guiContexts[i].indexOf(b.opts.gui)&&(e=!1),e?b.gui.main.contextMenu.items[i].show():b.gui.main.contextMenu.items[i].hide()}}b.gui.main={},b.gui.main.contextMenu={items:{},visContexts:{},guiContexts:{}},b.gui.main.contextMenu.addItem=function(i,e,t,o,a){if(t&&i in b.gui.main.contextMenu.items&&(b.gui.main.contextMenu.items[i].remove(),delete b.gui.main.contextMenu.items[i],delete b.gui.main.contextMenu.visContexts[i],delete b.gui.main.contextMenu.guiContexts[i]),!(i in b.gui.main.contextMenu.items)){var n=v("<li>").append(v("<div>").text(i).click(e));b.gui.main.contextMenu.menu.append(n),b.gui.main.contextMenu.menu.menu("refresh"),b.gui.main.contextMenu.items[i]=n,b.gui.main.contextMenu.visContexts[i]=o,b.gui.main.contextMenu.guiContexts[i]=a}s()},b.gui.main.contextMenu.removeItem=function(i){i in b.gui.main.contextMenu.items&&(b.gui.main.contextMenu.items[i].remove(),delete b.gui.main.contextMenu.items[i],delete b.gui.main.contextMenu.visContexts[i],delete b.gui.main.contextMenu.guiContexts[i])},b.gui.main.updateProgress=function(i){100==i&&v("#tombioGuiLargeDownloadProgressHeader").text("Resource download complete"),v("#tombioGuiLargeDownloadProgress").progressbar("value",i)},b.gui.main.offlineOptions=function(){v("#offlineOptions").html('<button id="tombioGuiLargeOfflineButton">Download for offline use</button><p id="tombioGuiLargeDownloadProgressHeader" style="display: none">Downloading resources...</p><div id="tombioGuiLargeDownloadProgress" style="display: none;"></div><p></p>'),v("#tombioGuiLargeOfflineButton").button().click(function(){v("#tombioGuiLargeDownloadProgressHeader").show(),v("#tombioGuiLargeDownloadProgress").show(),b.f.cacheAll()}),v("#tombioGuiLargeDownloadProgress").progressbar({min:0,max:100,value:0}),b.gui.main.visShow("offlineOptions")},b.gui.main.offerRefresh=function(){v("#tombioGuiDialog").remove(),v("<div>").attr("id","tombioGuiDialog").css("display","none").appendTo(v("#tombioGuiLargeJqueryUi")),v("#tombioGuiDialog").dialog({resizable:!1,height:"auto",width:400,modal:!0,buttons:{Refresh:function(){window.location.reload()},"Not now":function(){v(this).dialog("close")}}}),v("#tombioGuiDialog").dialog("option","title","Refresh required"),v("#tombioGuiDialog").html("<p>To complete preparation for using offline, a refresh is required.</p>"),v("#tombioGuiDialog").dialog("open")},b.gui.main.setSelectedTool=function(i){v("#tombioGuiLargeJqueryUiVisualisation").val()!=i&&v("#tombioGuiLargeJqueryUiVisualisation").val(i)},b.gui.main.resizeControlsAndTaxa=function(){if(v("#tombioGuiLargeJqueryUiControls").is(":visible")){var i=v("#tombioGuiLargeJqueryUiControls").width();v("#tombioGuiLargeJqueryUiTaxa").css("margin-left",i+10);var e=v("#tombioGuiLargeJqueryUiControls").height();v("#tombioGuiLargeJqueryUiControlsAndTaxa").css("min-height",e+10)}else v("#tombioGuiLargeJqueryUiTaxa").css("margin-left",0),v("#tombioGuiLargeJqueryUiControlsAndTaxa").css("min-height","0px")},b.gui.main.init=function(){v("#tombiod3vis").html(""),v("#tombiod3vis").css("position","relative"),v("<div>").attr("id","tombioGuiLargeJqueryUi").addClass("needsclick").css("display","none").appendTo("#tombiod3vis"),v("<div style='width: "+window.screen.width+"px'>").attr("id","tombioGuiLargeJqueryUiDeviceWarning").appendTo("#tombioGuiLargeJqueryUi"),v("<div>").attr("id","tombioGuiLargeJqueryUiDeviceWarningInnerDiv").css("margin","2em").appendTo(v("#tombioGuiLargeJqueryUiDeviceWarning")),v("<p>").text("This Identikit tool is designed for large format devices. If you are working with a small screen or with a touch device, it might not appear or work as intended. We are working to produce a range of 'mobile-first' tools in the latter part of 2018.").appendTo(v("#tombioGuiLargeJqueryUiDeviceWarningInnerDiv")),v("<img>").attr("id","tombioGuiLargeJqueryUiDeviceWarningButton").attr("src",b.opts.tombiopath+"/resources/remove.png").css("position","absolute").css("right","10px").css("top","10px").appendTo(v("#tombioGuiLargeJqueryUiDeviceWarningInnerDiv")),v("#tombioGuiLargeJqueryUiDeviceWarningButton").on("click",function(){v("#tombioGuiLargeJqueryUiDeviceWarning").hide()}),v("<div>").attr("id","tombioGuiLargeJqueryUiFlashDisplay").css("display","none").appendTo("#tombioGuiLargeJqueryUi");var i=v("<table>").appendTo("#tombioGuiLargeJqueryUi"),e=v("<tr>").appendTo(i),t=v("<td>").appendTo(e),o=v("<td>").appendTo(e);v("<select>").attr("id","tombioGuiLargeJqueryUiVisualisation").appendTo(t),v.ajax({type:"HEAD",url:b.opts.tombiokbpath+"info.pdf",success:function(i){var e=v("<img>").attr("src",b.opts.tombiopath+"resources/pdf.png");e.css("height","25px"),e.css("position","relative"),e.css("top","-3px");var t=v("<a>").attr("href",b.opts.tombiokbpath+"info.pdf");t.append(e),o.append(t)}}),v("<div>").addClass("tombioNoSelect").attr("id","tombioGuiLargeJqueryUiControlsAndTaxa").appendTo("#tombioGuiLargeJqueryUi"),v("<div>").attr("id","tombioGuiLargeJqueryUiControls").appendTo("#tombioGuiLargeJqueryUiControlsAndTaxa"),v("<div>").attr("id","tombioGuiLargeJqueryUiTaxa").appendTo("#tombioGuiLargeJqueryUiControlsAndTaxa"),v("<div>").attr("id","currentVisInfo").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),v("<div>").attr("id","kbInfo").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),v("<div>").attr("id","visInfo").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),v("<div>").attr("id","tombioCitation").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),v("<div>").attr("id","mediaFilesCheck").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),v("<div>").attr("id","tvkCheck").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),v("<div>").attr("id","offlineOptions").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),b.gui.main.divVis="#tombioGuiLargeJqueryUiTaxa",b.gui.main.divInput="#tombioGuiLargeJqueryUiControls",b.f.checkInterface("guiLargeJqueryUi",b.templates.gui.main,b.gui.main)},b.gui.main.createUIControls=function(){v("#tombioGuiLargeJqueryUi").css("display",""),b.gui.main.contextMenu.menu=v("<ul>").css("white-space","nowrap").appendTo("#tombioGuiLargeJqueryUi").addClass("contextMenu").css("position","absolute").css("display","none").css("z-index",999999),b.gui.main.contextMenu.menu.menu(),v("#tombioGuiLargeJqueryUi").on("contextmenu",function(i){b.gui.main.contextMenu.menu.position({});var e=v(this).parent().offset(),t=i.pageX-e.left,o=i.pageY-e.top;return b.gui.main.contextMenu.menu.css({left:t,top:o}),b.gui.main.contextMenu.menu.show(),!1}),v("#tombioGuiLargeJqueryUi").on("click",function(){b.gui.main.contextMenu.menu.hide()});var o=[];b.opts.devel&&o.push(v('<option value="reloadkb" class="html" data-class="wrench">Reload KB</option>')),b.opts.checkKB&&(o.push(v('<option value="mediaFilesCheck" class="html" data-class="wrench">Check media files</option>')),b.d.oCharacters.TVK&&o.push(v('<option value="tvkCheck" class="html" data-class="wrench">Check TVKs</option>'))),b.v.includedVisualisations.forEach(function(i,e){var t=v('<option class="needsclick">').attr("value",i).attr("data-class","vis").addClass("visualisation").text(b.js.jsFiles[i].toolName);o.push(t)}),o.push(v('<option id="optCurrentVisInfo" value="currentVisInfo" class="html" data-class="info"></option>')),o.push(v('<option value="kbInfo" class="html" data-class="info">About the Knowledge-base</option>')),o.push(v('<option value="visInfo" class="html" data-class="info">About FSC Identikit</option>')),o.push(v('<option value="tombioCitation" class="html" data-class="info">Get citation text</option>')),o.forEach(function(i){i.attr("value")==b.v.selectedTool&&i.attr("selected","selected")}),b.opts.pwa&&o.push(v('<option value="offline" class="html" data-class="download">Offline options</option>')),o.push(v('<option value="reload" class="html" data-class="reload">Reload app</option>')),v("#tombioGuiLargeJqueryUiVisualisation").append(o),v.widget("custom.iconselectmenu",v.ui.selectmenu,{_renderItem:function(i,e){var t=v("<li>"),o=v("<div>",{text:e.label});return e.disabled&&t.addClass("ui-state-disabled"),v("<span>",{style:e.element.attr("data-style"),class:"ui-icon "+e.element.attr("data-class")}).appendTo(o),t.append(o).appendTo(i)}}),v("#tombioGuiLargeJqueryUiVisualisation").iconselectmenu({change:function(){b.f.visChanged(v("#tombioGuiLargeJqueryUiVisualisation").val())}}).iconselectmenu("menuWidget").addClass("ui-menu-icons customicons"),1==b.opts.hideVisDropdown&&v("#tombioGuiLargeJqueryUiVisualisation-button").hide()},b.gui.main.visShow=function(i){if("tombioCitation"==i&&v("#tombioCitation").html(b.f.createCitationPage()),"mediaFilesCheck"==i&&v("#mediaFilesCheck").html(b.f.createMediaCheckPage()),"tvkCheck"==i&&v("#tvkCheck").html(b.f.createTvkCheckPage()),"kbInfo"==i&&0==v("#kbInfo").html().length&&b.f.setKbInfo(v("#kbInfo")),"visInfo"==i&&0==v("#visInfo").html().length&&b.f.setVisInfo(v("#visInfo")),"currentVisInfo"==i&&(v("#currentVisInfo").html(""),b.f.setSelectedToolInfo(v("#currentVisInfo"))),console.log("selectedToolName",i),i!=b.v.currentTool&&(b.v.currentTool&&(b.v.visualisations[b.v.currentTool]?b.v.visualisations[b.v.currentTool].hide():v("#"+b.v.currentTool).hide()),b.v.visualisations[i]?b.v.visualisations[i].show():v("#"+i).show()),b.v.visualisations[i]?v("#tombioGuiLargeJqueryUiControlsAndTaxa").show():v("#tombioGuiLargeJqueryUiControlsAndTaxa").hide(),b.f.refreshVisualisation(),b.v.currentTool=i,-1<Object.keys(b.v.visualisations).indexOf(i)&&(b.v.lastVis=i,v("#optCurrentVisInfo").text("Using the "+b.v.visualisations[b.v.lastVis].metadata.title),v("#tombioGuiLargeJqueryUiVisualisation").iconselectmenu("refresh")),s(),!b.v.initialised&&b.v.visualisations[i]){for(var e={},t=decodeURI(window.location.search.substring(1)).replace(/\+/g," ").split("&"),o=0;o<t.length;o++){var a=t[o].split("=");e[a[0]]=a[1]}b.v.visualisations[i].urlParams(e),b.v.initialised=!0}},b.gui.main.dialog=function(i,e){v("#tombioGuiDialog").remove(),v("<div>").attr("id","tombioGuiDialog").css("display","none").appendTo(v("#tombioGuiLargeJqueryUi")),v("#tombioGuiDialog").dialog({modal:!1,width:550,height:450,resizable:!0,draggable:!0,autoOpen:!1,show:{effect:"highlight",duration:500},hide:{effect:"fade",duration:250}}),v("#tombioGuiDialog").dialog("option","title",i),v("#tombioGuiDialog").html(e),v("#tombioGuiDialog").dialog("open")},b.gui.main.createCharacterTooltips=function(i){v(i).tooltip({track:!0,items:"span",content:function(){return function(e){var t=v("<div/>"),i=!1;if(b.d.oCharacters[e].HelpShort&&""!=b.d.oCharacters[e].HelpShort){var o=b.d.oCharacters[e].HelpShort;i=!0}else var o=b.d.oCharacters[e].Help;var a,n,s=b.d.media.filter(function(i){if(("image-local"==i.Type||"image-web"==i.Type)&&i.Character==e)return!0}).sort(function(i,e){return Number(i.Priority)-Number(e.Priority)}),r=0,u=0;s.forEach(function(e){var t=!1,o=!1;e.UseFor?e.UseFor.split(",").forEach(function(i){"tip"==i.toLowerCase().trim()&&(o=!e.State),"full"==i.toLowerCase().trim()&&(t=!0)}):(o=!e.State,t=!0),o&&!a?a=e:t&&r++,t&&u++});var l=!1;if(a){(n=v("<figure/>")).addClass("keyInputHelpFigure");var d=v("<img/>",{src:a.URI}).appendTo(n).css("margin-top",2);a.ImageWidth&&d.css("width",a.ImageWidth);v("<figcaption/>",{html:a.Caption}).appendTo(n);if(a.TipStyle&&""!=a.TipStyle){var c=a.TipStyle.split("-"),p=c[0],m=c[1];n.css("width",m+"%"),n.css("float",p),n.css("margin-bottom",5),"right"==p?n.css("margin-left",5):n.css("margin-right",5),l=!0}}var g=[];l&&g.push(n);0<o.length&&g.push(v("<span/>").html(o));!l&&n&&g.push(n);g.forEach(function(i){t.append(i)});var f=b.f.stateValueHelpPresent(b.d.oCharacters[e]),h="";if(i||0<r||0<f.length)var h="(Click for <b>more detailed help</b>.)";else if(a&&0<u)var h="(Click for resizeable help window.)";h&&v("<div/>").css("margin-top",5).css("font-weight","normal").html(h).appendTo(t);return t}(v(this).attr("character"))}})},b.gui.main.createTaxonToolTips=function(i,e){v(i).tooltip({track:!0,items:"text",content:function(){if(e)return b.f.getTaxonTipImage(this.textContent,this)},open:function(i,e){var t=v(i.target);e.tooltip.click(function(){t.tooltip("close")})}})},b.gui.main.tooltip=function(i){v(i).tooltip()},b.gui.main.showFullDetails=function(i,e,t,o){var a;t=void 0!==t?t:0,o=void 0!==o?o:0,e=void 0!==e?e:1;var n=v("<div>").addClass("tombioFullDetailsTabs");n.css("border","none");var s=v("<ul>").appendTo(n);s.append("<li><a href='#tabs-1'>Knowledge-base</a></li>"),s.append("<li><a href='#tabs-2'>Images</a></li>"),b.d.oCharacters.TVK&&s.append("<li><a href='#tabs-4'>NBN map</a></li>"),s.append("<li><a href='#tabs-3'>Details</a></li>");var r=v("<div>").attr("id","tabs-1").appendTo(n),u=v("<div>").attr("id","tabs-2").appendTo(n);if(b.d.oCharacters.TVK)var l=v("<div>").attr("id","tabs-4").appendTo(n);var d=v("<div>").attr("id","tabs-3").appendTo(n),c=v("<div>").append(n);c.attr("title",i),c.dialog({closeText:"",height:550,width:600,modal:!0,resizeStop:function(i,e){n.tabs("refresh"),g()}}),n.tabs({heightStyle:"fill",active:e,create:function(){a=c.height()-r.height()},activate:function(i,e){n.tabs("refresh"),1==e.newTab.index()&&g()}}),d.css("overflow","hidden");var p=b.f.getTaxonCharacterValues(b.d.oTaxa[i]);r.append(p);b.f.addTaxonImagesToContainer({taxon:i,container:u,height:u.height()});if(b.d.oCharacters.TVK&&b.d.oTaxa[i].TVK){var m=v("<div>").css("position","relative").appendTo(l);b.f.addNBNMapToContainer(b.d.oTaxa[i].TVK,m)}function g(){var i=c.find(".tombio-galleria-pane").first();i.data("galleria")&&(i.data("galleria").setOptions("height",c.height()-a),i.data("galleria").resize())}!function(t,i){var e=v("<div>").appendTo(i),o=b.f.getTaxonHtmlFiles(t);if(0==o.length){var a=v("<div>").css("margin","10px").appendTo(e);a.text("No text information files (HTML) are specified in the knowledge-base for this taxon.")}else{var n=v("<div>");if(1<o.length){var s=v('<div style="margin-bottom: 20px">').appendTo(e),r=v("<select id='tombioFileSelect'></select>").appendTo(s);o.forEach(function(i,e){var t=v("<option/>").text(i.Caption).attr("value",e);r.append(t)}),r.selectmenu({change:function(i,e){b.f.addTaxonHtmlToContainer(t,n,e.item.value)}})}n.appendTo(e),b.f.addTaxonHtmlToContainer(t,n,0)}}(i,d)}}(jQuery,this.tombiovis);